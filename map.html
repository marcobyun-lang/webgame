<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DUNGEON RPG - Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Noto+Serif+KR:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(18, 18, 24, 0.95);
            --border-color: #5c4d3c;
            --accent-gold: #c5a059;
            --accent-red: #d32f2f;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --hp-grad: linear-gradient(90deg, #8b0000, #b71c1c);
            --mp-grad: linear-gradient(90deg, #0d47a1, #1565c0);
            --exp-grad: linear-gradient(90deg, #4a148c, #6a1b9a);
            --font-head: 'Cinzel', serif;
            --font-body: 'Noto Serif KR', 'Inter', sans-serif;

            /* Bag Theme Colors */
            --bag-bg: #3e2723;
            --bag-panel: #4e342e;
            --bag-border: #6d4c41;
            --bag-item: #5d4037;

            /* Rarity Colors */
            --rarity-common: #ffffff;
            --rarity-rare: #2196f3;
            --rarity-epic: #a335ee;
            --rarity-legendary: #ff8000;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #1a1a20 0%, #000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: auto;
            user-select: none;
        }

        #game-container {
            width: 960px;
            height: 720px;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 4px;
            transition: width 0.1s, height 0.1s;
        }

        .game-ui-top {
            height: 80px;
            background: linear-gradient(180deg, #141414 0%, #0a0a0a 100%);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 20;
            position: relative;
        }

        .char-info { display: flex; flex-direction: column; justify-content: center; min-width: 150px; }
        .char-info h2 {
            font-family: var(--font-head); color: var(--accent-gold); margin: 0;
            font-size: 1.1rem; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .char-info span { font-family: var(--font-body); color: var(--text-muted); font-size: 0.75rem; margin-top: 2px; font-weight: 600; }

        #game-timer {
            font-family: var(--font-body); font-weight: 700; font-size: 1.5rem; color: #ef5350;
            text-shadow: 0 0 10px rgba(239, 83, 80, 0.4); min-width: 80px; text-align: center; letter-spacing: 1px;
            margin-right: 20px;
        }

        .ui-bars-center {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 320px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .bar-row { display: flex; align-items: center; gap: 8px; position: relative; }
        .bar-label {
            position: absolute; left: 8px; z-index: 2;
            color: #fff; font-family: var(--font-body); font-size: 0.7rem; font-weight: 800;
            text-shadow: 1px 1px 2px #000;
        }
        .bar-bg {
            flex: 1; height: 14px; background: #222; border: 1px solid #444;
            border-radius: 4px; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; border-radius: 3px; position: relative; }
        .bar-fill::after { content:""; position:absolute; top:0; left:0; width:100%; height:50%; background:rgba(255,255,255,0.15); }

        .hp-fill { background: linear-gradient(90deg, #c62828, #ff5252); }
        .mp-fill { background: linear-gradient(90deg, #1565c0, #448aff); }
        .exp-fill { background: linear-gradient(90deg, #4a148c, #6a1b9a); }

        .bar-text {
            position: absolute; right: 8px; top: 0; height: 100%;
            display: flex; align-items: center; font-size: 0.65rem;
            color: #fff; text-shadow: 1px 1px 2px #000; font-weight: bold; z-index: 2;
        }

        .btn-group { display: flex; gap: 10px; align-items: center; }
        .menu-icon {
            width: 42px; height: 42px; cursor: pointer; transition: all 0.2s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .menu-icon:hover {
            transform: scale(1.1) translateY(-2px);
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
        }
        .menu-icon:active { transform: scale(0.95); }

        .canvas-wrapper { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        canvas { image-rendering: pixelated; transition: width 0.1s, height 0.1s; }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(12, 12, 14, 0.98); border: 1px solid #444; display: none; flex-direction: column;
            z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-radius: 4px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #2a2a2a; }
        .modal-header h2 { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.2rem; margin: 0; letter-spacing: 2px; }
        .close-btn { background: none; border: none; color: #555; font-family: var(--font-body); cursor: pointer; font-size: 1.2rem; transition: color 0.2s; }
        .close-btn:hover { color: #fff; }

        .modal-body { padding: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* Inventory Modal Bag Theme */
        #inventory-modal {
            width: 920px; height: 620px;
            background: var(--bag-bg);
            border: 3px solid var(--bag-border);
            box-shadow: 0 0 30px rgba(0,0,0,0.7), inset 0 0 50px rgba(0,0,0,0.3);
        }
        #inventory-modal .modal-header { border-bottom: 2px solid var(--bag-border); background: rgba(0,0,0,0.2); }
        #inventory-modal .modal-body { background: var(--bag-panel); overflow-y: auto; }
        #inventory-modal .modal-body::-webkit-scrollbar { width: 8px; }
        #inventory-modal .modal-body::-webkit-scrollbar-thumb { background: var(--bag-border); border-radius: 4px; }

        #shop-modal { width: 920px; height: 620px; }
        #shop-list-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        #shop-list-container::-webkit-scrollbar { width: 8px; }
        #shop-list-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        #quest-modal { width: 500px; height: 550px; }
        #quest-modal .modal-body { overflow-y: auto; }
        #quest-modal .modal-body::-webkit-scrollbar { width: 6px; }
        #quest-modal .modal-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        #advancement-modal { width: 600px; height: 500px; }

        /* Custom Confirm Modal */
        #confirm-modal { width: 400px; height: auto; min-height: 200px; z-index: 200; }
        .confirm-text { color: #eee; text-align: center; font-size: 1.1rem; margin-bottom: 25px; line-height: 1.6; }
        .confirm-btns { display: flex; gap: 15px; justify-content: center; }
        .btn-yes { background: var(--accent-gold); color: #000; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-no { background: #444; color: #fff; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-yes:hover { background: #fff; }
        .btn-no:hover { background: #666; }

        /* GameOver Modal */
        #gameover-modal { width: 520px; height: auto; z-index: 1000; border: 2px solid var(--accent-red); }
        .gameover-title { font-family: var(--font-head); font-size: 2.5rem; color: var(--accent-red); text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .gameover-stats { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .go-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.1rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .go-label { display: flex; align-items: center; gap: 8px; }
        .go-val { color: var(--accent-gold); font-weight: bold; }
        .go-score { font-size: 2rem; color: #fff; text-align: center; margin-top: 15px; border-top: 2px solid #444; padding-top: 15px; font-family: var(--font-head); letter-spacing: 2px; }

        .inv-container { display: flex; gap: 20px; height: auto; min-height: 100%; }
        .inv-status-side {
            flex: 0 0 220px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            padding: 15px; border-radius: 4px; display: flex; flex-direction: column; height: fit-content;
        }
        .inv-grid-side { flex: 1; padding-right: 5px; }

        .inv-header-gold {
            color: var(--accent-gold); font-family: var(--font-body); font-weight: 600; font-size: 0.9rem; margin-right: 15px;
        }

        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }

        .item-card {
            background: var(--bag-item); border: 1px solid var(--bag-border); border-radius: 4px; padding: 10px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 140px; position: relative; cursor: pointer; transition: 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            min-width: 0;
        }
        .item-card:hover { border-color: #fff; background: #6d4c41; }
        .item-card.equipped { border-color: var(--accent-gold); background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

        .item-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px #000;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.25;
            min-height: 2.5em;
            word-break: keep-all;
        }
        .item-desc { font-size: 0.7rem; color: #d7ccc8; line-height: 1.4; }
        .item-price { font-size: 0.65rem; color: #bcaaa4; margin-top: 5px; font-family: var(--font-body); }
        .item-type { font-size: 0.6rem; margin-top: 8px; color: #a1887f; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }

        .sell-btn {
            position: absolute; bottom: 8px; right: 8px;
            padding: 4px 8px; background: #d32f2f; color: #fff; border: 1px solid #b71c1c; border-radius: 3px;
            font-size: 0.7rem; font-family: var(--font-body); cursor: pointer; transition: 0.2s;
            font-weight: bold; z-index: 5;
        }
        .sell-btn:hover { background: #f44336; transform: scale(1.1); }

        .side-stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--bag-border); padding: 6px 0; font-size: 0.8rem; }
        .side-stat-name { color: #bcaaa4; font-weight: 600; }
        .side-stat-val { color: #fff; font-family: var(--font-body); font-weight: 600; }
        .side-atk-val { color: #ff8a80; font-weight: bold; font-size: 1rem; }
        .side-bonus { color: #81c784; font-size: 0.75rem; margin-left: 4px; }

        /* Stat Colors */
        .stat-normal { color: #fff; }
        .stat-20 { color: #4caf50; text-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
        .stat-30 { color: #2196f3; text-shadow: 0 0 8px rgba(33, 150, 243, 0.6); }
        .stat-40 { color: #ff9800; text-shadow: 0 0 10px rgba(255, 152, 0, 0.7); }
        .stat-50 { color: #e91e63; text-shadow: 0 0 12px rgba(233, 30, 99, 0.8); }

        .shop-gold { text-align: center; color: var(--accent-gold); font-family: var(--font-body); font-size: 1.2rem; margin-bottom: 15px; padding: 10px; border: 1px solid #333; background: #111; }
        .enhance-btn {
            margin-top: 8px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .enhance-btn:hover { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }
        .enhance-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #111; color: #555; }

        .quest-item { background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .quest-title { color: var(--accent-gold); font-weight: bold; margin-bottom: 5px; }
        .quest-progress { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .quest-reward { font-size: 0.8rem; color: #4caf50; }
        .quest-claim-btn {
            margin-top: 10px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .quest-claim-btn:hover:not(:disabled) { background: var(--accent-gold); color: #000; }
        .quest-claim-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .adv-grid { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .adv-card {
            flex: 1; background: #111; border: 2px solid #333; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .adv-card:hover { border-color: var(--accent-gold); background: #1a1a1a; transform: translateY(-5px); }
        .adv-card img { width: 120px; height: 120px; object-fit: cover; border: 1px solid #444; margin-bottom: 15px; }
        .adv-name { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.3rem; margin-bottom: 10px; }
        .adv-desc { font-size: 0.75rem; color: #aaa; line-height: 1.5; margin-bottom: 15px; }
        .adv-bonus { font-size: 0.8rem; color: #4caf50; font-weight: bold; }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-text { font-family: var(--font-body); color: #fff; letter-spacing: 3px; font-size: 1rem; margin-top: 20px; }
        .spinner { width: 30px; height: 30px; border: 2px solid #333; border-top: 2px solid var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #enhance-effect {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-body); font-size: 2.5rem; font-weight: 700;
            color: #fff; text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #e65100;
            pointer-events: none; opacity: 0; z-index: 200; text-align: center;
            letter-spacing: 2px; width: 100%;
        }
        .enhance-anim { animation: enhanceSuccess 2s ease-out forwards; }
        @keyframes enhanceSuccess {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        #event-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 300; display: none; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        #event-img { width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 0 20px var(--accent-gold)); animation: bounce 1s infinite alternate; }
        #event-text {
            margin-top: 20px; font-family: var(--font-body); font-size: 1.8rem; color: #fff;
            text-shadow: 0 0 10px #000, 0 0 20px var(--accent-gold); text-align: center;
        }
        #event-reward {
            margin-top: 10px; font-family: var(--font-body); font-size: 1.2rem; color: #4caf50;
            font-weight: bold; text-shadow: 1px 1px 2px #000;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
        .event-anim { animation: eventFade 3s forwards; }
        @keyframes eventFade {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        /* Trait System Styles */
        .inv-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn {
            padding: 8px 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            color: #aaa; cursor: pointer; font-family: var(--font-body); font-size: 0.8rem;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active { background: var(--bag-panel); color: var(--accent-gold); border-bottom: none; font-weight: bold; }

        .trait-container { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .trait-point-display {
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; border: 1px solid var(--bag-border);
            text-align: center; color: var(--accent-gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;
        }
        .trait-item {
            background: rgba(255,255,255,0.05); border: 1px solid var(--bag-border); border-radius: 4px;
            padding: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .trait-info { flex: 1; }
        .trait-name { color: #fff; font-weight: bold; font-size: 0.95rem; margin-bottom: 4px; }
        .trait-desc { color: #aaa; font-size: 0.75rem; }
        .trait-level { color: var(--accent-gold); font-size: 0.85rem; font-weight: bold; margin-right: 15px; }
        .trait-up-btn {
            padding: 5px 12px; background: var(--accent-gold); color: #000; border: none;
            border-radius: 3px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .trait-up-btn:hover:not(:disabled) { background: #fff; }
        .trait-up-btn:disabled { background: #444; color: #777; cursor: not-allowed; }

        .rarity-common { color: var(--rarity-common) !important; }
        .rarity-rare { color: var(--rarity-rare) !important; text-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
        .rarity-epic { color: var(--rarity-epic) !important; text-shadow: 0 0 8px rgba(163, 53, 238, 0.6); }
        .rarity-legendary { color: var(--rarity-legendary) !important; text-shadow: 0 0 10px rgba(255, 128, 0, 0.7); }

        /* Weather Effects */
        #weather-ui {
            position: absolute; top: 90px; right: 20px;
            background: rgba(0,0,0,0.7); border: 1px solid #444; padding: 5px 20px;
            border-radius: 30px; display: flex; align-items: center; gap: 15px;
            font-family: var(--font-body); font-size: 0.85rem; color: #fff; z-index: 15;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .weather-icon { font-size: 1.2rem; }

        #weather-overlay {
            position: absolute; top: 80px; left: 0; width: 100%; height: calc(100% - 80px);
            pointer-events: none; z-index: 10; overflow: hidden;
        }
        .rain-drop {
            position: absolute; background: rgba(255,255,255,0.4); width: 1px; height: 15px;
            animation: rainFall 0.8s linear infinite;
        }
        @keyframes rainFall { to { transform: translateY(1000px); } }

        .fog-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); filter: blur(30px);
            animation: fogMove 10s linear infinite alternate;
        }
        @keyframes fogMove { from { transform: translateX(-50px); } to { transform: translateX(50px); } }

        .thunder-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.3); opacity: 0; z-index: 11;
        }
        .thunder-anim { animation: thunderFlash 0.2s ease-out; }
        @keyframes thunderFlash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* Boss Warning Popup */
        #boss-warning {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.9); border: 2px solid var(--accent-gold);
            color: #fff; padding: 15px 30px; border-radius: 8px; font-family: var(--font-body);
            font-size: 1.5rem; font-weight: bold; z-index: 1000; display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); animation: warningPulse 1s infinite alternate;
            text-align: center; pointer-events: none;
        }
        @keyframes warningPulse { from { opacity: 0.8; transform: translateX(-50%) scale(1); } to { opacity: 1; transform: translateX(-50%) scale(1.05); } }

        /* Mobile Controls */
        #mobile-controls {
            margin-top: 20px;
            z-index: 9999;
            display: none; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px;
            pointer-events: auto;
        }
        .d-pad-btn {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 2rem; user-select: none; cursor: pointer;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            touch-action: manipulation;
        }
        .d-pad-btn:active { background: rgba(255, 215, 0, 0.3); border-color: var(--accent-gold); color: var(--accent-gold); }

        .item-icon-small { width: 32px; height: 32px; border: 1px solid var(--bag-border); border-radius: 4px; margin-right: 10px; object-fit: cover; }
        .item-header { display: flex; align-items: center; margin-bottom: 5px; }

        /* Button Style */
        .btn {
            padding: 12px 20px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 1rem; cursor: pointer; transition: 0.2s;
            border-radius: 4px; font-weight: bold;
        }
        .btn:hover { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }

        /* Size Control UI */
        #size-control-overlay {
            position: absolute; top: 160px; right: 20px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--accent-gold);
            padding: 15px; border-radius: 8px; display: none; flex-direction: column;
            gap: 12px; z-index: 1000; align-items: center; width: 120px;
        }
        .size-btn {
            width: 100%; height: 40px; background: #333; border: 1px solid #555;
            color: #fff; font-size: 0.9rem; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; border-radius: 4px;
            font-family: var(--font-body);
        }
        .size-btn:hover { background: var(--accent-gold); color: #000; }
        .size-btn:active { transform: scale(0.95); }
        .size-label { font-size: 0.8rem; color: var(--accent-gold); font-family: var(--font-body); font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="loading-overlay"><div class="spinner"></div><div class="loading-text">연결 중...</div></div>
    <div id="enhance-effect">강화 성공!</div>
    <div id="boss-warning">⚠️ 경고: 초강력 보스가 필드에 출현했습니다!</div>

    <div id="weather-ui">
        <span class="weather-icon" id="weather-icon">☀️</span>
        <span id="weather-text">맑음</span>
        <div class="btn-group">
            <img src="image/menu_5.png" class="menu-icon" onclick="toggleSizeControl()" alt="화면 조절" title="화면 조절">
            <img src="image/menu_1.png" class="menu-icon" onclick="openQuest()" alt="퀘스트" title="퀘스트">
            <img src="image/menu_2.png" class="menu-icon" onclick="openInventory()" alt="가방" title="가방">
            <img src="image/menu_3.png" class="menu-icon" onclick="openShop()" alt="강화" title="강화">
            <img src="image/menu_4.png" class="menu-icon" onclick="askManualSave()" alt="저장" title="저장">
        </div>
    </div>
    <div id="weather-overlay"></div>
    <div id="thunder-flash" class="thunder-flash"></div>

    <div id="event-overlay">
        <img id="event-img" src="image/bm.jpg" alt="Event">
        <div id="event-text">보물 발견!</div>
        <div id="event-reward"></div>
    </div>

    <div id="size-control-overlay">
        <div class="size-label">화면 크기 조절</div>
        <div class="size-btn" id="size-up-btn">확대 (▲)</div>
        <div class="size-btn" id="size-down-btn">축소 (▼)</div>
        <div class="size-btn" id="size-full-btn">전체 화면</div>
        <div class="size-btn" id="size-reset-btn">기본 크기</div>
        <div class="size-btn" id="size-close-btn" style="background:#8b0000; margin-top:5px;">닫기</div>
    </div>

    <div id="inventory-modal" class="modal">
        <div class="modal-header">
            <div style="display:flex; align-items:center;">
                <h2>가방 및 상태</h2>
            </div>
            <div style="display:flex; align-items:center;">
                <span id="inv-gold-display" class="inv-header-gold">0 G</span>
                <button class="close-btn" onclick="toggleModal('inventory-modal')">×</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="inv-tabs">
                <button id="tab-inv" class="tab-btn active" onclick="switchTab('inv')">아이템</button>
                <button id="tab-traits" class="tab-btn" onclick="switchTab('traits')">특성 (Traits)</button>
            </div>
            <div class="inv-container">
                <div class="inv-status-side" id="inv-status-panel"></div>
                <div class="inv-grid-side">
                    <div id="inv-list" class="inv-grid"></div>
                    <div id="trait-list" class="trait-container" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-header"><h2>대장간</h2><button class="close-btn" onclick="toggleModal('shop-modal')">×</button></div>
        <div class="modal-body">
            <div class="shop-gold" id="shop-gold-display">0 G</div>
            <p style="color:#666; font-size:0.75rem; text-align:center; margin-bottom:15px;">
                강화할 장비를 선택하세요. (최대 +20)
            </p>
            <div id="shop-list-container">
                <div id="shop-list" class="inv-grid"></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-header"><h2 id="confirm-title">확인</h2><button class="close-btn" onclick="closeConfirm()">×</button></div>
        <div class="modal-body">
            <div id="confirm-msg" class="confirm-text"></div>
            <div class="confirm-btns">
                <button id="confirm-yes-btn" class="btn-yes" onclick="executeConfirm()">확인</button>
                <button id="confirm-no-btn" class="btn-no" onclick="closeConfirm()">취소</button>
            </div>
        </div>
    </div>

    <div id="quest-modal" class="modal">
        <div class="modal-header"><h2>퀘스트</h2><button class="close-btn" onclick="toggleModal('quest-modal')">×</button></div>
        <div class="modal-body" id="quest-list"></div>
    </div>

    <div id="advancement-modal" class="modal">
        <div class="modal-header"><h2>전직</h2></div>
        <div class="modal-body">
            <p style="text-align:center; color:#aaa; font-size:0.9rem;">레벨 5에 도달했습니다! 새로운 길을 선택하세요.</p>
            <div id="adv-list" class="adv-grid"></div>
        </div>
    </div>

    <div id="gameover-modal" class="modal">
        <div class="modal-header"><h2 style="color:var(--accent-red)">GAME OVER</h2></div>
        <div class="modal-body">
            <div class="gameover-title">던전 붕괴</div>
            <div id="go-stats-container" class="gameover-stats">
                <!-- 상세 점수 내역이 여기에 들어갑니다 -->
            </div>
            <div class="go-score">최종 점수: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            <button class="btn btn-start" style="width:100%; margin-top: 20px;" onclick="location.href='index.html'">메인 화면으로</button>
        </div>
    </div>

    <div class="game-ui-top">
        <div style="display:flex; align-items:center;">
            <div id="game-timer">15:00</div>
            <div class="char-info">
                <h2 id="ui-info">영웅</h2>
                <span id="ui-level">LV. 1</span>
            </div>
        </div>

        <div class="ui-bars-center">
            <div class="bar-row"><span class="bar-label">HP</span><div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill"></div><span id="ui-hp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">MP</span><div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-fill"></div><span id="ui-mp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">EXP</span><div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill"></div><span id="ui-exp-text" class="bar-text"></span></div></div>
        </div>

        <div style="display:flex; align-items:center;">
            <!-- 버튼 그룹이 날씨 UI로 이동됨 -->
        </div>
    </div>
    <div class="canvas-wrapper"><canvas id="gameCanvas" width="960" height="640"></canvas></div>
</div>

<div id="mobile-controls">
    <div class="d-pad-btn" id="btn-up" style="grid-column: 2; grid-row: 1;">▲</div>
    <div class="d-pad-btn" id="btn-left" style="grid-column: 1; grid-row: 2;">◀</div>
    <div class="d-pad-btn" id="btn-right" style="grid-column: 3; grid-row: 2;">▶</div>
    <div class="d-pad-btn" id="btn-down" style="grid-column: 2; grid-row: 3;">▼</div>
</div>

<script>
    const DB_URL = "https://script.google.com/macros/s/AKfycbzXcsngw4319YoBVGTmtuoXnpC66ZGlBQm5F2Hxw17n1_EEMazrftUD6gYsMYzQTV0YAg/exec";
    const CHAR_FILES = {
        '전사': 'image/warrior.jpg', '도적': 'image/rogue.jpg', '마법사': 'image/mage.jpg', '엘프 궁수': 'image/archer.jpg',
        '버서커': 'image/warrior1.jpg', '가디언': 'image/warrior1.jpg',
        '어쌔신': 'image/rogue1.jpg', '섀도우': 'image/rogue1.jpg',
        '아크메이지': 'image/mage1.jpg', '소서러': 'image/mage1.jpg',
        '스나이퍼': 'image/archer1.jpg', '레인저': 'image/archer1.jpg'
    };

    const MAP_SETS = [
        { day: 'image/map.jpg', night: 'image/map1.jpg' },
        { day: 'image/map2.jpg', night: 'image/map3.jpg' },
        { day: 'image/map4.jpg', night: 'image/map5.jpg' },
        { day: 'image/map6.jpg', night: 'image/map7.jpg' }
    ];

    const DROP_TABLE = {
        '전사': ['기사의 검', '대검', '용사의 검', '심판의 도끼'],
        '도적': ['암살자의 단도', '쌍검', '그림자 비수'],
        '마법사': ['마법 지팡이', '오브', '현자의 스태프'],
        '엘프 궁수': ['연습용 목궁', '컴포지트 보우', '윈드런너'],
        '버서커': ['광전사의 도끼', '피의 검'],
        '가디언': ['수호자의 방패검', '성기사의 망치'],
        '어쌔신': ['죽음의 인도자', '그림자 송곳니'],
        '섀도우': ['공포의 비수', '심연의 칼날'],
        '아크메이지': ['대마법사의 지팡이', '별의 조각'],
        '소서러': ['원소의 근원', '마나의 눈'],
        '스나이퍼': ['저격수의 활', '정령의 활'],
        '레인저': ['폭풍의 활', '자연의 활']
    };

    const LEGENDARY_SPECIAL_OPTIONS = [
        { name: "피의 갈증", desc: "공격 시 10% 확률로 피해량의 20% HP 흡수", key: "l_vamp", val: 20 },
        { name: "마나의 샘", desc: "공격 시 10% 확률로 최대 MP의 10% 회복", key: "l_mana", val: 10 },
        { name: "가벼운 발걸음", desc: "회피율 +10%", key: "l_eva", val: 10 },
        { name: "강철 피부", desc: "받는 피해량 -10%", key: "l_def", val: 10 },
        { name: "약점 간파", desc: "치명타 피해량 +25%", key: "l_crit_dmg", val: 25 },
        { name: "골드 러시", desc: "골드 획득량 +30%", key: "l_gold", val: 30 },
        { name: "성장의 가속", desc: "경험치 획득량 +20%", key: "l_exp", val: 20 },
        { name: "굳건한 의지", desc: "상태이상 저항 +30%", key: "l_resist", val: 30 },
        { name: "분노 조절", desc: "분노 획득량 +20%", key: "l_rage", val: 20 },
        { name: "재빠른 손놀림", desc: "아이템 획득 시 5% 확률로 2배 획득", key: "l_double_drop", val: 5 }
    ];

    let player = null;
    let playerImg = new Image();
    let mapImg = new Image();
    let mapSetIndex = 0;
    let boss = { x: 100, y: 100, speed: 2.2, img: new Image(), alive: true, isNightBoss: false, hp: 100, maxHp: 100 };
    let superBoss = { x: 500, y: 500, speed: 3.5, img: new Image(), alive: false, hp: 1500, maxHp: 1500, name: "초강력 보스" };
    superBoss.img.src = 'image/best_boss.jpg';

    const GAME_TIME_LIMIT = 15 * 60 * 1000;

    let isNight = false;
    let timeTick = 0;
    let currentWeather = "sunny"; // sunny, rain, fog, thunder

    // Size Control Variables
    let currentScale = parseFloat(localStorage.getItem('rpg_map_scale') || 1.0);
    const MIN_SCALE = 1.0;
    const MAX_SCALE = 3.0;
    const SCALE_STEP = 0.1;
    let isSizeControlling = false;
    let pauseStartTime = 0;

    let gameLoopInterval = null;
    let isGameOver = false;

    const advBgm = new Audio('song/bgm1.mp3');

    // Randomly select a song from song_1 to song_4
    const songList = ['song/song_1.mp3', 'song/song_2.mp3', 'song/song_3.mp3', 'song/song_4.mp3'];
    const randomSong = songList[Math.floor(Math.random() * songList.length)];
    const fieldBgm = new Audio(randomSong);

    const angelBgm = new Audio('song/angels.mp3');
    const successSfx = new Audio('song/blackout_piano1.mp3');
    const failSfx = new Audio('song/blackout_piano2.mp3');
    const thunderSfx = new Audio('song/thunder.mp3');
    const potionSfx = new Audio('song/potion-inght.wav');
    const goldSfx = new Audio('song/gold_drop-inght.wav');
    const rainThunderSfx = new Audio('song/thunder1-inght.wav');
    const rainRuinSfx = new Audio('song/ruin-inght.wav');
    const equipSfx = new Audio('image/eqp.mp3');
    const coinSfx = new Audio('song/money_box.mp3');
    const coinImgDay = new Image(); coinImgDay.src = 'image/coin_gold.jpg';
    const coinImgNight = new Image(); coinImgNight.src = 'image/coin_gold_night.jpg';
    let coins = [];
    let floatingTexts = [];

    fieldBgm.loop = true;
    fieldBgm.volume = 0.15;

    let fieldItems = [];
    const potionImg = new Image(); potionImg.src = 'image/potion_hp.jpg';
    const shoesImg = new Image(); shoesImg.src = 'image/shoes.jpg';
    const atkImg = new Image(); atkImg.src = 'image/attack_10.jpg';
    const defImg = new Image(); defImg.src = 'image/Defense_10.jpg';

    let treasureBoxes = [];
    const treasureBoxImg = new Image(); treasureBoxImg.src = 'image/bm.jpg';

    let currentConfirmAction = null;

    window.onload = async function() {
        const name = localStorage.getItem('rpg_player_name');
        const temp = localStorage.getItem('rpg_temp_player');
        if (temp) { player = JSON.parse(temp); initData(); initMap(); }
        else if (name) {
            try {
                document.querySelector('.loading-text').innerText = "데이터 불러오는 중...";
                document.getElementById('loading-overlay').style.display = 'flex';
                const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                player = await res.json(); initData(); initMap();
            } catch(e) { location.href='index.html'; }
        } else { location.href='index.html'; }
    };

    function initData() {
        if (!player.name) player.name = localStorage.getItem('rpg_player_name');
        if (!player.inventory) player.inventory = [];
        if (!player.bonusAtk) player.bonusAtk = 0;
        if (player.bonusDef === undefined) player.bonusDef = 0;
        if (player.moveSpeed === undefined) player.moveSpeed = 12;
        if (player.gold === undefined) player.gold = 0;
        if (player.coinScore === undefined) player.coinScore = 0;
        if (player.traitPoints === undefined) player.traitPoints = 0;
        if (!player.traits) player.traits = { str: 0, dex: 0, con: 0, int: 0, wis: 0 };
        if (!player.quests) player.quests = {
            killCount: 0,
            dayKillCount: 0,
            nightKillCount: 0,
            bossKillCount: 0,
            enhanceCount: 0,
            claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
        };

        if (player.quests.dayKillCount === undefined) player.quests.dayKillCount = 0;
        if (player.quests.nightKillCount === undefined) player.quests.nightKillCount = 0;
        if (player.quests.bossKillCount === undefined) player.quests.bossKillCount = 0;
        if (player.quests.coinCollectCount === undefined) player.quests.coinCollectCount = 0;
        if (!player.quests.claimed) player.quests.claimed = {};
        if (player.quests.claimed.dayKill === undefined) player.quests.claimed.dayKill = false;
        if (player.quests.claimed.nightKill === undefined) player.quests.claimed.nightKill = false;
        if (player.quests.claimed.bossKill === undefined) player.quests.claimed.bossKill = false;
        if (player.quests.claimed.coinCollect === undefined) player.quests.claimed.coinCollect = false;

        if (player.isAdvanced === undefined) player.isAdvanced = false;

        // Boundary check on load - Moved to after applyScale to handle scaled coordinates correctly
        if (player.x === undefined) player.x = 480;
        if (player.y === undefined) player.y = 320;

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        isNight = elapsed >= 90000;
        localStorage.setItem('rpg_is_night', isNight);

        currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

        if (localStorage.getItem('rpg_open_traits') === 'true') {
            localStorage.removeItem('rpg_open_traits');
            setTimeout(() => { openInventory(); switchTab('traits'); }, 500);
        }

        let savedMapIndex = localStorage.getItem('rpg_map_set_index');
        if (savedMapIndex === null) {
            mapSetIndex = Math.floor(Math.random() * MAP_SETS.length);
            localStorage.setItem('rpg_map_set_index', mapSetIndex);
        } else {
            mapSetIndex = parseInt(savedMapIndex);
        }
    }

    function getPlayerImage(job, inventory) {
        const equippedWeapon = inventory.find(i => i.type === 'weapon' && i.equipped);
        const isLegendary = equippedWeapon && equippedWeapon.rarity === 'legendary';

        if (isLegendary) {
            if (job === '전사' || job === '버서커' || job === '가디언') return 'image/warrior4.jpg';
            if (job === '도적' || job === '어쌔신' || job === '섀도우') return 'image/rogue4.jpg';
            if (job === '마법사' || job === '아크메이지' || job === '소서러') return 'image/mage4.jpg';
            if (job === '엘프 궁수' || job === '스나이퍼' || job === '레인저') return 'image/archer4.jpg';
        }
        return CHAR_FILES[job] || CHAR_FILES['전사'];
    }

    function initMap() {
        playerImg.src = getPlayerImage(player.job, player.inventory);
        const currentSet = MAP_SETS[mapSetIndex];
        mapImg.src = isNight ? currentSet.night : currentSet.day;

        applyScale();

        // Boundary check after scale is applied
        const canvas = document.getElementById('gameCanvas');
        if (player.x < 16 || player.x > canvas.width - 16) player.x = canvas.width / 2;
        if (player.y < 16 || player.y > canvas.height - 16) player.y = canvas.height / 2;

        mapImg.onload = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            fieldBgm.play().catch(e => console.log("BGM play failed:", e));

            const deathTime = localStorage.getItem('rpg_boss_death_time');
            const savedX = localStorage.getItem('rpg_boss_x');
            if (localStorage.getItem('rpg_boss_ran_away') === 'true') {
                localStorage.removeItem('rpg_boss_ran_away');
                boss.alive = false;
                setTimeout(spawnBossDefault, 10000);
            } else if (savedX) { // Check saved position first to avoid reset after normal mob battle
                boss.x = parseFloat(savedX); boss.y = parseFloat(localStorage.getItem('rpg_boss_y')); boss.alive = true;
                boss.hp = parseFloat(localStorage.getItem('rpg_boss_hp') || 400 + (player.level * 30));
                boss.maxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 400 + (player.level * 30));
            } else if (deathTime) {
                const diff = Date.now() - parseInt(deathTime);
                if (diff < 10000) { boss.alive = false; setTimeout(spawnBossDefault, 10000 - diff); }
                else { localStorage.removeItem('rpg_boss_death_time'); spawnBossDefault(); }
            } else {
                boss.alive = false; setTimeout(spawnBossDefault, 15000);
            }
            gameLoopInterval = setInterval(gameLoop, 50);
            updateTimeEffect();
            updateWeatherUI();
            checkAdvancement();
            spawnFieldItem();
            spawnTreasureBox();
            spawnCoin();
        };
        updateUI();
        window.addEventListener('keydown', move);

        // Size Control Events
        document.getElementById('size-up-btn').onclick = () => changeScale(SCALE_STEP);
        document.getElementById('size-down-btn').onclick = () => changeScale(-SCALE_STEP);
        document.getElementById('size-reset-btn').onclick = () => {
            const oldScale = currentScale;
            currentScale = 1.0;
            localStorage.setItem('rpg_map_scale', 1.0);
            rescalePositions(oldScale, currentScale);
            applyScale();
        };
        document.getElementById('size-full-btn').onclick = () => {
            const oldScale = currentScale;
            const winW = window.innerWidth - 40;
            const winH = window.innerHeight - 120;
            const scaleW = winW / 960;
            const scaleH = winH / 640;
            currentScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, Math.min(scaleW, scaleH)));
            localStorage.setItem('rpg_map_scale', currentScale);
            rescalePositions(oldScale, currentScale);
            applyScale();
        };
        document.getElementById('size-close-btn').onclick = () => toggleSizeControl();
    }

    function toggleSizeControl() {
        const overlay = document.getElementById('size-control-overlay');
        isSizeControlling = (overlay.style.display !== 'flex');
        overlay.style.display = isSizeControlling ? 'flex' : 'none';

        if (isSizeControlling) {
            pauseStartTime = Date.now();
            fieldBgm.volume = 0.05;
        } else {
            const pauseDuration = Date.now() - pauseStartTime;
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            localStorage.setItem('rpg_start_time', startTime + pauseDuration);
            fieldBgm.volume = 0.15;
        }
    }

    function changeScale(delta) {
        const oldScale = currentScale;
        currentScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale + delta));
        localStorage.setItem('rpg_map_scale', currentScale);
        rescalePositions(oldScale, currentScale);
        applyScale();
    }

    function rescalePositions(oldScale, newScale) {
        const ratio = newScale / oldScale;

        // Rescale Player
        player.x *= ratio;
        player.y *= ratio;

        // Rescale Boss
        boss.x *= ratio;
        boss.y *= ratio;

        // Rescale Super Boss
        superBoss.x *= ratio;
        superBoss.y *= ratio;

        // Rescale Field Items
        fieldItems.forEach(item => {
            item.x *= ratio;
            item.y *= ratio;
        });

        // Rescale Treasure Boxes
        treasureBoxes.forEach(box => {
            box.x *= ratio;
            box.y *= ratio;
        });

        // Rescale Coins
        coins.forEach(coin => {
            coin.x *= ratio;
            coin.y *= ratio;
        });

        // Rescale Floating Texts
        floatingTexts.forEach(ft => {
            ft.x *= ratio;
            ft.y *= ratio;
        });
    }

    function applyScale() {
        const container = document.getElementById('game-container');
        const canvas = document.getElementById('gameCanvas');

        const baseWidth = 960;
        const baseHeight = 640;
        const uiHeight = 80;

        const newWidth = baseWidth * currentScale;
        const newHeight = baseHeight * currentScale;

        container.style.width = newWidth + 'px';
        container.style.height = (newHeight + uiHeight) + 'px';
        canvas.width = newWidth;
        canvas.height = newHeight;

        // Boundary check for player
        if (player.x > canvas.width - 16) player.x = canvas.width - 16;
        if (player.y > canvas.height - 16) player.y = canvas.height - 16;

        updateWeatherUI();
        draw(); // Redraw immediately to reflect changes
    }

    function spawnFieldItem() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnFieldItem, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (fieldItems.length < 6) {
            const rand = Math.random();
            let type = 'potion';
            if (rand < 0.05) type = 'shoes';

            fieldItems.push({ x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50, type: type });
        }
        setTimeout(spawnFieldItem, 8000);
    }

    function spawnTreasureBox() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnTreasureBox, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (treasureBoxes.length < 2) {
            treasureBoxes.push({ x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50 });
        }
        setTimeout(spawnTreasureBox, Math.random() * 30000 + 30000);
    }

    function spawnCoin() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnCoin, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (coins.length < 30) {
            const r = Math.random();
            let size, score;
            if (r < 0.7) { // Small (70%)
                size = 20;
                score = Math.floor(Math.random() * 41) + 10;
            } else if (r < 0.95) { // Medium (25%)
                size = 30;
                score = Math.floor(Math.random() * 51) + 50;
            } else { // Large (5%)
                size = 45;
                score = Math.floor(Math.random() * 301) + 200; // 200-500
            }
            coins.push({
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                size: size,
                score: score,
                creationTime: Date.now(),
                lifeTime: 10000 + Math.random() * 5000
            });
        }
        setTimeout(spawnCoin, Math.random() * 2000 + 1000);
    }

    function addFloatingText(x, y, text, color) {
        floatingTexts.push({
            x: x,
            y: y,
            text: text,
            color: color,
            startTime: Date.now(),
            lifeTime: 1500
        });
    }

    function checkAdvancement() { if (player.level >= 5 && !player.isAdvanced) openAdvancement(); }

    function openAdvancement() {
        const modal = document.getElementById('advancement-modal');
        const list = document.getElementById('adv-list');
        list.innerHTML = '';
        fieldBgm.pause();
        advBgm.loop = true; advBgm.play().catch(e => console.log(e));

        let options = [];
        if (player.job === '전사' || player.job === '기사') {
            options = [
                { job: '버서커', desc: '공격 특화. 스킬 대미지 대폭 상승.', bonus: '힘 +10, HP +50', img: 'image/warrior1.jpg' },
                { job: '가디언', desc: '생존 특화. 받는 피해 감소.', bonus: '체력 +15, HP +150', img: 'image/warrior1.jpg' }
            ];
        } else if (player.job === '도적') {
            options = [
                { job: '어쌔신', desc: '극딜 특화. 치명타 확률 및 스킬 횟수 증가.', bonus: '민첩 +12, 치명타 +15%', img: 'image/rogue1.jpg' },
                { job: '섀도우', desc: '유틸 특화. 독 부여 확률 100%.', bonus: '민첩 +8, 지혜 +8', img: 'image/rogue1.jpg' }
            ];
        } else if (player.job === '마법사') {
            options = [
                { job: '아크메이지', desc: '화력 특화. 스킬 대미지 대폭 상승.', bonus: '지능 +15, MP +100', img: 'image/mage1.jpg' },
                { job: '소서러', desc: '효율 특화. 스킬 마나 소모량 감소.', bonus: '지능 +10, 지혜 +10', img: 'image/mage1.jpg' }
            ];
        } else if (player.job === '엘프 궁수') {
            options = [
                { job: '스나이퍼', desc: '정확한 저격. 치명타 피해량 증가 및 단일 대상 극대화.', bonus: '민첩 +15, 치명타 피해량 +20%', img: 'image/archer1.jpg' },
                { job: '레인저', desc: '광역 제압. 다수 대상 공격 및 군중 제어 특화.', bonus: '민첩 +10, 지혜 +10', img: 'image/archer1.jpg' }
            ];
        }

        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'adv-card';
            div.innerHTML = `<img src="${opt.img}"><div class="adv-name">${opt.job}</div><div class="adv-desc">${opt.desc}</div><div class="adv-bonus">${opt.bonus}</div>`;
            div.onclick = () => askAdvancement(opt);
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }

    function askAdvancement(opt) {
        showConfirm("전직 확인", `${opt.job}(으)로 전직하시겠습니까? 취소할 수 없습니다.`, () => selectAdvancement(opt));
    }

    function selectAdvancement(opt) {
        player.job = opt.job; player.isAdvanced = true;
        if (opt.job === '버서커') { player.stats.str += 10; player.maxHp += 50; }
        else if (opt.job === '가디언') { player.stats.con += 15; player.maxHp += 150; }
        else if (opt.job === '어쌔신') { player.stats.dex += 12; }
        else if (opt.job === '섀도우') { player.stats.dex += 8; player.stats.wis += 8; }
        else if (opt.job === '아크메이지') { player.stats.int += 15; player.maxMp += 100; }
        else if (opt.job === '소서러') { player.stats.int += 10; player.stats.wis += 10; }
        else if (opt.job === '스나이퍼') { player.stats.dex += 15; /* 치명타 피해량은 전투 로직에서 처리 */ }
        else if (opt.job === '레인저') { player.stats.dex += 10; player.stats.wis += 10; }
        player.hp = player.maxHp; player.mp = player.maxMp;
        playerImg.src = getPlayerImage(player.job, player.inventory);
        advBgm.pause(); advBgm.currentTime = 0;

        angelBgm.play().catch(e => console.log(e));
        setTimeout(() => { fieldBgm.play(); }, 5000);

        document.getElementById('advancement-modal').style.display = 'none';
        showConfirm("전직 성공", `축하합니다! ${opt.job}(으)로 전직했습니다!`, null, true);
        updateUI();
    }

    function updateTimeEffect() {
        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const newIsNight = elapsed >= 90000;

        if (newIsNight !== isNight) {
            isNight = newIsNight;
            const currentSet = MAP_SETS[mapSetIndex];
            mapImg.src = isNight ? currentSet.night : currentSet.day;
            localStorage.setItem('rpg_is_night', isNight);

            const ns = isNight ? "_night" : "";
            potionImg.src = 'image/potion_hp' + ns + '.jpg';
            atkImg.src = 'image/attack_10' + ns + '.jpg';
            defImg.src = 'image/Defense_10' + ns + '.jpg';

            changeWeather();
        }

        if (isNight) {
            if (Math.random() < 0.4) {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            } else {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            }
        } else {
            boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
        }

        if (Math.floor(elapsed / 30000) > timeTick) {
            timeTick = Math.floor(elapsed / 30000);
            changeWeather();
        }
    }

    function changeWeather() {
        const weathers = ["sunny", "rain", "fog", "thunder"];
        const rand = Math.random();
        if (rand < 0.5) currentWeather = "sunny";
        else if (rand < 0.7) currentWeather = "rain";
        else if (rand < 0.85) currentWeather = "fog";
        else currentWeather = "thunder";

        localStorage.setItem('rpg_current_weather', currentWeather);
        updateWeatherUI();
    }

    function updateWeatherUI() {
        const icon = document.getElementById('weather-icon');
        const text = document.getElementById('weather-text');
        const overlay = document.getElementById('weather-overlay');
        const canvas = document.getElementById('gameCanvas');
        overlay.innerHTML = '';

        if (currentWeather === "sunny") { icon.innerText = "☀️"; text.innerText = "맑음"; }
        else if (currentWeather === "rain") {
            icon.innerText = "🌧️"; text.innerText = "비 (마법 강화 / 이동 저하)";
            for(let i=0; i<50; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * canvas.width + 'px';
                drop.style.animationDelay = Math.random() * 0.8 + 's';
                overlay.appendChild(drop);
            }
            // Play rain weather sounds
            rainThunderSfx.play().catch(e => {});
            rainThunderSfx.onended = () => { rainRuinSfx.play().catch(e => {}); };
        }
        else if (currentWeather === "fog") {
            icon.innerText = "🌫️";
            // 엘프 궁수일 경우 명중률 페널티를 무시하므로 텍스트도 변경
            if (player && player.job === '엘프 궁수') {
                text.innerText = "안개 (조우율 상승 / 명중 페널티 없음)";
            } else {
                text.innerText = "안개 (조우율 상승 / 명중 변화)";
            }
            const fog = document.createElement('div');
            fog.className = 'fog-layer';
            overlay.appendChild(fog);
        }
        else if (currentWeather === "thunder") {
            icon.innerText = "⚡"; text.innerText = "뇌우 (낙뢰 주의)";
        }
    }

    function spawnBossDefault() {
        const canvas = document.getElementById('gameCanvas');
        boss.x = player.x > canvas.width / 2 ? 100 : canvas.width - 100; boss.y = player.y > canvas.height / 2 ? 100 : canvas.height - 100; boss.alive = true;
        boss.maxHp = 400 + (player.level * 30);
        boss.hp = boss.maxHp;
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.removeItem('rpg_boss_death_time');
        localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp);
    }

    function spawnSuperBoss() {
        const canvas = document.getElementById('gameCanvas');
        superBoss.alive = true;
        superBoss.x = canvas.width / 2; superBoss.y = canvas.height / 2;
        superBoss.hp = 1500;
        superBoss.maxHp = 1500;

        const warning = document.getElementById('boss-warning');
        warning.style.display = 'block';
        setTimeout(() => { warning.style.display = 'none'; }, 5000);
    }

    function gameLoop() {
        if(!player) return;
        if(isGameOver) return;
        if(isSizeControlling) {
            draw(); // Keep drawing even when paused to show scale changes
            return;
        }

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const remain = GAME_TIME_LIMIT - elapsed;

        if (remain <= 0) {
            document.getElementById('game-timer').innerText = "00:00";
            isGameOver = true;
            clearInterval(gameLoopInterval);
            showGameOver("시간 종료! 던전이 붕괴되었습니다.");
            return;
        }

        if(document.querySelector('.modal[style*="flex"]')) return;

        const m = Math.floor(remain / 60000);
        const s = Math.floor((remain % 60000) / 1000);
        document.getElementById('game-timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

        updateTimeEffect();

        if (currentWeather === "thunder" && Math.random() < 0.01) {
            triggerThunder();
        }

        // 최종 보스 3분 남았을 때 출현 (기존 5분에서 수정)
        if (remain <= 3 * 60 * 1000 && !superBoss.alive && !localStorage.getItem('rpg_super_boss_killed')) {
            spawnSuperBoss();
        }

        if (boss.alive) {
            const dx = player.x - boss.x; const dy = player.y - boss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { boss.x += (dx / dist) * boss.speed; boss.y += (dy / dist) * boss.speed; }
            if(dist < 30 * currentScale) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        if (superBoss.alive) {
            const dx = player.x - superBoss.x; const dy = player.y - superBoss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { superBoss.x += (dx / dist) * superBoss.speed; superBoss.y += (dy / dist) * superBoss.speed; }
            if(dist < 40 * currentScale) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_boss_hp', superBoss.hp);
                localStorage.setItem('rpg_boss_max_hp', superBoss.maxHp);
                localStorage.setItem('rpg_is_super_boss', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        fieldItems = fieldItems.filter(item => {
            const dx = player.x - item.x; const dy = player.y - item.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            if (dist < 25 * scale) {
                const ns = isNight ? "_night" : "";
                if (item.type === 'potion') {
                    const img = 'potion_hp' + ns + '.jpg';
                    player.inventory.push({name:'체력 물약', type:'potion_hp', desc:'HP +50 회복', val:50, img: img});
                } else if (item.type === 'shoes') {
                    player.moveSpeed += 2;
                    showConfirm("아이템 획득", "신속의 장화를 획득했습니다! 이동 속도가 영구적으로 증가합니다.", null, true);
                }
                return false;
            }
            return true;
        });

        treasureBoxes = treasureBoxes.filter(box => {
            const dx = player.x - box.x; const dy = player.y - box.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            if (dist < 30 * scale) {
                getTreasure();
                return false;
            }
            return true;
        });

        const now = Date.now();
        coins = coins.filter(coin => {
            if (now - coin.creationTime > coin.lifeTime) return false;
            const dx = player.x - coin.x; const dy = player.y - coin.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            if (dist < (coin.size/2 + 16) * scale) {
                player.coinScore += coin.score;
                player.quests.coinCollectCount++;
                const sfx = coinSfx.cloneNode();
                sfx.volume = 0.5;
                sfx.play().catch(e=>{});
                addFloatingText(player.x, player.y - 30 * scale, `+${coin.score}`, '#ffd700');
                return false;
            }
            return true;
        });

        floatingTexts = floatingTexts.filter(ft => now - ft.startTime < ft.lifeTime);

        draw();
    }

    function triggerThunder() {
        const flash = document.getElementById('thunder-flash');
        flash.classList.remove('thunder-anim');
        void flash.offsetWidth;
        flash.classList.add('thunder-anim');
        if (thunderSfx) thunderSfx.play().catch(e => {});

        const pDmg = Math.floor(player.maxHp * 0.05);
        player.hp -= pDmg;

        if (boss.alive) {
            const bDmg = Math.floor(boss.maxHp * 0.03);
            boss.hp -= bDmg;
            localStorage.setItem('rpg_boss_hp', boss.hp);
            if (boss.hp <= 0) {
                boss.alive = false;
                localStorage.setItem('rpg_boss_death_time', Date.now());
            }
        }

        if (player.hp <= 0) showGameOver("벼락에 맞았습니다...");
        updateUI();
    }

    async function showGameOver(msg) {
        if (gameLoopInterval) {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
        }
        isGameOver = true;

        if (!player.name) player.name = localStorage.getItem('rpg_player_name') || "Unknown";

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const survivalTime = Math.floor((Date.now() - startTime) / 1000);
        const min = Math.floor(survivalTime / 60);
        const sec = survivalTime % 60;

        const kills = player.quests.killCount || 0;
        const bossKills = player.quests.bossKillCount || 0;
        const normalKills = Math.max(0, kills - bossKills);

        let itemValue = 0;
        player.inventory.forEach(item => {
            if (item.type === 'weapon') {
                if (item.rarity === 'legendary') itemValue += 5000;
                else if (item.rarity === 'epic') itemValue += 2000;
            } else if (item.type.includes('potion') || item.type.includes('scroll')) {
                const rareItems = ['potion_full', 'potion_focus', 'potion_madness', 'potion_skeleton', 'potion_holy', 'potion_gamble', 'scroll_option'];
                if (rareItems.includes(item.type)) itemValue += 500;
            }
        });

        const lvScore = player.level * 1000;
        const bossScore = bossKills * 2000;
        const normalScore = normalKills * 10;
        const goldScore = Math.floor(player.gold * 0.1);
        const survivalScore = survivalTime;
        const coinScore = player.coinScore || 0;

        const totalScore = lvScore + bossScore + normalScore + goldScore + itemValue + survivalScore + coinScore;

        const statsContainer = document.getElementById('go-stats-container');
        statsContainer.innerHTML = `
            <div class="go-row"><div class="go-label">🔹 캐릭터 레벨</div><div class="go-val">${player.level} (LV) <span style="color:#888; font-size:0.8rem;">+${lvScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">💀 보스 처치</div><div class="go-val">${bossKills} (마리) <span style="color:#888; font-size:0.8rem;">+${bossScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">⚔️ 몬스터 사냥</div><div class="go-val">${normalKills} (마리) <span style="color:#888; font-size:0.8rem;">+${normalScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">💰 보유 자산</div><div class="go-val">${player.gold.toLocaleString()} (G) <span style="color:#888; font-size:0.8rem;">+${goldScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">💎 아이템 가치</div><div class="go-val"><span style="color:#888; font-size:0.8rem;">+${itemValue.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">🪙 코인 점수</div><div class="go-val">${coinScore.toLocaleString()} (점) <span style="color:#888; font-size:0.8rem;">+${coinScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">⏳ 생존 보너스</div><div class="go-val">${min}분 ${sec}초 <span style="color:#888; font-size:0.8rem;">+${survivalScore.toLocaleString()}</span></div></div>
        `;

        document.querySelector('.gameover-title').innerText = msg;
        document.getElementById('go-score-val').innerText = totalScore.toLocaleString();

        // Send Ranking Data
        try {
            await fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    type: 'ranking',
                    name: player.name,
                    score: totalScore,
                    job: player.job,
                    level: player.level,
                    bossKills: bossKills
                })
            });
        } catch (e) {
            console.error("Ranking update failed:", e);
        }

        localStorage.removeItem('rpg_temp_player');
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.removeItem('rpg_boss_death_time');

        document.getElementById('gameover-modal').style.display = 'flex';
    }

    function getTreasure() {
        const jobList = DROP_TABLE[player.job] || DROP_TABLE['전사'];
        const baseName = jobList[Math.floor(Math.random() * jobList.length)];

        const cha = player.stats.cha || 10;
        const chaBonus = (cha - 10) * 0.005; // 0.5% per CHA point above 10

        const rand = Math.random();
        let rarity = "common";
        let rarityColor = "#ffffff";
        let grade = Math.floor(Math.random() * 3) + 1;

        if (rand < 0.1 + chaBonus) { rarity = "legendary"; rarityColor = "#ff8000"; grade = Math.floor(Math.random() * 6) + 15; }
        else if (rand < 0.25 + chaBonus) { rarity = "epic"; rarityColor = "#a335ee"; grade = Math.floor(Math.random() * 5) + 10; }
        else if (rand < 0.5 + chaBonus) { rarity = "rare"; rarityColor = "#2196f3"; grade = Math.floor(Math.random() * 4) + 5; }

        // 전직 전에는 레전드리 드롭 불가
        if (!player.isAdvanced && rarity === "legendary") {
            rarity = "epic";
            rarityColor = "#a335ee";
            grade = Math.floor(Math.random() * 5) + 10;
        }

        const newItem = {
            name: `${rarity.toUpperCase()} ${baseName} (+${grade})`,
            type: 'weapon',
            desc: `공격력 +${grade} (${player.job} 전용)`,
            val: grade,
            reqJob: player.job,
            equipped: false,
            rarity: rarity,
            rarityColor: rarityColor,
            enhanceCount: grade,
            failCount: 0,
            options: []
        };

        if (rarity !== "common") {
            const optCount = rarity === "legendary" ? 3 : (rarity === "epic" ? 1 : 1);
            const possibleOpts = [
                { name: "힘", key: "str" },
                { name: "민첩", key: "dex" },
                { name: "체력", key: "con" },
                { name: "지능", key: "int" }
            ];
            for (let i = 0; i < optCount; i++) {
                const opt = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
                const val = Math.floor(Math.random() * 5) + 1; // 1~5
                newItem.options.push({ name: opt.name, key: opt.key, val: val });
                newItem.desc += `\n[옵션] ${opt.name} +${val}`;
            }
        }

        if (rarity === "legendary") {
             const specialOpt = LEGENDARY_SPECIAL_OPTIONS[Math.floor(Math.random() * LEGENDARY_SPECIAL_OPTIONS.length)];
             newItem.specialOption = specialOpt;
             newItem.desc += `\n<span style='color:#b2ff59; font-weight:bold;'>[특수] ${specialOpt.name}</span>\n<span style='color:#aaa; font-size:0.7rem;'>${specialOpt.desc}</span>`;
        }

        player.inventory.push(newItem);
        showTreasureEvent(newItem);
    }

    function showTreasureEvent(item) {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');

        text.innerText = "비밀 상자 발견!";
        rewardText.innerText = item.name;
        rewardText.style.color = item.rarityColor || '#fff';
        img.src = 'image/bm.jpg';

        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');

        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function saveBossPos() {
        if(boss.alive) { localStorage.setItem('rpg_boss_x', boss.x); localStorage.setItem('rpg_boss_y', boss.y); localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp); }
        if(superBoss.alive) { localStorage.setItem('rpg_super_boss_hp', superBoss.hp); localStorage.setItem('rpg_super_boss_max_hp', superBoss.maxHp); }
    }

    function updateUI() {
        document.getElementById('ui-info').innerText = player.name;
        document.getElementById('ui-level').innerText = `LV.${player.level} ${player.job.toUpperCase()}`;
        document.getElementById('ui-hp-bar').style.width = `${Math.min(100, (player.hp/player.maxHp)*100)}%`;
        document.getElementById('ui-mp-bar').style.width = `${Math.min(100, (player.mp/player.maxMp)*100)}%`;
        document.getElementById('ui-exp-bar').style.width = `${Math.min(100, (player.exp/player.maxExp)*100)}%`;
        document.getElementById('ui-hp-text').innerText = `${Math.ceil(player.hp)}/${Math.round(player.maxHp)}`;
        document.getElementById('ui-mp-text').innerText = `${Math.ceil(player.mp)}/${Math.round(player.maxMp)}`;
        document.getElementById('ui-exp-text').innerText = `${Math.floor(player.exp)}/${player.maxExp}`;
    }

    function draw() {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scale = currentScale;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);

        fieldItems.forEach(item => {
            let img = potionImg;
            if (item.type === 'shoes') img = shoesImg;
            else if (item.type === 'attack') img = atkImg;
            else if (item.type === 'defense') img = defImg;
            const size = 24 * scale;
            ctx.drawImage(img, item.x - size/2, item.y - size/2, size, size);
        });

        treasureBoxes.forEach(box => {
            const size = 30 * scale;
            ctx.drawImage(treasureBoxImg, box.x - size/2, box.y - size/2, size, size);
        });

        const cImg = isNight ? coinImgNight : coinImgDay;
        coins.forEach(coin => {
            const size = coin.size * scale;
            ctx.drawImage(cImg, coin.x - size/2, coin.y - size/2, size, size);
        });

        const pSize = 32 * scale;
        ctx.drawImage(playerImg, player.x - pSize/2, player.y - pSize/2, pSize, pSize);

        if(boss.alive) {
            const bSize = 50 * scale;
            ctx.drawImage(boss.img, boss.x - bSize/2, boss.y - bSize/2, bSize, bSize);
        }

        if(superBoss.alive) {
            const sbSize = 80 * scale;
            ctx.drawImage(superBoss.img, superBoss.x - sbSize/2, superBoss.y - sbSize/2, sbSize, sbSize);
        }

        ctx.font = `bold ${16 * scale}px 'Noto Serif KR'`;
        ctx.textAlign = "center";
        const now = Date.now();
        floatingTexts.forEach(ft => {
            const elapsed = now - ft.startTime;
            const alpha = 1 - (elapsed / ft.lifeTime);
            const lift = (elapsed / ft.lifeTime) * 30 * scale;
            ctx.fillStyle = ft.color;
            ctx.globalAlpha = alpha;
            ctx.fillText(ft.text, ft.x, ft.y - lift);
            ctx.globalAlpha = 1.0;
        });
    }

    function toggleModal(id) {
        const modal = document.getElementById(id);
        document.querySelectorAll('.modal').forEach(m => { if(m.id !== id) m.style.display = 'none'; });
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function openInventory() { toggleModal('inventory-modal'); switchTab('inv'); }

    function switchTab(tab) {
        document.getElementById('tab-inv').classList.toggle('active', tab === 'inv');
        document.getElementById('tab-traits').classList.toggle('active', tab === 'traits');
        document.getElementById('inv-list').style.display = (tab === 'inv') ? 'grid' : 'none';
        document.getElementById('trait-list').style.display = (tab === 'traits') ? 'block' : 'none';
        if (tab === 'inv') renderInventory();
        else renderTraits();
    }

    function getStatClass(val) {
        if (val >= 50) return 'stat-50';
        if (val >= 40) return 'stat-40';
        if (val >= 30) return 'stat-30';
        if (val >= 20) return 'stat-20';
        return 'stat-normal';
    }

    function getWeaponImage(job, rarity) {
        let baseJob = '전사';
        if (['도적', '어쌔신', '섀도우'].includes(job)) baseJob = '도적';
        if (['마법사', '아크메이지', '소서러'].includes(job)) baseJob = '마법사';
        if (['엘프 궁수', '스나이퍼', '레인저'].includes(job)) baseJob = '엘프 궁수';

        if (baseJob === '전사') {
            if (rarity === 'legendary') return 'legend_warrior.jpg';
            if (rarity === 'epic') return 'epic_warrior.jpg';
            return 'weapon_warrior.jpg';
        } else if (baseJob === '도적') {
            if (rarity === 'legendary') return 'legend_rogue.jpg';
            if (rarity === 'epic') return 'epic_rogue.jpg';
            return 'weapon_rogue.jpg';
        } else if (baseJob === '마법사') {
            if (rarity === 'legendary') return 'legend_mage.jpg';
            if (rarity === 'epic') return 'epic_mage.jpg';
            return 'weapon_mage.jpg';
        } else if (baseJob === '엘프 궁수') {
            if (rarity === 'legendary') return 'legend_archer.jpg';
            if (rarity === 'epic') return 'epic_archer.jpg';
            if (rarity === 'rare') return 'rare_archer.jpg';
            return 'weapon_archer.jpg';
        }
        return 'weapon_warrior.jpg';
    }

    function renderInventory() {
        const list = document.getElementById('inv-list');
        const statusPanel = document.getElementById('inv-status-panel');
        document.getElementById('inv-gold-display').innerText = `${player.gold} G`;
        const baseAtk = Math.floor(player.stats.str/1.8) + (player.level*2);
        const totalAtk = baseAtk + player.bonusAtk;

        statusPanel.innerHTML = `
            <div style="text-align:center; margin-bottom:15px;"><img src="${getPlayerImage(player.job, player.inventory)}" style="width:100px; height:100px; border:1px solid #444; margin-bottom:10px;"><div style="color:var(--accent-gold); font-family:var(--font-head); font-size:1.1rem;">${player.job.toUpperCase()}</div></div>
            <div class="side-stat-row"><span class="side-stat-name">레벨</span><span class="side-stat-val">${player.level}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">힘</span><span class="side-stat-val ${getStatClass(player.stats.str)}">${player.stats.str}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">민첩</span><span class="side-stat-val ${getStatClass(player.stats.dex)}">${player.stats.dex}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">체력</span><span class="side-stat-val ${getStatClass(player.stats.con)}">${player.stats.con}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">지능</span><span class="side-stat-val ${getStatClass(player.stats.int)}">${player.stats.int}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">지혜</span><span class="side-stat-val ${getStatClass(player.stats.wis)}">${player.stats.wis}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">매력</span><span class="side-stat-val ${getStatClass(player.stats.cha)}">${player.stats.cha}</span></div>
            <div class="side-stat-row" style="margin-top:15px; border-top:1px solid #333;"><span class="side-stat-name" style="color:#ef5350">총 공격력</span><div class="side-atk-val">${totalAtk}${player.bonusAtk > 0 ? `<span class="side-bonus">(+${player.bonusAtk})</span>` : ''}</div></div>
            <div class="side-stat-row"><span class="side-stat-name" style="color:#2196f3">추가 방어력</span><div class="side-stat-val">${player.bonusDef}</div></div>
        `;

        list.innerHTML = '';
        if(player.inventory.length === 0) list.innerHTML = '<p style="color:#666; grid-column:span 3; text-align:center; padding:20px;">가방이 비어 있습니다.</p>';

        const cha = player.stats.cha || 10;
        const chaSellBonus = 1 + (cha * 0.01); // 1% increase per CHA point

        player.inventory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `item-card ${item.equipped ? 'equipped' : ''}`;
            const typeText = item.type.includes('potion') || item.type.includes('scroll') ? '소모품' : '장비';
            const typeColor = item.type.includes('potion') || item.type.includes('scroll') ? '#ef5350' : '#26a69a';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : (item.equipped ? 'color:var(--accent-gold)' : '');
            const baseVal = item.val || 10; const enh = item.enhanceCount || 0;
            const sellPrice = Math.floor(((baseVal * 5) + (enh * 50)) * chaSellBonus);

            let iconHtml = '';
            if (item.type.includes('potion') || item.type.includes('scroll') || item.type === 'weapon') {
                let iconSrc = item.img || (item.type === 'weapon' ? getWeaponImage(player.job, item.rarity) : 'potion_hp.jpg');
                iconHtml = `<img src="image/${iconSrc}" class="item-icon-small">`;
            }

            div.innerHTML = `<div><div class="item-header">${iconHtml}<div class="item-name ${rarityClass}" style="${nameStyle}" title="${item.name}">${item.name}</div></div><div class="item-desc">${item.desc.replace(/\n/g, '<br>')}</div><div class="item-price">판매가: <span style="color:gold">${sellPrice} G</span></div></div><div class="item-type" style="color:${typeColor}">${typeText}</div><button class="sell-btn" onclick="askSell(${index}); event.stopPropagation();">판매</button>`;
            div.onclick = () => useItem(index);
            list.appendChild(div);
        });
    }

    function renderTraits() {
        const list = document.getElementById('trait-list');
        list.innerHTML = `<div class="trait-point-display">보유 특성 포인트: ${player.traitPoints}</div>`;

        const traitData = [
            { key: 'str', name: '근력 강화', desc: '힘 능력치를 영구적으로 증가시킵니다.' },
            { key: 'dex', name: '민첩 강화', desc: '민첩 능력치를 영구적으로 증가시킵니다.' },
            { key: 'con', name: '체력 강화', desc: '체력 능력치를 영구적으로 증가시킵니다.' },
            { key: 'int', name: '지능 강화', desc: '지능 능력치를 영구적으로 증가시킵니다.' },
            { key: 'wis', name: '지혜 강화', desc: '지혜 능력치를 영구적으로 증가시킵니다.' },
            { key: 'cha', name: '매력 강화', desc: '매력 능력치를 영구적으로 증가시킵니다.' }
        ];

        traitData.forEach(t => {
            const lv = player.traits[t.key] || 0;
            const div = document.createElement('div');
            div.className = 'trait-item';
            div.innerHTML = `
                <div class="trait-info">
                    <div class="trait-name">${t.name}</div>
                    <div class="trait-desc">${t.desc}</div>
                </div>
                <div class="trait-level">Lv. ${lv}</div>
                <button class="trait-up-btn" onclick="upgradeTrait('${t.key}')" ${player.traitPoints <= 0 ? 'disabled' : ''}>강화</button>
            `;
            list.appendChild(div);
        });
    }

    function upgradeTrait(key) {
        if (player.traitPoints <= 0) return;
        player.traitPoints--;
        if (!player.traits[key]) player.traits[key] = 0;
        player.traits[key]++;
        player.stats[key]++;

        if (key === 'con') { player.maxHp += 2; player.hp += 2; }
        if (key === 'int' || key === 'wis') { player.maxMp += 2; player.mp += 2; }

        renderTraits();
        updateUI();
    }

    function openShop() { toggleModal('shop-modal'); renderShopList(); }

    function renderShopList() {
        const list = document.getElementById('shop-list');
        document.getElementById('shop-gold-display').innerText = `${player.gold} GOLD`;
        list.innerHTML = '';
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if(weapons.length === 0) { list.innerHTML = '<p style="color:#666; grid-column:span 4; text-align:center;">강화할 무기가 없습니다.</p>'; return; }

        const cha = player.stats.cha || 10;
        const chaDiscount = Math.min(0.3, cha * 0.005); // Max 30% discount

        weapons.forEach(({ item, idx }) => {
            const enhanceLv = item.enhanceCount !== undefined ? item.enhanceCount : 0;
            const baseCost = (enhanceLv + 1) * 50;
            const cost = Math.floor(baseCost * (1 - chaDiscount));

            let successRate = 100;
            if (enhanceLv < 5) successRate = 100;
            else if (enhanceLv < 10) successRate = 100 - (enhanceLv - 4) * 10;
            else if (enhanceLv < 15) successRate = 45 - (enhanceLv - 10) * 5;
            else successRate = Math.max(5, 20 - (enhanceLv - 15) * 3);
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}" style="${nameStyle}" title="${item.name}">${item.name}</div><div class="item-desc">현재: +${enhanceLv}</div><div class="item-desc" style="color:#888; margin-top:5px;">비용: <span style="color:var(--accent-gold)">${cost} G</span> | 확률: ${successRate}%</div><button class="enhance-btn" onclick="askEnhance(${idx}, ${cost}, ${successRate}, ${enhanceLv})">강화하기</button>`;
            if(enhanceLv >= 20) { div.querySelector('button').disabled = true; div.querySelector('button').innerText = "최대 레벨"; }
            list.appendChild(div);
        });
    }

    function showConfirm(title, msg, onYes, onlyOk = false) {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerHTML = msg;
        document.getElementById('confirm-no-btn').style.display = onlyOk ? 'none' : 'block';
        document.getElementById('confirm-yes-btn').innerText = onlyOk ? '확인' : '예';
        currentConfirmAction = onYes;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function executeConfirm() {
        const action = currentConfirmAction;
        closeConfirm();
        if (action) action();
    }

    function askEnhance(index, cost, rate, currentLv) {
        if(player.gold < cost) return showConfirm("골드 부족", "강화에 필요한 골드가 부족합니다.", null, true);
        showConfirm("강화 확인", `${cost}G를 사용하여 강화하시겠습니까?\n(확률: ${rate}%)`, () => executeEnhance(index, cost, rate, currentLv));
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
        currentConfirmAction = null;
    }

    function executeEnhance(index, cost, rate, currentLv) {
        player.gold -= cost;
        const item = player.inventory[index];
        const isSuccess = Math.random() * 100 < rate;

        if(isSuccess) {
            item.enhanceCount = (item.enhanceCount || currentLv) + 1;
            item.val += 1;
            item.desc = item.desc.replace(/\+\d+/, `+${item.val}`);
            if(item.name.match(/\(\+\d+\)/)) item.name = item.name.replace(/\(\+\d+\)/, `(+${item.enhanceCount})`);
            else item.name += ` (+${item.enhanceCount})`;
            if(item.equipped) player.bonusAtk += 1;
            player.quests.enhanceCount++;
            item.failCount = 0; // Reset fail count on success
            showEnhanceEffect();
            successSfx.play().catch(e => console.log(e));
        } else {
            item.failCount = (item.failCount || 0) + 1;
            if (item.failCount >= 3) {
                if(item.equipped) {
                    player.bonusAtk -= item.val;
                    if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
                }
                player.inventory.splice(index, 1);
                showConfirm("강화 실패", "강화에 3번 실패하여 무기가 파괴되었습니다!", null, true);
            } else {
                showConfirm("강화 실패", `강화에 실패했습니다... (연속 실패: ${item.failCount}/3)\n골드만 소모되었습니다.`, null, true);
            }
            failSfx.play().catch(e => console.log(e));
        }
        updateUI(); renderShopList();
    }

    function openQuest() { toggleModal('quest-modal'); renderQuestList(); }

    function renderQuestList() {
        const list = document.getElementById('quest-list');
        list.innerHTML = '';
        const quests = [
            { id: 'dayKill', title: '낮의 사냥꾼', desc: '낮 몬스터 5마리 처치', goal: 5, current: player.quests.dayKillCount || 0, reward: '500 G', claimed: player.quests.claimed.dayKill },
            { id: 'nightKill', title: '밤의 추적자', desc: '밤 몬스터 5마리 처치', goal: 5, current: player.quests.nightKillCount || 0, reward: '800 G', claimed: player.quests.claimed.nightKill },
            { id: 'bossKill', title: '보스 슬레이어', desc: '보스 몬스터 1마리 처치', goal: 1, current: player.quests.bossKillCount || 0, reward: '2000 G', claimed: player.quests.claimed.bossKill },
            { id: 'enhance', title: '강화의 달인', desc: '강화 1회 성공', goal: 1, current: player.quests.enhanceCount, reward: '300 G', claimed: player.quests.claimed.enhance },
            { id: 'coinCollect', title: '반짝이는 유혹', desc: '필드에 떨어진 코인 5개 줍기', goal: 5, current: player.quests.coinCollectCount || 0, reward: '500 G', claimed: player.quests.claimed.coinCollect }
        ];
        quests.forEach(q => {
            const div = document.createElement('div');
            div.className = 'quest-item';
            const isComplete = q.current >= q.goal;
            const btnText = q.claimed ? '보상 수령 완료' : (isComplete ? '보상 받기' : '진행 중');
            div.innerHTML = `<div class="quest-title">${q.title}</div><div class="quest-progress">${q.desc} (${Math.min(q.current, q.goal)}/${q.goal})</div><div class="quest-reward">보상: ${q.reward}</div><button class="quest-claim-btn" onclick="claimQuest('${q.id}')" ${(!isComplete || q.claimed) ? 'disabled' : ''}>${btnText}</button>`;
            list.appendChild(div);
        });
    }

    function claimQuest(id) {
        if (id === 'dayKill' && !player.quests.claimed.dayKill) { player.gold += 500; player.quests.claimed.dayKill = true; showConfirm("퀘스트 완료", "500 G를 획득했습니다!", null, true); }
        else if (id === 'nightKill' && !player.quests.claimed.nightKill) { player.gold += 800; player.quests.claimed.nightKill = true; showConfirm("퀘스트 완료", "800 G를 획득했습니다!", null, true); }
        else if (id === 'bossKill' && !player.quests.claimed.bossKill) { player.gold += 2000; player.quests.claimed.bossKill = true; showConfirm("퀘스트 완료", "2000 G를 획득했습니다!", null, true); }
        else if (id === 'enhance' && !player.quests.claimed.enhance) { player.gold += 300; player.quests.claimed.enhance = true; showConfirm("퀘스트 완료", "300 G를 획득했습니다!", null, true); }
        else if (id === 'coinCollect' && !player.quests.claimed.coinCollect) { player.gold += 500; player.quests.claimed.coinCollect = true; showConfirm("퀘스트 완료", "500 G를 획득했습니다!", null, true); }
        updateUI(); renderQuestList();
    }

    function showEnhanceEffect() {
        const el = document.getElementById('enhance-effect');
        el.classList.remove('enhance-anim'); void el.offsetWidth; el.classList.add('enhance-anim');
    }

    function useItem(index) {
        const item = player.inventory[index];
        if (item.type.includes('potion') || item.type.includes('scroll')) {
            if (item.type === 'potion_gamble') { // Added check for potion_gamble
                return showConfirm("사용 불가", "도박사의 시약은 전투 중에만 사용할 수 있습니다.", null, true);
            }
            if (item.type === 'potion_full') {
                if (player.hp >= player.maxHp && player.mp >= player.maxMp) return showConfirm("사용 불가", "이미 체력과 마나가 가득 찼습니다.", null, true);
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                potionSfx.play().catch(e => {});
            } else if (player.hp >= player.maxHp && item.name.includes('체력')) return showConfirm("사용 불가", "체력이 가득 찼습니다.", null, true);
            else if (player.mp >= player.maxMp && item.name.includes('마나')) return showConfirm("사용 불가", "마나가 가득 찼습니다.", null, true);

            if (item.type === 'potion_full') { /* already handled above */ }
            else if (item.name.includes('체력')) { player.hp = Math.min(player.hp + item.val, player.maxHp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('마나')) { player.mp = Math.min(player.mp + item.val, player.maxMp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('경험치')) {
                player.exp += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("아이템 사용", `경험치를 ${item.val} 획득했습니다!`, null, true);
                if (player.exp >= player.maxExp) {
                    player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
                    player.traitPoints += 2;
                    showConfirm("레벨 업!", "레벨 업! 특성 포인트 2개를 획득했습니다.", () => { checkAdvancement(); }, true);
                }
            } else if (item.type === 'potion_atk') {
                player.bonusAtk += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("아이템 사용", `공격력이 ${item.val}만큼 영구적으로 증가했습니다!`, null, true);
            } else if (item.type === 'potion_def') {
                player.bonusDef += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("아이템 사용", `방어력이 ${item.val}만큼 영구적으로 증가했습니다!`, null, true);
            } else if (item.type === 'scroll_option') {
                // 옵션 부여 스크롤 사용 로직
                showOptionScrollUI(index);
                return; // UI에서 처리하므로 여기서 종료
            } else if (item.type === 'potion_skeleton') {
                // 해골 포션은 전투 중에만 사용 가능하므로 맵에서는 사용 불가 메시지
                return showConfirm("사용 불가", "전투 중에만 사용할 수 있는 아이템입니다.", null, true);
            } else if (item.type === 'potion_focus' || item.type === 'potion_holy' || item.type === 'potion_madness') {
                return showConfirm("사용 불가", "전투 중에만 사용할 수 있는 아이템입니다.", null, true);
            }

            player.inventory.splice(index, 1);
            if (!item.name.includes('경험치') && !item.type.includes('atk') && !item.type.includes('def')) showConfirm("아이템 사용", `${item.name}을(를) 사용했습니다.`, null, true);
        } else if (item.type === 'weapon') {
            if (item.reqJob && item.reqJob !== player.job) return showConfirm("착용 불가", `[${item.reqJob}] 전용 장비입니다.`, null, true);
            if (item.equipped) {
                item.equipped = false;
                player.bonusAtk -= item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            }
            else {
                player.inventory.forEach(i => {
                    if (i.type === 'weapon' && i.equipped) {
                        i.equipped = false;
                        player.bonusAtk -= i.val;
                        if (i.options) i.options.forEach(opt => player.stats[opt.key] -= opt.val);
                    }
                });
                item.equipped = true;
                player.bonusAtk += item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] += opt.val);
                equipSfx.play().catch(e => {});
            }
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        renderInventory(); updateUI();
    }

    function showOptionScrollUI(scrollIndex) {
        // 장비 목록을 보여주고 선택하게 함
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if (weapons.length === 0) {
            return showConfirm("사용 불가", "옵션을 부여할 장비가 없습니다.", null, true);
        }

        // 간단하게 프롬프트나 컨펌으로 처리하기엔 복잡하므로,
        // 기존 상점 모달을 재활용하거나 새로운 모달을 띄워야 함.
        // 여기서는 간단히 confirm으로 첫 번째 장비부터 순회하며 물어보는 방식보다는
        // 스크롤 사용 시 장비 선택 모달을 띄우는 것이 좋음.
        // 하지만 현재 구조상 복잡하므로,
        // 스크롤 사용 시 -> [강화] 모달처럼 장비 리스트를 띄우고 선택하게 하는 방식을 사용.

        toggleModal('inventory-modal'); // 인벤토리 닫기

        // 임시로 shop-modal을 재활용하여 장비 선택 유도
        const modal = document.getElementById('shop-modal');
        const list = document.getElementById('shop-list');
        const title = modal.querySelector('h2');
        const originalTitle = title.innerText;

        title.innerText = "옵션 부여 대상 선택";
        document.getElementById('shop-gold-display').style.display = 'none';

        list.innerHTML = '';
        weapons.forEach(({ item, idx }) => {
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}">${item.name}</div><div class="item-desc">${item.desc}</div><button class="enhance-btn" onclick="applyOptionScroll(${scrollIndex}, ${idx})">선택</button>`;
            list.appendChild(div);
        });

        // 모달 닫기 버튼 재정의 (원상복구 필요)
        const closeBtn = modal.querySelector('.close-btn');
        const originalOnClick = closeBtn.onclick;
        closeBtn.onclick = () => {
            toggleModal('shop-modal');
            title.innerText = originalTitle;
            document.getElementById('shop-gold-display').style.display = 'block';
            closeBtn.onclick = originalOnClick;
        };

        toggleModal('shop-modal');
    }

    function applyOptionScroll(scrollIndex, itemIndex) {
        const item = player.inventory[itemIndex];

        // 기존 옵션 제거 (스탯 차감)
        if (item.equipped && item.options) {
            item.options.forEach(opt => player.stats[opt.key] -= opt.val);
        }

        // 새로운 옵션 생성
        const optCount = Math.floor(Math.random() * 3) + 1; // 1~3개
        const newOptions = [];
        const possibleOpts = [
            { name: "힘", key: "str" },
            { name: "민첩", key: "dex" },
            { name: "체력", key: "con" },
            { name: "지능", key: "int" }
        ];

        let descText = `공격력 +${item.val} (${item.reqJob || player.job} 전용)`;
        let optionMsg = "";

        for(let i=0; i<optCount; i++) {
            const type = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
            const val = Math.floor(Math.random() * 5) + 1; // 1~5
            newOptions.push({ name: type.name, key: type.key, val: val });
            descText += `\n[옵션] ${type.name} +${val}`;
            optionMsg += `<span style="color:#ffd700; font-weight:bold;">[${type.name} +${val}]</span> `;
        }

        item.options = newOptions;
        item.desc = descText;

        // 새 옵션 적용 (스탯 가산)
        if (item.equipped) {
            item.options.forEach(opt => player.stats[opt.key] += opt.val);
        }

        // 스크롤 소모
        player.inventory.splice(scrollIndex, 1);

        // 모달 닫기 및 복구
        const modal = document.getElementById('shop-modal');
        toggleModal('shop-modal');
        modal.querySelector('h2').innerText = "대장간";
        document.getElementById('shop-gold-display').style.display = 'block';

        showConfirm("옵션 부여 성공", `${item.name}에 새로운 옵션이 부여되었습니다!<br><br>부여된 옵션:<br>${optionMsg}`, null, true);
        updateUI();
    }

    function askSell(index) {
        const item = player.inventory[index];
        const cha = player.stats.cha || 10;
        const chaSellBonus = 1 + (cha * 0.01);
        const baseVal = item.val || 10; const enh = item.enhanceCount || 0;
        const price = Math.floor(((baseVal * 5) + (enh * 50)) * chaSellBonus);
        showConfirm("판매 확인", `[${item.name}]을(를) ${price} G에 판매하시겠습니까?`, () => sellItem(index, price));
    }

    function sellItem(index, price) {
        const item = player.inventory[index];
        if(item.equipped) {
            player.bonusAtk -= item.val;
            if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        player.gold += price; player.inventory.splice(index, 1);
        renderInventory(); updateUI();
    }

    function askManualSave() {
        showConfirm("저장 확인", "현재 진행 상황을 저장하시겠습니까?", () => manualSave());
    }

    async function manualSave() {
        const overlay = document.getElementById('loading-overlay');
        const txt = document.querySelector('.loading-text');
        txt.innerText = "저장 중..."; overlay.style.display = 'flex';

        try {
            if (!player.name) {
                player.name = localStorage.getItem('rpg_player_name');
            }

            await fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(player)
            });

            localStorage.removeItem('rpg_temp_player');
            setTimeout(() => {
                overlay.style.display = 'none';
                showConfirm("저장 완료", "데이터가 스프레드시트에 전송되었습니다!", null, true);
            }, 1500);

        } catch(e) {
            console.error("Save Error:", e);
            showConfirm("저장 실패", "네트워크 오류가 발생했습니다.", null, true);
            overlay.style.display = 'none';
        }
    }

    function showRandomEvent() {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');
        const events = [
            { t: "보물 발견!", g: 200, h: 0, m: 0, i: "image/bm.jpg", r: "+200 골드" },
            { t: "고대의 샘!", g: 0, h: 50, m: 30, i: "image/bm.jpg", r: "+50 HP / +30 MP" },
            { t: "행운의 동전!", g: 100, h: 0, m: 0, i: "image/bm.jpg", r: "+100 골드" }
        ];
        const ev = events[Math.floor(Math.random() * events.length)];
        text.innerText = ev.t; rewardText.innerText = ev.r; img.src = ev.i;
        player.gold += ev.g; player.hp = Math.min(player.hp + ev.h, player.maxHp); player.mp = Math.min(player.mp + ev.m, player.maxMp);
        if (ev.g > 0) goldSfx.play().catch(e => {});
        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');
        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function move(e) {
        if(document.querySelector('.modal[style*="flex"]')) return;
        if(isSizeControlling) return; // Pause movement during size control

        const canvas = document.getElementById('gameCanvas');
        let s = player.moveSpeed || 12;
        if (currentWeather === "rain") s *= 0.7;

        let m = false;
        if (e.key === "ArrowUp") { player.y = Math.max(16, player.y - s); m = true; }
        if (e.key === "ArrowDown") { player.y = Math.min(canvas.height - 16, player.y + s); m = true; }
        if (e.key === "ArrowLeft") { player.x = Math.max(16, player.x - s); m = true; }
        if (e.key === "ArrowRight") { player.x = Math.min(canvas.width - 16, player.x + s); m = true; }
        if (m) {
            const rand = Math.random();
            let eventChance = isNight ? 0.02 : 0.01; // Reduced event chance
            let encounterChance = 0.06;

            // 엘프 궁수(Elf Archer)의 '정령의 눈' 패시브: 안개(Fog) 날씨의 명중률 페널티(-20%)를 무시하고 0%로 고정함.
            // map.html에서는 명중률 페널티를 직접적으로 처리하지 않으므로,
            // 안개 날씨의 '조우율 상승' 효과를 엘프 궁수에게는 적용하지 않도록 처리합니다.
            if (currentWeather === "fog") {
                if (player.job !== '엘프 궁수') {
                    eventChance *= 1.5;
                    encounterChance *= 2.0;
                }
            }

            if (rand < eventChance) showRandomEvent();
            else if (rand < encounterChance) {
                saveBossPos(); localStorage.removeItem('rpg_boss_encounter');
                localStorage.setItem('rpg_is_night', isNight);
                localStorage.setItem('rpg_temp_player', JSON.stringify(player)); location.href = 'battle.html';
            }
        }
    }

    // Mobile Control Logic
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.getElementById('mobile-controls').style.display = 'grid';
    }

    let moveTimer = null;
    function handleMobilePress(key) {
        if (moveTimer) clearInterval(moveTimer);
        move({key: key});
        moveTimer = setInterval(() => {
            move({key: key});
        }, 100);
    }
    function handleMobileRelease() {
        if (moveTimer) clearInterval(moveTimer);
        moveTimer = null;
    }

    const dPadButtons = [
        { id: 'btn-up', key: 'ArrowUp' },
        { id: 'btn-down', key: 'ArrowDown' },
        { id: 'btn-left', key: 'ArrowLeft' },
        { id: 'btn-right', key: 'ArrowRight' }
    ];

    dPadButtons.forEach(btn => {
        const el = document.getElementById(btn.id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); handleMobilePress(btn.key); }, {passive: false});
        el.addEventListener('touchend', (e) => { e.preventDefault(); handleMobileRelease(); });
        el.addEventListener('mousedown', (e) => { handleMobilePress(btn.key); });
        el.addEventListener('mouseup', (e) => { handleMobileRelease(); });
        el.addEventListener('mouseleave', (e) => { handleMobileRelease(); });
    });
</script>
</body>
</html>
