<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DUNGEON RPG - Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Noto+Serif+KR:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(18, 18, 24, 0.95);
            --border-color: #5c4d3c;
            --accent-gold: #c5a059;
            --accent-red: #d32f2f;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --hp-grad: linear-gradient(90deg, #8b0000, #b71c1c);
            --mp-grad: linear-gradient(90deg, #0d47a1, #1565c0);
            --exp-grad: linear-gradient(90deg, #4a148c, #6a1b9a);
            --font-head: 'Cinzel', serif;
            --font-body: 'Noto Serif KR', 'Inter', sans-serif;

            /* Bag Theme Colors */
            --bag-bg: #3e2723;
            --bag-panel: #4e342e;
            --bag-border: #6d4c41;
            --bag-item: #5d4037;

            /* Rarity Colors */
            --rarity-common: #ffffff;
            --rarity-rare: #2196f3;
            --rarity-epic: #a335ee;
            --rarity-legendary: #ff8000;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #1a1a20 0%, #000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: auto;
            user-select: none;
        }

        #game-container {
            width: 960px;
            height: 720px;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 4px;
        }

        .game-ui-top {
            height: 80px;
            background: linear-gradient(180deg, #141414 0%, #0a0a0a 100%);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 20;
            position: relative;
        }

        .char-info { display: flex; flex-direction: column; justify-content: center; min-width: 150px; }
        .char-info h2 {
            font-family: var(--font-head); color: var(--accent-gold); margin: 0;
            font-size: 1.1rem; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .char-info span { font-family: var(--font-body); color: var(--text-muted); font-size: 0.75rem; margin-top: 2px; font-weight: 600; }

        #game-timer {
            font-family: var(--font-body); font-weight: 700; font-size: 1.5rem; color: #ef5350;
            text-shadow: 0 0 10px rgba(239, 83, 80, 0.4); min-width: 80px; text-align: center; letter-spacing: 1px;
            margin-right: 20px;
        }

        .ui-bars-center {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 300px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .bar-row { display: flex; align-items: center; gap: 8px; }
        .bar-label { width: 25px; text-align: right; color: #666; font-family: var(--font-body); font-size: 0.65rem; font-weight: 700; }
        .bar-bg { flex: 1; height: 10px; background: #111; border: 1px solid #2a2a2a; border-radius: 2px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; border-radius: 1px; }
        .hp-fill { background: var(--hp-grad); }
        .mp-fill { background: var(--mp-grad); }
        .exp-fill { background: var(--exp-grad); }
        .bar-text { position: absolute; top: -1px; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 8px; color: rgba(255,255,255,0.7); text-shadow: 1px 1px 1px #000; }

        .btn-group { display: flex; gap: 8px; }
        .btn {
            padding: 8px 16px; background: #1a1a1a; border: 1px solid #333; color: #aaa;
            font-family: var(--font-body); font-size: 0.75rem; font-weight: 700; cursor: pointer;
            transition: all 0.2s; border-radius: 2px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:hover { background: #252525; color: var(--accent-gold); border-color: var(--accent-gold); box-shadow: 0 0 10px rgba(197, 160, 89, 0.1); }

        .canvas-wrapper { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        canvas { image-rendering: pixelated; }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(12, 12, 14, 0.98); border: 1px solid #444; display: none; flex-direction: column;
            z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-radius: 4px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #2a2a2a; }
        .modal-header h2 { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.2rem; margin: 0; letter-spacing: 2px; }
        .close-btn { background: none; border: none; color: #555; font-family: var(--font-body); cursor: pointer; font-size: 1.2rem; transition: color 0.2s; }
        .close-btn:hover { color: #fff; }

        .modal-body { padding: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* Inventory Modal Bag Theme */
        #inventory-modal {
            width: 850px; height: 620px;
            background: var(--bag-bg);
            border: 3px solid var(--bag-border);
            box-shadow: 0 0 30px rgba(0,0,0,0.7), inset 0 0 50px rgba(0,0,0,0.3);
        }
        #inventory-modal .modal-header { border-bottom: 2px solid var(--bag-border); background: rgba(0,0,0,0.2); }
        #inventory-modal .modal-body { background: var(--bag-panel); overflow-y: auto; }
        #inventory-modal .modal-body::-webkit-scrollbar { width: 8px; }
        #inventory-modal .modal-body::-webkit-scrollbar-thumb { background: var(--bag-border); border-radius: 4px; }

        #shop-modal { width: 850px; height: 620px; }
        #shop-list-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        #shop-list-container::-webkit-scrollbar { width: 8px; }
        #shop-list-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        #quest-modal { width: 500px; height: 550px; }
        #quest-modal .modal-body { overflow-y: auto; }
        #quest-modal .modal-body::-webkit-scrollbar { width: 6px; }
        #quest-modal .modal-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        #advancement-modal { width: 600px; height: 500px; }

        /* Custom Confirm Modal */
        #confirm-modal { width: 400px; height: auto; min-height: 200px; z-index: 200; }
        .confirm-text { color: #eee; text-align: center; font-size: 1.1rem; margin-bottom: 25px; line-height: 1.6; }
        .confirm-btns { display: flex; gap: 15px; justify-content: center; }
        .btn-yes { background: var(--accent-gold); color: #000; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-no { background: #444; color: #fff; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-yes:hover { background: #fff; }
        .btn-no:hover { background: #666; }

        /* GameOver Modal */
        #gameover-modal { width: 500px; height: auto; z-index: 1000; border: 2px solid var(--accent-red); }
        .gameover-title { font-family: var(--font-head); font-size: 2.5rem; color: var(--accent-red); text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .gameover-stats { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .go-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.1rem; color: #ccc; }
        .go-val { color: var(--accent-gold); font-weight: bold; }
        .go-score { font-size: 1.8rem; color: #fff; text-align: center; margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; }

        .inv-container { display: flex; gap: 20px; height: auto; min-height: 100%; }
        .inv-status-side {
            flex: 0 0 220px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            padding: 15px; border-radius: 4px; display: flex; flex-direction: column; height: fit-content;
        }
        .inv-grid-side { flex: 1; padding-right: 5px; }

        .inv-header-gold {
            color: var(--accent-gold); font-family: var(--font-body); font-weight: 600; font-size: 0.9rem; margin-right: 15px;
        }

        .inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .item-card {
            background: var(--bag-item); border: 1px solid var(--bag-border); border-radius: 4px; padding: 10px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 120px; position: relative; cursor: pointer; transition: 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .item-card:hover { border-color: #fff; background: #6d4c41; }
        .item-card.equipped { border-color: var(--accent-gold); background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

        .item-name { font-size: 0.85rem; font-weight: 700; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 2px #000; }
        .item-desc { font-size: 0.7rem; color: #d7ccc8; line-height: 1.4; }
        .item-price { font-size: 0.65rem; color: #bcaaa4; margin-top: 5px; font-family: var(--font-body); }
        .item-type { font-size: 0.6rem; margin-top: 8px; color: #a1887f; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }

        .sell-btn {
            position: absolute; bottom: 8px; right: 8px;
            padding: 4px 8px; background: #d32f2f; color: #fff; border: 1px solid #b71c1c; border-radius: 3px;
            font-size: 0.7rem; font-family: var(--font-body); cursor: pointer; transition: 0.2s;
            font-weight: bold; z-index: 5;
        }
        .sell-btn:hover { background: #f44336; transform: scale(1.1); }

        .side-stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--bag-border); padding: 6px 0; font-size: 0.8rem; }
        .side-stat-name { color: #bcaaa4; font-weight: 600; }
        .side-stat-val { color: #fff; font-family: var(--font-body); font-weight: 600; }
        .side-atk-val { color: #ff8a80; font-weight: bold; font-size: 1rem; }
        .side-bonus { color: #81c784; font-size: 0.75rem; margin-left: 4px; }

        .shop-gold { text-align: center; color: var(--accent-gold); font-family: var(--font-body); font-size: 1.2rem; margin-bottom: 15px; padding: 10px; border: 1px solid #333; background: #111; }
        .enhance-btn {
            margin-top: 8px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .enhance-btn:hover { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }
        .enhance-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #111; color: #555; }

        .quest-item { background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .quest-title { color: var(--accent-gold); font-weight: bold; margin-bottom: 5px; }
        .quest-progress { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .quest-reward { font-size: 0.8rem; color: #4caf50; }
        .quest-claim-btn {
            margin-top: 10px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .quest-claim-btn:hover:not(:disabled) { background: var(--accent-gold); color: #000; }
        .quest-claim-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .adv-grid { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .adv-card {
            flex: 1; background: #111; border: 2px solid #333; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .adv-card:hover { border-color: var(--accent-gold); background: #1a1a1a; transform: translateY(-5px); }
        .adv-card img { width: 120px; height: 120px; object-fit: cover; border: 1px solid #444; margin-bottom: 15px; }
        .adv-name { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.3rem; margin-bottom: 10px; }
        .adv-desc { font-size: 0.75rem; color: #aaa; line-height: 1.5; margin-bottom: 15px; }
        .adv-bonus { font-size: 0.8rem; color: #4caf50; font-weight: bold; }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-text { font-family: var(--font-body); color: #fff; letter-spacing: 3px; font-size: 1rem; margin-top: 20px; }
        .spinner { width: 30px; height: 30px; border: 2px solid #333; border-top: 2px solid var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #enhance-effect {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-body); font-size: 2.5rem; font-weight: 700;
            color: #fff; text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #e65100;
            pointer-events: none; opacity: 0; z-index: 200; text-align: center;
            letter-spacing: 2px; width: 100%;
        }
        .enhance-anim { animation: enhanceSuccess 2s ease-out forwards; }
        @keyframes enhanceSuccess {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        #event-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 300; display: none; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        #event-img { width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 0 20px var(--accent-gold)); animation: bounce 1s infinite alternate; }
        #event-text {
            margin-top: 20px; font-family: var(--font-body); font-size: 1.8rem; color: #fff;
            text-shadow: 0 0 10px #000, 0 0 20px var(--accent-gold); text-align: center;
        }
        #event-reward {
            margin-top: 10px; font-family: var(--font-body); font-size: 1.2rem; color: #4caf50;
            font-weight: bold; text-shadow: 1px 1px 2px #000;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
        .event-anim { animation: eventFade 3s forwards; }
        @keyframes eventFade {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        /* Trait System Styles */
        .inv-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn {
            padding: 8px 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            color: #aaa; cursor: pointer; font-family: var(--font-body); font-size: 0.8rem;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active { background: var(--bag-panel); color: var(--accent-gold); border-bottom: none; font-weight: bold; }

        .trait-container { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .trait-point-display {
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; border: 1px solid var(--bag-border);
            text-align: center; color: var(--accent-gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;
        }
        .trait-item {
            background: rgba(255,255,255,0.05); border: 1px solid var(--bag-border); border-radius: 4px;
            padding: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .trait-info { flex: 1; }
        .trait-name { color: #fff; font-weight: bold; font-size: 0.95rem; margin-bottom: 4px; }
        .trait-desc { color: #aaa; font-size: 0.75rem; }
        .trait-level { color: var(--accent-gold); font-size: 0.85rem; font-weight: bold; margin-right: 15px; }
        .trait-up-btn {
            padding: 5px 12px; background: var(--accent-gold); color: #000; border: none;
            border-radius: 3px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .trait-up-btn:hover:not(:disabled) { background: #fff; }
        .trait-up-btn:disabled { background: #444; color: #777; cursor: not-allowed; }

        .rarity-common { color: var(--rarity-common) !important; }
        .rarity-rare { color: var(--rarity-rare) !important; text-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
        .rarity-epic { color: var(--rarity-epic) !important; text-shadow: 0 0 8px rgba(163, 53, 238, 0.6); }
        .rarity-legendary { color: var(--rarity-legendary) !important; text-shadow: 0 0 10px rgba(255, 128, 0, 0.7); }

        /* Weather Effects */
        #weather-ui {
            position: absolute; top: 90px; right: 20px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 8px 15px;
            border-radius: 20px; display: flex; align-items: center; gap: 10px;
            font-family: var(--font-body); font-size: 0.85rem; color: #fff; z-index: 15;
        }
        .weather-icon { font-size: 1.2rem; }

        #weather-overlay {
            position: absolute; top: 80px; left: 0; width: 100%; height: calc(100% - 80px);
            pointer-events: none; z-index: 10; overflow: hidden;
        }
        .rain-drop {
            position: absolute; background: rgba(255,255,255,0.4); width: 1px; height: 15px;
            animation: rainFall 0.8s linear infinite;
        }
        @keyframes rainFall { to { transform: translateY(720px); } }

        .fog-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); filter: blur(30px);
            animation: fogMove 10s linear infinite alternate;
        }
        @keyframes fogMove { from { transform: translateX(-50px); } to { transform: translateX(50px); } }

        .thunder-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.3); opacity: 0; z-index: 11;
        }
        .thunder-anim { animation: thunderFlash 0.2s ease-out; }
        @keyframes thunderFlash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* Boss Warning Popup */
        #boss-warning {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.9); border: 2px solid var(--accent-gold);
            color: #fff; padding: 15px 30px; border-radius: 8px; font-family: var(--font-body);
            font-size: 1.5rem; font-weight: bold; z-index: 1000; display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); animation: warningPulse 1s infinite alternate;
            text-align: center; pointer-events: none;
        }
        @keyframes warningPulse { from { opacity: 0.8; transform: translateX(-50%) scale(1); } to { opacity: 1; transform: translateX(-50%) scale(1.05); } }

        /* Mobile Controls */
        #mobile-controls {
            margin-top: 20px;
            z-index: 9999;
            display: none; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px;
            pointer-events: auto;
        }
        .d-pad-btn {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 2rem; user-select: none; cursor: pointer;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            touch-action: manipulation;
        }
        .d-pad-btn:active { background: rgba(255, 215, 0, 0.3); border-color: var(--accent-gold); color: var(--accent-gold); }
    </style>
</head>
<body>
<div id="game-container">
    <div id="loading-overlay"><div class="spinner"></div><div class="loading-text">Ïó∞Í≤∞ Ï§ë...</div></div>
    <div id="enhance-effect">Í∞ïÌôî ÏÑ±Í≥µ!</div>
    <div id="boss-warning">‚ö†Ô∏è Í≤ΩÍ≥†: Ï¥àÍ∞ïÎ†• Î≥¥Ïä§Í∞Ä ÌïÑÎìúÏóê Ï∂úÌòÑÌñàÏäµÎãàÎã§!</div>

    <div id="weather-ui">
        <span class="weather-icon" id="weather-icon">‚òÄÔ∏è</span>
        <span id="weather-text">ÎßëÏùå</span>
    </div>
    <div id="weather-overlay"></div>
    <div id="thunder-flash" class="thunder-flash"></div>

    <div id="event-overlay">
        <img id="event-img" src="image/bm.jpg" alt="Event">
        <div id="event-text">Î≥¥Î¨º Î∞úÍ≤¨!</div>
        <div id="event-reward"></div>
    </div>

    <div id="inventory-modal" class="modal">
        <div class="modal-header">
            <div style="display:flex; align-items:center;">
                <h2>Í∞ÄÎ∞© Î∞è ÏÉÅÌÉú</h2>
            </div>
            <div style="display:flex; align-items:center;">
                <span id="inv-gold-display" class="inv-header-gold">0 G</span>
                <button class="close-btn" onclick="toggleModal('inventory-modal')">√ó</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="inv-tabs">
                <button id="tab-inv" class="tab-btn active" onclick="switchTab('inv')">ÏïÑÏù¥ÌÖú</button>
                <button id="tab-traits" class="tab-btn" onclick="switchTab('traits')">ÌäπÏÑ± (Traits)</button>
            </div>
            <div class="inv-container">
                <div class="inv-status-side" id="inv-status-panel"></div>
                <div class="inv-grid-side">
                    <div id="inv-list" class="inv-grid"></div>
                    <div id="trait-list" class="trait-container" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-header"><h2>ÎåÄÏû•Í∞Ñ</h2><button class="close-btn" onclick="toggleModal('shop-modal')">√ó</button></div>
        <div class="modal-body">
            <div class="shop-gold" id="shop-gold-display">0 G</div>
            <p style="color:#666; font-size:0.75rem; text-align:center; margin-bottom:15px;">
                Í∞ïÌôîÌï† Ïû•ÎπÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (ÏµúÎåÄ +20)
            </p>
            <div id="shop-list-container">
                <div id="shop-list" class="inv-grid"></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-header"><h2 id="confirm-title">ÌôïÏù∏</h2><button class="close-btn" onclick="closeConfirm()">√ó</button></div>
        <div class="modal-body">
            <div id="confirm-msg" class="confirm-text"></div>
            <div class="confirm-btns">
                <button id="confirm-yes-btn" class="btn-yes" onclick="executeConfirm()">ÌôïÏù∏</button>
                <button id="confirm-no-btn" class="btn-no" onclick="closeConfirm()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="quest-modal" class="modal">
        <div class="modal-header"><h2>ÌÄòÏä§Ìä∏</h2><button class="close-btn" onclick="toggleModal('quest-modal')">√ó</button></div>
        <div class="modal-body" id="quest-list"></div>
    </div>

    <div id="advancement-modal" class="modal">
        <div class="modal-header"><h2>Ï†ÑÏßÅ</h2></div>
        <div class="modal-body">
            <p style="text-align:center; color:#aaa; font-size:0.9rem;">Î†àÎ≤® 5Ïóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§! ÏÉàÎ°úÏö¥ Í∏∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
            <div id="adv-list" class="adv-grid"></div>
        </div>
    </div>

    <div id="gameover-modal" class="modal">
        <div class="modal-header"><h2 style="color:var(--accent-red)">GAME OVER</h2></div>
        <div class="modal-body">
            <div class="gameover-title">ÎçòÏ†Ñ Î∂ïÍ¥¥</div>
            <div class="gameover-stats">
                <div class="go-row"><span>ÏÉùÏ°¥ ÏãúÍ∞Ñ</span><span id="go-time" class="go-val"></span></div>
                <div class="go-row"><span>Ï≤òÏπòÌïú Î™¨Ïä§ÌÑ∞</span><span id="go-kills" class="go-val"></span></div>
                <div class="go-row"><span>Ï≤òÏπòÌïú Î≥¥Ïä§</span><span id="go-boss" class="go-val"></span></div>
                <div class="go-row"><span>ÏµúÏ¢Ö Î†àÎ≤®</span><span id="go-lv" class="go-val"></span></div>
                <div class="go-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            </div>
            <button class="btn btn-start" style="width:100%; padding:15px; font-size:1.2rem;" onclick="location.href='index.html'">Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú</button>
        </div>
    </div>

    <div class="game-ui-top">
        <div style="display:flex; align-items:center;">
            <div id="game-timer">15:00</div>
            <div class="char-info">
                <h2 id="ui-info">ÏòÅÏõÖ</h2>
                <span id="ui-level">LV. 1</span>
            </div>
        </div>

        <div class="ui-bars-center">
            <div class="bar-row"><span class="bar-label">HP</span><div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill"></div><span id="ui-hp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">MP</span><div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-fill"></div><span id="ui-mp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">EXP</span><div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill"></div><span id="ui-exp-text" class="bar-text"></span></div></div>
        </div>

        <div style="display:flex; align-items:center;">
            <div class="btn-group">
                <button class="btn" onclick="openQuest()">ÌÄòÏä§Ìä∏</button>
                <button class="btn" onclick="openInventory()">Í∞ÄÎ∞©</button>
                <button class="btn" onclick="openShop()">Í∞ïÌôî</button>
                <button class="btn" onclick="manualSave()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
    <div class="canvas-wrapper"><canvas id="gameCanvas" width="960" height="640"></canvas></div>
</div>

<div id="mobile-controls">
    <div class="d-pad-btn" id="btn-up" style="grid-column: 2; grid-row: 1;">‚ñ≤</div>
    <div class="d-pad-btn" id="btn-left" style="grid-column: 1; grid-row: 2;">‚óÄ</div>
    <div class="d-pad-btn" id="btn-right" style="grid-column: 3; grid-row: 2;">‚ñ∂</div>
    <div class="d-pad-btn" id="btn-down" style="grid-column: 2; grid-row: 3;">‚ñº</div>
</div>

<script>
    const DB_URL = "https://script.google.com/macros/s/AKfycbx-QwdXFDlin0T-qdKFxau0CHm8X06CPdDWyVPMZphNbIHgvjgtjQYSGk9AEqaRBEfDeA/exec";
    const CHAR_FILES = {
        'Ï†ÑÏÇ¨': 'image/warrior.jpg', 'ÎèÑÏ†Å': 'image/rogue.jpg', 'ÎßàÎ≤ïÏÇ¨': 'image/mage.jpg',
        'Î≤ÑÏÑúÏª§': 'image/warrior1.jpg', 'Í∞ÄÎîîÏñ∏': 'image/warrior1.jpg',
        'Ïñ¥ÏåîÏã†': 'image/rogue1.jpg', 'ÏÑÄÎèÑÏö∞': 'image/rogue1.jpg',
        'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'image/mage1.jpg', 'ÏÜåÏÑúÎü¨': 'image/mage1.jpg'
    };

    const DROP_TABLE = {
        'Ï†ÑÏÇ¨': ['Í∏∞ÏÇ¨Ïùò Í≤Ä', 'ÎåÄÍ≤Ä', 'Ïö©ÏÇ¨Ïùò Í≤Ä', 'Ïã¨ÌåêÏùò ÎèÑÎÅº'],
        'ÎèÑÏ†Å': ['ÏïîÏÇ¥ÏûêÏùò Îã®ÎèÑ', 'ÏåçÍ≤Ä', 'Í∑∏Î¶ºÏûê ÎπÑÏàò'],
        'ÎßàÎ≤ïÏÇ¨': ['ÎßàÎ≤ï ÏßÄÌå°Ïù¥', 'Ïò§Î∏å', 'ÌòÑÏûêÏùò Ïä§ÌÉúÌîÑ'],
        'Î≤ÑÏÑúÏª§': ['Í¥ëÏ†ÑÏÇ¨Ïùò ÎèÑÎÅº', 'ÌîºÏùò Í≤Ä'],
        'Í∞ÄÎîîÏñ∏': ['ÏàòÌò∏ÏûêÏùò Î∞©Ìå®Í≤Ä', 'ÏÑ±Í∏∞ÏÇ¨Ïùò ÎßùÏπò'],
        'Ïñ¥ÏåîÏã†': ['Ï£ΩÏùåÏùò Ïù∏ÎèÑÏûê', 'Í∑∏Î¶ºÏûê ÏÜ°Í≥≥Îãà'],
        'ÏÑÄÎèÑÏö∞': ['Í≥µÌè¨Ïùò ÎπÑÏàò', 'Ïã¨Ïó∞Ïùò ÏπºÎÇ†'],
        'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': ['ÎåÄÎßàÎ≤ïÏÇ¨Ïùò ÏßÄÌå°Ïù¥', 'Î≥ÑÏùò Ï°∞Í∞Å'],
        'ÏÜåÏÑúÎü¨': ['ÏõêÏÜåÏùò Í∑ºÏõê', 'ÎßàÎÇòÏùò Îàà']
    };

    let player = null;
    let playerImg = new Image();
    let mapImg = new Image();
    let boss = { x: 100, y: 100, speed: 2.2, img: new Image(), alive: true, isNightBoss: false, hp: 100, maxHp: 100 };
    let superBoss = { x: 500, y: 500, speed: 3.5, img: new Image(), alive: false, hp: 1500, maxHp: 1500, name: "Ï¥àÍ∞ïÎ†• Î≥¥Ïä§" };
    superBoss.img.src = 'image/best_boss.jpg';

    const GAME_TIME_LIMIT = 15 * 60 * 1000;

    let isNight = false;
    let timeTick = 0;
    let currentWeather = "sunny"; // sunny, rain, fog, thunder

    const advBgm = new Audio('song/bgm1.mp3');
    const fieldBgm = new Audio('song/song_2.mp3');
    const angelBgm = new Audio('song/angels.mp3');
    const successSfx = new Audio('song/blackout_piano1.mp3');
    const failSfx = new Audio('song/blackout_piano2.mp3');
    const thunderSfx = new Audio('song/thunder.mp3');
    const potionSfx = new Audio('song/potion-inght.wav');
    const goldSfx = new Audio('song/gold_drop-inght.wav');
    const rainThunderSfx = new Audio('song/thunder1-inght.wav');
    const rainRuinSfx = new Audio('song/ruin-inght.wav');
    const equipSfx = new Audio('image/eqp.mp3');

    fieldBgm.loop = true;
    fieldBgm.volume = 0.15;

    let fieldItems = [];
    const potionImg = new Image(); potionImg.src = 'image/potion_hp.jpg';
    const shoesImg = new Image(); shoesImg.src = 'image/shoes.jpg';
    const atkImg = new Image(); atkImg.src = 'image/attack_10.jpg';
    const defImg = new Image(); defImg.src = 'image/Defense_10.jpg';

    let treasureBoxes = [];
    const treasureBoxImg = new Image(); treasureBoxImg.src = 'image/bm.jpg';

    let currentConfirmAction = null;

    window.onload = async function() {
        const name = localStorage.getItem('rpg_player_name');
        const temp = localStorage.getItem('rpg_temp_player');
        if (temp) { player = JSON.parse(temp); initData(); initMap(); }
        else if (name) {
            try {
                document.querySelector('.loading-text').innerText = "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...";
                document.getElementById('loading-overlay').style.display = 'flex';
                const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                player = await res.json(); initData(); initMap();
            } catch(e) { location.href='index.html'; }
        } else { location.href='index.html'; }
    };

    function initData() {
        if (!player.inventory) player.inventory = [];
        if (!player.bonusAtk) player.bonusAtk = 0;
        if (player.bonusDef === undefined) player.bonusDef = 0;
        if (player.moveSpeed === undefined) player.moveSpeed = 12;
        if (player.gold === undefined) player.gold = 0;
        if (player.traitPoints === undefined) player.traitPoints = 0;
        if (!player.traits) player.traits = { str: 0, dex: 0, con: 0, int: 0, wis: 0 };
        if (!player.quests) player.quests = {
            killCount: 0,
            dayKillCount: 0,
            nightKillCount: 0,
            bossKillCount: 0,
            enhanceCount: 0,
            claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
        };

        if (player.quests.dayKillCount === undefined) player.quests.dayKillCount = 0;
        if (player.quests.nightKillCount === undefined) player.quests.nightKillCount = 0;
        if (player.quests.bossKillCount === undefined) player.quests.bossKillCount = 0;
        if (!player.quests.claimed) player.quests.claimed = {};
        if (player.quests.claimed.dayKill === undefined) player.quests.claimed.dayKill = false;
        if (player.quests.claimed.nightKill === undefined) player.quests.claimed.nightKill = false;
        if (player.quests.claimed.bossKill === undefined) player.quests.claimed.bossKill = false;

        if (player.isAdvanced === undefined) player.isAdvanced = false;

        // Boundary check on load
        if (player.x === undefined || player.x < 16 || player.x > 944) player.x = 480;
        if (player.y === undefined || player.y < 16 || player.y > 624) player.y = 320;

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        isNight = elapsed >= 90000;
        localStorage.setItem('rpg_is_night', isNight);

        currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

        if (localStorage.getItem('rpg_open_traits') === 'true') {
            localStorage.removeItem('rpg_open_traits');
            setTimeout(() => { openInventory(); switchTab('traits'); }, 500);
        }
    }

    function getPlayerImage(job, inventory) {
        const equippedWeapon = inventory.find(i => i.type === 'weapon' && i.equipped);
        const isLegendary = equippedWeapon && equippedWeapon.rarity === 'legendary';

        if (isLegendary) {
            if (job === 'Ï†ÑÏÇ¨' || job === 'Î≤ÑÏÑúÏª§' || job === 'Í∞ÄÎîîÏñ∏') return 'image/warrior4.jpg';
            if (job === 'ÎèÑÏ†Å' || job === 'Ïñ¥ÏåîÏã†' || job === 'ÏÑÄÎèÑÏö∞') return 'image/rogue4.jpg';
            if (job === 'ÎßàÎ≤ïÏÇ¨' || job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || job === 'ÏÜåÏÑúÎü¨') return 'image/mage4.jpg';
        }
        return CHAR_FILES[job] || CHAR_FILES['Ï†ÑÏÇ¨'];
    }

    function initMap() {
        playerImg.src = getPlayerImage(player.job, player.inventory);
        mapImg.src = isNight ? 'image/map1.jpg' : 'image/map.jpg';

        mapImg.onload = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            fieldBgm.play().catch(e => console.log("BGM play failed:", e));

            const deathTime = localStorage.getItem('rpg_boss_death_time');
            const savedX = localStorage.getItem('rpg_boss_x');
            if (localStorage.getItem('rpg_boss_ran_away') === 'true') {
                localStorage.removeItem('rpg_boss_ran_away');
                boss.alive = false;
                setTimeout(spawnBossDefault, 10000);
            } else if (deathTime) {
                const diff = Date.now() - parseInt(deathTime);
                if (diff < 10000) { boss.alive = false; setTimeout(spawnBossDefault, 10000 - diff); }
                else { localStorage.removeItem('rpg_boss_death_time'); spawnBossDefault(); }
            } else if (savedX) {
                boss.x = parseFloat(savedX); boss.y = parseFloat(localStorage.getItem('rpg_boss_y')); boss.alive = true;
                boss.hp = parseFloat(localStorage.getItem('rpg_boss_hp') || 100);
                boss.maxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 100);
            } else {
                boss.alive = false; setTimeout(spawnBossDefault, 15000);
            }
            setInterval(gameLoop, 50);
            updateTimeEffect();
            updateWeatherUI();
            checkAdvancement();
            spawnFieldItem();
            spawnTreasureBox();
        };
        updateUI();
        window.addEventListener('keydown', move);
    }

    function spawnFieldItem() {
        if (fieldItems.length < 6) {
            const rand = Math.random();
            let type = 'potion';
            if (rand < 0.05) type = 'shoes';

            fieldItems.push({ x: Math.random() * 900 + 30, y: Math.random() * 600 + 30, type: type });
        }
        setTimeout(spawnFieldItem, 8000);
    }

    function spawnTreasureBox() {
        if (treasureBoxes.length < 2) {
            treasureBoxes.push({ x: Math.random() * 900 + 30, y: Math.random() * 600 + 30 });
        }
        setTimeout(spawnTreasureBox, Math.random() * 30000 + 30000);
    }

    function checkAdvancement() { if (player.level >= 5 && !player.isAdvanced) openAdvancement(); }

    function openAdvancement() {
        const modal = document.getElementById('advancement-modal');
        const list = document.getElementById('adv-list');
        list.innerHTML = '';
        fieldBgm.pause();
        advBgm.loop = true; advBgm.play().catch(e => console.log(e));

        let options = [];
        if (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Í∏∞ÏÇ¨') {
            options = [
                { job: 'Î≤ÑÏÑúÏª§', desc: 'Í≥µÍ≤© ÌäπÌôî. Ïä§ÌÇ¨ ÎåÄÎØ∏ÏßÄ ÎåÄÌè≠ ÏÉÅÏäπ.', bonus: 'Ìûò +10, HP +50', img: 'image/warrior1.jpg' },
                { job: 'Í∞ÄÎîîÏñ∏', desc: 'ÏÉùÏ°¥ ÌäπÌôî. Î∞õÎäî ÌîºÌï¥ Í∞êÏÜå.', bonus: 'Ï≤¥Î†• +15, HP +150', img: 'image/warrior1.jpg' }
            ];
        } else if (player.job === 'ÎèÑÏ†Å') {
            options = [
                { job: 'Ïñ¥ÏåîÏã†', desc: 'Í∑πÎîú ÌäπÌôî. ÏπòÎ™ÖÌÉÄ ÌôïÎ•† Î∞è Ïä§ÌÇ¨ ÌöüÏàò Ï¶ùÍ∞Ä.', bonus: 'ÎØºÏ≤© +12, ÏπòÎ™ÖÌÉÄ +15%', img: 'image/rogue1.jpg' },
                { job: 'ÏÑÄÎèÑÏö∞', desc: 'Ïú†Ìã∏ ÌäπÌôî. ÎèÖ Î∂ÄÏó¨ ÌôïÎ•† 100%.', bonus: 'ÎØºÏ≤© +8, ÏßÄÌòú +8', img: 'image/rogue1.jpg' }
            ];
        } else if (player.job === 'ÎßàÎ≤ïÏÇ¨') {
            options = [
                { job: 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', desc: 'ÌôîÎ†• ÌäπÌôî. Ïä§ÌÇ¨ ÎåÄÎØ∏ÏßÄ ÎåÄÌè≠ ÏÉÅÏäπ.', bonus: 'ÏßÄÎä• +15, MP +100', img: 'image/mage1.jpg' },
                { job: 'ÏÜåÏÑúÎü¨', desc: 'Ìö®Ïú® ÌäπÌôî. Ïä§ÌÇ¨ ÎßàÎÇò ÏÜåÎ™®Îüâ Í∞êÏÜå.', bonus: 'ÏßÄÎä• +10, ÏßÄÌòú +10', img: 'image/mage1.jpg' }
            ];
        }

        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'adv-card';
            div.innerHTML = `<img src="${opt.img}"><div class="adv-name">${opt.job}</div><div class="adv-desc">${opt.desc}</div><div class="adv-bonus">${opt.bonus}</div>`;
            div.onclick = () => askAdvancement(opt);
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }

    function askAdvancement(opt) {
        showConfirm("Ï†ÑÏßÅ ÌôïÏù∏", `${opt.job}(Ïúº)Î°ú Ï†ÑÏßÅÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.`, () => selectAdvancement(opt));
    }

    function selectAdvancement(opt) {
        player.job = opt.job; player.isAdvanced = true;
        if (opt.job === 'Î≤ÑÏÑúÏª§') { player.stats.str += 10; player.maxHp += 50; }
        else if (opt.job === 'Í∞ÄÎîîÏñ∏') { player.stats.con += 15; player.maxHp += 150; }
        else if (opt.job === 'Ïñ¥ÏåîÏã†') { player.stats.dex += 12; }
        else if (opt.job === 'ÏÑÄÎèÑÏö∞') { player.stats.dex += 8; player.stats.wis += 8; }
        else if (opt.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ') { player.stats.int += 15; player.maxMp += 100; }
        else if (opt.job === 'ÏÜåÏÑúÎü¨') { player.stats.int += 10; player.stats.wis += 10; }
        player.hp = player.maxHp; player.mp = player.maxMp;
        playerImg.src = getPlayerImage(player.job, player.inventory);
        advBgm.pause(); advBgm.currentTime = 0;

        angelBgm.play().catch(e => console.log(e));
        setTimeout(() => { fieldBgm.play(); }, 5000);

        document.getElementById('advancement-modal').style.display = 'none';
        showConfirm("Ï†ÑÏßÅ ÏÑ±Í≥µ", `Ï∂ïÌïòÌï©ÎãàÎã§! ${opt.job}(Ïúº)Î°ú Ï†ÑÏßÅÌñàÏäµÎãàÎã§!`, null, true);
        updateUI();
    }

    function updateTimeEffect() {
        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const newIsNight = elapsed >= 90000;

        if (newIsNight !== isNight) {
            isNight = newIsNight;
            mapImg.src = isNight ? 'image/map1.jpg' : 'image/map.jpg';
            localStorage.setItem('rpg_is_night', isNight);
            changeWeather();
        }

        if (isNight) {
            if (Math.random() < 0.4) {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            } else {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            }
        } else {
            boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
        }

        if (Math.floor(elapsed / 30000) > timeTick) {
            timeTick = Math.floor(elapsed / 30000);
            changeWeather();
        }
    }

    function changeWeather() {
        const weathers = ["sunny", "rain", "fog", "thunder"];
        const rand = Math.random();
        if (rand < 0.5) currentWeather = "sunny";
        else if (rand < 0.7) currentWeather = "rain";
        else if (rand < 0.85) currentWeather = "fog";
        else currentWeather = "thunder";

        localStorage.setItem('rpg_current_weather', currentWeather);
        updateWeatherUI();
    }

    function updateWeatherUI() {
        const icon = document.getElementById('weather-icon');
        const text = document.getElementById('weather-text');
        const overlay = document.getElementById('weather-overlay');
        overlay.innerHTML = '';

        if (currentWeather === "sunny") { icon.innerText = "‚òÄÔ∏è"; text.innerText = "ÎßëÏùå"; }
        else if (currentWeather === "rain") {
            icon.innerText = "üåßÔ∏è"; text.innerText = "ÎπÑ (ÎßàÎ≤ï Í∞ïÌôî / Ïù¥Îèô Ï†ÄÌïò)";
            for(let i=0; i<50; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 960 + 'px';
                drop.style.animationDelay = Math.random() * 0.8 + 's';
                overlay.appendChild(drop);
            }
            // Play rain weather sounds
            rainThunderSfx.play().catch(e => {});
            rainThunderSfx.onended = () => { rainRuinSfx.play().catch(e => {}); };
        }
        else if (currentWeather === "fog") {
            icon.innerText = "üå´Ô∏è"; text.innerText = "ÏïàÍ∞ú (Ï°∞Ïö∞Ïú® ÏÉÅÏäπ / Î™ÖÏ§ë Î≥ÄÌôî)";
            const fog = document.createElement('div');
            fog.className = 'fog-layer';
            overlay.appendChild(fog);
        }
        else if (currentWeather === "thunder") {
            icon.innerText = "‚ö°"; text.innerText = "ÎáåÏö∞ (ÎÇôÎ¢∞ Ï£ºÏùò)";
        }
    }

    function spawnBossDefault() {
        boss.x = player.x > 480 ? 100 : 800; boss.y = player.y > 320 ? 100 : 600; boss.alive = true;
        boss.maxHp = 400 + (player.level * 30);
        boss.hp = boss.maxHp;
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp);
    }

    function spawnSuperBoss() {
        superBoss.alive = true;
        superBoss.x = 480; superBoss.y = 320;
        superBoss.hp = 1500;
        superBoss.maxHp = 1500;

        const warning = document.getElementById('boss-warning');
        warning.style.display = 'block';
        setTimeout(() => { warning.style.display = 'none'; }, 5000);
    }

    function gameLoop() {
        if(!player) return;

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const remain = GAME_TIME_LIMIT - elapsed;

        if (remain <= 0) {
            document.getElementById('game-timer').innerText = "00:00";
            showGameOver("ÏãúÍ∞Ñ Ï¢ÖÎ£å! ÎçòÏ†ÑÏù¥ Î∂ïÍ¥¥ÎêòÏóàÏäµÎãàÎã§.");
            return;
        }

        if(document.querySelector('.modal[style*="flex"]')) return;

        const m = Math.floor(remain / 60000);
        const s = Math.floor((remain % 60000) / 1000);
        document.getElementById('game-timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

        updateTimeEffect();

        if (currentWeather === "thunder" && Math.random() < 0.01) {
            triggerThunder();
        }

        if (remain <= 5 * 60 * 1000 && !superBoss.alive && !localStorage.getItem('rpg_super_boss_killed')) {
            spawnSuperBoss();
        }

        if (boss.alive) {
            const dx = player.x - boss.x; const dy = player.y - boss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { boss.x += (dx / dist) * boss.speed; boss.y += (dy / dist) * boss.speed; }
            if(dist < 30) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        if (superBoss.alive) {
            const dx = player.x - superBoss.x; const dy = player.y - superBoss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { superBoss.x += (dx / dist) * superBoss.speed; superBoss.y += (dy / dist) * superBoss.speed; }
            if(dist < 40) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_boss_hp', superBoss.hp);
                localStorage.setItem('rpg_boss_max_hp', superBoss.maxHp);
                localStorage.setItem('rpg_is_super_boss', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        fieldItems = fieldItems.filter(item => {
            const dx = player.x - item.x; const dy = player.y - item.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 25) {
                if (item.type === 'potion') {
                    player.inventory.push({name:'Ï≤¥Î†• Î¨ºÏïΩ', type:'potion_hp', desc:'HP +50 ÌöåÎ≥µ', val:50});
                } else if (item.type === 'shoes') {
                    player.moveSpeed += 2;
                    showConfirm("ÏïÑÏù¥ÌÖú ÌöçÎìù", "Ïã†ÏÜçÏùò Ïû•ÌôîÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§! Ïù¥Îèô ÏÜçÎèÑÍ∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌï©ÎãàÎã§.", null, true);
                }
                return false;
            }
            return true;
        });

        treasureBoxes = treasureBoxes.filter(box => {
            const dx = player.x - box.x; const dy = player.y - box.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 30) {
                getTreasure();
                return false;
            }
            return true;
        });

        draw();
    }

    function triggerThunder() {
        const flash = document.getElementById('thunder-flash');
        flash.classList.remove('thunder-anim');
        void flash.offsetWidth;
        flash.classList.add('thunder-anim');
        if (thunderSfx) thunderSfx.play().catch(e => {});

        const pDmg = Math.floor(player.maxHp * 0.05);
        player.hp -= pDmg;

        if (boss.alive) {
            const bDmg = Math.floor(boss.maxHp * 0.03);
            boss.hp -= bDmg;
            localStorage.setItem('rpg_boss_hp', boss.hp);
            if (boss.hp <= 0) {
                boss.alive = false;
                localStorage.setItem('rpg_boss_death_time', Date.now());
            }
        }

        if (player.hp <= 0) showGameOver("Î≤ºÎùΩÏóê ÎßûÏïòÏäµÎãàÎã§...");
        updateUI();
    }

    function showGameOver(msg) {
        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const survivalTime = Math.floor((Date.now() - startTime) / 1000);
        const min = Math.floor(survivalTime / 60);
        const sec = survivalTime % 60;

        const kills = player.quests.killCount || 0;
        const bossKills = player.quests.bossKillCount || 0;

        let itemValue = 0;
        player.inventory.forEach(item => {
            const baseVal = item.val || 10;
            const enh = item.enhanceCount || 0;
            itemValue += Math.floor((baseVal * 5) + (enh * 50));
        });

        const score = (kills * 100) + (bossKills * 1000) + (survivalTime * 10) + (player.level * 500) + itemValue;

        document.querySelector('.gameover-title').innerText = msg;
        document.getElementById('go-time').innerText = `${min}Î∂Ñ ${sec}Ï¥à`;
        document.getElementById('go-kills').innerText = `${kills}ÎßàÎ¶¨`;
        document.getElementById('go-boss').innerText = `${bossKills}ÎßàÎ¶¨`;
        document.getElementById('go-lv').innerText = `LV.${player.level}`;
        document.getElementById('go-score-val').innerText = score.toLocaleString();

        // Send Ranking Data
        fetch(DB_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                type: 'ranking',
                name: player.name,
                score: score,
                job: player.job,
                level: player.level
            })
        });

        localStorage.removeItem('rpg_temp_player');
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.removeItem('rpg_boss_death_time');

        document.getElementById('gameover-modal').style.display = 'flex';
    }

    function getTreasure() {
        const jobList = DROP_TABLE[player.job] || DROP_TABLE['Ï†ÑÏÇ¨'];
        const baseName = jobList[Math.floor(Math.random() * jobList.length)];

        const rand = Math.random();
        let rarity = "common";
        let rarityColor = "#ffffff";
        let grade = Math.floor(Math.random() * 3) + 1;

        if (rand < 0.05) { rarity = "legendary"; rarityColor = "#ff8000"; grade = Math.floor(Math.random() * 6) + 15; }
        else if (rand < 0.15) { rarity = "epic"; rarityColor = "#a335ee"; grade = Math.floor(Math.random() * 5) + 10; }
        else if (rand < 0.4) { rarity = "rare"; rarityColor = "#2196f3"; grade = Math.floor(Math.random() * 4) + 5; }

        // Ï†ÑÏßÅ Ï†ÑÏóêÎäî Î†àÏ†ÑÎìúÎ¶¨ ÎìúÎ°≠ Î∂àÍ∞Ä
        if (!player.isAdvanced && rarity === "legendary") {
            rarity = "epic";
            rarityColor = "#a335ee";
            grade = Math.floor(Math.random() * 5) + 10;
        }

        const newItem = {
            name: `${rarity.toUpperCase()} ${baseName} (+${grade})`,
            type: 'weapon',
            desc: `Í≥µÍ≤©Î†• +${grade} (${player.job} Ï†ÑÏö©)`,
            val: grade,
            reqJob: player.job,
            equipped: false,
            rarity: rarity,
            rarityColor: rarityColor,
            enhanceCount: grade,
            failCount: 0,
            options: []
        };

        if (rarity !== "common") {
            const optCount = rarity === "legendary" ? 3 : (rarity === "epic" ? 1 : 1);
            const possibleOpts = [
                { name: "Ìûò", key: "str", val: Math.floor(Math.random() * 5) + 1 },
                { name: "ÎØºÏ≤©", key: "dex", val: Math.floor(Math.random() * 5) + 1 },
                { name: "Ï≤¥Î†•", key: "con", val: Math.floor(Math.random() * 5) + 1 },
                { name: "ÏßÄÎä•", key: "int", val: Math.floor(Math.random() * 5) + 1 }
            ];
            for (let i = 0; i < optCount; i++) {
                const opt = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
                newItem.options.push(opt);
                newItem.desc += `\n[ÏòµÏÖò] ${opt.name} +${opt.val}`;
            }
        }

        player.inventory.push(newItem);
        showTreasureEvent(newItem);
    }

    function showTreasureEvent(item) {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');

        text.innerText = "ÎπÑÎ∞Ä ÏÉÅÏûê Î∞úÍ≤¨!";
        rewardText.innerText = item.name;
        rewardText.style.color = item.rarityColor || '#fff';
        img.src = 'image/bm.jpg';

        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');

        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function saveBossPos() {
        if(boss.alive) { localStorage.setItem('rpg_boss_x', boss.x); localStorage.setItem('rpg_boss_y', boss.y); localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp); }
        if(superBoss.alive) { localStorage.setItem('rpg_super_boss_hp', superBoss.hp); localStorage.setItem('rpg_super_boss_max_hp', superBoss.maxHp); }
    }

    function updateUI() {
        document.getElementById('ui-info').innerText = player.name;
        document.getElementById('ui-level').innerText = `LV.${player.level} ${player.job.toUpperCase()}`;
        document.getElementById('ui-hp-bar').style.width = `${Math.min(100, (player.hp/player.maxHp)*100)}%`;
        document.getElementById('ui-mp-bar').style.width = `${Math.min(100, (player.mp/player.maxMp)*100)}%`;
        document.getElementById('ui-exp-bar').style.width = `${Math.min(100, (player.exp/player.maxExp)*100)}%`;
        document.getElementById('ui-hp-text').innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
        document.getElementById('ui-mp-text').innerText = `${Math.ceil(player.mp)}/${player.maxMp}`;
        document.getElementById('ui-exp-text').innerText = `${Math.floor(player.exp)}/${player.maxExp}`;
    }

    function draw() {
        const ctx = document.getElementById('gameCanvas').getContext('2d');
        ctx.clearRect(0, 0, 960, 640);
        ctx.drawImage(mapImg, 0, 0, 960, 640);
        fieldItems.forEach(item => {
            let img = potionImg;
            if (item.type === 'shoes') img = shoesImg;
            else if (item.type === 'attack') img = atkImg;
            else if (item.type === 'defense') img = defImg;
            ctx.drawImage(img, item.x - 12, item.y - 12, 24, 24);
        });
        treasureBoxes.forEach(box => { ctx.drawImage(treasureBoxImg, box.x - 15, box.y - 15, 30, 30); });
        ctx.drawImage(playerImg, player.x - 16, player.y - 16, 32, 32);
        if(boss.alive) ctx.drawImage(boss.img, boss.x - 25, boss.y - 25, 50, 50);
        if(superBoss.alive) ctx.drawImage(superBoss.img, superBoss.x - 40, superBoss.y - 40, 80, 80);
    }

    function toggleModal(id) {
        const modal = document.getElementById(id);
        document.querySelectorAll('.modal').forEach(m => { if(m.id !== id) m.style.display = 'none'; });
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function openInventory() { toggleModal('inventory-modal'); switchTab('inv'); }

    function switchTab(tab) {
        document.getElementById('tab-inv').classList.toggle('active', tab === 'inv');
        document.getElementById('tab-traits').classList.toggle('active', tab === 'traits');
        document.getElementById('inv-list').style.display = (tab === 'inv') ? 'grid' : 'none';
        document.getElementById('trait-list').style.display = (tab === 'traits') ? 'block' : 'none';
        if (tab === 'inv') renderInventory();
        else renderTraits();
    }

    function renderInventory() {
        const list = document.getElementById('inv-list');
        const statusPanel = document.getElementById('inv-status-panel');
        document.getElementById('inv-gold-display').innerText = `${player.gold} G`;
        const baseAtk = Math.floor(player.stats.str/1.8) + (player.level*2);
        const totalAtk = baseAtk + player.bonusAtk;

        statusPanel.innerHTML = `
            <div style="text-align:center; margin-bottom:15px;"><img src="${CHAR_FILES[player.job]}" style="width:100px; height:100px; border:1px solid #444; margin-bottom:10px;"><div style="color:var(--accent-gold); font-family:var(--font-head); font-size:1.1rem;">${player.job.toUpperCase()}</div></div>
            <div class="side-stat-row"><span class="side-stat-name">Î†àÎ≤®</span><span class="side-stat-val">${player.level}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">Ìûò</span><span class="side-stat-val">${player.stats.str}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÎØºÏ≤©</span><span class="side-stat-val">${player.stats.dex}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">Ï≤¥Î†•</span><span class="side-stat-val">${player.stats.con}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÏßÄÎä•</span><span class="side-stat-val">${player.stats.int}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÏßÄÌòú</span><span class="side-stat-val">${player.stats.wis}</span></div>
            <div class="side-stat-row" style="margin-top:15px; border-top:1px solid #333;"><span class="side-stat-name" style="color:#ef5350">Ï¥ù Í≥µÍ≤©Î†•</span><div class="side-atk-val">${totalAtk}${player.bonusAtk > 0 ? `<span class="side-bonus">(+${player.bonusAtk})</span>` : ''}</div></div>
            <div class="side-stat-row"><span class="side-stat-name" style="color:#2196f3">Ï∂îÍ∞Ä Î∞©Ïñ¥Î†•</span><div class="side-stat-val">${player.bonusDef}</div></div>
        `;

        list.innerHTML = '';
        if(player.inventory.length === 0) list.innerHTML = '<p style="color:#666; grid-column:span 3; text-align:center; padding:20px;">Í∞ÄÎ∞©Ïù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.</p>';
        player.inventory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `item-card ${item.equipped ? 'equipped' : ''}`;
            const typeText = item.type.includes('potion') || item.type.includes('scroll') ? 'ÏÜåÎ™®Ìíà' : 'Ïû•ÎπÑ';
            const typeColor = item.type.includes('potion') || item.type.includes('scroll') ? '#ef5350' : '#26a69a';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : (item.equipped ? 'color:var(--accent-gold)' : '');
            const baseVal = item.val || 10; const enh = item.enhanceCount || 0; const sellPrice = Math.floor((baseVal * 5) + (enh * 50));
            div.innerHTML = `<div><div class="item-name ${rarityClass}" style="${nameStyle}">${item.name}</div><div class="item-desc">${item.desc.replace(/\n/g, '<br>')}</div><div class="item-price">ÌåêÎß§Í∞Ä: <span style="color:gold">${sellPrice} G</span></div></div><div class="item-type" style="color:${typeColor}">${typeText}</div><button class="sell-btn" onclick="askSell(${index}); event.stopPropagation();">ÌåêÎß§</button>`;
            div.onclick = () => useItem(index);
            list.appendChild(div);
        });
    }

    function renderTraits() {
        const list = document.getElementById('trait-list');
        list.innerHTML = `<div class="trait-point-display">Î≥¥Ïú† ÌäπÏÑ± Ìè¨Ïù∏Ìä∏: ${player.traitPoints}</div>`;

        const traitData = [
            { key: 'str', name: 'Í∑ºÎ†• Í∞ïÌôî', desc: 'Ìûò Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'dex', name: 'ÎØºÏ≤© Í∞ïÌôî', desc: 'ÎØºÏ≤© Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'con', name: 'Ï≤¥Î†• Í∞ïÌôî', desc: 'Ï≤¥Î†• Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'int', name: 'ÏßÄÎä• Í∞ïÌôî', desc: 'ÏßÄÎä• Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'wis', name: 'ÏßÄÌòú Í∞ïÌôî', desc: 'ÏßÄÌòú Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' }
        ];

        traitData.forEach(t => {
            const lv = player.traits[t.key] || 0;
            const div = document.createElement('div');
            div.className = 'trait-item';
            div.innerHTML = `
                <div class="trait-info">
                    <div class="trait-name">${t.name}</div>
                    <div class="trait-desc">${t.desc}</div>
                </div>
                <div class="trait-level">Lv. ${lv}</div>
                <button class="trait-up-btn" onclick="upgradeTrait('${t.key}')" ${player.traitPoints <= 0 ? 'disabled' : ''}>Í∞ïÌôî</button>
            `;
            list.appendChild(div);
        });
    }

    function upgradeTrait(key) {
        if (player.traitPoints <= 0) return;
        player.traitPoints--;
        player.traits[key]++;
        player.stats[key]++;

        if (key === 'con') { player.maxHp += 2; player.hp += 2; }
        if (key === 'int' || key === 'wis') { player.maxMp += 2; player.mp += 2; }

        renderTraits();
        updateUI();
    }

    function openShop() { toggleModal('shop-modal'); renderShopList(); }

    function renderShopList() {
        const list = document.getElementById('shop-list');
        document.getElementById('shop-gold-display').innerText = `${player.gold} GOLD`;
        list.innerHTML = '';
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if(weapons.length === 0) { list.innerHTML = '<p style="color:#666; grid-column:span 4; text-align:center;">Í∞ïÌôîÌï† Î¨¥Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'; return; }
        weapons.forEach(({ item, idx }) => {
            const enhanceLv = item.enhanceCount !== undefined ? item.enhanceCount : 0;
            const cost = (enhanceLv + 1) * 50;
            let successRate = 100;
            if (enhanceLv < 5) successRate = 100;
            else if (enhanceLv < 10) successRate = 100 - (enhanceLv - 4) * 10;
            else if (enhanceLv < 15) successRate = 45 - (enhanceLv - 10) * 5;
            else successRate = Math.max(5, 20 - (enhanceLv - 15) * 3);
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}" style="${nameStyle}">${item.name}</div><div class="item-desc">ÌòÑÏû¨: +${enhanceLv}</div><div class="item-desc" style="color:#888; margin-top:5px;">ÎπÑÏö©: <span style="color:var(--accent-gold)">${cost} G</span> | ÌôïÎ•†: ${successRate}%</div><button class="enhance-btn" onclick="askEnhance(${idx}, ${cost}, ${successRate}, ${enhanceLv})">Í∞ïÌôîÌïòÍ∏∞</button>`;
            if(enhanceLv >= 20) { div.querySelector('button').disabled = true; div.querySelector('button').innerText = "ÏµúÎåÄ Î†àÎ≤®"; }
            list.appendChild(div);
        });
    }

    function showConfirm(title, msg, onYes, onlyOk = false) {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerText = msg;
        document.getElementById('confirm-no-btn').style.display = onlyOk ? 'none' : 'block';
        document.getElementById('confirm-yes-btn').innerText = onlyOk ? 'ÌôïÏù∏' : 'Ïòà';
        currentConfirmAction = onYes;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function executeConfirm() {
        const action = currentConfirmAction;
        closeConfirm();
        if (action) action();
    }

    function askEnhance(index, cost, rate, currentLv) {
        if(player.gold < cost) return showConfirm("Í≥®Îìú Î∂ÄÏ°±", "Í∞ïÌôîÏóê ÌïÑÏöîÌïú Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", null, true);
        showConfirm("Í∞ïÌôî ÌôïÏù∏", `${cost}GÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Í∞ïÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(ÌôïÎ•†: ${rate}%)`, () => executeEnhance(index, cost, rate, currentLv));
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
        currentConfirmAction = null;
    }

    function executeEnhance(index, cost, rate, currentLv) {
        player.gold -= cost;
        const item = player.inventory[index];
        const isSuccess = Math.random() * 100 < rate;

        if(isSuccess) {
            item.enhanceCount = (item.enhanceCount || currentLv) + 1;
            item.val += 1;
            item.desc = item.desc.replace(/\+\d+/, `+${item.val}`);
            if(item.name.match(/\(\+\d+\)/)) item.name = item.name.replace(/\(\+\d+\)/, `(+${item.enhanceCount})`);
            else item.name += ` (+${item.enhanceCount})`;
            if(item.equipped) player.bonusAtk += 1;
            player.quests.enhanceCount++;
            item.failCount = 0; // Reset fail count on success
            showEnhanceEffect();
            successSfx.play().catch(e => console.log(e));
        } else {
            item.failCount = (item.failCount || 0) + 1;
            if (item.failCount >= 3) {
                if(item.equipped) {
                    player.bonusAtk -= item.val;
                    if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
                }
                player.inventory.splice(index, 1);
                showConfirm("Í∞ïÌôî Ïã§Ìå®", "Í∞ïÌôîÏóê 3Î≤à Ïã§Ìå®ÌïòÏó¨ Î¨¥Í∏∞Í∞Ä ÌååÍ¥¥ÎêòÏóàÏäµÎãàÎã§!", null, true);
            } else {
                showConfirm("Í∞ïÌôî Ïã§Ìå®", `Í∞ïÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§... (Ïó∞ÏÜç Ïã§Ìå®: ${item.failCount}/3)\nÍ≥®ÎìúÎßå ÏÜåÎ™®ÎêòÏóàÏäµÎãàÎã§.`, null, true);
            }
            failSfx.play().catch(e => console.log(e));
        }
        updateUI(); renderShopList();
    }

    function openQuest() { toggleModal('quest-modal'); renderQuestList(); }

    function renderQuestList() {
        const list = document.getElementById('quest-list');
        list.innerHTML = '';
        const quests = [
            { id: 'dayKill', title: 'ÎÇÆÏùò ÏÇ¨ÎÉ•Íæº', desc: 'ÎÇÆ Î™¨Ïä§ÌÑ∞ 5ÎßàÎ¶¨ Ï≤òÏπò', goal: 5, current: player.quests.dayKillCount || 0, reward: '500 G', claimed: player.quests.claimed.dayKill },
            { id: 'nightKill', title: 'Î∞§Ïùò Ï∂îÏ†ÅÏûê', desc: 'Î∞§ Î™¨Ïä§ÌÑ∞ 5ÎßàÎ¶¨ Ï≤òÏπò', goal: 5, current: player.quests.nightKillCount || 0, reward: '800 G', claimed: player.quests.claimed.nightKill },
            { id: 'bossKill', title: 'Î≥¥Ïä§ Ïä¨Î†àÏù¥Ïñ¥', desc: 'Î≥¥Ïä§ Î™¨Ïä§ÌÑ∞ 1ÎßàÎ¶¨ Ï≤òÏπò', goal: 1, current: player.quests.bossKillCount || 0, reward: '2000 G', claimed: player.quests.claimed.bossKill },
            { id: 'enhance', title: 'Í∞ïÌôîÏùò Îã¨Ïù∏', desc: 'Í∞ïÌôî 1Ìöå ÏÑ±Í≥µ', goal: 1, current: player.quests.enhanceCount, reward: '300 G', claimed: player.quests.claimed.enhance }
        ];
        quests.forEach(q => {
            const div = document.createElement('div');
            div.className = 'quest-item';
            const isComplete = q.current >= q.goal;
            const btnText = q.claimed ? 'Î≥¥ÏÉÅ ÏàòÎ†π ÏôÑÎ£å' : (isComplete ? 'Î≥¥ÏÉÅ Î∞õÍ∏∞' : 'ÏßÑÌñâ Ï§ë');
            div.innerHTML = `<div class="quest-title">${q.title}</div><div class="quest-progress">${q.desc} (${Math.min(q.current, q.goal)}/${q.goal})</div><div class="quest-reward">Î≥¥ÏÉÅ: ${q.reward}</div><button class="quest-claim-btn" onclick="claimQuest('${q.id}')" ${(!isComplete || q.claimed) ? 'disabled' : ''}>${btnText}</button>`;
            list.appendChild(div);
        });
    }

    function claimQuest(id) {
        if (id === 'dayKill' && !player.quests.claimed.dayKill) { player.gold += 500; player.quests.claimed.dayKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "500 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'nightKill' && !player.quests.claimed.nightKill) { player.gold += 800; player.quests.claimed.nightKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "800 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'bossKill' && !player.quests.claimed.bossKill) { player.gold += 2000; player.quests.claimed.bossKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "2000 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'enhance' && !player.quests.claimed.enhance) { player.gold += 300; player.quests.claimed.enhance = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "300 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        updateUI(); renderQuestList();
    }

    function showEnhanceEffect() {
        const el = document.getElementById('enhance-effect');
        el.classList.remove('enhance-anim'); void el.offsetWidth; el.classList.add('enhance-anim');
    }

    function useItem(index) {
        const item = player.inventory[index];
        if (item.type.includes('potion') || item.type.includes('scroll')) {
            if (player.hp >= player.maxHp && item.name.includes('Ï≤¥Î†•')) return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï≤¥Î†•Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", null, true);
            if (player.mp >= player.maxMp && item.name.includes('ÎßàÎÇò')) return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "ÎßàÎÇòÍ∞Ä Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", null, true);

            if (item.name.includes('Ï≤¥Î†•')) { player.hp = Math.min(player.hp + item.val, player.maxHp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('ÎßàÎÇò')) { player.mp = Math.min(player.mp + item.val, player.maxMp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('Í≤ΩÌóòÏπò')) {
                player.exp += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Í≤ΩÌóòÏπòÎ•º ${item.val} ÌöçÎìùÌñàÏäµÎãàÎã§!`, null, true);
                if (player.exp >= player.maxExp) {
                    player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
                    player.traitPoints += 2;
                    showConfirm("Î†àÎ≤® ÏóÖ!", "Î†àÎ≤® ÏóÖ! ÌäπÏÑ± Ìè¨Ïù∏Ìä∏ 2Í∞úÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§.", () => { checkAdvancement(); }, true);
                }
            } else if (item.type === 'potion_atk') {
                player.bonusAtk += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Í≥µÍ≤©Î†•Ïù¥ ${item.val}ÎßåÌÅº ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§!`, null, true);
            } else if (item.type === 'potion_def') {
                player.bonusDef += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Î∞©Ïñ¥Î†•Ïù¥ ${item.val}ÎßåÌÅº ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§!`, null, true);
            } else if (item.type === 'scroll_option') {
                // ÏòµÏÖò Î∂ÄÏó¨ Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö© Î°úÏßÅ
                showOptionScrollUI(index);
                return; // UIÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑú Ï¢ÖÎ£å
            } else if (item.type === 'potion_skeleton') {
                // Ìï¥Í≥® Ìè¨ÏÖòÏùÄ Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö© Í∞ÄÎä•ÌïòÎØÄÎ°ú ÎßµÏóêÏÑúÎäî ÏÇ¨Ïö© Î∂àÍ∞Ä Î©îÏãúÏßÄ
                return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§.", null, true);
            } else if (item.type === 'potion_focus' || item.type === 'potion_holy' || item.type === 'potion_madness') {
                return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§.", null, true);
            }

            player.inventory.splice(index, 1);
            if (!item.name.includes('Í≤ΩÌóòÏπò') && !item.type.includes('atk') && !item.type.includes('def')) showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `${item.name}ÏùÑ(Î•º) ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.`, null, true);
        } else if (item.type === 'weapon') {
            if (item.reqJob && item.reqJob !== player.job) return showConfirm("Ï∞©Ïö© Î∂àÍ∞Ä", `[${item.reqJob}] Ï†ÑÏö© Ïû•ÎπÑÏûÖÎãàÎã§.`, null, true);
            if (item.equipped) {
                item.equipped = false;
                player.bonusAtk -= item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            }
            else {
                player.inventory.forEach(i => {
                    if (i.type === 'weapon' && i.equipped) {
                        i.equipped = false;
                        player.bonusAtk -= i.val;
                        if (i.options) i.options.forEach(opt => player.stats[opt.key] -= opt.val);
                    }
                });
                item.equipped = true;
                player.bonusAtk += item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] += opt.val);
                equipSfx.play().catch(e => {});
            }
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        renderInventory(); updateUI();
    }

    function showOptionScrollUI(scrollIndex) {
        // Ïû•ÎπÑ Î™©Î°ùÏùÑ Î≥¥Ïó¨Ï£ºÍ≥† ÏÑ†ÌÉùÌïòÍ≤å Ìï®
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if (weapons.length === 0) {
            return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "ÏòµÏÖòÏùÑ Î∂ÄÏó¨Ìï† Ïû•ÎπÑÍ∞Ä ÏóÜÏäµÎãàÎã§.", null, true);
        }

        // Í∞ÑÎã®ÌïòÍ≤å ÌîÑÎ°¨ÌîÑÌä∏ÎÇò Ïª®ÌéåÏúºÎ°ú Ï≤òÎ¶¨ÌïòÍ∏∞Ïóî Î≥µÏû°ÌïòÎØÄÎ°ú,
        // Í∏∞Ï°¥ ÏÉÅÏ†ê Î™®Îã¨ÏùÑ Ïû¨ÌôúÏö©ÌïòÍ±∞ÎÇò ÏÉàÎ°úÏö¥ Î™®Îã¨ÏùÑ ÎùÑÏõåÏïº Ìï®.
        // Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®Ìûà confirmÏúºÎ°ú Ï≤´ Î≤àÏß∏ Ïû•ÎπÑÎ∂ÄÌÑ∞ ÏàúÌöåÌïòÎ©∞ Î¨ºÏñ¥Î≥¥Îäî Î∞©ÏãùÎ≥¥Îã§Îäî
        // Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö© Ïãú Ïû•ÎπÑ ÏÑ†ÌÉù Î™®Îã¨ÏùÑ ÎùÑÏö∞Îäî Í≤ÉÏù¥ Ï¢ãÏùå.
        // ÌïòÏßÄÎßå ÏΩîÎìú Î≥µÏû°ÎèÑÎ•º Ï§ÑÏù¥Í∏∞ ÏúÑÌï¥, ÌòÑÏû¨ Ï∞©Ïö© Ï§ëÏù∏ Ïû•ÎπÑÏóê Ïö∞ÏÑ† Ï†ÅÏö©ÌïòÍ±∞ÎÇò
        // Ïù∏Î≤§ÌÜ†Î¶¨ÏóêÏÑú Ïû•ÎπÑÎ•º ÌÅ¥Î¶≠ÌñàÏùÑ Îïå 'Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö©' Î≤ÑÌäºÏù¥ ÎÇòÏò§Í≤å ÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏùå.

        // Ïó¨Í∏∞ÏÑúÎäî "ÏòµÏÖò Î∂ÄÏó¨ Ïä§ÌÅ¨Î°§"ÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑ Îïå -> "Ïû•ÎπÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî" ÏïåÎ¶º ÌõÑ
        // Ïù∏Î≤§ÌÜ†Î¶¨Ïùò Ïû•ÎπÑÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ Ïä§ÌÅ¨Î°§ÏùÑ ÏÇ¨Ïö©Ìï†ÏßÄ Î¨ªÎäî Î∞©ÏãùÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÎäî Í≤ÉÏù¥ UXÏÉÅ Ï¢ãÏùå.
        // ÌïòÏßÄÎßå ÌòÑÏû¨ Íµ¨Ï°∞ÏÉÅ Î≥µÏû°ÌïòÎØÄÎ°ú,
        // Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö© Ïãú -> [Í∞ïÌôî] Î™®Îã¨Ï≤òÎüº Ïû•ÎπÑ Î¶¨Ïä§Ìä∏Î•º ÎùÑÏö∞Í≥† ÏÑ†ÌÉùÌïòÍ≤å ÌïòÎäî Î∞©ÏãùÏùÑ ÏÇ¨Ïö©.

        toggleModal('inventory-modal'); // Ïù∏Î≤§ÌÜ†Î¶¨ Îã´Í∏∞

        // ÏûÑÏãúÎ°ú shop-modalÏùÑ Ïû¨ÌôúÏö©ÌïòÏó¨ Ïû•ÎπÑ ÏÑ†ÌÉù Ïú†ÎèÑ
        const modal = document.getElementById('shop-modal');
        const list = document.getElementById('shop-list');
        const title = modal.querySelector('h2');
        const originalTitle = title.innerText;

        title.innerText = "ÏòµÏÖò Î∂ÄÏó¨ ÎåÄÏÉÅ ÏÑ†ÌÉù";
        document.getElementById('shop-gold-display').style.display = 'none';

        list.innerHTML = '';
        weapons.forEach(({ item, idx }) => {
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}">${item.name}</div><div class="item-desc">${item.desc}</div><button class="enhance-btn" onclick="applyOptionScroll(${scrollIndex}, ${idx})">ÏÑ†ÌÉù</button>`;
            list.appendChild(div);
        });

        // Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº Ïû¨Ï†ïÏùò (ÏõêÏÉÅÎ≥µÍµ¨ ÌïÑÏöî)
        const closeBtn = modal.querySelector('.close-btn');
        const originalOnClick = closeBtn.onclick;
        closeBtn.onclick = () => {
            toggleModal('shop-modal');
            title.innerText = originalTitle;
            document.getElementById('shop-gold-display').style.display = 'block';
            closeBtn.onclick = originalOnClick;
        };

        toggleModal('shop-modal');
    }

    function applyOptionScroll(scrollIndex, itemIndex) {
        const item = player.inventory[itemIndex];

        // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ (Ïä§ÌÉØ Ï∞®Í∞ê)
        if (item.equipped && item.options) {
            item.options.forEach(opt => player.stats[opt.key] -= opt.val);
        }

        // ÏÉàÎ°úÏö¥ ÏòµÏÖò ÏÉùÏÑ±
        const optCount = Math.floor(Math.random() * 3) + 1; // 1~3Í∞ú
        const newOptions = [];
        const possibleOpts = [
            { name: "Ìûò", key: "str" },
            { name: "ÎØºÏ≤©", key: "dex" },
            { name: "Ï≤¥Î†•", key: "con" },
            { name: "ÏßÄÎä•", key: "int" }
        ];

        let descText = `Í≥µÍ≤©Î†• +${item.val} (${item.reqJob || player.job} Ï†ÑÏö©)`;

        for(let i=0; i<optCount; i++) {
            const type = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
            const val = Math.floor(Math.random() * 5) + 1; // 1~5
            newOptions.push({ name: type.name, key: type.key, val: val });
            descText += `\n[ÏòµÏÖò] ${type.name} +${val}`;
        }

        item.options = newOptions;
        item.desc = descText;

        // ÏÉà ÏòµÏÖò Ï†ÅÏö© (Ïä§ÌÉØ Í∞ÄÏÇ∞)
        if (item.equipped) {
            item.options.forEach(opt => player.stats[opt.key] += opt.val);
        }

        // Ïä§ÌÅ¨Î°§ ÏÜåÎ™®
        player.inventory.splice(scrollIndex, 1);

        // Î™®Îã¨ Îã´Í∏∞ Î∞è Î≥µÍµ¨
        const modal = document.getElementById('shop-modal');
        toggleModal('shop-modal');
        modal.querySelector('h2').innerText = "ÎåÄÏû•Í∞Ñ";
        document.getElementById('shop-gold-display').style.display = 'block';

        showConfirm("ÏòµÏÖò Î∂ÄÏó¨ ÏÑ±Í≥µ", `${item.name}Ïóê ÏÉàÎ°úÏö¥ ÏòµÏÖòÏù¥ Î∂ÄÏó¨ÎêòÏóàÏäµÎãàÎã§!`, null, true);
        updateUI();
    }

    function askSell(index) {
        const item = player.inventory[index];
        const baseVal = item.val || 10; const enh = item.enhanceCount || 0; const price = Math.floor((baseVal * 5) + (enh * 50));
        showConfirm("ÌåêÎß§ ÌôïÏù∏", `[${item.name}]ÏùÑ(Î•º) ${price} GÏóê ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => sellItem(index, price));
    }

    function sellItem(index, price) {
        const item = player.inventory[index];
        if(item.equipped) {
            player.bonusAtk -= item.val;
            if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        player.gold += price; player.inventory.splice(index, 1);
        renderInventory(); updateUI();
    }

    async function manualSave() {
        const overlay = document.getElementById('loading-overlay');
        const txt = document.querySelector('.loading-text');
        txt.innerText = "Ï†ÄÏû• Ï§ë..."; overlay.style.display = 'flex';

        try {
            if (!player.name) {
                player.name = localStorage.getItem('rpg_player_name');
            }

            await fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(player)
            });

            localStorage.removeItem('rpg_temp_player');
            setTimeout(() => {
                overlay.style.display = 'none';
                showConfirm("Ï†ÄÏû• ÏôÑÎ£å", "Îç∞Ïù¥ÌÑ∞Í∞Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!", null, true);
            }, 1500);

        } catch(e) {
            console.error("Save Error:", e);
            showConfirm("Ï†ÄÏû• Ïã§Ìå®", "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", null, true);
            overlay.style.display = 'none';
        }
    }

    function showRandomEvent() {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');
        const events = [
            { t: "Î≥¥Î¨º Î∞úÍ≤¨!", g: 200, h: 0, m: 0, i: "image/bm.jpg", r: "+200 Í≥®Îìú" },
            { t: "Í≥†ÎåÄÏùò ÏÉò!", g: 0, h: 50, m: 30, i: "image/bm.jpg", r: "+50 HP / +30 MP" },
            { t: "ÌñâÏö¥Ïùò ÎèôÏ†Ñ!", g: 100, h: 0, m: 0, i: "image/bm.jpg", r: "+100 Í≥®Îìú" }
        ];
        const ev = events[Math.floor(Math.random() * events.length)];
        text.innerText = ev.t; rewardText.innerText = ev.r; img.src = ev.i;
        player.gold += ev.g; player.hp = Math.min(player.hp + ev.h, player.maxHp); player.mp = Math.min(player.mp + ev.m, player.maxMp);
        if (ev.g > 0) goldSfx.play().catch(e => {});
        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');
        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function move(e) {
        if(document.querySelector('.modal[style*="flex"]')) return;
        let s = player.moveSpeed || 12;
        if (currentWeather === "rain") s *= 0.7;

        let m = false;
        if (e.key === "ArrowUp") { player.y = Math.max(16, player.y - s); m = true; }
        if (e.key === "ArrowDown") { player.y = Math.min(624, player.y + s); m = true; }
        if (e.key === "ArrowLeft") { player.x = Math.max(16, player.x - s); m = true; }
        if (e.key === "ArrowRight") { player.x = Math.min(944, player.x + s); m = true; }
        if (m) {
            const rand = Math.random();
            let eventChance = isNight ? 0.02 : 0.01; // Reduced event chance
            let encounterChance = 0.06;

            if (currentWeather === "fog") {
                eventChance *= 1.5;
                encounterChance *= 2.0;
            }

            if (rand < eventChance) showRandomEvent();
            else if (rand < encounterChance) {
                saveBossPos(); localStorage.removeItem('rpg_boss_encounter');
                localStorage.setItem('rpg_is_night', isNight);
                localStorage.setItem('rpg_temp_player', JSON.stringify(player)); location.href = 'battle.html';
            }
        }
    }

    // Mobile Control Logic
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.getElementById('mobile-controls').style.display = 'grid';
    }

    let moveTimer = null;
    function handleMobilePress(key) {
        if (moveTimer) clearInterval(moveTimer);
        move({key: key});
        moveTimer = setInterval(() => {
            move({key: key});
        }, 100);
    }
    function handleMobileRelease() {
        if (moveTimer) clearInterval(moveTimer);
        moveTimer = null;
    }

    const dPadButtons = [
        { id: 'btn-up', key: 'ArrowUp' },
        { id: 'btn-down', key: 'ArrowDown' },
        { id: 'btn-left', key: 'ArrowLeft' },
        { id: 'btn-right', key: 'ArrowRight' }
    ];

    dPadButtons.forEach(btn => {
        const el = document.getElementById(btn.id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); handleMobilePress(btn.key); }, {passive: false});
        el.addEventListener('touchend', (e) => { e.preventDefault(); handleMobileRelease(); });
        el.addEventListener('mousedown', (e) => { handleMobilePress(btn.key); });
        el.addEventListener('mouseup', (e) => { handleMobileRelease(); });
        el.addEventListener('mouseleave', (e) => { handleMobileRelease(); });
    });
</script>
</body>
</html>