<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DUNGEON RPG - Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Noto+Serif+KR:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(18, 18, 24, 0.95);
            --border-color: #5c4d3c;
            --accent-gold: #c5a059;
            --accent-red: #d32f2f;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --hp-grad: linear-gradient(90deg, #8b0000, #b71c1c);
            --mp-grad: linear-gradient(90deg, #0d47a1, #1565c0);
            --exp-grad: linear-gradient(90deg, #4a148c, #6a1b9a);
            --font-head: 'Cinzel', serif;
            --font-body: 'Noto Serif KR', 'Inter', sans-serif;

            /* Bag Theme Colors */
            --bag-bg: #3e2723;
            --bag-panel: #4e342e;
            --bag-border: #6d4c41;
            --bag-item: #5d4037;

            /* Rarity Colors */
            --rarity-common: #ffffff;
            --rarity-rare: #2196f3;
            --rarity-epic: #a335ee;
            --rarity-legendary: #ff8000;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #1a1a20 0%, #000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: auto;
            user-select: none;
        }

        #game-container {
            width: 960px;
            height: 780px;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 4px;
            transition: width 0.1s, height 0.1s;
        }

        .game-ui-top {
            height: 140px;
            background: linear-gradient(180deg, #141414 0%, #0a0a0a 100%);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 20;
            position: relative;
        }

        .char-info { display: flex; flex-direction: column; justify-content: center; min-width: 150px; }
        .char-info h2 {
            font-family: var(--font-head); color: var(--accent-gold); margin: 0;
            font-size: 1.1rem; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .char-info span { font-family: var(--font-body); color: var(--text-muted); font-size: 0.75rem; margin-top: 2px; font-weight: 600; }

        #game-timer {
            font-family: var(--font-body); font-weight: 700; font-size: 1.5rem; color: #ef5350;
            text-shadow: 0 0 10px rgba(239, 83, 80, 0.4); min-width: 80px; text-align: center; letter-spacing: 1px;
            margin-right: 20px;
        }

        .ui-bars-center {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 320px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .bar-row { display: flex; align-items: center; gap: 8px; position: relative; }
        .bar-label {
            position: absolute; left: 8px; z-index: 2;
            color: #fff; font-family: var(--font-body); font-size: 0.7rem; font-weight: 800;
            text-shadow: 1px 1px 2px #000;
        }
        .bar-bg {
            flex: 1; height: 14px; background: #222; border: 1px solid #444;
            border-radius: 4px; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; border-radius: 3px; position: relative; }
        .bar-fill::after { content:""; position:absolute; top:0; left:0; width:100%; height:50%; background:rgba(255,255,255,0.15); }

        .hp-fill { background: linear-gradient(90deg, #c62828, #ff5252); }
        .mp-fill { background: linear-gradient(90deg, #1565c0, #448aff); }
        .exp-fill { background: linear-gradient(90deg, #4a148c, #6a1b9a); }

        .bar-text {
            position: absolute; right: 8px; top: 0; height: 100%;
            display: flex; align-items: center; font-size: 0.65rem;
            color: #fff; text-shadow: 1px 1px 2px #000; font-weight: bold; z-index: 2;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            align-items: center;
            position: absolute;
            left: calc(50% + 190px);
            top: 50%;
            transform: translateY(-50%);
        }
        .menu-icon {
            width: 45px; height: 45px; cursor: pointer; transition: all 0.2s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .menu-icon:hover {
            transform: scale(1.1) translateY(-2px);
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
        }
        .menu-icon:active { transform: scale(0.95); }

        .canvas-wrapper { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        canvas { image-rendering: pixelated; transition: width 0.1s, height 0.1s; }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(12, 12, 14, 0.98); border: 1px solid #444; display: none; flex-direction: column;
            z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-radius: 4px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #2a2a2a; }
        .modal-header h2 { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.2rem; margin: 0; letter-spacing: 2px; }
        .close-btn { background: none; border: none; color: #555; font-family: var(--font-body); cursor: pointer; font-size: 1.2rem; transition: color 0.2s; }
        .close-btn:hover { color: #fff; }

        .modal-body { padding: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* Inventory Modal Bag Theme */
        #inventory-modal {
            width: 920px; height: 620px;
            background: var(--bag-bg);
            border: 3px solid var(--bag-border);
            box-shadow: 0 0 30px rgba(0,0,0,0.7), inset 0 0 50px rgba(0,0,0,0.3);
        }
        #inventory-modal .modal-header { border-bottom: 2px solid var(--bag-border); background: rgba(0,0,0,0.2); }
        #inventory-modal .modal-body { background: var(--bag-panel); overflow-y: auto; }
        #inventory-modal .modal-body::-webkit-scrollbar { width: 8px; }
        #inventory-modal .modal-body::-webkit-scrollbar-thumb { background: var(--bag-border); border-radius: 4px; }

        #shop-modal { width: 920px; height: 620px; }
        #shop-list-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        #shop-list-container::-webkit-scrollbar { width: 8px; }
        #shop-list-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        #quest-modal { width: 500px; height: 550px; }
        #quest-modal .modal-body { overflow-y: auto; }
        #quest-modal .modal-body::-webkit-scrollbar { width: 6px; }
        #quest-modal .modal-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        #advancement-modal { width: 600px; height: 500px; }

        /* Merchant Slot Machine Styles */
        .slot-machine-container {
            background: #222;
            border: 4px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
        }
        .slot-window {
            width: 120px;
            height: 120px;
            background: #000;
            border: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        #slot-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .slot-spinning {
            animation: slotSpin 0.1s infinite linear;
        }
        @keyframes slotSpin {
            0% { transform: translateY(-10px); filter: blur(2px); }
            50% { transform: translateY(10px); filter: blur(2px); }
            100% { transform: translateY(-10px); filter: blur(2px); }
        }
        #slot-result {
            font-family: var(--font-body);
            font-size: 1.2rem;
            font-weight: bold;
            height: 1.5em;
            text-align: center;
        }

        /* Custom Confirm Modal */
        #confirm-modal { width: 400px; height: auto; min-height: 200px; z-index: 200; }
        .confirm-text { color: #eee; text-align: center; font-size: 1.1rem; margin-bottom: 25px; line-height: 1.6; }
        .confirm-btns { display: flex; gap: 15px; justify-content: center; }
        .btn-yes { background: var(--accent-gold); color: #000; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-no { background: #444; color: #fff; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; }
        .btn-yes:hover { background: #fff; }
        .btn-no:hover { background: #666; }

        /* GameOver Modal */
        #gameover-modal { width: 520px; height: auto; z-index: 1000; border: 2px solid var(--accent-red); }
        .gameover-title { font-family: var(--font-head); font-size: 2.5rem; color: var(--accent-red); text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .gameover-stats { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .go-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.1rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .go-label { display: flex; align-items: center; gap: 8px; }
        .go-val { color: var(--accent-gold); font-weight: bold; }
        .go-score { font-size: 2rem; color: #fff; text-align: center; margin-top: 15px; border-top: 2px solid #444; padding-top: 15px; font-family: var(--font-head); letter-spacing: 2px; }

        .inv-container { display: flex; gap: 20px; height: auto; min-height: 100%; }
        .inv-status-side {
            flex: 0 0 220px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            padding: 15px; border-radius: 4px; display: flex; flex-direction: column; height: fit-content;
        }
        .inv-grid-side { flex: 1; padding-right: 5px; }

        .inv-header-gold {
            color: var(--accent-gold); font-family: var(--font-body); font-weight: 600; font-size: 0.9rem; margin-right: 15px;
        }

        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }

        .item-card {
            background: var(--bag-item); border: 1px solid var(--bag-border); border-radius: 4px; padding: 10px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 140px; position: relative; cursor: pointer; transition: 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            min-width: 0;
        }
        .item-card:hover { border-color: #fff; background: #6d4c41; }
        .item-card.equipped { border-color: var(--accent-gold); background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

        .item-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px #000;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.25;
            min-height: 2.5em;
            word-break: keep-all;
        }
        .item-desc { font-size: 0.7rem; color: #d7ccc8; line-height: 1.4; }
        .item-price { font-size: 0.65rem; color: #bcaaa4; margin-top: 5px; font-family: var(--font-body); }
        .item-type { font-size: 0.6rem; margin-top: 8px; color: #a1887f; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }

        .sell-btn {
            position: absolute; bottom: 8px; right: 8px;
            padding: 4px 8px; background: #d32f2f; color: #fff; border: 1px solid #b71c1c; border-radius: 3px;
            font-size: 0.7rem; font-family: var(--font-body); cursor: pointer; transition: 0.2s;
            font-weight: bold; z-index: 5;
        }
        .sell-btn:hover { background: #f44336; transform: scale(1.1); }

        .side-stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--bag-border); padding: 6px 0; font-size: 0.8rem; }
        .side-stat-name { color: #bcaaa4; font-weight: 600; }
        .side-stat-val { color: #fff; font-family: var(--font-body); font-weight: 600; }
        .side-atk-val { color: #ff8a80; font-weight: bold; font-size: 1rem; }
        .side-bonus { color: #81c784; font-size: 0.75rem; margin-left: 4px; }

        /* Stat Colors */
        .stat-normal { color: #fff; }
        .stat-20 { color: #4caf50; text-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
        .stat-30 { color: #2196f3; text-shadow: 0 0 8px rgba(33, 150, 243, 0.6); }
        .stat-40 { color: #ff9800; text-shadow: 0 0 10px rgba(255, 152, 0, 0.7); }
        .stat-50 { color: #e91e63; text-shadow: 0 0 12px rgba(233, 30, 99, 0.8); }

        .shop-gold { text-align: center; color: var(--accent-gold); font-family: var(--font-body); font-size: 1.2rem; margin-bottom: 15px; padding: 10px; border: 1px solid #333; background: #111; }
        .enhance-btn {
            margin-top: 8px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .enhance-btn:hover { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }
        .enhance-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #111; color: #555; }

        .quest-item { background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .quest-title { color: var(--accent-gold); font-weight: bold; margin-bottom: 5px; }
        .quest-progress { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .quest-reward { font-size: 0.8rem; color: #4caf50; }
        .quest-claim-btn {
            margin-top: 10px; width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .quest-claim-btn:hover:not(:disabled) { background: var(--accent-gold); color: #000; }
        .quest-claim-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .adv-grid { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .adv-card {
            flex: 1; background: #111; border: 2px solid #333; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .adv-card:hover { border-color: var(--accent-gold); background: #1a1a1a; transform: translateY(-5px); }
        .adv-card img { width: 120px; height: 120px; object-fit: cover; border: 1px solid #444; margin-bottom: 15px; }
        .adv-name { font-family: var(--font-body); color: var(--accent-gold); font-size: 1.3rem; margin-bottom: 10px; }
        .adv-desc { font-size: 0.75rem; color: #aaa; line-height: 1.5; margin-bottom: 15px; }
        .adv-bonus { font-size: 0.8rem; color: #4caf50; font-weight: bold; }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-text { font-family: var(--font-body); color: #fff; letter-spacing: 3px; font-size: 1rem; margin-top: 20px; }
        .spinner { width: 30px; height: 30px; border: 2px solid #333; border-top: 2px solid var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #enhance-effect {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-body); font-size: 2.5rem; font-weight: 700;
            color: #fff; text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #e65100;
            pointer-events: none; opacity: 0; z-index: 200; text-align: center;
            letter-spacing: 2px; width: 100%;
        }
        .enhance-anim { animation: enhanceSuccess 2s ease-out forwards; }
        @keyframes enhanceSuccess {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        #event-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 300; display: none; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        #event-img { width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 0 20px var(--accent-gold)); animation: bounce 1s infinite alternate; }
        #event-text {
            margin-top: 20px; font-family: var(--font-body); font-size: 1.8rem; color: #fff;
            text-shadow: 0 0 10px #000, 0 0 20px var(--accent-gold); text-align: center;
        }
        #event-reward {
            margin-top: 10px; font-family: var(--font-body); font-size: 1.2rem; color: #4caf50;
            font-weight: bold; text-shadow: 1px 1px 2px #000;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
        .event-anim { animation: eventFade 3s forwards; }
        @keyframes eventFade {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        /* Trait System Styles */
        .inv-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn {
            padding: 8px 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border);
            color: #aaa; cursor: pointer; font-family: var(--font-body); font-size: 0.8rem;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active { background: var(--bag-panel); color: var(--accent-gold); border-bottom: none; font-weight: bold; }

        .trait-container { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .trait-point-display {
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; border: 1px solid var(--bag-border);
            text-align: center; color: var(--accent-gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;
        }
        .trait-item {
            background: rgba(255,255,255,0.05); border: 1px solid var(--bag-border); border-radius: 4px;
            padding: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .trait-info { flex: 1; }
        .trait-name { color: #fff; font-weight: bold; font-size: 0.95rem; margin-bottom: 4px; }
        .trait-desc { color: #aaa; font-size: 0.75rem; }
        .trait-level { color: var(--accent-gold); font-size: 0.85rem; font-weight: bold; margin-right: 15px; }
        .trait-up-btn {
            padding: 5px 12px; background: var(--accent-gold); color: #000; border: none;
            border-radius: 3px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .trait-up-btn:hover:not(:disabled) { background: #fff; }
        .trait-up-btn:disabled { background: #444; color: #777; cursor: not-allowed; }

        .rarity-common { color: var(--rarity-common) !important; }
        .rarity-rare { color: var(--rarity-rare) !important; text-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
        .rarity-epic { color: var(--rarity-epic) !important; text-shadow: 0 0 8px rgba(163, 53, 238, 0.6); }
        .rarity-legendary { color: var(--rarity-legendary) !important; text-shadow: 0 0 10px rgba(255, 128, 0, 0.7); }

        /* Weather Effects */
        #weather-display {
            position: absolute;
            top: 150px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px 20px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            z-index: 21;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .weather-icon { font-size: 1.1rem; }
        #weather-text { font-size: 0.75rem; color: #fff; }

        #weather-overlay {
            position: absolute; top: 140px; left: 0; width: 100%; height: calc(100% - 140px);
            pointer-events: none; z-index: 10; overflow: hidden;
        }
        .rain-drop {
            position: absolute; background: rgba(255,255,255,0.4); width: 1px; height: 15px;
            animation: rainFall 0.8s linear infinite;
        }
        @keyframes rainFall { to { transform: translateY(1000px); } }

        .fog-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); filter: blur(30px);
            animation: fogMove 10s linear infinite alternate;
        }
        @keyframes fogMove { from { transform: translateX(-50px); } to { transform: translateX(50px); } }

        .thunder-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.3); opacity: 0; z-index: 11;
        }
        .thunder-anim { animation: thunderFlash 0.2s ease-out; }
        @keyframes thunderFlash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* Boss Warning Popup */
        #boss-warning {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.9); border: 2px solid var(--accent-gold);
            color: #fff; padding: 15px 30px; border-radius: 8px; font-family: var(--font-body);
            font-size: 1.5rem; font-weight: bold; z-index: 1000; display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); animation: warningPulse 1s infinite alternate;
            text-align: center; pointer-events: none;
        }
        @keyframes warningPulse { from { opacity: 0.8; transform: translateX(-50%) scale(1); } to { opacity: 1; transform: translateX(-50%) scale(1.05); } }

        /* Mobile Controls */
        #mobile-controls {
            margin-top: 20px;
            z-index: 9999;
            display: none; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px;
            pointer-events: auto;
        }
        .d-pad-btn {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 2rem; user-select: none; cursor: pointer;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            touch-action: manipulation;
        }
        .d-pad-btn:active { background: rgba(255, 215, 0, 0.3); border-color: var(--accent-gold); color: var(--accent-gold); }

        .item-icon-small { width: 32px; height: 32px; border: 1px solid var(--bag-border); border-radius: 4px; margin-right: 10px; object-fit: cover; }
        .item-header { display: flex; align-items: center; margin-bottom: 5px; }

        /* Button Style */
        .btn {
            padding: 12px 20px; background: #222; border: 1px solid #444; color: #ddd;
            font-family: var(--font-body); font-size: 1rem; cursor: pointer; transition: 0.2s;
            border-radius: 4px; font-weight: bold;
        }
        .btn:hover { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }

        /* Size Control UI */
        #size-control-overlay {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--accent-gold);
            padding: 15px; border-radius: 8px; display: none; flex-direction: column;
            gap: 12px; z-index: 1000; align-items: center; width: 120px;
        }
        .size-btn {
            width: 100%; height: 40px; background: #333; border: 1px solid #555;
            color: #fff; font-size: 0.9rem; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; border-radius: 4px;
            font-family: var(--font-body);
        }
        .size-btn:hover { background: var(--accent-gold); color: #000; }
        .size-btn:active { transform: scale(0.95); }
        .size-label { font-size: 0.8rem; color: var(--accent-gold); font-family: var(--font-body); font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="loading-overlay"><div class="spinner"></div><div class="loading-text">Ïó∞Í≤∞ Ï§ë...</div></div>
    <div id="enhance-effect">Í∞ïÌôî ÏÑ±Í≥µ!</div>
    <div id="boss-warning">‚ö†Ô∏è Í≤ΩÍ≥†: Ï¥àÍ∞ïÎ†• Î≥¥Ïä§Í∞Ä ÌïÑÎìúÏóê Ï∂úÌòÑÌñàÏäµÎãàÎã§!</div>

    <div id="weather-display">
        <span class="weather-icon" id="weather-icon">‚òÄÔ∏è</span>
        <span id="weather-text">ÎßëÏùå</span>
    </div>

    <div id="weather-overlay"></div>
    <div id="thunder-flash" class="thunder-flash"></div>

    <div id="event-overlay">
        <img id="event-img" src="image/bm.jpg" alt="Event">
        <div id="event-text">Î≥¥Î¨º Î∞úÍ≤¨!</div>
        <div id="event-reward"></div>
    </div>

    <div id="size-control-overlay">
        <div class="size-label">ÌôîÎ©¥ ÌÅ¨Í∏∞ Ï°∞Ï†à</div>
        <div class="size-btn" id="size-up-btn">ÌôïÎåÄ (‚ñ≤)</div>
        <div class="size-btn" id="size-down-btn">Ï∂ïÏÜå (‚ñº)</div>
        <div class="size-btn" id="size-full-btn">Ï†ÑÏ≤¥ ÌôîÎ©¥</div>
        <div class="size-btn" id="size-reset-btn">Í∏∞Î≥∏ ÌÅ¨Í∏∞</div>
        <div class="size-btn" id="size-close-btn" style="background:#8b0000; margin-top:5px;">Îã´Í∏∞</div>
    </div>

    <div id="inventory-modal" class="modal">
        <div class="modal-header">
            <div style="display:flex; align-items:center;">
                <h2>Í∞ÄÎ∞© Î∞è ÏÉÅÌÉú</h2>
            </div>
            <div style="display:flex; align-items:center;">
                <span id="inv-gold-display" class="inv-header-gold">0 G</span>
                <button class="close-btn" onclick="toggleModal('inventory-modal')">√ó</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="inv-tabs">
                <button id="tab-inv" class="tab-btn active" onclick="switchTab('inv')">ÏïÑÏù¥ÌÖú</button>
                <button id="tab-traits" class="tab-btn" onclick="switchTab('traits')">ÌäπÏÑ± (Traits)</button>
            </div>
            <div class="inv-container">
                <div class="inv-status-side" id="inv-status-panel"></div>
                <div class="inv-grid-side">
                    <div id="inv-list" class="inv-grid"></div>
                    <div id="trait-list" class="trait-container" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-header"><h2>ÎåÄÏû•Í∞Ñ</h2><button class="close-btn" onclick="toggleModal('shop-modal')">√ó</button></div>
        <div class="modal-body">
            <div class="shop-gold" id="shop-gold-display">0 G</div>
            <p style="color:#666; font-size:0.75rem; text-align:center; margin-bottom:15px;">
                Í∞ïÌôîÌï† Ïû•ÎπÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (ÏµúÎåÄ +20)
            </p>
            <div id="shop-list-container">
                <div id="shop-list" class="inv-grid"></div>
            </div>
        </div>
    </div>

    <div id="merchant-modal" class="modal" style="width: 800px; height: 550px;">
        <div class="modal-header">
            <h2 style="color:#ff9800;">üé∞ Í≥†Î∏îÎ¶∞Ïùò ÌñâÏö¥ Ïä¨Î°Ø</h2>
            <button class="close-btn" onclick="closeMerchant()">√ó</button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: row; align-items: center; justify-content: center; padding: 20px; gap: 50px; background: rgba(0,0,0,0.4);">
            <!-- Left: Goblin -->
            <div style="text-align:center; flex: 1;">
                <img src="image/merchant_npc.jpg" style="width:300px; height: 300px; object-fit: cover; border-radius:20px; border:4px solid #ff9800; box-shadow: 0 0 30px rgba(255,152,0,0.6);">
                <p id="merchant-talk" style="color:#fff; margin-top: 20px; font-size: 1.3rem; font-weight: bold; text-shadow: 2px 2px 4px #000;">"ÌûàÌûà! Ïö¥ÏùÑ ÏãúÌóòÌï¥ Î≥º ÌÖêÍ∞Ä?"</p>
            </div>

            <!-- Right: Slot -->
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 25px;">
                <div class="slot-machine-container" style="padding: 40px; border-width: 8px; background: #1a1a1a;">
                    <div class="slot-window" style="width: 220px; height: 220px; border: 4px solid #333; box-shadow: inset 0 0 20px #000;">
                        <img id="slot-image" src="image/potion_hp.jpg" style="width: 160px; height: 160px;">
                    </div>
                </div>
                <div id="slot-result" style="font-size: 1.6rem; min-height: 1.5em; font-weight: bold; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5);">Ï§ÄÎπÑ ÏôÑÎ£å!</div>
                <button id="slot-run-btn" class="btn" onclick="runSlotMachine()" style="width: 220px; height: 60px; background: linear-gradient(180deg, #ffb74d, #ff9800); color: #000; font-size: 1.4rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 900; box-shadow: 0 5px 0 #e65100;">Ïä¨Î°Ø ÎèåÎ¶¨Í∏∞!</button>
                <button id="slot-confirm-btn" class="btn" onclick="closeMerchant()" style="display:none; width: 220px; height: 50px; font-size: 1.1rem;">Í≤∞Í≥º ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-header"><h2 id="confirm-title">ÌôïÏù∏</h2><button class="close-btn" onclick="closeConfirm()">√ó</button></div>
        <div class="modal-body">
            <div id="confirm-msg" class="confirm-text"></div>
            <div class="confirm-btns">
                <button id="confirm-yes-btn" class="btn-yes" onclick="executeConfirm()">ÌôïÏù∏</button>
                <button id="confirm-no-btn" class="btn-no" onclick="closeConfirm()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="quest-modal" class="modal">
        <div class="modal-header"><h2>ÌÄòÏä§Ìä∏</h2><button class="close-btn" onclick="toggleModal('quest-modal')">√ó</button></div>
        <div class="modal-body" id="quest-list"></div>
    </div>

    <div id="advancement-modal" class="modal">
        <div class="modal-header"><h2>Ï†ÑÏßÅ</h2></div>
        <div class="modal-body">
            <p style="text-align:center; color:#aaa; font-size:0.9rem;">Î†àÎ≤® 5Ïóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§! ÏÉàÎ°úÏö¥ Í∏∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
            <div id="adv-list" class="adv-grid"></div>
        </div>
    </div>

    <div id="gameover-modal" class="modal">
        <div class="modal-header"><h2 style="color:var(--accent-red)">GAME OVER</h2></div>
        <div class="modal-body">
            <div class="gameover-title">ÎçòÏ†Ñ Î∂ïÍ¥¥</div>
            <div id="go-stats-container" class="gameover-stats">
                <!-- ÏÉÅÏÑ∏ Ï†êÏàò ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê Îì§Ïñ¥Í∞ëÎãàÎã§ -->
            </div>
            <div class="go-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            <button class="btn btn-start" style="width:100%; margin-top: 20px;" onclick="location.href='index.html'">Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú</button>
        </div>
    </div>

    <div class="game-ui-top">
        <div style="display:flex; align-items:center;">
            <div id="game-timer">15:00</div>
            <div class="char-info">
                <h2 id="ui-info">ÏòÅÏõÖ</h2>
                <span id="ui-level">LV. 1</span>
            </div>
        </div>

        <div class="ui-bars-center">
            <div class="bar-row"><span class="bar-label">HP</span><div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill"></div><span id="ui-hp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">MP</span><div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-fill"></div><span id="ui-mp-text" class="bar-text"></span></div></div>
            <div class="bar-row"><span class="bar-label">EXP</span><div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill"></div><span id="ui-exp-text" class="bar-text"></span></div></div>
        </div>

        <div class="btn-group">
            <img src="image/menu_1.png" class="menu-icon" onclick="openQuest()" alt="ÌÄòÏä§Ìä∏" title="ÌÄòÏä§Ìä∏">
            <img src="image/menu_2.png" class="menu-icon" onclick="openInventory()" alt="Í∞ÄÎ∞©" title="Í∞ÄÎ∞©">
            <img src="image/menu_3.png" class="menu-icon" onclick="openShop()" alt="Í∞ïÌôî" title="Í∞ïÌôî">
            <img src="image/menu_4.png" class="menu-icon" onclick="askManualSave()" alt="Ï†ÄÏû•" title="Ï†ÄÏû•">
            <img src="image/menu_5.png" class="menu-icon" onclick="toggleSizeControl()" alt="ÌôîÎ©¥ Ï°∞Ï†à" title="ÌôîÎ©¥ Ï°∞Ï†à">
        </div>
    </div>
    <div class="canvas-wrapper"><canvas id="gameCanvas" width="960" height="640"></canvas></div>
</div>

<div id="mobile-controls">
    <div class="d-pad-btn" id="btn-up" style="grid-column: 2; grid-row: 1;">‚ñ≤</div>
    <div class="d-pad-btn" id="btn-left" style="grid-column: 1; grid-row: 2;">‚óÄ</div>
    <div class="d-pad-btn" id="btn-right" style="grid-column: 3; grid-row: 2;">‚ñ∂</div>
    <div class="d-pad-btn" id="btn-down" style="grid-column: 2; grid-row: 3;">‚ñº</div>
</div>

<script>
    const DB_URL = "https://script.google.com/macros/s/AKfycbzXcsngw4319YoBVGTmtuoXnpC66ZGlBQm5F2Hxw17n1_EEMazrftUD6gYsMYzQTV0YAg/exec";
    const CHAR_FILES = {
        'Ï†ÑÏÇ¨': 'image/warrior.jpg', 'ÎèÑÏ†Å': 'image/rogue.jpg', 'ÎßàÎ≤ïÏÇ¨': 'image/mage.jpg', 'ÏóòÌîÑ Í∂ÅÏàò': 'image/archer.jpg',
        'Î≤ÑÏÑúÏª§': 'image/warrior1.jpg', 'Í∞ÄÎîîÏñ∏': 'image/warrior1.jpg',
        'Ïñ¥ÏåîÏã†': 'image/rogue1.jpg', 'ÏÑÄÎèÑÏö∞': 'image/rogue1.jpg',
        'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'image/mage1.jpg', 'ÏÜåÏÑúÎü¨': 'image/mage1.jpg',
        'Ïä§ÎÇòÏù¥Ìçº': 'image/archer1.jpg', 'Î†àÏù∏Ï†Ä': 'image/archer1.jpg'
    };

    const MAP_SETS = [
        { day: 'image/map.jpg', night: 'image/map1.jpg' },
        { day: 'image/map2.jpg', night: 'image/map3.jpg' },
        { day: 'image/map4.jpg', night: 'image/map5.jpg' },
        { day: 'image/map6.jpg', night: 'image/map7.jpg' }
    ];

    const DROP_TABLE = {
        'Ï†ÑÏÇ¨': ['Í∏∞ÏÇ¨Ïùò Í≤Ä', 'ÎåÄÍ≤Ä', 'Ïö©ÏÇ¨Ïùò Í≤Ä', 'Ïã¨ÌåêÏùò ÎèÑÎÅº'],
        'ÎèÑÏ†Å': ['ÏïîÏÇ¥ÏûêÏùò Îã®ÎèÑ', 'ÏåçÍ≤Ä', 'Í∑∏Î¶ºÏûê ÎπÑÏàò'],
        'ÎßàÎ≤ïÏÇ¨': ['ÎßàÎ≤ï ÏßÄÌå°Ïù¥', 'Ïò§Î∏å', 'ÌòÑÏûêÏùò Ïä§ÌÉúÌîÑ'],
        'ÏóòÌîÑ Í∂ÅÏàò': ['Ïó∞ÏäµÏö© Î™©Í∂Å', 'Ïª¥Ìè¨ÏßÄÌä∏ Î≥¥Ïö∞', 'ÏúàÎìúÎü∞ÎÑà'],
        'Î≤ÑÏÑúÏª§': ['Í¥ëÏ†ÑÏÇ¨Ïùò ÎèÑÎÅº', 'ÌîºÏùò Í≤Ä'],
        'Í∞ÄÎîîÏñ∏': ['ÏàòÌò∏ÏûêÏùò Î∞©Ìå®Í≤Ä', 'ÏÑ±Í∏∞ÏÇ¨Ïùò ÎßùÏπò'],
        'Ïñ¥ÏåîÏã†': ['Ï£ΩÏùåÏùò Ïù∏ÎèÑÏûê', 'Í∑∏Î¶ºÏûê ÏÜ°Í≥≥Îãà'],
        'ÏÑÄÎèÑÏö∞': ['Í≥µÌè¨Ïùò ÎπÑÏàò', 'Ïã¨Ïó∞Ïùò ÏπºÎÇ†'],
        'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': ['ÎåÄÎßàÎ≤ïÏÇ¨Ïùò ÏßÄÌå°Ïù¥', 'Î≥ÑÏùò Ï°∞Í∞Å'],
        'ÏÜåÏÑúÎü¨': ['ÏõêÏÜåÏùò Í∑ºÏõê', 'ÎßàÎÇòÏùò Îàà'],
        'Ïä§ÎÇòÏù¥Ìçº': ['Ï†ÄÍ≤©ÏàòÏùò Ìôú', 'Ï†ïÎ†πÏùò Ìôú'],
        'Î†àÏù∏Ï†Ä': ['Ìè≠ÌíçÏùò Ìôú', 'ÏûêÏó∞Ïùò Ìôú']
    };

    const LEGENDARY_SPECIAL_OPTIONS = [
        { name: "ÌîºÏùò Í∞àÏ¶ù", desc: "Í≥µÍ≤© Ïãú 10% ÌôïÎ•†Î°ú ÌîºÌï¥ÎüâÏùò 20% HP Ìù°Ïàò", key: "l_vamp", val: 20 },
        { name: "ÎßàÎÇòÏùò ÏÉò", desc: "Í≥µÍ≤© Ïãú 10% ÌôïÎ•†Î°ú ÏµúÎåÄ MPÏùò 10% ÌöåÎ≥µ", key: "l_mana", val: 10 },
        { name: "Í∞ÄÎ≤ºÏö¥ Î∞úÍ±∏Ïùå", desc: "ÌöåÌîºÏú® +10%", key: "l_eva", val: 10 },
        { name: "Í∞ïÏ≤† ÌîºÎ∂Ä", desc: "Î∞õÎäî ÌîºÌï¥Îüâ -10%", key: "l_def", val: 10 },
        { name: "ÏïΩÏ†ê Í∞ÑÌåå", desc: "ÏπòÎ™ÖÌÉÄ ÌîºÌï¥Îüâ +25%", key: "l_crit_dmg", val: 25 },
        { name: "Í≥®Îìú Îü¨Ïãú", desc: "Í≥®Îìú ÌöçÎìùÎüâ +30%", key: "l_gold", val: 30 },
        { name: "ÏÑ±Ïû•Ïùò Í∞ÄÏÜç", desc: "Í≤ΩÌóòÏπò ÌöçÎìùÎüâ +20%", key: "l_exp", val: 20 },
        { name: "Íµ≥Í±¥Ìïú ÏùòÏßÄ", desc: "ÏÉÅÌÉúÏù¥ÏÉÅ Ï†ÄÌï≠ +30%", key: "l_resist", val: 30 },
        { name: "Î∂ÑÎÖ∏ Ï°∞Ï†à", desc: "Î∂ÑÎÖ∏ ÌöçÎìùÎüâ +20%", key: "l_rage", val: 20 },
        { name: "Ïû¨Îπ†Î•∏ ÏÜêÎÜÄÎ¶º", desc: "ÏïÑÏù¥ÌÖú ÌöçÎìù Ïãú 5% ÌôïÎ•†Î°ú 2Î∞∞ ÌöçÎìù", key: "l_double_drop", val: 5 }
    ];

    let player = null;
    let keysPressed = {};
    let distAccumulator = 0;
    let playerImg = new Image();
    let mapImg = new Image();
    let mapSetIndex = 0;
    let boss = { x: 100, y: 100, speed: 2.2, img: new Image(), alive: true, isNightBoss: false, hp: 100, maxHp: 100 };
    let superBoss = { x: 500, y: 500, speed: 3.5, img: new Image(), alive: false, hp: 1500, maxHp: 1500, name: "Ï¥àÍ∞ïÎ†• Î≥¥Ïä§" };
    superBoss.img.src = 'image/best_boss.jpg';

    let merchant = { x: 0, y: 0, speed: 12, img: new Image(), alive: false, spawnTime: 0, lifeTime: 25000, moveDir: {x:0, y:0} };
    merchant.img.src = 'image/merchant_npc.jpg';

    const GAME_TIME_LIMIT = 15 * 60 * 1000;

    let isNight = false;
    let timeTick = 0;
    let currentWeather = "sunny"; // sunny, rain, fog, thunder

    // Size Control Variables
    let currentScale = parseFloat(localStorage.getItem('rpg_map_scale') || 1.0);
    const MIN_SCALE = 1.0;
    const MAX_SCALE = 3.0;
    const SCALE_STEP = 0.1;
    let isSizeControlling = false;
    let pauseStartTime = 0;

    let gameLoopInterval = null;
    let isGameOver = false;

    const advBgm = new Audio('song/bgm1.mp3');

    // Randomly select a song from song_1 to song_4
    const songList = ['song/song_1.mp3', 'song/song_2.mp3', 'song/song_3.mp3', 'song/song_4.mp3'];
    const randomSong = songList[Math.floor(Math.random() * songList.length)];
    const fieldBgm = new Audio(randomSong);

    const angelBgm = new Audio('song/angels.mp3');
    const successSfx = new Audio('song/blackout_piano1.mp3');
    const failSfx = new Audio('song/blackout_piano2.mp3');
    const thunderSfx = new Audio('song/thunder.mp3');
    const potionSfx = new Audio('song/potion-inght.wav');
    const goldSfx = new Audio('song/gold_drop-inght.wav');
    const rainThunderSfx = new Audio('song/thunder1-inght.wav');
    const rainRuinSfx = new Audio('song/ruin-inght.wav');
    const equipSfx = new Audio('image/eqp.mp3');
    const coinSfx = new Audio('song/money_box.mp3');
    const slotSfx = new Audio('song/glass_rolling.mp3');
    const coinImgDay = new Image(); coinImgDay.src = 'image/coin_gold.jpg';
    const coinImgNight = new Image(); coinImgNight.src = 'image/coin_gold_night.jpg';
    let coins = [];
    let floatingTexts = [];

    fieldBgm.loop = true;
    fieldBgm.volume = 0.15;

    let fieldItems = [];
    const potionImg = new Image(); potionImg.src = 'image/potion_hp.jpg';
    const shoesImg = new Image(); shoesImg.src = 'image/shoes.jpg';
    const atkImg = new Image(); atkImg.src = 'image/attack_10.jpg';
    const defImg = new Image(); defImg.src = 'image/Defense_10.jpg';

    let treasureBoxes = [];
    const treasureBoxImg = new Image(); treasureBoxImg.src = 'image/bm.jpg';

    let currentConfirmAction = null;
    let pendingReward = null;

    window.onload = async function() {
        const name = localStorage.getItem('rpg_player_name');
        const temp = localStorage.getItem('rpg_temp_player');
        if (temp) { player = JSON.parse(temp); initData(); initMap(); }
        else if (name) {
            try {
                document.querySelector('.loading-text').innerText = "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...";
                document.getElementById('loading-overlay').style.display = 'flex';
                const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                player = await res.json(); initData(); initMap();
            } catch(e) { location.href='index.html'; }
        } else { location.href='index.html'; }
    };

    function initData() {
        if (!player.name) player.name = localStorage.getItem('rpg_player_name');
        if (!player.inventory) player.inventory = [];
        if (!player.bonusAtk) player.bonusAtk = 0;
        if (player.bonusDef === undefined) player.bonusDef = 0;
        if (player.moveSpeed === undefined) player.moveSpeed = 12;
        if (player.gold === undefined) player.gold = 0;
        if (player.coinScore === undefined) player.coinScore = 0;
        if (player.traitPoints === undefined) player.traitPoints = 0;
        if (!player.traits) player.traits = { str: 0, dex: 0, con: 0, int: 0, wis: 0 };
        if (!player.quests) player.quests = {
            killCount: 0,
            dayKillCount: 0,
            nightKillCount: 0,
            bossKillCount: 0,
            enhanceCount: 0,
            claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
        };

        if (player.quests.dayKillCount === undefined) player.quests.dayKillCount = 0;
        if (player.quests.nightKillCount === undefined) player.quests.nightKillCount = 0;
        if (player.quests.bossKillCount === undefined) player.quests.bossKillCount = 0;
        if (player.quests.coinCollectCount === undefined) player.quests.coinCollectCount = 0;
        if (!player.quests.claimed) player.quests.claimed = {};
        if (player.quests.claimed.dayKill === undefined) player.quests.claimed.dayKill = false;
        if (player.quests.claimed.nightKill === undefined) player.quests.claimed.nightKill = false;
        if (player.quests.claimed.bossKill === undefined) player.quests.claimed.bossKill = false;
        if (player.quests.claimed.coinCollect === undefined) player.quests.claimed.coinCollect = false;

        if (player.isAdvanced === undefined) player.isAdvanced = false;
        if (player.merchantUsed === undefined) player.merchantUsed = false;

        // Boundary check on load - Moved to after applyScale to handle scaled coordinates correctly
        if (player.x === undefined) player.x = 480;
        if (player.y === undefined) player.y = 320;

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        isNight = elapsed >= 90000;
        localStorage.setItem('rpg_is_night', isNight);

        currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

        if (localStorage.getItem('rpg_open_traits') === 'true') {
            localStorage.removeItem('rpg_open_traits');
            setTimeout(() => { openInventory(); switchTab('traits'); }, 500);
        }

        let savedMapIndex = localStorage.getItem('rpg_map_set_index');
        if (savedMapIndex === null) {
            mapSetIndex = Math.floor(Math.random() * MAP_SETS.length);
            localStorage.setItem('rpg_map_set_index', mapSetIndex);
        } else {
            mapSetIndex = parseInt(savedMapIndex);
        }
    }

    function getPlayerImage(job, inventory) {
        const equippedWeapon = inventory.find(i => i.type === 'weapon' && i.equipped);
        const isLegendary = equippedWeapon && equippedWeapon.rarity === 'legendary';

        if (isLegendary) {
            if (job === 'Ï†ÑÏÇ¨' || job === 'Î≤ÑÏÑúÏª§' || job === 'Í∞ÄÎîîÏñ∏') return 'image/warrior4.jpg';
            if (job === 'ÎèÑÏ†Å' || job === 'Ïñ¥ÏåîÏã†' || job === 'ÏÑÄÎèÑÏö∞') return 'image/rogue4.jpg';
            if (job === 'ÎßàÎ≤ïÏÇ¨' || job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || job === 'ÏÜåÏÑúÎü¨') return 'image/mage4.jpg';
            if (job === 'ÏóòÌîÑ Í∂ÅÏàò' || job === 'Ïä§ÎÇòÏù¥Ìçº' || job === 'Î†àÏù∏Ï†Ä') return 'image/archer4.jpg';
        }
        return CHAR_FILES[job] || CHAR_FILES['Ï†ÑÏÇ¨'];
    }

    function initMap() {
        playerImg.src = getPlayerImage(player.job, player.inventory);
        const currentSet = MAP_SETS[mapSetIndex];
        mapImg.src = isNight ? currentSet.night : currentSet.day;

        applyScale();

        // Boundary check after scale is applied
        const canvas = document.getElementById('gameCanvas');
        if (player.x < 16 || player.x > canvas.width - 16) player.x = canvas.width / 2;
        if (player.y < 16 || player.y > canvas.height - 16) player.y = canvas.height / 2;

        mapImg.onload = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            fieldBgm.play().catch(e => console.log("BGM play failed:", e));

            const deathTime = localStorage.getItem('rpg_boss_death_time');
            const savedX = localStorage.getItem('rpg_boss_x');
            if (localStorage.getItem('rpg_boss_ran_away') === 'true') {
                localStorage.removeItem('rpg_boss_ran_away');
                boss.alive = false;
                setTimeout(spawnBossDefault, 10000);
            } else if (savedX) { // Check saved position first to avoid reset after normal mob battle
                boss.x = parseFloat(savedX); boss.y = parseFloat(localStorage.getItem('rpg_boss_y')); boss.alive = true;
                boss.hp = parseFloat(localStorage.getItem('rpg_boss_hp') || 400 + (player.level * 30));
                boss.maxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 400 + (player.level * 30));
            } else if (deathTime) {
                const diff = Date.now() - parseInt(deathTime);
                if (diff < 10000) { boss.alive = false; setTimeout(spawnBossDefault, 10000 - diff); }
                else { localStorage.removeItem('rpg_boss_death_time'); spawnBossDefault(); }
            } else {
                boss.alive = false; setTimeout(spawnBossDefault, 15000);
            }
            gameLoopInterval = setInterval(gameLoop, 50);
            updateTimeEffect();
            updateWeatherUI();
            checkAdvancement();
            spawnFieldItem();
            spawnTreasureBox();
            spawnCoin();
            spawnMerchant();
        };
        updateUI();
        window.addEventListener('keydown', e => {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
                keysPressed[e.key] = true;
            }
        });
        window.addEventListener('keyup', e => {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
                keysPressed[e.key] = false;
            }
        });

        // Size Control Events
        document.getElementById('size-up-btn').onclick = () => changeScale(SCALE_STEP);
        document.getElementById('size-down-btn').onclick = () => changeScale(-SCALE_STEP);
        document.getElementById('size-reset-btn').onclick = () => {
            const oldScale = currentScale;
            currentScale = 1.0;
            localStorage.setItem('rpg_map_scale', 1.0);
            rescalePositions(oldScale, currentScale);
            applyScale();
        };
        document.getElementById('size-full-btn').onclick = () => {
            const oldScale = currentScale;
            const winW = window.innerWidth - 40;
            const winH = window.innerHeight - 120;
            const scaleW = winW / 960;
            const scaleH = winH / 640;
            currentScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, Math.min(scaleW, scaleH)));
            localStorage.setItem('rpg_map_scale', currentScale);
            rescalePositions(oldScale, currentScale);
            applyScale();
        };
        document.getElementById('size-close-btn').onclick = () => toggleSizeControl();
    }

    function toggleSizeControl() {
        const overlay = document.getElementById('size-control-overlay');
        isSizeControlling = (overlay.style.display !== 'flex');
        overlay.style.display = isSizeControlling ? 'flex' : 'none';

        if (isSizeControlling) {
            pauseStartTime = Date.now();
            fieldBgm.volume = 0.05;
        } else {
            const pauseDuration = Date.now() - pauseStartTime;
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            localStorage.setItem('rpg_start_time', startTime + pauseDuration);
            fieldBgm.volume = 0.15;
        }
    }

    function changeScale(delta) {
        const oldScale = currentScale;
        currentScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale + delta));
        localStorage.setItem('rpg_map_scale', currentScale);
        rescalePositions(oldScale, currentScale);
        applyScale();
    }

    function rescalePositions(oldScale, newScale) {
        const ratio = newScale / oldScale;

        // Rescale Player
        player.x *= ratio;
        player.y *= ratio;

        // Rescale Boss
        boss.x *= ratio;
        boss.y *= ratio;

        // Rescale Super Boss
        superBoss.x *= ratio;
        superBoss.y *= ratio;

        // Rescale Merchant
        merchant.x *= ratio;
        merchant.y *= ratio;

        // Rescale Field Items
        fieldItems.forEach(item => {
            item.x *= ratio;
            item.y *= ratio;
        });

        // Rescale Treasure Boxes
        treasureBoxes.forEach(box => {
            box.x *= ratio;
            box.y *= ratio;
        });

        // Rescale Coins
        coins.forEach(coin => {
            coin.x *= ratio;
            coin.y *= ratio;
        });

        // Rescale Floating Texts
        floatingTexts.forEach(ft => {
            ft.x *= ratio;
            ft.y *= ratio;
        });
    }

    function applyScale() {
        const container = document.getElementById('game-container');
        const canvas = document.getElementById('gameCanvas');

        const baseWidth = 960;
        const baseHeight = 640;
        const uiHeight = 140;

        const newWidth = baseWidth * currentScale;
        const newHeight = baseHeight * currentScale;

        container.style.width = newWidth + 'px';
        container.style.height = (newHeight + uiHeight) + 'px';
        canvas.width = newWidth;
        canvas.height = newHeight;

        // Boundary check for player
        if (player.x > canvas.width - 16) player.x = canvas.width - 16;
        if (player.y > canvas.height - 16) player.y = canvas.height - 16;

        updateWeatherUI();
        draw(); // Redraw immediately to reflect changes
    }

    function spawnFieldItem() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnFieldItem, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (fieldItems.length < 6) {
            const rand = Math.random();
            let type = 'potion';
            if (rand < 0.05) type = 'shoes';

            fieldItems.push({ x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50, type: type });
        }
        setTimeout(spawnFieldItem, 8000);
    }

    function spawnTreasureBox() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnTreasureBox, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (treasureBoxes.length < 2) {
            treasureBoxes.push({ x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50 });
        }
        setTimeout(spawnTreasureBox, Math.random() * 30000 + 30000);
    }

    function spawnCoin() {
        if (isSizeControlling || isGameOver) {
            setTimeout(spawnCoin, 1000);
            return;
        }
        const canvas = document.getElementById('gameCanvas');
        if (coins.length < 30) {
            const r = Math.random();
            let size, score;
            if (r < 0.7) { // Small (70%)
                size = 20;
                score = Math.floor(Math.random() * 41) + 10;
            } else if (r < 0.95) { // Medium (25%)
                size = 30;
                score = Math.floor(Math.random() * 51) + 50;
            } else { // Large (5%)
                size = 45;
                score = Math.floor(Math.random() * 301) + 200; // 200-500
            }
            coins.push({
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                size: size,
                score: score,
                creationTime: Date.now(),
                lifeTime: 10000 + Math.random() * 5000
            });
        }
        setTimeout(spawnCoin, Math.random() * 2000 + 1000);
    }

    function spawnMerchant() {
        if (!isNight || player.merchantUsed) {
            setTimeout(spawnMerchant, 10000);
            return;
        }
        if (merchant.alive) {
            setTimeout(spawnMerchant, 10000);
            return;
        }

        const canvas = document.getElementById('gameCanvas');
        merchant.x = Math.random() * (canvas.width - 100) + 50;
        merchant.y = Math.random() * (canvas.height - 100) + 50;
        merchant.alive = true;
        merchant.spawnTime = Date.now();
        merchant.moveDir = { x: Math.random() * 2 - 1, y: Math.random() * 2 - 1 };

        setTimeout(spawnMerchant, 60000); // Try to spawn again in 1 min
    }

    function addFloatingText(x, y, text, color) {
        floatingTexts.push({
            x: x,
            y: y,
            text: text,
            color: color,
            startTime: Date.now(),
            lifeTime: 1500
        });
    }

    function checkAdvancement() { if (player.level >= 5 && !player.isAdvanced) openAdvancement(); }

    function openAdvancement() {
        const modal = document.getElementById('advancement-modal');
        const list = document.getElementById('adv-list');
        list.innerHTML = '';
        fieldBgm.pause();
        advBgm.loop = true; advBgm.play().catch(e => console.log(e));

        let options = [];
        if (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Í∏∞ÏÇ¨') {
            options = [
                { job: 'Î≤ÑÏÑúÏª§', desc: 'Í≥µÍ≤© ÌäπÌôî. Ïä§ÌÇ¨ ÎåÄÎØ∏ÏßÄ ÎåÄÌè≠ ÏÉÅÏäπ.', bonus: 'Ìûò +10, HP +50', img: 'image/warrior1.jpg' },
                { job: 'Í∞ÄÎîîÏñ∏', desc: 'ÏÉùÏ°¥ ÌäπÌôî. Î∞õÎäî ÌîºÌï¥ Í∞êÏÜå.', bonus: 'Ï≤¥Î†• +15, HP +150', img: 'image/warrior1.jpg' }
            ];
        } else if (player.job === 'ÎèÑÏ†Å') {
            options = [
                { job: 'Ïñ¥ÏåîÏã†', desc: 'Í∑πÎîú ÌäπÌôî. ÏπòÎ™ÖÌÉÄ ÌôïÎ•† Î∞è Ïä§ÌÇ¨ ÌöüÏàò Ï¶ùÍ∞Ä.', bonus: 'ÎØºÏ≤© +12, ÏπòÎ™ÖÌÉÄ +15%', img: 'image/rogue1.jpg' },
                { job: 'ÏÑÄÎèÑÏö∞', desc: 'Ïú†Ìã∏ ÌäπÌôî. ÎèÖ Î∂ÄÏó¨ ÌôïÎ•† 100%.', bonus: 'ÎØºÏ≤© +8, ÏßÄÌòú +8', img: 'image/rogue1.jpg' }
            ];
        } else if (player.job === 'ÎßàÎ≤ïÏÇ¨') {
            options = [
                { job: 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', desc: 'ÌôîÎ†• ÌäπÌôî. Ïä§ÌÇ¨ ÎåÄÎØ∏ÏßÄ ÎåÄÌè≠ ÏÉÅÏäπ.', bonus: 'ÏßÄÎä• +15, MP +100', img: 'image/mage1.jpg' },
                { job: 'ÏÜåÏÑúÎü¨', desc: 'Ìö®Ïú® ÌäπÌôî. Ïä§ÌÇ¨ ÎßàÎÇò ÏÜåÎ™®Îüâ Í∞êÏÜå.', bonus: 'ÏßÄÎä• +10, ÏßÄÌòú +10', img: 'image/mage1.jpg' }
            ];
        } else if (player.job === 'ÏóòÌîÑ Í∂ÅÏàò') {
            options = [
                { job: 'Ïä§ÎÇòÏù¥Ìçº', desc: 'Ï†ïÌôïÌïú Ï†ÄÍ≤©. ÏπòÎ™ÖÌÉÄ ÌîºÌï¥Îüâ Ï¶ùÍ∞Ä Î∞è Îã®Ïùº ÎåÄÏÉÅ Í∑πÎåÄÌôî.', bonus: 'ÎØºÏ≤© +15, ÏπòÎ™ÖÌÉÄ ÌîºÌï¥Îüâ +20%', img: 'image/archer1.jpg' },
                { job: 'Î†àÏù∏Ï†Ä', desc: 'Í¥ëÏó≠ Ï†úÏïï. Îã§Ïàò ÎåÄÏÉÅ Í≥µÍ≤© Î∞è Íµ∞Ï§ë Ï†úÏñ¥ ÌäπÌôî.', bonus: 'ÎØºÏ≤© +10, ÏßÄÌòú +10', img: 'image/archer1.jpg' }
            ];
        }

        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'adv-card';
            div.innerHTML = `<img src="${opt.img}"><div class="adv-name">${opt.job}</div><div class="adv-desc">${opt.desc}</div><div class="adv-bonus">${opt.bonus}</div>`;
            div.onclick = () => askAdvancement(opt);
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }

    function askAdvancement(opt) {
        showConfirm("Ï†ÑÏßÅ ÌôïÏù∏", `${opt.job}(Ïúº)Î°ú Ï†ÑÏßÅÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.`, () => selectAdvancement(opt));
    }

    function selectAdvancement(opt) {
        player.job = opt.job; player.isAdvanced = true;
        if (opt.job === 'Î≤ÑÏÑúÏª§') { player.stats.str += 10; player.maxHp += 50; }
        else if (opt.job === 'Í∞ÄÎîîÏñ∏') { player.stats.con += 15; player.maxHp += 150; }
        else if (opt.job === 'Ïñ¥ÏåîÏã†') { player.stats.dex += 12; }
        else if (opt.job === 'ÏÑÄÎèÑÏö∞') { player.stats.dex += 8; player.stats.wis += 8; }
        else if (opt.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ') { player.stats.int += 15; player.maxMp += 100; }
        else if (opt.job === 'ÏÜåÏÑúÎü¨') { player.stats.int += 10; player.stats.wis += 10; }
        else if (opt.job === 'Ïä§ÎÇòÏù¥Ìçº') { player.stats.dex += 15; /* ÏπòÎ™ÖÌÉÄ ÌîºÌï¥ÎüâÏùÄ Ï†ÑÌà¨ Î°úÏßÅÏóêÏÑú Ï≤òÎ¶¨ */ }
        else if (opt.job === 'Î†àÏù∏Ï†Ä') { player.stats.dex += 10; player.stats.wis += 10; }
        player.hp = player.maxHp; player.mp = player.maxMp;
        playerImg.src = getPlayerImage(player.job, player.inventory);
        advBgm.pause(); advBgm.currentTime = 0;

        angelBgm.play().catch(e => console.log(e));
        setTimeout(() => { fieldBgm.play(); }, 5000);

        document.getElementById('advancement-modal').style.display = 'none';
        showConfirm("Ï†ÑÏßÅ ÏÑ±Í≥µ", `Ï∂ïÌïòÌï©ÎãàÎã§! ${opt.job}(Ïúº)Î°ú Ï†ÑÏßÅÌñàÏäµÎãàÎã§!`, null, true);
        updateUI();
    }

    function updateTimeEffect() {
        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const newIsNight = elapsed >= 90000;

        if (newIsNight !== isNight) {
            isNight = newIsNight;
            const currentSet = MAP_SETS[mapSetIndex];
            mapImg.src = isNight ? currentSet.night : currentSet.day;
            localStorage.setItem('rpg_is_night', isNight);

            const ns = isNight ? "_night" : "";
            potionImg.src = 'image/potion_hp' + ns + '.jpg';
            atkImg.src = 'image/attack_10' + ns + '.jpg';
            defImg.src = 'image/Defense_10' + ns + '.jpg';

            changeWeather();
        }

        if (isNight) {
            if (Math.random() < 0.4) {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            } else {
                boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
            }
        } else {
            boss.img.src = 'image/ka1.jpg'; boss.isNightBoss = false; boss.speed = 2.2;
        }

        if (Math.floor(elapsed / 30000) > timeTick) {
            timeTick = Math.floor(elapsed / 30000);
            changeWeather();
        }
    }

    function changeWeather() {
        const weathers = ["sunny", "rain", "fog", "thunder"];
        const rand = Math.random();
        if (rand < 0.5) currentWeather = "sunny";
        else if (rand < 0.7) currentWeather = "rain";
        else if (rand < 0.85) currentWeather = "fog";
        else currentWeather = "thunder";

        localStorage.setItem('rpg_current_weather', currentWeather);
        updateWeatherUI();
    }

    function updateWeatherUI() {
        const icon = document.getElementById('weather-icon');
        const text = document.getElementById('weather-text');
        const overlay = document.getElementById('weather-overlay');
        const canvas = document.getElementById('gameCanvas');
        if (!overlay) return;
        overlay.innerHTML = '';

        if (currentWeather === "sunny") { icon.innerText = "‚òÄÔ∏è"; text.innerText = "ÎßëÏùå"; }
        else if (currentWeather === "rain") {
            icon.innerText = "üåßÔ∏è"; text.innerText = "ÎπÑ (ÎßàÎ≤ï Í∞ïÌôî / Ïù¥Îèô Ï†ÄÌïò)";
            for(let i=0; i<50; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * canvas.width + 'px';
                drop.style.animationDelay = Math.random() * 0.8 + 's';
                overlay.appendChild(drop);
            }
            // Play rain weather sounds
            rainThunderSfx.play().catch(e => {});
            rainThunderSfx.onended = () => { rainRuinSfx.play().catch(e => {}); };
        }
        else if (currentWeather === "fog") {
            icon.innerText = "üå´Ô∏è";
            // ÏóòÌîÑ Í∂ÅÏàòÏùº Í≤ΩÏö∞ Î™ÖÏ§ëÎ•† ÌéòÎÑêÌã∞Î•º Î¨¥ÏãúÌïòÎØÄÎ°ú ÌÖçÏä§Ìä∏ÎèÑ Î≥ÄÍ≤Ω
            if (player && player.job === 'ÏóòÌîÑ Í∂ÅÏàò') {
                text.innerText = "ÏïàÍ∞ú (Ï°∞Ïö∞Ïú® ÏÉÅÏäπ / Î™ÖÏ§ë ÌéòÎÑêÌã∞ ÏóÜÏùå)";
            } else {
                text.innerText = "ÏïàÍ∞ú (Ï°∞Ïö∞Ïú® ÏÉÅÏäπ / Î™ÖÏ§ë Î≥ÄÌôî)";
            }
            const fog = document.createElement('div');
            fog.className = 'fog-layer';
            overlay.appendChild(fog);
        }
        else if (currentWeather === "thunder") {
            icon.innerText = "‚ö°"; text.innerText = "ÎáåÏö∞ (ÎÇôÎ¢∞ Ï£ºÏùò)";
        }
    }

    function spawnBossDefault() {
        const canvas = document.getElementById('gameCanvas');
        boss.x = player.x > canvas.width / 2 ? 100 : canvas.width - 100; boss.y = player.y > canvas.height / 2 ? 100 : canvas.height - 100; boss.alive = true;
        boss.maxHp = 400 + (player.level * 30);
        boss.hp = boss.maxHp;
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.removeItem('rpg_boss_death_time');
        localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp);
    }

    function spawnSuperBoss() {
        const canvas = document.getElementById('gameCanvas');
        superBoss.alive = true;
        superBoss.x = canvas.width / 2; superBoss.y = canvas.height / 2;
        superBoss.hp = 1500;
        superBoss.maxHp = 1500;

        const warning = document.getElementById('boss-warning');
        warning.style.display = 'block';
        setTimeout(() => { warning.style.display = 'none'; }, 5000);
    }

    function gameLoop() {
        if(!player) return;
        if(isGameOver) return;
        if(isSizeControlling) {
            draw(); // Keep drawing even when paused to show scale changes
            return;
        }

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const elapsed = Date.now() - startTime;
        const remain = GAME_TIME_LIMIT - elapsed;

        if (remain <= 0) {
            document.getElementById('game-timer').innerText = "00:00";
            isGameOver = true;
            clearInterval(gameLoopInterval);
            showGameOver("ÏãúÍ∞Ñ Ï¢ÖÎ£å! ÎçòÏ†ÑÏù¥ Î∂ïÍ¥¥ÎêòÏóàÏäµÎãàÎã§.");
            return;
        }

        if(document.querySelector('.modal[style*="flex"]')) return;

        handleMovement();

        const m = Math.floor(remain / 60000);
        const s = Math.floor((remain % 60000) / 1000);
        document.getElementById('game-timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

        updateTimeEffect();

        if (currentWeather === "thunder" && Math.random() < 0.01) {
            triggerThunder();
        }

        // ÏµúÏ¢Ö Î≥¥Ïä§ 3Î∂Ñ ÎÇ®ÏïòÏùÑ Îïå Ï∂úÌòÑ (Í∏∞Ï°¥ 5Î∂ÑÏóêÏÑú ÏàòÏ†ï)
        if (remain <= 3 * 60 * 1000 && !superBoss.alive && !localStorage.getItem('rpg_super_boss_killed')) {
            spawnSuperBoss();
        }

        if (boss.alive) {
            const dx = player.x - boss.x; const dy = player.y - boss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { boss.x += (dx / dist) * boss.speed; boss.y += (dy / dist) * boss.speed; }
            if(dist < 30 * currentScale) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        if (superBoss.alive) {
            const dx = player.x - superBoss.x; const dy = player.y - superBoss.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 0) { superBoss.x += (dx / dist) * superBoss.speed; superBoss.y += (dy / dist) * superBoss.speed; }
            if(dist < 40 * currentScale) {
                saveBossPos();
                localStorage.setItem('rpg_boss_encounter', 'true');
                localStorage.setItem('rpg_boss_hp', superBoss.hp);
                localStorage.setItem('rpg_boss_max_hp', superBoss.maxHp);
                localStorage.setItem('rpg_is_super_boss', 'true');
                localStorage.setItem('rpg_temp_player', JSON.stringify(player));
                location.href = 'battle.html';
            }
        }

        if (merchant.alive) {
            if (!isNight) {
                merchant.alive = false;
            } else {
                const now = Date.now();
                if (now - merchant.spawnTime > merchant.lifeTime) {
                    merchant.alive = false;
                } else {
                    // Random staggering movement
                    if (Math.random() < 0.05) {
                        merchant.moveDir = { x: Math.random() * 2 - 1, y: Math.random() * 2 - 1 };
                    }
                    merchant.x += merchant.moveDir.x * merchant.speed;
                    merchant.y += merchant.moveDir.y * merchant.speed;

                    const canvas = document.getElementById('gameCanvas');
                    if (merchant.x < 50 || merchant.x > canvas.width - 50) merchant.moveDir.x *= -1;
                    if (merchant.y < 50 || merchant.y > canvas.height - 50) merchant.moveDir.y *= -1;

                    const dx = player.x - merchant.x; const dy = player.y - merchant.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 40 * currentScale) {
                        merchant.alive = false;
                        openMerchantModal();
                    }
                }
            }
        }

        fieldItems = fieldItems.filter(item => {
            const dx = player.x - item.x; const dy = player.y - item.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            let pickupDist = 25 * scale;
            if (item.type === 'shoes') pickupDist = 35 * scale; // Larger pickup radius for shoes

            if (dist < pickupDist) {
                const ns = isNight ? "_night" : "";
                if (item.type === 'potion') {
                    const img = 'potion_hp' + ns + '.jpg';
                    player.inventory.push({name:'Ï≤¥Î†• Î¨ºÏïΩ', type:'potion_hp', desc:'HP +50 ÌöåÎ≥µ', val:50, img: img});
                } else if (item.type === 'shoes') {
                    player.moveSpeed += 2;
                    showConfirm("ÏïÑÏù¥ÌÖú ÌöçÎìù", "Ïã†ÏÜçÏùò Ïû•ÌôîÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§! Ïù¥Îèô ÏÜçÎèÑÍ∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌï©ÎãàÎã§.", null, true);
                }
                return false;
            }
            return true;
        });

        treasureBoxes = treasureBoxes.filter(box => {
            const dx = player.x - box.x; const dy = player.y - box.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            if (dist < 30 * scale) {
                getTreasure();
                return false;
            }
            return true;
        });

        const now = Date.now();
        coins = coins.filter(coin => {
            if (now - coin.creationTime > coin.lifeTime) return false;
            const dx = player.x - coin.x; const dy = player.y - coin.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const scale = currentScale;
            if (dist < (coin.size/2 + 16) * scale) {
                player.coinScore += coin.score;
                player.quests.coinCollectCount++;
                const sfx = coinSfx.cloneNode();
                sfx.volume = 0.5;
                sfx.play().catch(e=>{});
                addFloatingText(player.x, player.y - 30 * scale, `+${coin.score}`, '#ffd700');
                return false;
            }
            return true;
        });

        floatingTexts = floatingTexts.filter(ft => now - ft.startTime < ft.lifeTime);

        draw();
    }

    function triggerThunder() {
        const flash = document.getElementById('thunder-flash');
        flash.classList.remove('thunder-anim');
        void flash.offsetWidth;
        flash.classList.add('thunder-anim');
        if (thunderSfx) thunderSfx.play().catch(e => {});

        const pDmg = Math.floor(player.maxHp * 0.05);
        player.hp -= pDmg;

        if (boss.alive) {
            const bDmg = Math.floor(boss.maxHp * 0.03);
            boss.hp -= bDmg;
            localStorage.setItem('rpg_boss_hp', boss.hp);
            if (boss.hp <= 0) {
                boss.alive = false;
                localStorage.setItem('rpg_boss_death_time', Date.now());
            }
        }

        if (player.hp <= 0) showGameOver("Î≤ºÎùΩÏóê ÎßûÏïòÏäµÎãàÎã§...");
        updateUI();
    }

    async function showGameOver(msg) {
        if (gameLoopInterval) {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
        }
        isGameOver = true;

        if (!player.name) player.name = localStorage.getItem('rpg_player_name') || "Unknown";

        const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
        const survivalTime = Math.floor((Date.now() - startTime) / 1000);
        const min = Math.floor(survivalTime / 60);
        const sec = survivalTime % 60;

        const kills = player.quests.killCount || 0;
        const bossKills = player.quests.bossKillCount || 0;
        const normalKills = Math.max(0, kills - bossKills);

        let itemValue = 0;
        player.inventory.forEach(item => {
            if (item.type === 'weapon') {
                if (item.rarity === 'legendary') itemValue += 5000;
                else if (item.rarity === 'epic') itemValue += 2000;
            } else if (item.type.includes('potion') || item.type.includes('scroll')) {
                const rareItems = ['potion_full', 'potion_focus', 'potion_madness', 'potion_skeleton', 'potion_holy', 'potion_gamble', 'scroll_option'];
                if (rareItems.includes(item.type)) itemValue += 500;
            }
        });

        const lvScore = player.level * 1000;
        const bossScore = bossKills * 2000;
        const normalScore = normalKills * 10;
        const goldScore = Math.floor(player.gold * 0.1);
        const survivalScore = survivalTime;
        const coinScore = player.coinScore || 0;
        const merchantScore = player.merchantUsed ? 1000 : 0;

        const totalScore = lvScore + bossScore + normalScore + goldScore + itemValue + survivalScore + coinScore + merchantScore;

        const statsContainer = document.getElementById('go-stats-container');
        statsContainer.innerHTML = `
            <div class="go-row"><div class="go-label">üîπ Ï∫êÎ¶≠ÌÑ∞ Î†àÎ≤®</div><div class="go-val">${player.level} (LV) <span style="color:#888; font-size:0.8rem;">+${lvScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">üíÄ Î≥¥Ïä§ Ï≤òÏπò</div><div class="go-val">${bossKills} (ÎßàÎ¶¨) <span style="color:#888; font-size:0.8rem;">+${bossScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">‚öîÔ∏è Î™¨Ïä§ÌÑ∞ ÏÇ¨ÎÉ•</div><div class="go-val">${normalKills} (ÎßàÎ¶¨) <span style="color:#888; font-size:0.8rem;">+${normalScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">üí∞ Î≥¥Ïú† ÏûêÏÇ∞</div><div class="go-val">${player.gold.toLocaleString()} (G) <span style="color:#888; font-size:0.8rem;">+${goldScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">üíé ÏïÑÏù¥ÌÖú Í∞ÄÏπò</div><div class="go-val"><span style="color:#888; font-size:0.8rem;">+${itemValue.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">ü™ô ÏΩîÏù∏ Ï†êÏàò</div><div class="go-val">${coinScore.toLocaleString()} (Ï†ê) <span style="color:#888; font-size:0.8rem;">+${coinScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">üé∞ Í≥†Î∏îÎ¶∞ ÏÉÅÏù∏ Ï°∞Ïö∞</div><div class="go-val">${player.merchantUsed ? 'ÏôÑÎ£å' : 'ÎØ∏Î∞úÍ≤¨'} <span style="color:#888; font-size:0.8rem;">+${merchantScore.toLocaleString()}</span></div></div>
            <div class="go-row"><div class="go-label">‚è≥ ÏÉùÏ°¥ Î≥¥ÎÑàÏä§</div><div class="go-val">${min}Î∂Ñ ${sec}Ï¥à <span style="color:#888; font-size:0.8rem;">+${survivalScore.toLocaleString()}</span></div></div>
        `;

        document.querySelector('.gameover-title').innerText = msg;
        document.getElementById('go-score-val').innerText = totalScore.toLocaleString();

        // Send Ranking Data
        try {
            await fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    type: 'ranking',
                    name: player.name,
                    score: totalScore,
                    job: player.job,
                    level: player.level,
                    bossKills: bossKills
                })
            });
        } catch (e) {
            console.error("Ranking update failed:", e);
        }

        localStorage.removeItem('rpg_temp_player');
        localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
        localStorage.removeItem('rpg_boss_death_time');

        document.getElementById('gameover-modal').style.display = 'flex';
    }

    function getTreasure() {
        const jobList = DROP_TABLE[player.job] || DROP_TABLE['Ï†ÑÏÇ¨'];
        const baseName = jobList[Math.floor(Math.random() * jobList.length)];

        const cha = player.stats.cha || 10;
        const chaBonus = (cha - 10) * 0.005; // 0.5% per CHA point above 10

        const rand = Math.random();
        let rarity = "common";
        let rarityColor = "#ffffff";
        let grade = Math.floor(Math.random() * 3) + 1;

        if (rand < 0.1 + chaBonus) { rarity = "legendary"; rarityColor = "#ff8000"; grade = Math.floor(Math.random() * 6) + 15; }
        else if (rand < 0.25 + chaBonus) { rarity = "epic"; rarityColor = "#a335ee"; grade = Math.floor(Math.random() * 5) + 10; }
        else if (rand < 0.5 + chaBonus) { rarity = "rare"; rarityColor = "#2196f3"; grade = Math.floor(Math.random() * 4) + 5; }

        // Ï†ÑÏßÅ Ï†ÑÏóêÎäî Î†àÏ†ÑÎìúÎ¶¨ ÎìúÎ°≠ Î∂àÍ∞Ä
        if (!player.isAdvanced && rarity === "legendary") {
            rarity = "epic";
            rarityColor = "#a335ee";
            grade = Math.floor(Math.random() * 5) + 10;
        }

        const newItem = {
            name: `${rarity.toUpperCase()} ${baseName} (+${grade})`,
            type: 'weapon',
            desc: `Í≥µÍ≤©Î†• +${grade} (${player.job} Ï†ÑÏö©)`,
            val: grade,
            reqJob: player.job,
            equipped: false,
            rarity: rarity,
            rarityColor: rarityColor,
            enhanceCount: grade,
            failCount: 0,
            options: []
        };

        if (rarity !== "common") {
            const optCount = rarity === "legendary" ? 3 : (rarity === "epic" ? 1 : 1);
            const possibleOpts = [
                { name: "Ìûò", key: "str" },
                { name: "ÎØºÏ≤©", key: "dex" },
                { name: "Ï≤¥Î†•", key: "con" },
                { name: "ÏßÄÎä•", key: "int" }
            ];
            for (let i = 0; i < optCount; i++) {
                const opt = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
                const val = Math.floor(Math.random() * 5) + 1; // 1~5
                newItem.options.push({ name: opt.name, key: opt.key, val: val });
                newItem.desc += `\n[ÏòµÏÖò] ${opt.name} +${val}`;
            }
        }

        if (rarity === "legendary") {
             const specialOpt = LEGENDARY_SPECIAL_OPTIONS[Math.floor(Math.random() * LEGENDARY_SPECIAL_OPTIONS.length)];
             newItem.specialOption = specialOpt;
             newItem.desc += `\n<span style='color:#b2ff59; font-weight:bold;'>[ÌäπÏàò] ${specialOpt.name}</span>\n<span style='color:#aaa; font-size:0.7rem;'>${specialOpt.desc}</span>`;
        }

        player.inventory.push(newItem);
        showTreasureEvent(newItem);
    }

    function showTreasureEvent(item) {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');

        text.innerText = "ÎπÑÎ∞Ä ÏÉÅÏûê Î∞úÍ≤¨!";
        rewardText.innerText = item.name;
        rewardText.style.color = item.rarityColor || '#fff';
        img.src = 'image/bm.jpg';

        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');

        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function saveBossPos() {
        if(boss.alive) { localStorage.setItem('rpg_boss_x', boss.x); localStorage.setItem('rpg_boss_y', boss.y); localStorage.setItem('rpg_boss_hp', boss.hp); localStorage.setItem('rpg_boss_max_hp', boss.maxHp); }
        if(superBoss.alive) { localStorage.setItem('rpg_super_boss_hp', superBoss.hp); localStorage.setItem('rpg_super_boss_max_hp', superBoss.maxHp); }
    }

    function updateUI() {
        document.getElementById('ui-info').innerText = player.name;
        document.getElementById('ui-level').innerText = `LV.${player.level} ${player.job.toUpperCase()}`;
        document.getElementById('ui-hp-bar').style.width = `${Math.min(100, (player.hp/player.maxHp)*100)}%`;
        document.getElementById('ui-mp-bar').style.width = `${Math.min(100, (player.mp/player.maxMp)*100)}%`;
        document.getElementById('ui-exp-bar').style.width = `${Math.min(100, (player.exp/player.maxExp)*100)}%`;
        document.getElementById('ui-hp-text').innerText = `${Math.ceil(player.hp)}/${Math.round(player.maxHp)}`;
        document.getElementById('ui-mp-text').innerText = `${Math.ceil(player.mp)}/${Math.round(player.maxMp)}`;
        document.getElementById('ui-exp-text').innerText = `${Math.floor(player.exp)}/${player.maxExp}`;
    }

    function draw() {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scale = currentScale;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);

        fieldItems.forEach(item => {
            let img = potionImg;
            let size = 24 * scale;
            if (item.type === 'shoes') {
                img = shoesImg;
                size = 45 * scale; // Large coin size
            }
            else if (item.type === 'attack') img = atkImg;
            else if (item.type === 'defense') img = defImg;

            ctx.drawImage(img, item.x - size/2, item.y - size/2, size, size);
        });

        treasureBoxes.forEach(box => {
            const size = 30 * scale;
            ctx.drawImage(treasureBoxImg, box.x - size/2, box.y - size/2, size, size);
        });

        const cImg = isNight ? coinImgNight : coinImgDay;
        coins.forEach(coin => {
            const size = coin.size * scale;
            ctx.drawImage(cImg, coin.x - size/2, coin.y - size/2, size, size);
        });

        const pSize = 32 * scale;
        ctx.drawImage(playerImg, player.x - pSize/2, player.y - pSize/2, pSize, pSize);

        if(boss.alive) {
            const bSize = 50 * scale;
            ctx.drawImage(boss.img, boss.x - bSize/2, boss.y - bSize/2, bSize, bSize);
        }

        if(superBoss.alive) {
            const sbSize = 80 * scale;
            ctx.drawImage(superBoss.img, superBoss.x - sbSize/2, superBoss.y - sbSize/2, sbSize, sbSize);
        }

        if (merchant.alive) {
            const mSize = 40 * scale;
            ctx.drawImage(merchant.img, merchant.x - mSize/2, merchant.y - mSize/2, mSize, mSize);
        }

        ctx.font = `bold ${16 * scale}px 'Noto Serif KR'`;
        ctx.textAlign = "center";
        const now = Date.now();
        floatingTexts.forEach(ft => {
            const elapsed = now - ft.startTime;
            const alpha = 1 - (elapsed / ft.lifeTime);
            const lift = (elapsed / ft.lifeTime) * 30 * scale;
            ctx.fillStyle = ft.color;
            ctx.globalAlpha = alpha;
            ctx.fillText(ft.text, ft.x, ft.y - lift);
            ctx.globalAlpha = 1.0;
        });
    }

    function toggleModal(id) {
        const modal = document.getElementById(id);
        document.querySelectorAll('.modal').forEach(m => { if(m.id !== id) m.style.display = 'none'; });
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function openInventory() { toggleModal('inventory-modal'); switchTab('inv'); }

    function switchTab(tab) {
        document.getElementById('tab-inv').classList.toggle('active', tab === 'inv');
        document.getElementById('tab-traits').classList.toggle('active', tab === 'traits');
        document.getElementById('inv-list').style.display = (tab === 'inv') ? 'grid' : 'none';
        document.getElementById('trait-list').style.display = (tab === 'traits') ? 'block' : 'none';
        if (tab === 'inv') renderInventory();
        else renderTraits();
    }

    function getStatClass(val) {
        if (val >= 50) return 'stat-50';
        if (val >= 40) return 'stat-40';
        if (val >= 30) return 'stat-30';
        if (val >= 20) return 'stat-20';
        return 'stat-normal';
    }

    function getWeaponImage(job, rarity) {
        let baseJob = 'Ï†ÑÏÇ¨';
        if (['ÎèÑÏ†Å', 'Ïñ¥ÏåîÏã†', 'ÏÑÄÎèÑÏö∞'].includes(job)) baseJob = 'ÎèÑÏ†Å';
        if (['ÎßàÎ≤ïÏÇ¨', 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', 'ÏÜåÏÑúÎü¨'].includes(job)) baseJob = 'ÎßàÎ≤ïÏÇ¨';
        if (['ÏóòÌîÑ Í∂ÅÏàò', 'Ïä§ÎÇòÏù¥Ìçº', 'Î†àÏù∏Ï†Ä'].includes(job)) baseJob = 'ÏóòÌîÑ Í∂ÅÏàò';

        if (baseJob === 'Ï†ÑÏÇ¨') {
            if (rarity === 'legendary') return 'legend_warrior.jpg';
            if (rarity === 'epic') return 'epic_warrior.jpg';
            return 'weapon_warrior.jpg';
        } else if (baseJob === 'ÎèÑÏ†Å') {
            if (rarity === 'legendary') return 'legend_rogue.jpg';
            if (rarity === 'epic') return 'epic_rogue.jpg';
            return 'weapon_rogue.jpg';
        } else if (baseJob === 'ÎßàÎ≤ïÏÇ¨') {
            if (rarity === 'legendary') return 'legend_mage.jpg';
            if (rarity === 'epic') return 'epic_mage.jpg';
            return 'weapon_mage.jpg';
        } else if (baseJob === 'ÏóòÌîÑ Í∂ÅÏàò') {
            if (rarity === 'legendary') return 'legend_archer.jpg';
            if (rarity === 'epic') return 'epic_archer.jpg';
            if (rarity === 'rare') return 'rare_archer.jpg';
            return 'weapon_archer.jpg';
        }
        return 'weapon_warrior.jpg';
    }

    function renderInventory() {
        const list = document.getElementById('inv-list');
        const statusPanel = document.getElementById('inv-status-panel');
        document.getElementById('inv-gold-display').innerText = `${player.gold} G`;
        const baseAtk = Math.floor(player.stats.str/1.8) + (player.level*2);
        const totalAtk = baseAtk + player.bonusAtk;

        statusPanel.innerHTML = `
            <div style="text-align:center; margin-bottom:15px;"><img src="${getPlayerImage(player.job, player.inventory)}" style="width:100px; height:100px; border:1px solid #444; margin-bottom:10px;"><div style="color:var(--accent-gold); font-family:var(--font-head); font-size:1.1rem;">${player.job.toUpperCase()}</div></div>
            <div class="side-stat-row"><span class="side-stat-name">Î†àÎ≤®</span><span class="side-stat-val">${player.level}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">Ìûò</span><span class="side-stat-val ${getStatClass(player.stats.str)}">${player.stats.str}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÎØºÏ≤©</span><span class="side-stat-val ${getStatClass(player.stats.dex)}">${player.stats.dex}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">Ï≤¥Î†•</span><span class="side-stat-val ${getStatClass(player.stats.con)}">${player.stats.con}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÏßÄÎä•</span><span class="side-stat-val ${getStatClass(player.stats.int)}">${player.stats.int}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">ÏßÄÌòú</span><span class="side-stat-val ${getStatClass(player.stats.wis)}">${player.stats.wis}</span></div>
            <div class="side-stat-row"><span class="side-stat-name">Îß§Î†•</span><span class="side-stat-val ${getStatClass(player.stats.cha)}">${player.stats.cha}</span></div>
            <div class="side-stat-row" style="margin-top:15px; border-top:1px solid #333;"><span class="side-stat-name" style="color:#ef5350">Ï¥ù Í≥µÍ≤©Î†•</span><div class="side-atk-val">${totalAtk}${player.bonusAtk > 0 ? `<span class="side-bonus">(+${player.bonusAtk})</span>` : ''}</div></div>
            <div class="side-stat-row"><span class="side-stat-name" style="color:#2196f3">Ï∂îÍ∞Ä Î∞©Ïñ¥Î†•</span><div class="side-stat-val">${player.bonusDef}</div></div>
        `;

        list.innerHTML = '';
        if(player.inventory.length === 0) list.innerHTML = '<p style="color:#666; grid-column:span 3; text-align:center; padding:20px;">Í∞ÄÎ∞©Ïù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.</p>';

        const cha = player.stats.cha || 10;
        const chaSellBonus = 1 + (cha * 0.01); // 1% increase per CHA point

        player.inventory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `item-card ${item.equipped ? 'equipped' : ''}`;
            const typeText = item.type.includes('potion') || item.type.includes('scroll') ? 'ÏÜåÎ™®Ìíà' : 'Ïû•ÎπÑ';
            const typeColor = item.type.includes('potion') || item.type.includes('scroll') ? '#ef5350' : '#26a69a';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : (item.equipped ? 'color:var(--accent-gold)' : '');
            const baseVal = item.val || 10; const enh = item.enhanceCount || 0;
            const sellPrice = Math.floor(((baseVal * 5) + (enh * 50)) * chaSellBonus);

            let iconHtml = '';
            if (item.type.includes('potion') || item.type.includes('scroll') || item.type === 'weapon') {
                let iconSrc = item.img || (item.type === 'weapon' ? getWeaponImage(player.job, item.rarity) : 'potion_hp.jpg');
                iconHtml = `<img src="image/${iconSrc}" class="item-icon-small">`;
            }

            div.innerHTML = `<div><div class="item-header">${iconHtml}<div class="item-name ${rarityClass}" style="${nameStyle}" title="${item.name}">${item.name}</div></div><div class="item-desc">${item.desc.replace(/\n/g, '<br>')}</div><div class="item-price">ÌåêÎß§Í∞Ä: <span style="color:gold">${sellPrice} G</span></div></div><div class="item-type" style="color:${typeColor}">${typeText}</div><button class="sell-btn" onclick="askSell(${index}); event.stopPropagation();">ÌåêÎß§</button>`;
            div.onclick = () => useItem(index);
            list.appendChild(div);
        });
    }

    function renderTraits() {
        const list = document.getElementById('trait-list');
        list.innerHTML = `<div class="trait-point-display">Î≥¥Ïú† ÌäπÏÑ± Ìè¨Ïù∏Ìä∏: ${player.traitPoints}</div>`;

        const traitData = [
            { key: 'str', name: 'Í∑ºÎ†• Í∞ïÌôî', desc: 'Ìûò Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'dex', name: 'ÎØºÏ≤© Í∞ïÌôî', desc: 'ÎØºÏ≤© Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'con', name: 'Ï≤¥Î†• Í∞ïÌôî', desc: 'Ï≤¥Î†• Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'int', name: 'ÏßÄÎä• Í∞ïÌôî', desc: 'ÏßÄÎä• Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'wis', name: 'ÏßÄÌòú Í∞ïÌôî', desc: 'ÏßÄÌòú Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' },
            { key: 'cha', name: 'Îß§Î†• Í∞ïÌôî', desc: 'Îß§Î†• Îä•Î†•ÏπòÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.' }
        ];

        traitData.forEach(t => {
            const lv = player.traits[t.key] || 0;
            const div = document.createElement('div');
            div.className = 'trait-item';
            div.innerHTML = `
                <div class="trait-info">
                    <div class="trait-name">${t.name}</div>
                    <div class="trait-desc">${t.desc}</div>
                </div>
                <div class="trait-level">Lv. ${lv}</div>
                <button class="trait-up-btn" onclick="upgradeTrait('${t.key}')" ${player.traitPoints <= 0 ? 'disabled' : ''}>Í∞ïÌôî</button>
            `;
            list.appendChild(div);
        });
    }

    function upgradeTrait(key) {
        if (player.traitPoints <= 0) return;
        player.traitPoints--;
        if (!player.traits[key]) player.traits[key] = 0;
        player.traits[key]++;
        player.stats[key]++;

        if (key === 'con') { player.maxHp += 2; player.hp += 2; }
        if (key === 'int' || key === 'wis') { player.maxMp += 2; player.mp += 2; }

        renderTraits();
        updateUI();
    }

    function openShop() { toggleModal('shop-modal'); renderShopList(); }

    function renderShopList() {
        const list = document.getElementById('shop-list');
        document.getElementById('shop-gold-display').innerText = `${player.gold} GOLD`;
        list.innerHTML = '';
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if(weapons.length === 0) { list.innerHTML = '<p style="color:#666; grid-column:span 4; text-align:center;">Í∞ïÌôîÌï† Î¨¥Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'; return; }

        const cha = player.stats.cha || 10;
        const chaDiscount = Math.min(0.3, cha * 0.005); // Max 30% discount

        weapons.forEach(({ item, idx }) => {
            const enhanceLv = item.enhanceCount !== undefined ? item.enhanceCount : 0;
            const baseCost = (enhanceLv + 1) * 50;
            const cost = Math.floor(baseCost * (1 - chaDiscount));

            let successRate = 100;
            if (enhanceLv < 5) successRate = 100;
            else if (enhanceLv < 10) successRate = 100 - (enhanceLv - 4) * 10;
            else if (enhanceLv < 15) successRate = 45 - (enhanceLv - 10) * 5;
            else successRate = Math.max(5, 20 - (enhanceLv - 15) * 3);
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            const nameStyle = item.rarityColor ? `color:${item.rarityColor};` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}" style="${nameStyle}" title="${item.name}">${item.name}</div><div class="item-desc">ÌòÑÏû¨: +${enhanceLv}</div><div class="item-desc" style="color:#888; margin-top:5px;">ÎπÑÏö©: <span style="color:var(--accent-gold)">${cost} G</span> | ÌôïÎ•†: ${successRate}%</div><button class="enhance-btn" onclick="askEnhance(${idx}, ${cost}, ${successRate}, ${enhanceLv})">Í∞ïÌôîÌïòÍ∏∞</button>`;
            if(enhanceLv >= 20) { div.querySelector('button').disabled = true; div.querySelector('button').innerText = "ÏµúÎåÄ Î†àÎ≤®"; }
            list.appendChild(div);
        });
    }

    function showConfirm(title, msg, onYes, onlyOk = false) {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerHTML = msg;
        document.getElementById('confirm-no-btn').style.display = onlyOk ? 'none' : 'block';
        document.getElementById('confirm-yes-btn').innerText = onlyOk ? 'ÌôïÏù∏' : 'Ïòà';
        currentConfirmAction = onYes;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function executeConfirm() {
        const action = currentConfirmAction;
        closeConfirm();
        if (action) action();
    }

    function askEnhance(index, cost, rate, currentLv) {
        if(player.gold < cost) return showConfirm("Í≥®Îìú Î∂ÄÏ°±", "Í∞ïÌôîÏóê ÌïÑÏöîÌïú Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", null, true);
        showConfirm("Í∞ïÌôî ÌôïÏù∏", `${cost}GÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Í∞ïÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(ÌôïÎ•†: ${rate}%)`, () => executeEnhance(index, cost, rate, currentLv));
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
        currentConfirmAction = null;
    }

    function executeEnhance(index, cost, rate, currentLv) {
        player.gold -= cost;
        const item = player.inventory[index];
        const isSuccess = Math.random() * 100 < rate;

        if(isSuccess) {
            item.enhanceCount = (item.enhanceCount || currentLv) + 1;
            item.val += 1;
            item.desc = item.desc.replace(/\+\d+/, `+${item.val}`);
            if(item.name.match(/\(\+\d+\)/)) item.name = item.name.replace(/\(\+\d+\)/, `(+${item.enhanceCount})`);
            else item.name += ` (+${item.enhanceCount})`;
            if(item.equipped) player.bonusAtk += 1;
            player.quests.enhanceCount++;
            item.failCount = 0; // Reset fail count on success
            showEnhanceEffect();
            successSfx.play().catch(e => console.log(e));
        } else {
            item.failCount = (item.failCount || 0) + 1;
            if (item.failCount >= 3) {
                if(item.equipped) {
                    player.bonusAtk -= item.val;
                    if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
                }
                player.inventory.splice(index, 1);
                showConfirm("Í∞ïÌôî Ïã§Ìå®", "Í∞ïÌôîÏóê 3Î≤à Ïã§Ìå®ÌïòÏó¨ Î¨¥Í∏∞Í∞Ä ÌååÍ¥¥ÎêòÏóàÏäµÎãàÎã§!", null, true);
            } else {
                showConfirm("Í∞ïÌôî Ïã§Ìå®", `Í∞ïÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§... (Ïó∞ÏÜç Ïã§Ìå®: ${item.failCount}/3)\nÍ≥®ÎìúÎßå ÏÜåÎ™®ÎêòÏóàÏäµÎãàÎã§.`, null, true);
            }
            failSfx.play().catch(e => console.log(e));
        }
        updateUI(); renderShopList();
    }

    function openQuest() { toggleModal('quest-modal'); renderQuestList(); }

    function renderQuestList() {
        const list = document.getElementById('quest-list');
        list.innerHTML = '';
        const quests = [
            { id: 'dayKill', title: 'ÎÇÆÏùò ÏÇ¨ÎÉ•Íæº', desc: 'ÎÇÆ Î™¨Ïä§ÌÑ∞ 5ÎßàÎ¶¨ Ï≤òÏπò', goal: 5, current: player.quests.dayKillCount || 0, reward: '500 G', claimed: player.quests.claimed.dayKill },
            { id: 'nightKill', title: 'Î∞§Ïùò Ï∂îÏ†ÅÏûê', desc: 'Î∞§ Î™¨Ïä§ÌÑ∞ 5ÎßàÎ¶¨ Ï≤òÏπò', goal: 5, current: player.quests.nightKillCount || 0, reward: '800 G', claimed: player.quests.claimed.nightKill },
            { id: 'bossKill', title: 'Î≥¥Ïä§ Ïä¨Î†àÏù¥Ïñ¥', desc: 'Î≥¥Ïä§ Î™¨Ïä§ÌÑ∞ 1ÎßàÎ¶¨ Ï≤òÏπò', goal: 1, current: player.quests.bossKillCount || 0, reward: '2000 G', claimed: player.quests.claimed.bossKill },
            { id: 'enhance', title: 'Í∞ïÌôîÏùò Îã¨Ïù∏', desc: 'Í∞ïÌôî 1Ìöå ÏÑ±Í≥µ', goal: 1, current: player.quests.enhanceCount, reward: '300 G', claimed: player.quests.claimed.enhance },
            { id: 'coinCollect', title: 'Î∞òÏßùÏù¥Îäî Ïú†Ìòπ', desc: 'ÌïÑÎìúÏóê Îñ®Ïñ¥ÏßÑ ÏΩîÏù∏ 5Í∞ú Ï§çÍ∏∞', goal: 5, current: player.quests.coinCollectCount || 0, reward: '500 G', claimed: player.quests.claimed.coinCollect }
        ];
        quests.forEach(q => {
            const div = document.createElement('div');
            div.className = 'quest-item';
            const isComplete = q.current >= q.goal;
            const btnText = q.claimed ? 'Î≥¥ÏÉÅ ÏàòÎ†π ÏôÑÎ£å' : (isComplete ? 'Î≥¥ÏÉÅ Î∞õÍ∏∞' : 'ÏßÑÌñâ Ï§ë');
            div.innerHTML = `<div class="quest-title">${q.title}</div><div class="quest-progress">${q.desc} (${Math.min(q.current, q.goal)}/${q.goal})</div><div class="quest-reward">Î≥¥ÏÉÅ: ${q.reward}</div><button class="quest-claim-btn" onclick="claimQuest('${q.id}')" ${(!isComplete || q.claimed) ? 'disabled' : ''}>${btnText}</button>`;
            list.appendChild(div);
        });
    }

    function claimQuest(id) {
        if (id === 'dayKill' && !player.quests.claimed.dayKill) { player.gold += 500; player.quests.claimed.dayKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "500 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'nightKill' && !player.quests.claimed.nightKill) { player.gold += 800; player.quests.claimed.nightKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "800 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'bossKill' && !player.quests.claimed.bossKill) { player.gold += 2000; player.quests.claimed.bossKill = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "2000 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'enhance' && !player.quests.claimed.enhance) { player.gold += 300; player.quests.claimed.enhance = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "300 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        else if (id === 'coinCollect' && !player.quests.claimed.coinCollect) { player.gold += 500; player.quests.claimed.coinCollect = true; showConfirm("ÌÄòÏä§Ìä∏ ÏôÑÎ£å", "500 GÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!", null, true); }
        updateUI(); renderQuestList();
    }

    function showEnhanceEffect() {
        const el = document.getElementById('enhance-effect');
        el.classList.remove('enhance-anim'); void el.offsetWidth; el.classList.add('enhance-anim');
    }

    function useItem(index) {
        const item = player.inventory[index];
        if (item.type.includes('potion') || item.type.includes('scroll')) {
            if (item.type === 'potion_gamble') { // Added check for potion_gamble
                return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "ÎèÑÎ∞ïÏÇ¨Ïùò ÏãúÏïΩÏùÄ Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.", null, true);
            }
            if (item.type === 'potion_full') {
                if (player.hp >= player.maxHp && player.mp >= player.maxMp) return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ïù¥ÎØ∏ Ï≤¥Î†•Í≥º ÎßàÎÇòÍ∞Ä Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", null, true);
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                potionSfx.play().catch(e => {});
            } else if (player.hp >= player.maxHp && item.name.includes('Ï≤¥Î†•')) return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï≤¥Î†•Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", null, true);
            else if (player.mp >= player.maxMp && item.name.includes('ÎßàÎÇò')) return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "ÎßàÎÇòÍ∞Ä Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", null, true);

            if (item.type === 'potion_full') { /* already handled above */ }
            else if (item.name.includes('Ï≤¥Î†•')) { player.hp = Math.min(player.hp + item.val, player.maxHp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('ÎßàÎÇò')) { player.mp = Math.min(player.mp + item.val, player.maxMp); potionSfx.play().catch(e => {}); }
            else if (item.name.includes('Í≤ΩÌóòÏπò')) {
                player.exp += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Í≤ΩÌóòÏπòÎ•º ${item.val} ÌöçÎìùÌñàÏäµÎãàÎã§!`, null, true);
                if (player.exp >= player.maxExp) {
                    player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
                    player.traitPoints += 2;
                    showConfirm("Î†àÎ≤® ÏóÖ!", "Î†àÎ≤® ÏóÖ! ÌäπÏÑ± Ìè¨Ïù∏Ìä∏ 2Í∞úÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§.", () => { checkAdvancement(); }, true);
                }
            } else if (item.type === 'potion_atk') {
                player.bonusAtk += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Í≥µÍ≤©Î†•Ïù¥ ${item.val}ÎßåÌÅº ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§!`, null, true);
            } else if (item.type === 'potion_def') {
                player.bonusDef += item.val;
                potionSfx.play().catch(e => {});
                showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `Î∞©Ïñ¥Î†•Ïù¥ ${item.val}ÎßåÌÅº ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§!`, null, true);
            } else if (item.type === 'scroll_option') {
                // ÏòµÏÖò Î∂ÄÏó¨ Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö© Î°úÏßÅ
                showOptionScrollUI(index);
                return; // UIÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑú Ï¢ÖÎ£å
            } else if (item.type === 'potion_skeleton') {
                // Ìï¥Í≥® Ìè¨ÏÖòÏùÄ Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö© Í∞ÄÎä•ÌïòÎØÄÎ°ú ÎßµÏóêÏÑúÎäî ÏÇ¨Ïö© Î∂àÍ∞Ä Î©îÏãúÏßÄ
                return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§.", null, true);
            } else if (item.type === 'potion_focus' || item.type === 'potion_holy' || item.type === 'potion_madness') {
                return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§.", null, true);
            }

            player.inventory.splice(index, 1);
            if (!item.name.includes('Í≤ΩÌóòÏπò') && !item.type.includes('atk') && !item.type.includes('def')) showConfirm("ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©", `${item.name}ÏùÑ(Î•º) ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.`, null, true);
        } else if (item.type === 'weapon') {
            if (item.reqJob && item.reqJob !== player.job) return showConfirm("Ï∞©Ïö© Î∂àÍ∞Ä", `[${item.reqJob}] Ï†ÑÏö© Ïû•ÎπÑÏûÖÎãàÎã§.`, null, true);
            if (item.equipped) {
                item.equipped = false;
                player.bonusAtk -= item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            }
            else {
                player.inventory.forEach(i => {
                    if (i.type === 'weapon' && i.equipped) {
                        i.equipped = false;
                        player.bonusAtk -= i.val;
                        if (i.options) i.options.forEach(opt => player.stats[opt.key] -= opt.val);
                    }
                });
                item.equipped = true;
                player.bonusAtk += item.val;
                if (item.options) item.options.forEach(opt => player.stats[opt.key] += opt.val);
                equipSfx.play().catch(e => {});
            }
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        renderInventory(); updateUI();
    }

    function showOptionScrollUI(scrollIndex) {
        // Ïû•ÎπÑ Î™©Î°ùÏùÑ Î≥¥Ïó¨Ï£ºÍ≥† ÏÑ†ÌÉùÌïòÍ≤å Ìï®
        const weapons = player.inventory.map((item, idx) => ({ item, idx })).filter(obj => obj.item.type === 'weapon');
        if (weapons.length === 0) {
            return showConfirm("ÏÇ¨Ïö© Î∂àÍ∞Ä", "ÏòµÏÖòÏùÑ Î∂ÄÏó¨Ìï† Ïû•ÎπÑÍ∞Ä ÏóÜÏäµÎãàÎã§.", null, true);
        }

        // Í∞ÑÎã®ÌïòÍ≤å ÌîÑÎ°¨ÌîÑÌä∏ÎÇò Ïª®ÌéåÏúºÎ°ú Ï≤òÎ¶¨ÌïòÍ∏∞Ïóî Î≥µÏû°ÌïòÎØÄÎ°ú,
        // Í∏∞Ï°¥ ÏÉÅÏ†ê Î™®Îã¨ÏùÑ Ïû¨ÌôúÏö©ÌïòÏó¨ Ïû•ÎπÑ ÏÑ†ÌÉù Ïú†ÎèÑ
        const modal = document.getElementById('shop-modal');
        const list = document.getElementById('shop-list');
        const title = modal.querySelector('h2');
        const originalTitle = title.innerText;

        title.innerText = "ÏòµÏÖò Î∂ÄÏó¨ ÎåÄÏÉÅ ÏÑ†ÌÉù";
        document.getElementById('shop-gold-display').style.display = 'none';

        list.innerHTML = '';
        weapons.forEach(({ item, idx }) => {
            const div = document.createElement('div');
            div.className = 'item-card';
            const rarityClass = item.rarity ? `rarity-${item.rarity}` : '';
            div.innerHTML = `<div class="item-name ${rarityClass}">${item.name}</div><div class="item-desc">${item.desc}</div><button class="enhance-btn" onclick="applyOptionScroll(${scrollIndex}, ${idx})">ÏÑ†ÌÉù</button>`;
            list.appendChild(div);
        });

        // Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº Ïû¨Ï†ïÏùò (ÏõêÏÉÅÎ≥µÍµ¨ ÌïÑÏöî)
        const closeBtn = modal.querySelector('.close-btn');
        const originalOnClick = closeBtn.onclick;
        closeBtn.onclick = () => {
            toggleModal('shop-modal');
            title.innerText = originalTitle;
            document.getElementById('shop-gold-display').style.display = 'block';
            closeBtn.onclick = originalOnClick;
        };

        toggleModal('shop-modal');
    }

    function applyOptionScroll(scrollIndex, itemIndex) {
        const item = player.inventory[itemIndex];

        // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ (Ïä§ÌÉØ Ï∞®Í∞ê)
        if (item.equipped && item.options) {
            item.options.forEach(opt => player.stats[opt.key] -= opt.val);
        }

        // ÏÉàÎ°úÏö¥ ÏòµÏÖò ÏÉùÏÑ±
        const optCount = Math.floor(Math.random() * 3) + 1; // 1~3Í∞ú
        const newOptions = [];
        const possibleOpts = [
            { name: "Ìûò", key: "str" },
            { name: "ÎØºÏ≤©", key: "dex" },
            { name: "Ï≤¥Î†•", key: "con" },
            { name: "ÏßÄÎä•", key: "int" }
        ];

        let descText = `Í≥µÍ≤©Î†• +${item.val} (${item.reqJob || player.job} Ï†ÑÏö©)`;
        let optionMsg = "";

        for(let i=0; i<optCount; i++) {
            const type = possibleOpts[Math.floor(Math.random() * possibleOpts.length)];
            const val = Math.floor(Math.random() * 5) + 1; // 1~5
            newOptions.push({ name: type.name, key: type.key, val: val });
            descText += `\n[ÏòµÏÖò] ${type.name} +${val}`;
            optionMsg += `<span style="color:#ffd700; font-weight:bold;">[${type.name} +${val}]</span> `;
        }

        item.options = newOptions;
        item.desc = descText;

        // ÏÉà ÏòµÏÖò Ï†ÅÏö© (Ïä§ÌÉØ Í∞ÄÏÇ∞)
        if (item.equipped) {
            item.options.forEach(opt => player.stats[opt.key] += opt.val);
        }

        // Ïä§ÌÅ¨Î°§ ÏÜåÎ™®
        player.inventory.splice(scrollIndex, 1);

        // Î™®Îã¨ Îã´Í∏∞ Î∞è Î≥µÍµ¨
        const modal = document.getElementById('shop-modal');
        toggleModal('shop-modal');
        modal.querySelector('h2').innerText = "ÎåÄÏû•Í∞Ñ";
        document.getElementById('shop-gold-display').style.display = 'block';

        showConfirm("ÏòµÏÖò Î∂ÄÏó¨ ÏÑ±Í≥µ", `${item.name}Ïóê ÏÉàÎ°úÏö¥ ÏòµÏÖòÏù¥ Î∂ÄÏó¨ÎêòÏóàÏäµÎãàÎã§!<br><br>Î∂ÄÏó¨Îêú ÏòµÏÖò:<br>${optionMsg}`, null, true);
        updateUI();
    }

    function askSell(index) {
        const item = player.inventory[index];
        const cha = player.stats.cha || 10;
        const chaSellBonus = 1 + (cha * 0.01);
        const baseVal = item.val || 10; const enh = item.enhanceCount || 0;
        const price = Math.floor(((baseVal * 5) + (enh * 50)) * chaSellBonus);
        showConfirm("ÌåêÎß§ ÌôïÏù∏", `[${item.name}]ÏùÑ(Î•º) ${price} GÏóê ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => sellItem(index, price));
    }

    function sellItem(index, price) {
        const item = player.inventory[index];
        if(item.equipped) {
            player.bonusAtk -= item.val;
            if (item.options) item.options.forEach(opt => player.stats[opt.key] -= opt.val);
            playerImg.src = getPlayerImage(player.job, player.inventory);
        }
        player.gold += price; player.inventory.splice(index, 1);
        renderInventory(); updateUI();
    }

    function askManualSave() {
        showConfirm("Ï†ÄÏû• ÌôïÏù∏", "ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô©ÏùÑ Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => manualSave());
    }

    async function manualSave() {
        const overlay = document.getElementById('loading-overlay');
        const txt = document.querySelector('.loading-text');
        txt.innerText = "Ï†ÄÏû• Ï§ë..."; overlay.style.display = 'flex';

        try {
            if (!player.name) {
                player.name = localStorage.getItem('rpg_player_name');
            }

            await fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(player)
            });

            localStorage.removeItem('rpg_temp_player');
            setTimeout(() => {
                overlay.style.display = 'none';
                showConfirm("Ï†ÄÏû• ÏôÑÎ£å", "Îç∞Ïù¥ÌÑ∞Í∞Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!", null, true);
            }, 1500);

        } catch(e) {
            console.error("Save Error:", e);
            showConfirm("Ï†ÄÏû• Ïã§Ìå®", "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", null, true);
            overlay.style.display = 'none';
        }
    }

    function showRandomEvent() {
        const overlay = document.getElementById('event-overlay');
        const text = document.getElementById('event-text');
        const rewardText = document.getElementById('event-reward');
        const img = document.getElementById('event-img');
        const events = [
            { t: "Î≥¥Î¨º Î∞úÍ≤¨!", g: 200, h: 0, m: 0, i: "image/bm.jpg", r: "+200 Í≥®Îìú" },
            { t: "Í≥†ÎåÄÏùò ÏÉò!", g: 0, h: 50, m: 30, i: "image/bm.jpg", r: "+50 HP / +30 MP" },
            { t: "ÌñâÏö¥Ïùò ÎèôÏ†Ñ!", g: 100, h: 0, m: 0, i: "image/bm.jpg", r: "+100 Í≥®Îìú" }
        ];
        const ev = events[Math.floor(Math.random() * events.length)];
        text.innerText = ev.t; rewardText.innerText = ev.r; img.src = ev.i;
        player.gold += ev.g; player.hp = Math.min(player.hp + ev.h, player.maxHp); player.mp = Math.min(player.mp + ev.m, player.maxMp);
        if (ev.g > 0) goldSfx.play().catch(e => {});
        overlay.style.display = 'flex';
        overlay.classList.remove('event-anim');
        void overlay.offsetWidth;
        overlay.classList.add('event-anim');
        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
        updateUI();
    }

    function handleMovement() {
        if(document.querySelector('.modal[style*="flex"]')) return;
        if(isSizeControlling) return;

        const canvas = document.getElementById('gameCanvas');
        let s = player.moveSpeed || 12;
        if (currentWeather === "rain") s *= 0.7;

        let dx = 0;
        let dy = 0;

        if (keysPressed["ArrowUp"]) dy -= 1;
        if (keysPressed["ArrowDown"]) dy += 1;
        if (keysPressed["ArrowLeft"]) dx -= 1;
        if (keysPressed["ArrowRight"]) dx += 1;

        if (dx !== 0 || dy !== 0) {
            if (dx !== 0 && dy !== 0) {
                const factor = 0.7071;
                dx *= factor;
                dy *= factor;
            }

            const oldX = player.x;
            const oldY = player.y;

            player.x += dx * s;
            player.y += dy * s;

            player.x = Math.max(16, Math.min(canvas.width - 16, player.x));
            player.y = Math.max(16, Math.min(canvas.height - 16, player.y));

            if (player.x !== oldX || player.y !== oldY) {
                const moveDist = Math.sqrt(Math.pow(player.x - oldX, 2) + Math.pow(player.y - oldY, 2));
                distAccumulator += moveDist;
                if (distAccumulator >= 30) {
                    distAccumulator = 0;
                    checkEncounters();
                }
            }
        }
    }

    function checkEncounters() {
        const rand = Math.random();
        let eventChance = isNight ? 0.02 : 0.01;
        let encounterChance = 0.06;

        if (currentWeather === "fog") {
            if (player.job !== 'ÏóòÌîÑ Í∂ÅÏàò') {
                eventChance *= 1.5;
                encounterChance *= 2.0;
            }
        }

        if (rand < eventChance) showRandomEvent();
        else if (rand < encounterChance) {
            saveBossPos();
            localStorage.removeItem('rpg_boss_encounter');
            localStorage.setItem('rpg_is_night', isNight);
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            location.href = 'battle.html';
        }
    }

    // Slot Machine Logic
    let slotInterval = null;
    let currentRewardPool = [];

    const rewardPools = {
        common: [
            { name: "Ï≤¥Î†• Î¨ºÏïΩ", type: "potion_hp", val: 50, img: "potion_hp.jpg", rarity: "common" },
            { name: "Í≥®Îìú Ï£ºÎ®∏Îãà", type: "gold", val: 500, img: "coin_gold.jpg", rarity: "rare" },
            { name: "Í≤ΩÌóòÏπò ÎπÑÏïΩ", type: "exp", val: 100, img: "potion_hp_night.jpg", rarity: "rare" }
        ],
        'Ï†ÑÏÇ¨': [
            { name: "Í∏∞ÏÇ¨Ïùò Í≤Ä", type: "weapon", val: 10, img: "weapon_warrior.jpg", rarity: "rare" },
            { name: "Ïö©ÏÇ¨Ïùò ÎåÄÍ≤Ä", type: "weapon", val: 20, img: "epic_warrior.jpg", rarity: "epic" }
        ],
        'ÎèÑÏ†Å': [
            { name: "ÏïîÏÇ¥ÏûêÏùò Îã®ÎèÑ", type: "weapon", val: 10, img: "weapon_rogue.jpg", rarity: "rare" },
            { name: "Í∑∏Î¶ºÏûê ÎπÑÏàò", type: "weapon", val: 20, img: "epic_rogue.jpg", rarity: "epic" }
        ],
        'ÎßàÎ≤ïÏÇ¨': [
            { name: "ÎßàÎ≤ï ÏßÄÌå°Ïù¥", type: "weapon", val: 10, img: "weapon_mage.jpg", rarity: "rare" },
            { name: "ÌòÑÏûêÏùò Ïä§ÌÉúÌîÑ", type: "weapon", val: 20, img: "epic_mage.jpg", rarity: "epic" }
        ],
        'ÏóòÌîÑ Í∂ÅÏàò': [
            { name: "Ïª¥Ìè¨ÏßÄÌä∏ Î≥¥Ïö∞", type: "weapon", val: 10, img: "weapon_archer.jpg", rarity: "rare" },
            { name: "ÏúàÎìúÎü∞ÎÑà", type: "weapon", val: 20, img: "epic_archer.jpg", rarity: "epic" }
        ]
    };

    function openMerchantModal() {
        const modal = document.getElementById('merchant-modal');
        const slotImg = document.getElementById('slot-image');
        const resultText = document.getElementById('slot-result');
        const runBtn = document.getElementById('slot-run-btn');
        const confirmBtn = document.getElementById('slot-confirm-btn');

        modal.style.display = 'flex';
        resultText.innerText = "Ï§ÄÎπÑ ÏôÑÎ£å!";
        resultText.style.color = "#fff";
        runBtn.style.display = 'block';
        confirmBtn.style.display = 'none';
        slotImg.classList.remove('slot-spinning');
        slotImg.style.filter = 'none';
        slotImg.src = 'image/potion_hp.jpg'; // Reset image

        // Mark as used immediately when modal opens to prevent multiple spawns
        player.merchantUsed = true;
    }

    function runSlotMachine() {
        const slotImg = document.getElementById('slot-image');
        const resultText = document.getElementById('slot-result');
        const runBtn = document.getElementById('slot-run-btn');

        runBtn.style.display = 'none';
        resultText.innerText = "ÎèåÏïÑÍ∞ÄÎäî Ï§ë...";
        slotImg.classList.add('slot-spinning');
        slotImg.style.filter = 'none';

        // Play rolling sound
        slotSfx.currentTime = 0;
        slotSfx.play().catch(e => {});

        // Build pool: Common + Job Specific
        let jobBase = 'Ï†ÑÏÇ¨';
        if (['ÎèÑÏ†Å', 'Ïñ¥ÏåîÏã†', 'ÏÑÄÎèÑÏö∞'].includes(player.job)) jobBase = 'ÎèÑÏ†Å';
        if (['ÎßàÎ≤ïÏÇ¨', 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', 'ÏÜåÏÑúÎü¨'].includes(player.job)) jobBase = 'ÎßàÎ≤ïÏÇ¨';
        if (['ÏóòÌîÑ Í∂ÅÏàò', 'Ïä§ÎÇòÏù¥Ìçº', 'Î†àÏù∏Ï†Ä'].includes(player.job)) jobBase = 'ÏóòÌîÑ Í∂ÅÏàò';

        currentRewardPool = [...rewardPools.common, ...(rewardPools[jobBase] || rewardPools['Ï†ÑÏÇ¨'])];

        slotInterval = setInterval(() => {
            const randItem = currentRewardPool[Math.floor(Math.random() * currentRewardPool.length)];
            slotImg.src = 'image/' + randItem.img;
        }, 100);

        setTimeout(stopSlotMachine, 3000);
    }

    function stopSlotMachine() {
        clearInterval(slotInterval);
        const slotImg = document.getElementById('slot-image');
        const resultText = document.getElementById('slot-result');
        const confirmBtn = document.getElementById('slot-confirm-btn');
        slotImg.classList.remove('slot-spinning');

        const rand = Math.random();
        let reward = null;

        if (rand < 0.1) { // Jackpot (10%)
            reward = currentRewardPool.find(i => i.rarity === 'epic') || currentRewardPool[0];
            resultText.innerText = "üéä ÎåÄÎ∞ï! üéä " + reward.name;
            resultText.style.color = "#ff8000";
            slotImg.src = 'image/' + reward.img;
        } else if (rand < 0.6) { // Normal (50%)
            reward = currentRewardPool[Math.floor(Math.random() * currentRewardPool.length)];
            resultText.innerText = "ÌöçÎìù: " + reward.name;
            resultText.style.color = "#4caf50";
            slotImg.src = 'image/' + reward.img;
        } else { // Fail (40%)
            resultText.innerText = "ÍΩù! Îã§Ïùå Í∏∞ÌöåÏóê...";
            resultText.style.color = "#ff3333";
            // Sensible fail display: Grayscale and a bit of a shake or a specific "fail" look
            slotImg.src = 'image/ka.jpg'; // Using a monster image as a "fail"
            slotImg.style.filter = 'grayscale(100%) sepia(100%) hue-rotate(-50deg)';
        }

        pendingReward = reward;
        confirmBtn.style.display = 'block';
        updateUI();
    }

    function closeMerchant() {
        if (pendingReward) {
            const reward = pendingReward;
            if (reward.type === 'weapon') {
                const newItem = {
                    name: reward.name + " (+0)",
                    type: 'weapon',
                    desc: `Í≥µÍ≤©Î†• +${reward.val} (${player.job} Ï†ÑÏö©)`,
                    val: reward.val,
                    reqJob: player.job,
                    equipped: false,
                    rarity: reward.rarity,
                    rarityColor: reward.rarity === 'epic' ? '#a335ee' : '#2196f3',
                    enhanceCount: 0,
                    failCount: 0,
                    options: [],
                    img: reward.img
                };
                player.inventory.push(newItem);
            } else if (reward.type === 'gold') {
                player.gold += reward.val;
                coinSfx.play().catch(e=>{});
            } else if (reward.type === 'potion_hp') {
                player.inventory.push({name: reward.name, type: 'potion_hp', desc: "HP +50 ÌöåÎ≥µ", val: reward.val, img: reward.img});
            } else if (reward.type === 'exp') {
                player.exp += reward.val;
                if (player.exp >= player.maxExp) {
                    player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
                    player.traitPoints += 2;
                }
            }
            pendingReward = null;
        }
        document.getElementById('merchant-modal').style.display = 'none';
        updateUI();
    }

    // Mobile Control Logic
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.getElementById('mobile-controls').style.display = 'grid';
    }

    function handleMobilePress(key) {
        keysPressed[key] = true;
    }
    function handleMobileRelease(key) {
        keysPressed[key] = false;
    }

    const dPadButtons = [
        { id: 'btn-up', key: 'ArrowUp' },
        { id: 'btn-down', key: 'ArrowDown' },
        { id: 'btn-left', key: 'ArrowLeft' },
        { id: 'btn-right', key: 'ArrowRight' }
    ];

    dPadButtons.forEach(btn => {
        const el = document.getElementById(btn.id);
        if (el) {
            el.addEventListener('touchstart', (e) => { e.preventDefault(); handleMobilePress(btn.key); }, {passive: false});
            el.addEventListener('touchend', (e) => { e.preventDefault(); handleMobileRelease(btn.key); });
            el.addEventListener('mousedown', (e) => { handleMobilePress(btn.key); });
            el.addEventListener('mouseup', (e) => { handleMobileRelease(btn.key); });
            el.addEventListener('mouseleave', (e) => { handleMobileRelease(btn.key); });
        }
    });
</script>
</body>
</html>
