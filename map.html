<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUNGEON RPG - Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Noto+Serif+KR:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(18, 18, 24, 0.95);
            --border-color: #5c4d3c;
            --accent-gold: #c5a059;
            --accent-red: #d32f2f;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --hp-grad: linear-gradient(90deg, #8b0000, #b71c1c);
            --mp-grad: linear-gradient(90deg, #0d47a1, #1565c0);
            --exp-grad: linear-gradient(90deg, #4a148c, #6a1b9a);
            --font-head: 'Cinzel', serif;
            --font-body: 'Noto Serif KR', 'Inter', sans-serif;
            --bag-bg: #3e2723;
            --bag-panel: #4e342e;
            --bag-border: #6d4c41;
            --bag-item: #5d4037;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #1a1a20 0%, #000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            width: 100%;
            max-width: 960px;
            height: 100vh;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
        }

        .game-ui-top {
            height: auto;
            background: linear-gradient(180deg, #141414 0%, #0a0a0a 100%);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 5px 15px;
            justify-content: space-between;
            z-index: 20;
            position: relative;
            flex-wrap: wrap;
            gap: 5px;
        }

        .char-info { display: flex; flex-direction: column; justify-content: center; min-width: 100px; }
        .char-info h2 {
            font-family: var(--font-head); color: var(--accent-gold); margin: 0;
            font-size: 0.9rem; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .char-info span { font-family: var(--font-body); color: var(--text-muted); font-size: 0.65rem; margin-top: 1px; font-weight: 600; }

        #game-timer {
            font-family: var(--font-body); font-weight: 700; font-size: 1.1rem; color: #ef5350;
            text-shadow: 0 0 10px rgba(239, 83, 80, 0.4); min-width: 50px; text-align: center;
        }

        .ui-bars-center {
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 100%;
            max-width: 250px;
            order: 3;
        }
        @media (min-width: 768px) {
            .ui-bars-center {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                order: 2;
            }
        }

        .bar-row { display: flex; align-items: center; gap: 5px; }
        .bar-label { width: 22px; text-align: right; color: #666; font-size: 0.6rem; font-weight: 700; }
        .bar-bg { flex: 1; height: 8px; background: #111; border: 1px solid #2a2a2a; border-radius: 2px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; }
        .hp-fill { background: var(--hp-grad); }
        .mp-fill { background: var(--mp-grad); }
        .exp-fill { background: var(--exp-grad); }
        .bar-text { position: absolute; top: -1px; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 7px; color: rgba(255,255,255,0.7); text-shadow: 1px 1px 1px #000; }

        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; order: 2; }
        @media (min-width: 768px) { .btn-group { order: 3; } }
        .btn {
            padding: 4px 8px; background: #1a1a1a; border: 1px solid #333; color: #aaa;
            font-family: var(--font-body); font-size: 0.65rem; font-weight: 700; cursor: pointer;
            border-radius: 2px; text-transform: uppercase;
        }

        .canvas-wrapper {
            flex: 1; background: #000; display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative; width: 100%;
        }
        canvas {
            image-rendering: pixelated;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Mobile Controls */
        .mobile-ctrl-group {
            position: absolute;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        #mobile-controls-left { bottom: 40px; left: 20px; }
        #mobile-controls-right { bottom: 40px; right: 20px; flex-direction: column; }

        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .control-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
        }

        /* Hide on desktop */
        @media (min-width: 1025px) {
            .mobile-ctrl-group { display: none; }
        }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(12, 12, 14, 0.98); border: 1px solid #444; display: none; flex-direction: column;
            z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-radius: 4px;
            width: 95%; max-width: 850px; max-height: 90vh;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #2a2a2a; }
        .modal-header h2 { font-family: var(--font-body); color: var(--accent-gold); font-size: 1rem; margin: 0; }
        .modal-body { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

        #inventory-modal { background: var(--bag-bg); border: 3px solid var(--bag-border); }
        #inventory-modal .modal-body { background: var(--bag-panel); }

        .inv-container { display: flex; gap: 15px; flex-direction: column; }
        @media (min-width: 600px) {
            .inv-container { flex-direction: row; }
            .inv-status-side { flex: 0 0 200px; }
        }
        .inv-status-side { background: rgba(0,0,0,0.3); border: 1px solid var(--bag-border); padding: 10px; border-radius: 4px; }
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }

        .item-card {
            background: var(--bag-item); border: 1px solid var(--bag-border); border-radius: 4px; padding: 8px;
            min-height: 100px; position: relative; cursor: pointer;
        }
        .item-name { font-size: 0.8rem; font-weight: 700; color: #fff; margin-bottom: 3px; }
        .item-desc { font-size: 0.65rem; color: #d7ccc8; line-height: 1.3; }
        .sell-btn { position: absolute; bottom: 5px; right: 5px; padding: 3px 6px; background: #d32f2f; color: #fff; border: none; border-radius: 2px; font-size: 0.6rem; }

        #weather-ui {
            position: absolute; top: 110px; right: 10px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 4px 8px;
            border-radius: 20px; display: flex; align-items: center; gap: 5px;
            font-size: 0.65rem; color: #fff; z-index: 15;
        }
        @media (min-width: 768px) { #weather-ui { top: 70px; font-size: 0.8rem; } }

        #boss-warning {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.9); border: 2px solid var(--accent-gold);
            color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 1rem; font-weight: bold; z-index: 1000; display: none;
            text-align: center; width: 80%;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading-overlay"><div class="spinner"></div><div class="loading-text">Ïó∞Í≤∞ Ï§ë...</div></div>
        <div id="enhance-effect">Í∞ïÌôî ÏÑ±Í≥µ!</div>
        <div id="boss-warning">‚ö†Ô∏è Í≤ΩÍ≥†: Ï¥àÍ∞ïÎ†• Î≥¥Ïä§Í∞Ä ÌïÑÎìúÏóê Ï∂úÌòÑÌñàÏäµÎãàÎã§!</div>

        <div id="weather-ui">
            <span class="weather-icon" id="weather-icon">‚òÄÔ∏è</span>
            <span id="weather-text">ÎßëÏùå</span>
        </div>
        <div id="weather-overlay"></div>
        <div id="thunder-flash" class="thunder-flash"></div>

        <div id="event-overlay">
            <img id="event-img" src="image/bm.jpg" alt="Event">
            <div id="event-text">Î≥¥Î¨º Î∞úÍ≤¨!</div>
            <div id="event-reward"></div>
        </div>

        <div id="mobile-controls-left" class="mobile-ctrl-group">
            <div class="control-btn" id="btn-left">‚óÄ</div>
            <div class="control-btn" id="btn-right">‚ñ∂</div>
        </div>
        <div id="mobile-controls-right" class="mobile-ctrl-group">
            <div class="control-btn" id="btn-up">‚ñ≤</div>
            <div class="control-btn" id="btn-down">‚ñº</div>
        </div>

        <div id="inventory-modal" class="modal">
            <div class="modal-header">
                <h2>Í∞ÄÎ∞© Î∞è ÏÉÅÌÉú</h2>
                <div style="display:flex; align-items:center;">
                    <span id="inv-gold-display" class="inv-header-gold" style="color:var(--accent-gold); font-size:0.8rem; margin-right:10px;">0 G</span>
                    <button class="close-btn" onclick="toggleModal('inventory-modal')" style="background:none; border:none; color:#fff; cursor:pointer;">√ó</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="inv-tabs" style="display:flex; gap:5px; margin-bottom:10px;">
                    <button id="tab-inv" class="tab-btn active" onclick="switchTab('inv')">ÏïÑÏù¥ÌÖú</button>
                    <button id="tab-traits" class="tab-btn" onclick="switchTab('traits')">ÌäπÏÑ±</button>
                </div>
                <div class="inv-container">
                    <div class="inv-status-side" id="inv-status-panel"></div>
                    <div class="inv-grid-side">
                        <div id="inv-list" class="inv-grid"></div>
                        <div id="trait-list" class="trait-container" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="shop-modal" class="modal">
            <div class="modal-header"><h2>ÎåÄÏû•Í∞Ñ</h2><button class="close-btn" onclick="toggleModal('shop-modal')" style="background:none; border:none; color:#fff;">√ó</button></div>
            <div class="modal-body">
                <div class="shop-gold" id="shop-gold-display">0 G</div>
                <div id="shop-list-container"><div id="shop-list" class="inv-grid"></div></div>
            </div>
        </div>

        <div id="confirm-modal" class="modal">
            <div class="modal-header"><h2 id="confirm-title">ÌôïÏù∏</h2><button class="close-btn" onclick="closeConfirm()" style="background:none; border:none; color:#fff;">√ó</button></div>
            <div class="modal-body">
                <div id="confirm-msg" class="confirm-text" style="color:#eee; text-align:center; margin-bottom:20px;"></div>
                <div class="confirm-btns" style="display:flex; gap:10px; justify-content:center;">
                    <button id="confirm-yes-btn" class="btn-yes" onclick="executeConfirm()" style="background:var(--accent-gold); padding:8px 20px; border:none;">ÌôïÏù∏</button>
                    <button id="confirm-no-btn" class="btn-no" onclick="closeConfirm()" style="background:#444; color:#fff; padding:8px 20px; border:none;">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>

        <div id="quest-modal" class="modal">
            <div class="modal-header"><h2>ÌÄòÏä§Ìä∏</h2><button class="close-btn" onclick="toggleModal('quest-modal')" style="background:none; border:none; color:#fff;">√ó</button></div>
            <div class="modal-body" id="quest-list"></div>
        </div>

        <div id="advancement-modal" class="modal">
            <div class="modal-header"><h2>Ï†ÑÏßÅ</h2></div>
            <div class="modal-body"><div id="adv-list" class="adv-grid"></div></div>
        </div>

        <div id="gameover-modal" class="modal">
            <div class="modal-header"><h2 style="color:var(--accent-red)">GAME OVER</h2></div>
            <div class="modal-body">
                <div class="gameover-title" style="text-align:center; font-size:1.5rem; color:var(--accent-red); margin-bottom:15px;">ÎçòÏ†Ñ Î∂ïÍ¥¥</div>
                <div class="gameover-stats" id="go-stats-content"></div>
                <button class="btn btn-start" style="width:100%; padding:12px; margin-top:10px;" onclick="location.href='index.html'">Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú</button>
            </div>
        </div>

        <div class="game-ui-top">
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="game-timer">15:00</div>
                <div class="char-info">
                    <h2 id="ui-info">ÏòÅÏõÖ</h2>
                    <span id="ui-level">LV. 1</span>
                </div>
            </div>

            <div class="ui-bars-center">
                <div class="bar-row"><span class="bar-label">HP</span><div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill"></div><span id="ui-hp-text" class="bar-text"></span></div></div>
                <div class="bar-row"><span class="bar-label">MP</span><div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-grad"></div><span id="ui-mp-text" class="bar-text"></span></div></div>
                <div class="bar-row"><span class="bar-label">EXP</span><div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill"></div><span id="ui-exp-text" class="bar-text"></span></div></div>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="openQuest()">ÌÄòÏä§Ìä∏</button>
                <button class="btn" onclick="openInventory()">Í∞ÄÎ∞©</button>
                <button class="btn" onclick="openShop()">Í∞ïÌôî</button>
                <button class="btn" onclick="manualSave()">Ï†ÄÏû•</button>
            </div>
        </div>
        <div class="canvas-wrapper"><canvas id="gameCanvas" width="960" height="640"></canvas></div>
    </div>

    <script>
        const DB_URL = "https://script.google.com/macros/s/AKfycbyl5HZ8Yk_x8_3d8Ayf2B-j480ZDX3czhlULozQHUO20gbviOMcI9ivOF6Ht6uOQbFD9Q/exec";
        const CHAR_FILES = {
            'Ï†ÑÏÇ¨': 'image/warrior.jpg', 'ÎèÑÏ†Å': 'image/rogue.jpg', 'ÎßàÎ≤ïÏÇ¨': 'image/mage.jpg',
            'Î≤ÑÏÑúÏª§': 'image/warrior1.jpg', 'Í∞ÄÎîîÏñ∏': 'image/warrior1.jpg',
            'Ïñ¥ÏåîÏã†': 'image/rogue1.jpg', 'ÏÑÄÎèÑÏö∞': 'image/rogue1.jpg',
            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'image/mage1.jpg', 'ÏÜåÏÑúÎü¨': 'image/mage1.jpg'
        };
        
        const DROP_TABLE = {
            'Ï†ÑÏÇ¨': ['Í∏∞ÏÇ¨Ïùò Í≤Ä', 'ÎåÄÍ≤Ä', 'Ïö©ÏÇ¨Ïùò Í≤Ä', 'Ïã¨ÌåêÏùò ÎèÑÎÅº'],
            'ÎèÑÏ†Å': ['ÏïîÏÇ¥ÏûêÏùò Îã®ÎèÑ', 'ÏåçÍ≤Ä', 'Í∑∏Î¶ºÏûê ÎπÑÏàò'],
            'ÎßàÎ≤ïÏÇ¨': ['ÎßàÎ≤ï ÏßÄÌå°Ïù¥', 'Ïò§Î∏å', 'ÌòÑÏûêÏùò Ïä§ÌÉúÌîÑ'],
            'Î≤ÑÏÑúÏª§': ['Í¥ëÏ†ÑÏÇ¨Ïùò ÎèÑÎÅº', 'ÌîºÏùò Í≤Ä'],
            'Í∞ÄÎîîÏñ∏': ['ÏàòÌò∏ÏûêÏùò Î∞©Ìå®Í≤Ä', 'ÏÑ±Í∏∞ÏÇ¨Ïùò ÎßùÏπò'],
            'Ïñ¥ÏåîÏã†': ['Ï£ΩÏùåÏùò Ïù∏ÎèÑÏûê', 'Í∑∏Î¶ºÏûê ÏÜ°Í≥≥Îãà'],
            'ÏÑÄÎèÑÏö∞': ['Í≥µÌè¨Ïùò ÎπÑÏàò', 'Ïã¨Ïó∞Ïùò ÏπºÎÇ†'],
            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': ['ÎåÄÎßàÎ≤ïÏÇ¨Ïùò ÏßÄÌå°Ïù¥', 'Î≥ÑÏùò Ï°∞Í∞Å'],
            'ÏÜåÏÑúÎü¨': ['ÏõêÏÜåÏùò Í∑ºÏõê', 'ÎßàÎÇòÏùò Îàà']
        };

        let player = null;
        let playerImg = new Image();
        let mapImg = new Image();
        let boss = { x: 100, y: 100, speed: 2.2, img: new Image(), alive: true, isNightBoss: false, hp: 100, maxHp: 100 };
        let superBoss = { x: 500, y: 500, speed: 3.5, img: new Image(), alive: false, hp: 3000, maxHp: 3000, name: "Ï¥àÍ∞ïÎ†• Î≥¥Ïä§" };
        superBoss.img.src = 'image/best_boss.jpg';

        const GAME_TIME_LIMIT = 15 * 60 * 1000;
        let isNight = false;
        let timeTick = 0;
        let currentWeather = "sunny";

        const advBgm = new Audio('song/bgm1.mp3');
        const fieldBgm = new Audio('song/song_2.mp3');
        const angelBgm = new Audio('song/angels.mp3');
        const successSfx = new Audio('song/blackout_piano1.mp3');
        const failSfx = new Audio('song/blackout_piano2.mp3');
        const thunderSfx = new Audio('song/thunder.mp3');
        const potionSfx = new Audio('song/potion-inght.wav');
        const goldSfx = new Audio('song/gold_drop-inght.wav');
        const rainThunderSfx = new Audio('song/thunder1-inght.wav');
        const rainRuinSfx = new Audio('song/ruin-inght.wav');

        fieldBgm.loop = true;
        fieldBgm.volume = 0.15;

        let fieldItems = [];
        const potionImg = new Image(); potionImg.src = 'image/potion_hp.jpg';
        const shoesImg = new Image(); shoesImg.src = 'image/shoes.jpg';
        const atkImg = new Image(); atkImg.src = 'image/attack_10.jpg';
        const defImg = new Image(); defImg.src = 'image/Defense_10.jpg';

        let treasureBoxes = [];
        const treasureBoxImg = new Image(); treasureBoxImg.src = 'image/bm.jpg';

        let currentConfirmAction = null;
        const moveState = { up: false, down: false, left: false, right: false };

        window.onload = async function() {
            const name = localStorage.getItem('rpg_player_name');
            const temp = localStorage.getItem('rpg_temp_player');
            if (temp) { player = JSON.parse(temp); initData(); initMap(); }
            else if (name) {
                try {
                    document.querySelector('.loading-text').innerText = "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...";
                    document.getElementById('loading-overlay').style.display = 'flex';
                    const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                    player = await res.json(); initData(); initMap();
                } catch(e) { location.href='index.html'; }
            } else { location.href='index.html'; }

            setupMobileControls();
        };

        function setupMobileControls() {
            const btns = { 'btn-up': 'up', 'btn-down': 'down', 'btn-left': 'left', 'btn-right': 'right' };
            for (const id in btns) {
                const el = document.getElementById(id);
                if (!el) continue;
                const dir = btns[id];
                const start = (e) => { e.preventDefault(); moveState[dir] = true; };
                const end = (e) => { e.preventDefault(); moveState[dir] = false; };
                el.addEventListener('touchstart', start, {passive: false});
                el.addEventListener('touchend', end);
                el.addEventListener('touchcancel', end);
                el.addEventListener('mousedown', start);
                el.addEventListener('mouseup', end);
                el.addEventListener('mouseleave', end);
            }
        }

        function initData() {
            if (!player.inventory) player.inventory = [];
            if (!player.bonusAtk) player.bonusAtk = 0;
            if (player.bonusDef === undefined) player.bonusDef = 0;
            if (player.moveSpeed === undefined) player.moveSpeed = 12;
            if (player.gold === undefined) player.gold = 0;
            if (player.traitPoints === undefined) player.traitPoints = 0;
            if (!player.traits) player.traits = { str: 0, dex: 0, con: 0, int: 0, wis: 0 };
            if (!player.quests) player.quests = { killCount: 0, dayKillCount: 0, nightKillCount: 0, bossKillCount: 0, enhanceCount: 0, claimed: {} };
            if (player.isAdvanced === undefined) player.isAdvanced = false;
            if (player.x === undefined) player.x = 480;
            if (player.y === undefined) player.y = 320;

            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            isNight = (Date.now() - startTime) >= 90000;
            currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

            if (localStorage.getItem('rpg_open_traits') === 'true') {
                localStorage.removeItem('rpg_open_traits');
                setTimeout(() => { openInventory(); switchTab('traits'); }, 500);
            }
        }

        function initMap() {
            playerImg.src = CHAR_FILES[player.job] || CHAR_FILES['Ï†ÑÏÇ¨'];
            mapImg.src = isNight ? 'image/map1.jpg' : 'image/map.jpg';
            mapImg.onload = () => {
                document.getElementById('loading-overlay').style.display = 'none'; 
                fieldBgm.play().catch(e => {});
                const deathTime = localStorage.getItem('rpg_boss_death_time');
                if (deathTime) {
                    const diff = Date.now() - parseInt(deathTime);
                    if (diff < 10000) { boss.alive = false; setTimeout(spawnBossDefault, 10000 - diff); } 
                    else { spawnBossDefault(); }
                } else { spawnBossDefault(); }
                setInterval(gameLoop, 50); 
                updateTimeEffect(); updateWeatherUI(); checkAdvancement(); spawnFieldItem(); spawnTreasureBox();
            };
            updateUI(); 
            window.addEventListener('keydown', (e) => {
                if (e.key === "ArrowUp") moveState.up = true; if (e.key === "ArrowDown") moveState.down = true;
                if (e.key === "ArrowLeft") moveState.left = true; if (e.key === "ArrowRight") moveState.right = true;
            });
            window.addEventListener('keyup', (e) => {
                if (e.key === "ArrowUp") moveState.up = false; if (e.key === "ArrowDown") moveState.down = false;
                if (e.key === "ArrowLeft") moveState.left = false; if (e.key === "ArrowRight") moveState.right = false;
            });
        }

        function spawnFieldItem() {
            if (fieldItems.length < 6) {
                const rand = Math.random();
                let type = rand < 0.05 ? 'shoes' : (rand < 0.15 ? 'attack' : (rand < 0.25 ? 'defense' : 'potion'));
                fieldItems.push({ x: Math.random() * 900 + 30, y: Math.random() * 600 + 30, type: type });
            }
            setTimeout(spawnFieldItem, 8000);
        }

        function spawnTreasureBox() {
            if (treasureBoxes.length < 2) treasureBoxes.push({ x: Math.random() * 900 + 30, y: Math.random() * 600 + 30 });
            setTimeout(spawnTreasureBox, Math.random() * 30000 + 30000);
        }

        function checkAdvancement() { if (player.level >= 5 && !player.isAdvanced) openAdvancement(); }

        function openAdvancement() {
            const modal = document.getElementById('advancement-modal');
            const list = document.getElementById('adv-list');
            list.innerHTML = ''; fieldBgm.pause(); advBgm.play().catch(e => {});
            let options = [];
            if (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Í∏∞ÏÇ¨') options = [{ job: 'Î≤ÑÏÑúÏª§', desc: 'Í≥µÍ≤© ÌäπÌôî', bonus: 'Ìûò +10, HP +50', img: 'image/warrior1.jpg' }, { job: 'Í∞ÄÎîîÏñ∏', desc: 'ÏÉùÏ°¥ ÌäπÌôî', bonus: 'Ï≤¥Î†• +15, HP +150', img: 'image/warrior1.jpg' }];
            else if (player.job === 'ÎèÑÏ†Å') options = [{ job: 'Ïñ¥ÏåîÏã†', desc: 'Í∑πÎîú ÌäπÌôî', bonus: 'ÎØºÏ≤© +12, ÏπòÎ™ÖÌÉÄ +15%', img: 'image/rogue1.jpg' }, { job: 'ÏÑÄÎèÑÏö∞', desc: 'Ïú†Ìã∏ ÌäπÌôî', bonus: 'ÎØºÏ≤© +8, ÏßÄÌòú +8', img: 'image/rogue1.jpg' }];
            else if (player.job === 'ÎßàÎ≤ïÏÇ¨') options = [{ job: 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', desc: 'ÌôîÎ†• ÌäπÌôî', bonus: 'ÏßÄÎä• +15, MP +100', img: 'image/mage1.jpg' }, { job: 'ÏÜåÏÑúÎü¨', desc: 'Ìö®Ïú® ÌäπÌôî', bonus: 'ÏßÄÎä• +10, ÏßÄÌòú +10', img: 'image/mage1.jpg' }];
            options.forEach(opt => {
                const div = document.createElement('div'); div.className = 'adv-card';
                div.innerHTML = `<img src="${opt.img}"><div class="adv-name">${opt.job}</div><div class="adv-desc">${opt.desc}</div><div class="adv-bonus">${opt.bonus}</div>`;
                div.onclick = () => { showConfirm("Ï†ÑÏßÅ ÌôïÏù∏", `${opt.job}(Ïúº)Î°ú Ï†ÑÏßÅÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => {
                    player.job = opt.job; player.isAdvanced = true;
                    if (opt.job === 'Î≤ÑÏÑúÏª§') { player.stats.str += 10; player.maxHp += 50; }
                    else if (opt.job === 'Í∞ÄÎîîÏñ∏') { player.stats.con += 15; player.maxHp += 150; }
                    else if (opt.job === 'Ïñ¥ÏåîÏã†') { player.stats.dex += 12; }
                    else if (opt.job === 'ÏÑÄÎèÑÏö∞') { player.stats.dex += 8; player.stats.wis += 8; }
                    else if (opt.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ') { player.stats.int += 15; player.maxMp += 100; }
                    else if (opt.job === 'ÏÜåÏÑúÎü¨') { player.stats.int += 10; player.stats.wis += 10; }
                    player.hp = player.maxHp; player.mp = player.maxMp; playerImg.src = CHAR_FILES[player.job];
                    advBgm.pause(); angelBgm.play().catch(e => {}); setTimeout(() => fieldBgm.play(), 5000);
                    modal.style.display = 'none'; updateUI();
                }); };
                list.appendChild(div);
            });
            modal.style.display = 'flex';
        }

        function updateTimeEffect() {
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            const elapsed = Date.now() - startTime;
            const newIsNight = elapsed >= 90000;
            if (newIsNight !== isNight) {
                isNight = newIsNight; mapImg.src = isNight ? 'image/map1.jpg' : 'image/map.jpg';
                localStorage.setItem('rpg_is_night', isNight); changeWeather();
            }
            if (Math.floor(elapsed / 30000) > timeTick) { timeTick = Math.floor(elapsed / 30000); changeWeather(); }
        }

        function changeWeather() {
            const rand = Math.random();
            currentWeather = rand < 0.5 ? "sunny" : (rand < 0.7 ? "rain" : (rand < 0.85 ? "fog" : "thunder"));
            localStorage.setItem('rpg_current_weather', currentWeather); updateWeatherUI();
        }

        function updateWeatherUI() {
            const icon = document.getElementById('weather-icon'); const text = document.getElementById('weather-text');
            const overlay = document.getElementById('weather-overlay'); overlay.innerHTML = '';
            if (currentWeather === "sunny") { icon.innerText = "‚òÄÔ∏è"; text.innerText = "ÎßëÏùå"; }
            else if (currentWeather === "rain") {
                icon.innerText = "üåßÔ∏è"; text.innerText = "ÎπÑ";
                for(let i=0; i<30; i++) {
                    const drop = document.createElement('div'); drop.className = 'rain-drop';
                    drop.style.cssText = `position:absolute; background:rgba(255,255,255,0.4); width:1px; height:15px; left:${Math.random()*100}%; animation:rainFall 0.8s linear infinite; animation-delay:${Math.random()}s;`;
                    overlay.appendChild(drop);
                }
                rainThunderSfx.play().catch(e => {});
            }
            else if (currentWeather === "fog") { icon.innerText = "üå´Ô∏è"; text.innerText = "ÏïàÍ∞ú"; }
            else if (currentWeather === "thunder") { icon.innerText = "‚ö°"; text.innerText = "ÎáåÏö∞"; }
        }

        function spawnBossDefault() {
            boss.x = player.x > 480 ? 100 : 800; boss.y = player.y > 320 ? 100 : 600; boss.alive = true;
            boss.maxHp = 400 + (player.level * 30); boss.hp = boss.maxHp; boss.img.src = 'image/ka1.jpg';
        }

        function gameLoop() {
            if(!player || document.querySelector('.modal[style*="flex"]')) return;
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            const remain = GAME_TIME_LIMIT - (Date.now() - startTime);
            if (remain <= 0) { showGameOver("ÏãúÍ∞Ñ Ï¢ÖÎ£å!"); return; }
            const m = Math.floor(remain / 60000); const s = Math.floor((remain % 60000) / 1000);
            document.getElementById('game-timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;

            let speed = player.moveSpeed || 12; if (currentWeather === "rain") speed *= 0.7;
            let moved = false;
            if (moveState.up) { player.y = Math.max(16, player.y - speed); moved = true; }
            if (moveState.down) { player.y = Math.min(624, player.y + speed); moved = true; }
            if (moveState.left) { player.x = Math.max(16, player.x - speed); moved = true; }
            if (moveState.right) { player.x = Math.min(944, player.x + speed); moved = true; }

            if (moved) {
                const rand = Math.random();
                if (rand < (isNight ? 0.04 : 0.02)) showRandomEvent();
                else if (rand < 0.06) { saveBossPos(); localStorage.setItem('rpg_temp_player', JSON.stringify(player)); location.href = 'battle.html'; }
            }

            if (boss.alive) {
                const dx = player.x - boss.x; const dy = player.y - boss.y; const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist > 0) { boss.x += (dx / dist) * boss.speed; boss.y += (dy / dist) * boss.speed; }
                if(dist < 30) { saveBossPos(); localStorage.setItem('rpg_boss_encounter', 'true'); localStorage.setItem('rpg_temp_player', JSON.stringify(player)); location.href = 'battle.html'; }
            }
            draw();
        }

        function draw() {
            const ctx = document.getElementById('gameCanvas').getContext('2d');
            ctx.clearRect(0, 0, 960, 640); ctx.drawImage(mapImg, 0, 0, 960, 640);
            fieldItems.forEach(item => {
                let img = item.type === 'shoes' ? shoesImg : (item.type === 'attack' ? atkImg : (item.type === 'defense' ? defImg : potionImg));
                ctx.drawImage(img, item.x - 12, item.y - 12, 24, 24);
            });
            treasureBoxes.forEach(box => ctx.drawImage(treasureBoxImg, box.x - 15, box.y - 15, 30, 30));
            ctx.drawImage(playerImg, player.x - 16, player.y - 16, 32, 32);
            if(boss.alive) ctx.drawImage(boss.img, boss.x - 25, boss.y - 25, 50, 50);
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            document.querySelectorAll('.modal').forEach(m => { if(m.id !== id) m.style.display = 'none'; });
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
            if (modal.style.display === 'flex' && id === 'inventory-modal') renderInventory();
        }

        function switchTab(tab) {
            document.getElementById('tab-inv').classList.toggle('active', tab === 'inv');
            document.getElementById('tab-traits').classList.toggle('active', tab === 'traits');
            document.getElementById('inv-list').style.display = (tab === 'inv') ? 'grid' : 'none';
            document.getElementById('trait-list').style.display = (tab === 'traits') ? 'block' : 'none';
            if (tab === 'inv') renderInventory(); else renderTraits();
        }

        function renderInventory() {
            const list = document.getElementById('inv-list'); const status = document.getElementById('inv-status-panel');
            document.getElementById('inv-gold-display').innerText = `${player.gold} G`;
            status.innerHTML = `<div style="text-align:center; margin-bottom:10px;"><img src="${CHAR_FILES[player.job]}" style="width:60px; height:60px; border:1px solid #444;"><div style="color:var(--accent-gold); font-size:0.9rem;">${player.job}</div></div><div style="font-size:0.75rem; color:#ccc;">LV.${player.level}<br>Ìûò:${player.stats.str} ÎØº:${player.stats.dex} Ï≤¥:${player.stats.con}<br>ÏßÄ:${player.stats.int} ÏßÄÌòú:${player.stats.wis}</div>`;
            list.innerHTML = player.inventory.length === 0 ? '<p style="color:#666; text-align:center; grid-column:1/-1;">ÎπÑÏñ¥ ÏûàÏùå</p>' : '';
            player.inventory.forEach((item, index) => {
                const div = document.createElement('div'); div.className = `item-card ${item.equipped ? 'equipped' : ''}`;
                div.innerHTML = `<div class="item-name">${item.name}</div><div class="item-desc">${item.desc}</div><button class="sell-btn" onclick="event.stopPropagation(); player.gold+=10; player.inventory.splice(${index},1); renderInventory();">ÌåêÎß§</button>`;
                div.onclick = () => { /* Use item logic */ };
                list.appendChild(div);
            });
        }

        function renderTraits() {
            const list = document.getElementById('trait-list');
            list.innerHTML = `<div class="trait-point-display">Ìè¨Ïù∏Ìä∏: ${player.traitPoints}</div>`;
            ['str', 'dex', 'con', 'int', 'wis'].forEach(key => {
                const div = document.createElement('div'); div.className = 'trait-item';
                div.innerHTML = `<div class="trait-info"><div class="trait-name">${key.toUpperCase()}</div></div><div class="trait-level">Lv.${player.traits[key]}</div><button class="trait-up-btn" onclick="if(player.traitPoints>0){player.traitPoints--; player.traits['${key}']++; player.stats['${key}']++; renderTraits(); updateUI();}" ${player.traitPoints<=0?'disabled':''}>+</button>`;
                list.appendChild(div);
            });
        }

        function openQuest() { toggleModal('quest-modal'); const list = document.getElementById('quest-list'); list.innerHTML = '<p style="color:#aaa; text-align:center;">ÏßÑÌñâ Ï§ëÏù∏ ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'; }
        function openShop() { toggleModal('shop-modal'); document.getElementById('shop-gold-display').innerText = `${player.gold} G`; document.getElementById('shop-list').innerHTML = '<p style="color:#666; text-align:center; grid-column:1/-1;">Í∞ïÌôî Í∞ÄÎä•Ìïú Ïû•ÎπÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>'; }
        function showConfirm(title, msg, onYes) { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-msg').innerText = msg; currentConfirmAction = onYes; document.getElementById('confirm-modal').style.display = 'flex'; }
        function executeConfirm() { if(currentConfirmAction) currentConfirmAction(); closeConfirm(); }
        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; }
        function updateUI() {
            document.getElementById('ui-info').innerText = player.name; document.getElementById('ui-level').innerText = `LV.${player.level} ${player.job}`;
            document.getElementById('ui-hp-bar').style.width = `${(player.hp/player.maxHp)*100}%`;
            document.getElementById('ui-mp-bar').style.width = `${(player.mp/player.maxMp)*100}%`;
            document.getElementById('ui-exp-bar').style.width = `${(player.exp/player.maxExp)*100}%`;
            document.getElementById('ui-hp-text').innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
            document.getElementById('ui-mp-text').innerText = `${Math.ceil(player.mp)}/${player.maxMp}`;
            document.getElementById('ui-exp-text').innerText = `${Math.floor(player.exp)}/${player.maxExp}`;
        }
        function saveBossPos() { if(boss.alive) { localStorage.setItem('rpg_boss_x', boss.x); localStorage.setItem('rpg_boss_y', boss.y); } }
        async function manualSave() {
            const overlay = document.getElementById('loading-overlay'); overlay.style.display = 'flex';
            try { await fetch(DB_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(player) }); showConfirm("Ï†ÄÏû• ÏôÑÎ£å", "Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.", null); }
            catch(e) { showConfirm("Ï†ÄÏû• Ïã§Ìå®", "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", null); }
            overlay.style.display = 'none';
        }
        function showRandomEvent() {
            const overlay = document.getElementById('event-overlay'); overlay.style.display = 'flex';
            document.getElementById('event-text').innerText = "ÌñâÏö¥Ïùò Î∞úÍ≤¨!"; document.getElementById('event-reward').innerText = "+100 Gold";
            player.gold += 100; goldSfx.play().catch(e=>{}); setTimeout(() => overlay.style.display = 'none', 2000); updateUI();
        }
        function showGameOver(msg) { document.getElementById('gameover-modal').style.display = 'flex'; }
    </script>
</body>
</html>