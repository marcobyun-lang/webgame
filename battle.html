<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUNGEON RPG - Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Cinzel:wght@700&family=Noto+Serif+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #050505; 
            --panel-bg: rgba(20, 20, 25, 0.95); 
            --border-color: #5c4d3c; 
            --accent-gold: #ffd700; 
            --accent-red: #ff3333; 
            --danger: #ff1744; 
            --mp-color: #2979ff; 
            --rage-color: #ff9800;
            --text-main: #e0e0e0;
            --font-combat: 'Black Han Sans', sans-serif;
            --font-ui: 'Noto Serif KR', serif;
            --font-eng: 'Cinzel', serif;
        }

        body { 
            background-color: var(--bg-color); 
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), repeating-linear-gradient(45deg, #121212 0, #121212 10px, #0a0a0a 10px, #0a0a0a 20px); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; user-select: none;
            padding: 10px; box-sizing: border-box;
        }

        #game-container { 
            width: 100%; max-width: 960px; height: 100vh; max-height: 720px;
            background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('image/map.jpg') center/cover;
            border: 2px solid #333; 
            box-shadow: 0 0 80px rgba(0,0,0,0.9), inset 0 0 100px rgba(0,0,0,0.8); 
            border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }

        #game-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 60%, black 100%); pointer-events: none; z-index: 5; }
        
        .battle-stage { display: flex; justify-content: space-around; align-items: center; width: 95%; margin-bottom: 10px; z-index: 20; position: relative; flex-wrap: wrap; gap: 10px; }
        .unit-box { text-align: center; width: 45%; max-width: 260px; position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .unit-frame {
            width: 100%; aspect-ratio: 1/1; max-width: 180px;
            border: 4px solid #444; border-radius: 8px; 
            overflow: hidden; position: relative; background: #111; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 1; 
            transition: transform 0.1s;
        }
        .unit-img, video { width: 100% !important; height: 100% !important; object-fit: cover !important; background-color: #000; }
        
        .unit-info { margin-top: 10px; width: 100%; text-shadow: 2px 2px 4px #000; }
        .unit-name { font-family: var(--font-combat); font-size: 1.1rem; color: #fff; margin: 0; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unit-job { font-family: var(--font-eng); font-size: 0.7rem; color: #aaa; margin-bottom: 3px; font-weight: bold; }
        
        .bar-container { width: 100%; display: flex; flex-direction: column; gap: 4px; margin-top: 5px; }
        .bar-wrap { 
            background: #111; height: 12px; border: 1px solid #333;
            border-radius: 3px; overflow: hidden; position: relative; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
        }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; position: relative; }
        .bar-text {
            position: absolute; width: 100%; top: 0; left: 0; line-height: 12px;
            font-size: 8px; font-family: var(--font-eng); font-weight: bold; text-align: center;
            text-shadow: 1px 1px 1px #000; z-index: 5; color: #fff;
        }

        .vs-text { font-family: var(--font-eng); font-size: 2rem; color: rgba(255,255,255,0.2); font-style: italic; font-weight: bold; }

        .log-panel {
            width: 90%; height: 80px;
            background: rgba(0,0,0,0.7); border: 1px solid #444; border-radius: 4px;
            padding: 10px; overflow-y: auto; margin-bottom: 15px;
            font-size: 0.85rem; color: #ccc; z-index: 20; text-align: center;
            font-family: var(--font-ui); line-height: 1.4;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; z-index: 20; width: 90%; max-width: 500px; }
        .btn { 
            padding: 10px; border: 2px solid #333; font-family: var(--font-combat);
            font-size: 1rem; cursor: pointer; color: #ccc; transition: all 0.2s;
            text-transform: uppercase; border-radius: 6px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .btn-rage {
            background: linear-gradient(to bottom, #e65100, #bf360c); border-color: #ff9800;
            color: #fff; font-size: 1.2rem; padding: 12px; display: none;
            width: 90%; max-width: 500px; margin-top: 10px;
            animation: ragePulse 1s infinite alternate; z-index: 30;
        }

        .modal-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 520px;
            background: rgba(15, 15, 20, 0.98); border: 2px solid var(--accent-gold); display: none; 
            flex-direction: column; align-items: center; padding: 20px; z-index: 1000;
            box-shadow: 0 0 80px rgba(0,0,0,1); border-radius: 8px;
        }
        .modal-title { font-size: 2rem; margin-bottom: 15px; }

        @media (min-width: 600px) {
            .unit-name { font-size: 1.5rem; }
            .bar-wrap { height: 16px; }
            .bar-text { line-height: 16px; font-size: 10px; }
            .vs-text { font-size: 4rem; }
            .log-panel { height: 100px; font-size: 1rem; }
            .btn { font-size: 1.3rem; padding: 12px; }
            .btns { gap: 20px; }
        }

        #weather-info {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 3px 10px;
            border-radius: 20px; display: flex; align-items: center; gap: 5px;
            font-family: var(--font-ui); font-size: 0.7rem; color: #fff; z-index: 100;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="weather-info">
            <span id="weather-icon">â˜€ï¸</span>
            <span id="weather-text">ë§‘ìŒ</span>
        </div>

        <img id="drop-item-img" class="drop-item-effect" src="" style="display:none;">
        <img id="rage-kill-img" class="rage-kill-effect" src="image/damage_kill.jpg">

        <div id="loading-overlay"><div class="spinner"></div><h2 id="loading-text" style="color:var(--accent-red); font-family:var(--font-eng);">BATTLE START</h2></div>
        
        <div id="result-modal" class="modal-overlay">
            <div class="modal-title">ì „íˆ¬ ìŠ¹ë¦¬!</div>
            <div id="result-content" class="result-content"></div>
            <button class="btn-confirm" onclick="checkLevelUpOrFinish()">í™•ì¸</button>
        </div>

        <div id="levelup-modal" class="modal-overlay">
            <div class="modal-title" style="color:#00e676; border-color:#00e676;">ë ˆë²¨ ì—…!</div>
            <div class="lv-grid">
                <div class="lv-stat"><div class="stat-name">LEVEL</div><div class="stat-change"><span id="old-lv">1</span> â–· <span id="new-lv" style="color:var(--accent-gold)">2</span></div></div>
                <div class="lv-stat"><div class="stat-name">MAX HP</div><div class="stat-change" id="stat-hp"></div></div>
                <div class="lv-stat"><div class="stat-name">MAX MP</div><div class="stat-change" id="stat-mp"></div></div>
            </div>
            <button id="lv-confirm-btn" class="btn-confirm" onclick="finishBattleWithLevelUp()" style="background:#00e676;">íŠ¹ì„± ë¶„ë°°í•˜ëŸ¬ ê°€ê¸°</button>
        </div>

        <div id="item-modal" class="modal-overlay">
            <div class="modal-title" style="color:#4caf50; border-color:#4caf50; font-size: 1.5rem;">ì•„ì´í…œ ì„ íƒ</div>
            <div id="item-list" class="item-list"></div>
            <button class="btn-confirm" onclick="closeItemModal()" style="background:#555; margin-top:20px;">ë‹«ê¸°</button>
        </div>

        <div id="gameover-modal" class="modal-overlay">
            <div class="gameover-title">íŒ¨ë°°</div>
            <div class="gameover-stats">
                <div class="go-row"><span>ìƒì¡´ ì‹œê°„</span><span id="go-time" class="go-val"></span></div>
                <div class="go-row"><span>ì²˜ì¹˜í•œ ëª¬ìŠ¤í„°</span><span id="go-kills" class="go-val"></span></div>
                <div class="go-row"><span>ì²˜ì¹˜í•œ ë³´ìŠ¤</span><span id="go-boss" class="go-val"></span></div>
                <div class="go-row"><span>ìµœì¢… ë ˆë²¨</span><span id="go-lv" class="go-val"></span></div>
                <div class="go-score">ìµœì¢… ì ìˆ˜: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            </div>
            <button class="btn-confirm" style="width:100%;" onclick="location.href='index.html'">ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
        </div>

        <div class="battle-stage">
            <div class="unit-box">
                <div id="p-speech" class="speech"></div>
                <div id="player-frame" class="unit-frame" style="border-color:#2979ff;">
                    <div id="p-cure" class="cure-effect"></div>
                    <img id="p-img" class="unit-img">
                    <img id="atk-warrior" src="image/warrior_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-rogue" src="image/rogue_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-mage" src="image/mage_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="hit-warrior" src="image/warrior_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-rogue" src="image/rogue_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-mage" src="image/mage_hit.jpg" class="unit-img" style="display:none;">
                    <img id="crit-warrior" src="image/critical_warrior.jpg" class="unit-img" style="display:none;">
                    <img id="crit-rogue" src="image/critical_rogue.jpg" class="unit-img" style="display:none;">
                    <img id="crit-mage" src="image/critical_mage.jpg" class="unit-img" style="display:none;">
                    <img id="eva-warrior" src="image/warrior_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-rogue" src="image/rogue_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-mage" src="image/mage_evasion.jpg" class="unit-img" style="display:none;">
                    <video id="v-warrior" src="image/warrior_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage" src="image/mage_atk.mp4" class="unit-img" style="display:none;"></video>
                </div>
                <div class="unit-info">
                    <h3 id="p-name" class="unit-name">í”Œë ˆì´ì–´</h3>
                    <div id="p-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div class="bar-wrap"><div id="p-hp-bar" class="bar-fill hp-bar"></div><span id="p-hp-text" class="bar-text"></span></div>
                        <div class="bar-wrap"><div id="p-mp-bar" class="bar-fill mp-bar"></div><span id="p-mp-text" class="bar-text"></span></div>
                        <div class="bar-wrap"><div id="p-rage-bar" class="bar-fill rage-bar"></div><span id="p-rage-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="vs-text">VS</div>
            
            <div class="unit-box">
                <div id="e-speech" class="speech"></div>
                <div id="enemy-frame" class="unit-frame" style="border-color:var(--danger);">
                    <img id="e-img" class="unit-img">
                </div>
                <div class="unit-info">
                    <h3 id="e-name" class="unit-name">ì  ì´ë¦„</h3>
                    <div id="e-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div class="bar-wrap"><div id="e-hp-bar" class="bar-fill hp-bar"></div><span id="e-hp-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="log" class="log-panel">ì „íˆ¬ê°€ ê³§ ì‹œì‘ë©ë‹ˆë‹¤...</div>
        
        <div class="btns">
            <button class="btn btn-atk" onclick="atk()">âš”ï¸ ê³µê²©</button>
            <button class="btn btn-skl" onclick="skl()">âš¡ ìŠ¤í‚¬</button>
            <button class="btn btn-item" onclick="openItemModal()">ğŸ’Š ì•„ì´í…œ</button>
            <button class="btn btn-run" onclick="run()">ğŸƒ ë„ë§</button>
        </div>

        <button id="btn-rage" class="btn btn-rage" onclick="rageAtk()">ğŸ”¥ ë¶„ë…¸ ê³µê²©</button>
    </div>

    <script>
        const DB_URL = "https://script.google.com/macros/s/AKfycbyl5HZ8Yk_x8_3d8Ayf2B-j480ZDX3czhlULozQHUO20gbviOMcI9ivOF6Ht6uOQbFD9Q/exec";
        
        const attackSfx = new Audio('song/attack.mp3');
        const critSfx = new Audio('song/attack_1.mp3');
        const levelupSfx = new Audio('song/powerup.mp3');
        const itemSfx = new Audio('song/poka.mp3');
        const damageSfx = new Audio('song/damage1.mp3');
        const evadeSfx = new Audio('song/swish.mp3');
        const potionSfx = new Audio('song/potion-inght.wav');
        const goldSfx = new Audio('song/gold_drop-inght.wav');

        const DAY_ENEMY_POOL = [
            {f:'image/ka.jpg', n:'ë‚˜ë¬´ ëª¬ìŠ¤í„°', e:70, w:3},  
            {f:'image/ka2.jpg', n:'ìŠ¬ë¼ì„ ë² ì´ë¹„', e:50, w:3}, 
            {f:'image/ka3.jpg', n:'ê²ë¨¹ì€ í† ë¼', e:30, w:4}  
        ];
        const NIGHT_ENEMY_POOL = [
            {f:'image/monster1.jpg', n:'ë¸”ë£¨ë¨¸ì‰¬ ê°€ë””ì–¸ (Bluemush Guardian)', e:150, w:3, poison: true},
            {f:'image/monster2.jpg', n:'ê·¸ë¡œìš¸ íŠ¸ë ŒíŠ¸ (Growl Trent)', e:180, w:3},
            {f:'image/monster3.jpg', n:'ìœ„ìŠ¤í”„ ëœí„´ (Wisp Lantern)', e:120, w:4, poison: true}
        ];
        
        const WEAPON_IMAGES = {
            'ì „ì‚¬': 'weapon_warrior.jpg', 'ë„ì ': 'weapon_rogue.jpg', 'ë§ˆë²•ì‚¬': 'weapon_mage.jpg',
            'ë²„ì„œì»¤': 'weapon_warrior.jpg', 'ê°€ë””ì–¸': 'weapon_warrior.jpg',
            'ì–´ìŒ”ì‹ ': 'weapon_rogue.jpg', 'ì„€ë„ìš°': 'weapon_rogue.jpg',
            'ì•„í¬ë©”ì´ì§€': 'weapon_mage.jpg', 'ì†Œì„œëŸ¬': 'weapon_mage.jpg'
        };
        const ITEM_IMAGES = {
            'hp_potion': 'potion_hp.jpg',
            'mp_potion': 'potion_mp.jpg',
            'poison_potion': 'potion_poison.jpg',
            'exp_potion': 'potion_exp.jpg',
            'gold': 'coin_gold.jpg'
        };
        
        const DROP_TABLE = {
            'ì „ì‚¬': ['ê¸°ì‚¬ì˜ ê²€', 'ëŒ€ê²€', 'ìš©ì‚¬ì˜ ê²€', 'ì‹¬íŒì˜ ë„ë¼'],
            'ë„ì ': ['ì•”ì‚´ìì˜ ë‹¨ë„', 'ìŒê²€', 'ê·¸ë¦¼ì ë¹„ìˆ˜'],
            'ë§ˆë²•ì‚¬': ['ë§ˆë²• ì§€íŒ¡ì´', 'ì˜¤ë¸Œ', 'í˜„ìì˜ ìŠ¤íƒœí”„'],
            'ë²„ì„œì»¤': ['ê´‘ì „ì‚¬ì˜ ë„ë¼', 'í”¼ì˜ ê²€'],
            'ê°€ë””ì–¸': ['ìˆ˜í˜¸ìì˜ ë°©íŒ¨ê²€', 'ì„±ê¸°ì‚¬ì˜ ë§ì¹˜'],
            'ì–´ìŒ”ì‹ ': ['ì£½ìŒì˜ ì¸ë„ì', 'ê·¸ë¦¼ì ì†¡ê³³ë‹ˆ'],
            'ì„€ë„ìš°': ['ê³µí¬ì˜ ë¹„ìˆ˜', 'ì‹¬ì—°ì˜ ì¹¼ë‚ '],
            'ì•„í¬ë©”ì´ì§€': ['ëŒ€ë§ˆë²•ì‚¬ì˜ ì§€íŒ¡ì´', 'ë³„ì˜ ì¡°ê°'],
            'ì†Œì„œëŸ¬': ['ì›ì†Œì˜ ê·¼ì›', 'ë§ˆë‚˜ì˜ ëˆˆ']
        };

        let player, enemy, isActing = false;
        let isBossBattle = false;
        let isSuperBoss = false;
        let currentWeather = "sunny";

        let pStatus = { poison: 0, stun: 0 };
        let eStatus = { poison: 0, stun: 0 };
        let rage = 0;
        const maxRage = 100;

        window.onload = async () => {
            const name = localStorage.getItem('rpg_player_name');
            const temp = localStorage.getItem('rpg_temp_player');
            try {
                if (temp && temp !== "undefined") { player = JSON.parse(temp); if (!player || !player.job) throw new Error("Err"); init(); } 
                else if (name) {
                    const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                    player = await res.json(); if(player.error) throw new Error("Hero not found"); init();
                } else { throw new Error("No data"); }
            } catch (e) { alert("ë°ì´í„° ì˜¤ë¥˜. ë§µìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤."); localStorage.removeItem('rpg_temp_player'); location.href = 'map.html'; }
        };

        function init() {
            if(!player.inventory) player.inventory = [];
            if(!player.bonusAtk) player.bonusAtk = 0;
            if(player.gold === undefined) player.gold = 0;
            if(player.rage === undefined) player.rage = 0;
            rage = player.rage;
            currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

            if(!player.quests) player.quests = {
                killCount: 0,
                dayKillCount: 0,
                nightKillCount: 0,
                bossKillCount: 0,
                enhanceCount: 0,
                claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
            };

            const jM = {
                'ì „ì‚¬': 'warrior', 'ë„ì ': 'rogue', 'ë§ˆë²•ì‚¬': 'mage',
                'ë²„ì„œì»¤': 'warrior1', 'ê°€ë””ì–¸': 'warrior1',
                'ì–´ìŒ”ì‹ ': 'rogue1', 'ì„€ë„ìš°': 'rogue1',
                'ì•„í¬ë©”ì´ì§€': 'mage1', 'ì†Œì„œëŸ¬': 'mage1'
            };
            document.getElementById('p-img').src = `image/${jM[player.job] || 'warrior'}.jpg`;
            document.getElementById('p-name').innerText = player.name;
            
            const isBossFlag = localStorage.getItem('rpg_boss_encounter');
            const isSuperBossFlag = localStorage.getItem('rpg_is_super_boss');
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            if (isSuperBossFlag === 'true') {
                isBossBattle = true;
                isSuperBoss = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 3000);
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 3000);
                enemy = { name: 'ì´ˆê°•ë ¥ ë³´ìŠ¤ (Ancient Overlord)', hp: bossHp, maxHp: bossMaxHp, atk: 40 + (player.level * 4), exp: 10000, img: 'image/best_boss.jpg' };
                localStorage.removeItem('rpg_is_super_boss');
            } else if (isBossFlag === 'true') {
                isBossBattle = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 400 + (player.level * 30));
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 400 + (player.level * 30));
                const bossAtk = 15 + (player.level * 2);
                enemy = { name: 'ê°•í™”ëœ ë³´ìŠ¤ ë‚˜ë¬´', hp: bossHp, maxHp: bossMaxHp, atk: bossAtk, exp: 2000, img: 'image/ka1.jpg' };
                localStorage.removeItem('rpg_boss_encounter'); 
            } else {
                isBossBattle = false;
                const pool = isNight ? NIGHT_ENEMY_POOL : DAY_ENEMY_POOL;
                let tW = pool.reduce((s, e) => s + e.w, 0);
                let r = Math.random() * tW; let sel = pool[0];
                for (let e of pool) { if (r < e.w) { sel = e; break; } r -= e.w; }

                const avg = (player.stats.str + player.stats.int) / 2 + (player.level * 3);
                enemy = {
                    name: sel.n,
                    hp: Math.floor(avg * 2.5) + 10,
                    maxHp: Math.floor(avg * 2.5) + 10,
                    atk: Math.floor(avg/2.2) + 2,
                    exp: sel.e,
                    img: sel.f,
                    canPoison: sel.poison || false
                };
            }
            
            document.getElementById('e-img').src = enemy.img;
            document.getElementById('e-name').innerText = enemy.name;
            if(isBossBattle) {
                document.getElementById('e-name').style.color = "#ff1744";
                document.getElementById('e-name').innerText = "ğŸ’€ " + enemy.name;
            }
            
            updateWeatherUI();
            addLog(`<span class='log-highlight'>[${enemy.name}]</span>ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
            document.getElementById('loading-overlay').style.display = 'none';
            update(); say('p', 'ì „íˆ¬ ì‹œì‘!');
        }

        function updateWeatherUI() {
            const icon = document.getElementById('weather-icon');
            const text = document.getElementById('weather-text');
            if (currentWeather === "sunny") { icon.innerText = "â˜€ï¸"; text.innerText = "ë§‘ìŒ"; }
            else if (currentWeather === "rain") { icon.innerText = "ğŸŒ§ï¸"; text.innerText = "ë¹„ (ë§ˆë²• ê°•í™”)"; }
            else if (currentWeather === "fog") { icon.innerText = "ğŸŒ«ï¸"; text.innerText = "ì•ˆê°œ (ëª…ì¤‘ ì €í•˜)"; }
            else if (currentWeather === "thunder") { icon.innerText = "âš¡"; text.innerText = "ë‡Œìš°"; }
        }

        function say(target, txt) { const el = document.getElementById(target+'-speech'); el.innerText = txt; el.style.display = 'block'; setTimeout(()=>el.style.display='none', 1500); }
        
        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
        }

        function update() {
            document.getElementById('p-hp-bar').style.width = `${Math.max(0, Math.min(100, (player.hp/player.maxHp)*100))}%`;
            document.getElementById('p-mp-bar').style.width = `${Math.max(0, Math.min(100, (player.mp/player.maxMp)*100))}%`;
            document.getElementById('p-rage-bar').style.width = `${Math.min(100, (rage/maxRage)*100)}%`;
            document.getElementById('e-hp-bar').style.width = `${Math.max(0, Math.min(100, (enemy.hp/enemy.maxHp)*100))}%`;
            document.getElementById('p-hp-text').innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
            document.getElementById('p-mp-text').innerText = `${Math.ceil(player.mp)}/${player.maxMp}`;
            document.getElementById('p-rage-text').innerText = `RAGE ${rage}/${maxRage}`;
            document.getElementById('e-hp-text').innerText = `${Math.ceil(enemy.hp)}/${enemy.maxHp}`;

            const pStatusEl = document.getElementById('p-status');
            pStatusEl.innerHTML = '';
            if(pStatus.poison > 0) {
                pStatusEl.innerHTML += `<span class="status-icon status-poison">ë…(${pStatus.poison})</span>`;
                document.getElementById('player-frame').classList.add('poison-aura');
            } else {
                document.getElementById('player-frame').classList.remove('poison-aura');
            }
            if(pStatus.stun > 0) pStatusEl.innerHTML += `<span class="status-icon status-stun">ê¸°ì ˆ(${pStatus.stun})</span>`;

            const eStatusEl = document.getElementById('e-status');
            eStatusEl.innerHTML = '';
            if(eStatus.poison > 0) eStatusEl.innerHTML += `<span class="status-icon status-poison">ë…(${eStatus.poison})</span>`;
            if(eStatus.stun > 0) eStatusEl.innerHTML += `<span class="status-icon status-stun">ê¸°ì ˆ(${eStatus.stun})</span>`;

            if (rage >= maxRage) {
                document.getElementById('btn-rage').style.display = 'block';
            } else {
                document.getElementById('btn-rage').style.display = 'none';
            }
        }
        
        function showDamage(targetId, dmg, type) {
            const frame = document.getElementById(targetId); const el = document.createElement('div');
            let cssClass = 'dmg-text'; let content = dmg;
            if (type === 'crit') {
                cssClass += ' crit-text';
                content = '<div style="color: #ffeb3b; font-size: 2rem; margin-bottom: -10px;">CRITICAL!</div>' + dmg;
                triggerScreenShake();
            }
            else if (type === 'player_hit') { cssClass += ' player-dmg'; }
            else if (type === 'poison') { cssClass += ' poison-dmg'; content = 'POISON<br>' + dmg; }
            else if (type === 'evade') { cssClass += ' evade-text'; content = 'MISS'; }
            el.className = cssClass; el.innerHTML = content;
            const randomX = Math.floor(Math.random()*40)-20; const randomY = Math.floor(Math.random()*20)-10;
            el.style.transform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px))`;
            frame.appendChild(el); setTimeout(() => el.remove(), 1500);
        }

        function triggerScreenShake() {
            const container = document.getElementById('game-container');
            container.classList.remove('screen-shake');
            void container.offsetWidth;
            container.classList.add('screen-shake');
            setTimeout(() => container.classList.remove('screen-shake'), 500);
        }
        
        function triggerHitEffect(targetId, type) {
            const frame = document.getElementById(targetId);
            frame.classList.remove('hit-small', 'hit-big', 'hit-rogue', 'player-hit-anim', 'crit-action', 'evasion-action'); void frame.offsetWidth;
            if (type === 'normal') frame.classList.add('hit-small');
            else if (type === 'rogue') frame.classList.add('hit-rogue');
            else if (type === 'big') frame.classList.add('hit-big');
            else if (type === 'player_hit') frame.classList.add('player-hit-anim');
            else if (type === 'crit') frame.classList.add('crit-action');
            else if (type === 'evade') frame.classList.add('evasion-action');
        }
        
        function playMotion(imgId, targetFrameId, effectType) {
            const pImg = document.getElementById('p-img');
            const motionImg = document.getElementById(imgId);

            const jM = {
                'ë²„ì„œì»¤': 'warrior', 'ê°€ë””ì–¸': 'warrior',
                'ì–´ìŒ”ì‹ ': 'rogue', 'ì„€ë„ìš°': 'rogue',
                'ì•„í¬ë©”ì´ì§€': 'mage', 'ì†Œì„œëŸ¬': 'mage'
            };

            let base = jM[player.job];
            if (base) {
                if (imgId && imgId.includes('atk')) {
                    pImg.src = `image/${base}2.jpg`;
                } else if (imgId && imgId.includes('skl')) {
                    pImg.src = `image/${base}3.jpg`;
                }
                triggerHitEffect(targetFrameId, effectType);
                setTimeout(() => { pImg.src = `image/${base}1.jpg`; }, 1000);
            } else {
                if (effectType === 'crit') {
                    const critMap = { 'ì „ì‚¬': 'crit-warrior', 'ë„ì ': 'crit-rogue', 'ë§ˆë²•ì‚¬': 'crit-mage' };
                    const cImg = document.getElementById(critMap[player.job || 'ì „ì‚¬']);
                    if (cImg) {
                        pImg.style.display = 'none'; cImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('crit-action');
                        setTimeout(() => {
                            cImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('crit-action');
                        }, 1000);
                    }
                } else if (effectType === 'evade') {
                    const evaMap = { 'ì „ì‚¬': 'eva-warrior', 'ë„ì ': 'eva-rogue', 'ë§ˆë²•ì‚¬': 'eva-mage' };
                    const eImg = document.getElementById(evaMap[player.job || 'ì „ì‚¬']);
                    if (eImg) {
                        pImg.style.display = 'none'; eImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('evasion-action');
                        setTimeout(() => {
                            eImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('evasion-action');
                        }, 1000);
                    }
                } else {
                    if(motionImg) { pImg.style.display = 'none'; motionImg.style.display = 'block'; setTimeout(() => { motionImg.style.display = 'none'; pImg.style.display = 'block'; }, 1000); }
                }
                triggerHitEffect(targetFrameId, effectType);
            }
        }

        function playAttackSfx() { attackSfx.currentTime = 0; attackSfx.play().catch(e => {}); }
        function playCritSfx() { critSfx.currentTime = 0; critSfx.play().catch(e => {}); }
        function playLevelupSfx() { levelupSfx.currentTime = 0; levelupSfx.play().catch(e => {}); }
        function playItemSfx() { itemSfx.currentTime = 0; itemSfx.play().catch(e => {}); }
        function playDamageSfx() { damageSfx.currentTime = 0; damageSfx.play().catch(e => {}); }
        function playEvadeSfx() { evadeSfx.currentTime = 0; evadeSfx.play().catch(e => {}); }
        function playPotionSfx() { potionSfx.currentTime = 0; potionSfx.play().catch(e => {}); }
        function playGoldSfx() { goldSfx.currentTime = 0; goldSfx.play().catch(e => {}); }

        function atk() { 
            if(isActing) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ê³µê²©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            isActing = true;
            const jobKey = player.job || 'ì „ì‚¬'; 
            const imgMap = {
                'ì „ì‚¬':'atk-warrior', 'ë„ì ':'atk-rogue', 'ë§ˆë²•ì‚¬':'atk-mage',
                'ë²„ì„œì»¤':'atk-warrior', 'ê°€ë””ì–¸':'atk-warrior',
                'ì–´ìŒ”ì‹ ':'atk-rogue', 'ì„€ë„ìš°':'atk-rogue',
                'ì•„í¬ë©”ì´ì§€':'atk-mage', 'ì†Œì„œëŸ¬':'atk-mage'
            };
            
            playAttackSfx();

            setTimeout(() => {
                let enemyEvadeChance = isBossBattle ? 0.1 : 0.05;
                if (currentWeather === "fog") enemyEvadeChance += 0.15;

                if (Math.random() < enemyEvadeChance) {
                    addLog("<span class='log-evade'>ì ì´ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!</span>");
                    playEvadeSfx();
                    showDamage('enemy-frame', 0, 'evade');
                    triggerHitEffect('enemy-frame', 'evade');
                    update(); check();
                    return;
                }

                let critChance = 0.2;
                if (player.job === 'ì–´ìŒ”ì‹ ') critChance = 0.35;

                let isCrit = Math.random() < critChance;
                let dmg = Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0);
                if(isCrit) {
                    dmg = Math.floor(dmg*2);
                    playCritSfx();
                }
                
                playMotion(imgMap[jobKey], 'enemy-frame', isCrit?'crit':'normal');
                enemy.hp -= dmg; 
                showDamage('enemy-frame', dmg, isCrit?'crit':'normal');
                addLog(`ì ì—ê²Œ <span class='log-dmg'>${dmg}</span>ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                update(); check();
            }, 200);
        }

        function skl() {
            if(isActing) return; 
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ìŠ¤í‚¬ì„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            let costRate = 0.6;
            if (player.job === 'ì†Œì„œëŸ¬') costRate = 0.3;
            if (player.job === 'ë„ì ' || player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') costRate = 0.2;

            const cost = Math.floor(player.maxMp * costRate);
            if(player.mp < cost) { say('p', 'ë§ˆë‚˜ê°€ ë¶€ì¡±í•´!'); return; }

            isActing = true;
            player.mp -= cost;
            update();

            const jobKey = player.job || 'ì „ì‚¬';
            playAttackSfx();

            setTimeout(() => {
                let isCrit = false; let dmg = 0;
                
                if(player.job === 'ë„ì ' || player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') {
                    say('p', `ê¸‰ì†Œ ì°Œë¥´ê¸°!`);
                    let baseDmg = Math.floor(player.stats.dex * 0.5) + (player.level * 2);
                    let critChance = (player.job === 'ì–´ìŒ”ì‹ ') ? 0.55 : 0.4;
                    isCrit = Math.random() < critChance;
                    if (isCrit) {
                        dmg = (baseDmg * 4) + (player.bonusAtk||0);
                        playCritSfx();
                    }
                    else { dmg = baseDmg + (player.bonusAtk||0); }

                    let poisonChance = (player.job === 'ì„€ë„ìš°') ? 1.0 : 0.5;
                    if(Math.random() < poisonChance) { eStatus.poison = 3; addLog("ì ì—ê²Œ ë…ì„ ë¶€ì—¬í–ˆìŠµë‹ˆë‹¤!"); }

                    playMotion('atk-rogue', 'enemy-frame', isCrit?'crit':'rogue');
                } else {
                    say('p', 'ê°•ë ¥í•œ ìŠ¤í‚¬ ë°œë™!');
                    const vMap = {
                        'ì „ì‚¬':'v-warrior', 'ë§ˆë²•ì‚¬':'v-mage',
                        'ë²„ì„œì»¤':'v-warrior', 'ê°€ë””ì–¸':'v-warrior',
                        'ì•„í¬ë©”ì´ì§€':'v-mage', 'ì†Œì„œëŸ¬':'v-mage'
                    };
                    const v = document.getElementById(vMap[jobKey]); const pImg = document.getElementById('p-img');
                    if(v) {
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => { v.style.display='none'; pImg.style.display='block'; applySkillDmg(player.job); }
                    } else applySkillDmg(player.job);
                    return;
                }
                enemy.hp -= dmg; 
                showDamage('enemy-frame', dmg, isCrit?'crit':'normal'); 
                addLog(`ê°•ë ¥í•œ ê³µê²©! ì ì—ê²Œ <span class='log-dmg'>${dmg}</span>ì˜ í”¼í•´!`);
                update(); check();
            }, 200);
        }

        function applySkillDmg(job) {
            let isCrit = Math.random() < 0.2; let dmg = 0;
            let multiplier = 2.0;

            if (job === 'ë²„ì„œì»¤') multiplier = 4.0;
            else if (job === 'ì•„í¬ë©”ì´ì§€') multiplier = 4.5;
            else if (job === 'ì „ì‚¬' || job === 'ê°€ë””ì–¸') multiplier = 2.5;
            else if (job === 'ë§ˆë²•ì‚¬' || job === 'ì†Œì„œëŸ¬') multiplier = 2.2;

            if (currentWeather === "rain" && (job === 'ë§ˆë²•ì‚¬' || job === 'ì•„í¬ë©”ì´ì§€' || job === 'ì†Œì„œëŸ¬')) {
                multiplier *= 1.3;
                addLog("<span style='color:#82b1ff'>ë¹„ì˜ ê¸°ìš´ìœ¼ë¡œ ë§ˆë²•ì´ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤!</span>");
            }

            if(job === 'ì „ì‚¬' || job === 'ë²„ì„œì»¤' || job === 'ê°€ë””ì–¸') {
                dmg = (player.stats.str * multiplier) + (player.level * 4);
                if (job === 'ê°€ë””ì–¸' && Math.random() < 0.3) { eStatus.stun = 1; addLog("ì ì„ ê¸°ì ˆì‹œì¼°ìŠµë‹ˆë‹¤!"); }
            } else {
                dmg = (player.stats.int * multiplier) + (player.level * 5);
            }

            dmg += (player.bonusAtk||0);
            if(isCrit) { dmg = Math.floor(dmg*2); playCritSfx(); }

            triggerHitEffect('enemy-frame', isCrit?'crit':'big');
            enemy.hp -= dmg; 
            showDamage('enemy-frame', dmg, isCrit?'crit':'normal'); 
            addLog(`ìŠ¤í‚¬ ì ì¤‘! <span class='log-dmg'>${dmg}</span> í”¼í•´!`);
            update(); check();
        }

        function rageAtk() {
            if(isActing || rage < maxRage) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ë¶„ë…¸ ê³µê²©ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; }

            isActing = true;
            rage = 0;
            player.rage = 0;
            update();

            say('p', 'ë¶„ë…¸ì˜ ì¼ê²©!!!');
            playCritSfx();

            // Show Rage Kill Effect
            const killImg = document.getElementById('rage-kill-img');
            killImg.classList.add('rage-kill-anim');
            setTimeout(() => killImg.classList.remove('rage-kill-anim'), 2000);

            setTimeout(() => {
                let dmg = (Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0)) * 3;

                const jobKey = player.job || 'ì „ì‚¬';
                const imgMap = {
                    'ì „ì‚¬':'atk-warrior', 'ë„ì ':'atk-rogue', 'ë§ˆë²•ì‚¬':'atk-mage',
                    'ë²„ì„œì»¤':'atk-warrior', 'ê°€ë””ì–¸':'atk-warrior',
                    'ì–´ìŒ”ì‹ ':'atk-rogue', 'ì„€ë„ìš°':'atk-rogue',
                    'ì•„í¬ë©”ì´ì§€':'atk-mage', 'ì†Œì„œëŸ¬':'atk-mage'
                };

                playMotion(imgMap[jobKey], 'enemy-frame', 'crit');
                enemy.hp -= dmg;
                showDamage('enemy-frame', dmg, 'crit');
                addLog(`ë¶„ë…¸ ê³µê²©! ì ì—ê²Œ <span class='log-dmg'>${dmg}</span>ì˜ ì¹˜ëª…ì ì¸ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                update(); check();
            }, 200);
        }

        function check() { 
            if(enemy.hp <= 0) { say('e', 'í¬ìœ½..!'); setTimeout(win, 1000); }
            else { setTimeout(eTurn, 1500); }
        }
        
        function eTurn() { 
            if(eStatus.stun > 0) { addLog("ì ì´ ê¸°ì ˆ ìƒíƒœë¼ í–‰ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); eStatus.stun--; update(); isActing = false; return; }

            if(eStatus.poison > 0) {
                const pDmg = Math.floor(enemy.maxHp * 0.05);
                enemy.hp -= pDmg;
                showDamage('enemy-frame', pDmg, 'poison');
                addLog(`ì ì´ ë…ìœ¼ë¡œ ì¸í•´ <span style="color:#9b26b6">${pDmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
                eStatus.poison--;
                update();
                if(enemy.hp <= 0) { win(); return; }
            }

            if(pStatus.poison > 0) {
                const pDmg = Math.floor(player.maxHp * 0.08);
                player.hp -= pDmg;
                showDamage('player-frame', pDmg, 'poison');
                addLog(`ë…ìœ¼ë¡œ ì¸í•´ <span style="color:#9b26b6">${pDmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
                pStatus.poison--;
                update();
                if(player.hp <= 0) { showGameOver("ë…ì— ì˜í•´ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤..."); return; }
            }

            let evadeChance = (player.stats.dex / 100) + (player.level * 0.005);
            if (player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') evadeChance += 0.1;
            if (currentWeather === "fog") evadeChance += 0.1;
            evadeChance = Math.min(0.4, evadeChance);

            if (Math.random() < evadeChance) {
                addLog("<span class='log-evade'>ì ì˜ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!</span>");
                playEvadeSfx();
                say('p', 'ëŠë ¤!');
                playMotion('', 'player-frame', 'evade');
                showDamage('player-frame', 0, 'evade');
                update(); isActing = false;
                return;
            }

            let dmg = Math.max(1, enemy.atk - Math.floor(player.stats.dex/3));
            if (player.job === 'ê°€ë””ì–¸') dmg = Math.floor(dmg * 0.8);

            player.hp -= dmg;
            rage = Math.min(maxRage, rage + Math.floor(dmg * 1.5));
            player.rage = rage;

            playDamageSfx();
            const jobKey = player.job || 'ì „ì‚¬';
            const hitMap = {
                'ì „ì‚¬':'hit-warrior', 'ë„ì ':'hit-rogue', 'ë§ˆë²•ì‚¬':'hit-mage',
                'ë²„ì„œì»¤':'hit-warrior', 'ê°€ë””ì–¸':'hit-warrior',
                'ì–´ìŒ”ì‹ ':'hit-rogue', 'ì„€ë„ìš°':'hit-rogue',
                'ì•„í¬ë©”ì´ì§€':'hit-mage', 'ì†Œì„œëŸ¬':'hit-mage'
            };
            playMotion(hitMap[jobKey], 'player-frame', 'player_hit'); 
            showDamage('player-frame', dmg, 'player_hit');
            say('e', 'ë°›ì•„ë¼!'); 
            addLog(`ì ì´ ê³µê²©í•©ë‹ˆë‹¤! <span style='color:red'>${dmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);

            let poisonChance = enemy.canPoison ? 0.3 : 0;
            if(Math.random() < poisonChance) { pStatus.poison = 3; addLog("<span style='color:#9b26b6'>ì ì˜ ê³µê²©ì— ì¤‘ë…ë˜ì—ˆìŠµë‹ˆë‹¤!</span>"); }
            if(Math.random() < 0.1) { pStatus.stun = 1; addLog("ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!"); }

            update(); isActing = false;
            if(player.hp <= 0) { showGameOver("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤..."); }
        }

        function showGameOver(msg) {
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            const survivalTime = Math.floor((Date.now() - startTime) / 1000);
            const min = Math.floor(survivalTime / 60);
            const sec = survivalTime % 60;

            const kills = player.quests.killCount || 0;
            const bossKills = player.quests.bossKillCount || 0;

            let itemValue = 0;
            player.inventory.forEach(item => {
                const baseVal = item.val || 10;
                const enh = item.enhanceCount || 0;
                itemValue += Math.floor((baseVal * 5) + (enh * 50));
            });

            const score = (kills * 100) + (bossKills * 1000) + (survivalTime * 10) + (player.level * 500) + itemValue;

            document.querySelector('.gameover-title').innerText = msg;
            document.getElementById('go-time').innerText = `${min}ë¶„ ${sec}ì´ˆ`;
            document.getElementById('go-kills').innerText = `${kills}ë§ˆë¦¬`;
            document.getElementById('go-boss').innerText = `${bossKills}ë§ˆë¦¬`;
            document.getElementById('go-lv').innerText = `LV.${player.level}`;
            document.getElementById('go-score-val').innerText = score.toLocaleString();

            // Send Ranking Data
            fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    type: 'ranking',
                    name: player.name,
                    score: score,
                    job: player.job,
                    level: player.level
                })
            });

            localStorage.removeItem('rpg_temp_player');
            localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
            localStorage.removeItem('rpg_boss_death_time');

            document.getElementById('gameover-modal').style.display = 'flex';
        }

        function win() {
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            if (isBossBattle) {
                if (isSuperBoss) {
                    localStorage.setItem('rpg_super_boss_killed', 'true');
                } else {
                    localStorage.setItem('rpg_boss_death_time', Date.now());
                }
                localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
                player.quests.bossKillCount = (player.quests.bossKillCount || 0) + 1;
            } else {
                if (isNight) player.quests.nightKillCount = (player.quests.nightKillCount || 0) + 1;
                else player.quests.dayKillCount = (player.quests.dayKillCount || 0) + 1;
            }

            player.exp += enemy.exp;
            player.quests.killCount++;

            let resultHTML = `<div class="result-row">íšë“ ê²½í—˜ì¹˜ <span style="color:violet">+${enemy.exp} EXP</span></div>`;
            let dropImg = null; let dropName = ""; let dropColor = "#fff";

            const gold = Math.floor(Math.random()*50)+10 + (isBossBattle ? 500 : 0);
            player.gold = (player.gold||0) + gold;
            resultHTML += `<div class="result-row">íšë“ ê³¨ë“œ <span style="color:gold">+${gold} G</span></div>`;
            if(!dropImg) dropImg = ITEM_IMAGES['gold'];
            playGoldSfx();

            if (isBossBattle && Math.random() < 0.5) {
                const jobList = DROP_TABLE[player.job] || DROP_TABLE['ì „ì‚¬'];
                const baseName = jobList[Math.floor(Math.random() * jobList.length)];
                let isLegendary = isSuperBoss || Math.random() < 0.3;
                let grade = isLegendary ? Math.floor(Math.random() * 6) + 10 : Math.floor(Math.random() * 5) + 8;
                let colorCode = isLegendary ? "#ff8000" : "#a335ee";
                let rarityName = isLegendary ? "ì „ì„¤ì˜" : "ì—í”½";
                const newItem = { name: `${rarityName} ${baseName} (+${grade})`, type: 'weapon', desc: `ê³µê²©ë ¥ +${grade} (${player.job} ì „ìš©)`, val: grade, reqJob: player.job, equipped: false, rarity: isLegendary ? "legendary" : "epic", rarityColor: colorCode, enhanceCount: grade, options: [] };

                const optCount = isLegendary ? 3 : 2;
                const possibleOpts = [{name:"í˜",key:"str",val:Math.floor(Math.random()*5)+2}, {name:"ë¯¼ì²©",key:"dex",val:Math.floor(Math.random()*5)+2}, {name:"ì²´ë ¥",key:"con",val:Math.floor(Math.random()*5)+2}, {name:"ì§€ëŠ¥",key:"int",val:Math.floor(Math.random()*5)+2}];
                for(let i=0; i<optCount; i++) { const opt = possibleOpts[Math.floor(Math.random()*possibleOpts.length)]; newItem.options.push(opt); newItem.desc += `\n[ì˜µì…˜] ${opt.name} +${opt.val}`; }

                player.inventory.push(newItem);
                dropName = newItem.name; dropColor = colorCode; dropImg = WEAPON_IMAGES[player.job];
            } 
            else if (!isBossBattle && Math.random() < 0.05) {
                const nameList = DROP_TABLE[player.job] || DROP_TABLE['ì „ì‚¬'];
                const baseName = nameList[Math.floor(Math.random() * nameList.length)];
                const grade = Math.floor(Math.random() * 5) + 8;
                const newItem = { name: `ì—í”½ ${baseName} (+${grade})`, type: 'weapon', desc: `ê³µê²©ë ¥ +${grade} (${player.job} ì „ìš©)`, val: grade, reqJob: player.job, equipped: false, rarity: "epic", rarityColor: '#a335ee', enhanceCount: grade, options: [] };
                player.inventory.push(newItem);
                dropName = newItem.name; dropColor = '#a335ee'; dropImg = WEAPON_IMAGES[player.job];
            }
            else if (Math.random() < 0.6) {
                const rand = Math.random();
                if(rand < 0.3) { player.inventory.push({name:'ì²´ë ¥ ë¬¼ì•½', type:'potion_hp', desc:'HP +50 íšŒë³µ', val:50}); dropName = "ì²´ë ¥ ë¬¼ì•½"; dropColor="#ff8a80"; dropImg=ITEM_IMAGES['hp_potion']; }
                else if(rand < 0.6) { player.inventory.push({name:'ë§ˆë‚˜ ë¬¼ì•½', type:'potion_mp', desc:'MP +30 íšŒë³µ', val:30}); dropName = "ë§ˆë‚˜ ë¬¼ì•½"; dropColor="#82b1ff"; dropImg=ITEM_IMAGES['mp_potion']; }
                else if(rand < 0.8) { player.inventory.push({name:'ê²½í—˜ì¹˜ ë¬¼ì•½', type:'potion_exp', desc:'EXP +100 íšë“', val:100}); dropName = "ê²½í—˜ì¹˜ ë¬¼ì•½"; dropColor="#e040fb"; dropImg=ITEM_IMAGES['exp_potion']; }
                else { player.inventory.push({name:'í•´ë… ë¬¼ì•½', type:'potion_poison', desc:'ë… ìƒíƒœ í•´ì œ', val:0}); dropName = "í•´ë… ë¬¼ì•½"; dropColor="#00e676"; dropImg=ITEM_IMAGES['poison_potion']; }
            }

            if(dropName) {
                playItemSfx();
                resultHTML += `<div class="result-item-box"><img src="image/${dropImg}" class="result-item-img"><div class="result-item-name" style="color:${dropColor}">${dropName}</div><div style="font-size:0.8rem; color:#aaa;">ì•„ì´í…œì„ íšë“í–ˆìŠµë‹ˆë‹¤!</div></div>`;
            }
            
            if(dropName && dropImg) { 
                const imgEl = document.getElementById('drop-item-img'); 
                imgEl.src = `image/${dropImg}`; 
                imgEl.style.display = 'block'; 
                setTimeout(() => { imgEl.style.display = 'none'; showResultModal(resultHTML); }, 2000); 
            } else { 
                showResultModal(resultHTML); 
            }
        }

        function showResultModal(html) { document.getElementById('result-content').innerHTML = html; document.getElementById('result-modal').style.display = 'flex'; }
        
        function checkLevelUpOrFinish() { 
            document.getElementById('result-modal').style.display = 'none'; 
            if(player.exp >= player.maxExp) { showLevelUpModal(); } 
            else { finishBattle(); } 
        }
        
        function showLevelUpModal() {
            playLevelupSfx();
            const modal = document.getElementById('levelup-modal'); const oldLv = player.level; const oldHp = player.maxHp; const oldMp = player.maxMp;
            player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
            player.traitPoints = (player.traitPoints || 0) + 2;
            document.getElementById('old-lv').innerText = oldLv; document.getElementById('new-lv').innerText = player.level;
            document.getElementById('stat-hp').innerHTML = `${oldHp} <span class='stat-up'>â–· ${player.maxHp} (+10)</span>`;
            document.getElementById('stat-mp').innerHTML = `${oldMp} <span class='stat-up'>â–· ${player.maxMp} (+5)</span>`;

            const btn = document.getElementById('lv-confirm-btn');
            if (player.level >= 5 && !player.isAdvanced) {
                btn.innerText = "ì „ì§í•˜ëŸ¬ ê°€ê¸°";
            } else {
                btn.innerText = "íŠ¹ì„± ë¶„ë°°í•˜ëŸ¬ ê°€ê¸°";
            }

            modal.style.display = 'flex';
        }
        
        function finishBattle() {
            player.rage = rage;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            location.href = 'map.html';
        }

        function finishBattleWithLevelUp() {
            player.rage = rage;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            if (!(player.level >= 5 && !player.isAdvanced)) {
                localStorage.setItem('rpg_open_traits', 'true');
            }
            location.href = 'map.html';
        }
        
        function run() { 
            if(isActing) return; isActing = true; 
            let runChance = isBossBattle ? 0.3 : 0.4;
            if(Math.random() < runChance) {
                say('p', "íŠ€ì–´!");
                addLog("ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤!");
                setTimeout(finishBattle, 1200);
            }
            else {
                say('p', "ì‹¤íŒ¨..!");
                addLog("ë„ë§ì¹˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!");
                setTimeout(eTurn, 1500);
            }
        }

        function openItemModal() {
            if(isActing) return;
            const modal = document.getElementById('item-modal');
            const list = document.getElementById('item-list');
            list.innerHTML = '';
            const potions = player.inventory.filter(i => i.type.includes('potion'));
            const potionGroups = {};
            potions.forEach((p, idx) => {
                const originalIdx = player.inventory.indexOf(p);
                if (!potionGroups[p.name]) potionGroups[p.name] = { item: p, count: 0, indices: [] };
                potionGroups[p.name].count++;
                potionGroups[p.name].indices.push(originalIdx);
            });

            if (Object.keys(potionGroups).length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                for (const key in potionGroups) {
                    const group = potionGroups[key];
                    const item = group.item;
                    const div = document.createElement('div');
                    div.className = 'battle-item-row';
                    let iconSrc = 'potion_hp.jpg';
                    if (item.name.includes('ë§ˆë‚˜')) iconSrc = 'potion_mp.jpg';
                    else if (item.name.includes('í•´ë…')) iconSrc = 'potion_poison.jpg';
                    else if (item.name.includes('ê²½í—˜ì¹˜')) iconSrc = 'potion_exp.jpg';
                    div.innerHTML = `<img src="image/${iconSrc}" class="battle-item-icon"><div class="battle-item-info"><div class="battle-item-name">${item.name}<span class="battle-item-count">x${group.count}</span></div><div class="battle-item-desc">${item.desc}</div></div>`;
                    div.onclick = () => useBattleItem(group.indices[0]);
                    list.appendChild(div);
                }
            }
            modal.style.display = 'flex';
        }

        function closeItemModal() { document.getElementById('item-modal').style.display = 'none'; }

        function useBattleItem(index) {
            closeItemModal();
            if(isActing) return;
            const item = player.inventory[index];
            if (!item) return;

            if (item.name.includes('ì²´ë ¥')) {
                if (player.hp >= player.maxHp) { addLog("ì²´ë ¥ì´ ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); return; }
                isActing = true;
                const heal = item.val;
                player.hp = Math.min(player.hp + heal, player.maxHp);
                addLog(`<span style="color:#ff5252">ì²´ë ¥ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ HPë¥¼ <span style="color:#00e676">${heal}</span> íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
                playPotionSfx();
            } else if (item.name.includes('ë§ˆë‚˜')) {
                if (player.mp >= player.maxMp) { addLog("ë§ˆë‚˜ê°€ ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); return; }
                isActing = true;
                const heal = item.val;
                player.mp = Math.min(player.mp + heal, player.maxMp);
                addLog(`<span style="color:#2979ff">ë§ˆë‚˜ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ MPë¥¼ <span style="color:#2979ff">${heal}</span> íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
                playPotionSfx();
            } else if (item.name.includes('ê²½í—˜ì¹˜')) {
                isActing = true;
                player.exp += item.val;
                addLog(`<span style="color:#e040fb">ê²½í—˜ì¹˜ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ ê²½í—˜ì¹˜ë¥¼ <span style="color:#e040fb">${item.val}</span> íšë“í–ˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
            } else if (item.type === 'potion_poison') {
                if (pStatus.poison <= 0) { addLog("ë… ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."); return; }
                isActing = true;
                pStatus.poison = 0;
                addLog(`<span style="color:#00e676">í•´ë… ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ ë…ì„ ì¹˜ë£Œí–ˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
                const cureEl = document.getElementById('p-cure');
                cureEl.style.display = 'block';
                setTimeout(() => { cureEl.style.display = 'none'; }, 1000);
            }

            player.inventory.splice(index, 1);
            update();
            setTimeout(eTurn, 1500);
        }
    </script>
</body>
</html>