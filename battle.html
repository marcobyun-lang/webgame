<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DUNGEON RPG - Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Cinzel:wght@700&family=Inter:wght@400;600&family=Noto+Serif+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #050505; 
            --panel-bg: rgba(20, 20, 25, 0.95); 
            --border-color: #5c4d3c; 
            --accent-gold: #ffd700; 
            --accent-red: #ff3333; 
            --danger: #ff1744; 
            --mp-color: #2979ff; 
            --rage-color: #ff9800;
            --text-main: #e0e0e0;
            --font-combat: 'Black Han Sans', sans-serif;
            --font-ui: 'Noto Serif KR', serif;
            --font-eng: 'Cinzel', serif;

            /* Button Colors */
            --btn-atk: #d32f2f;
            --btn-def: #1976d2;
            --btn-skl: #009688;
            --btn-special: #7b1fa2;
            --btn-item: #388e3c;
        }

        body { 
            background-color: var(--bg-color); 
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), repeating-linear-gradient(45deg, #121212 0, #121212 10px, #0a0a0a 10px, #0a0a0a 20px); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; user-select: none;
        }

        #game-container { 
            width: 960px; height: 720px; 
            background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('image/map.jpg') center/cover;
            border: 2px solid #333; 
            box-shadow: 0 0 80px rgba(0,0,0,0.9), inset 0 0 100px rgba(0,0,0,0.8); 
            border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }

        #game-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 60%, black 100%); pointer-events: none; z-index: 5; }
        
        .battle-stage { display: flex; justify-content: space-around; align-items: center; width: 90%; margin-bottom: 20px; z-index: 20; position: relative; }
        .unit-box { text-align: center; width: 260px; position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .unit-frame {
            width: 180px; height: 180px; 
            border: 4px solid #444; border-radius: 8px; 
            overflow: hidden; position: relative; background: #111;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 1; 
            transition: transform 0.1s;
        }
        .unit-img, video { width: 100% !important; height: 100% !important; object-fit: cover !important; background-color: #000; }
        
        .unit-info { margin-top: 15px; width: 100%; text-shadow: 2px 2px 4px #000; }
        .unit-name { font-family: var(--font-combat); font-size: 1.5rem; color: #fff; margin: 0; letter-spacing: 1px; }
        .unit-job { font-family: var(--font-eng); font-size: 0.8rem; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        
        .bar-container { width: 100%; display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
        .bar-wrap { 
            background: #111; height: 16px; border: 1px solid #333; 
            border-radius: 3px; overflow: hidden; position: relative; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
        }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; position: relative; }
        .bar-fill::after { content:""; position:absolute; top:0; left:0; width:100%; height:50%; background:rgba(255,255,255,0.2); }
        .hp-bar { background: linear-gradient(90deg, #b71c1c, #ff5252); }
        .mp-bar { background: linear-gradient(90deg, #0d47a1, #448aff); }
        .rage-bar { background: linear-gradient(90deg, #e65100, #ff9800); }

        .bar-text { 
            position: absolute; width: 100%; top: 0; left: 0; line-height: 16px; 
            font-size: 10px; font-family: var(--font-eng); font-weight: bold; text-align: center; 
            text-shadow: 1px 1px 2px #000; z-index: 5; color: #fff; letter-spacing: 1px;
        }

        .status-effects { display: flex; gap: 5px; margin-top: 5px; justify-content: center; min-height: 20px; }
        .status-icon { padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: #fff; }
        .status-poison { background: #4caf50; }
        .status-stun { background: #ffeb3b; color: #000; }
        .status-wind { background: #81c784; }
        .status-atk-up-ranger { background: #ff9800; }

        .speech {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.95); color: #000; padding: 8px 16px; border: 2px solid #000; 
            border-radius: 8px; font-family: var(--font-ui); font-weight: bold; font-size: 0.95rem; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; z-index: 100; white-space: nowrap; 
            animation: float 2s infinite ease-in-out;
        }
        .speech::after { content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); border-width:8px 8px 0; border-style:solid; border-color:rgba(255,255,255,0.95) transparent transparent transparent; }
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }
        
        .vs-text { font-family: var(--font-eng); font-size: 4rem; color: rgba(255,255,255,0.1); font-style: italic; font-weight: bold; }

        .log-panel {
            width: 700px; height: 100px; 
            background: rgba(0,0,0,0.7); border: 1px solid #444; border-radius: 4px;
            padding: 15px; overflow-y: auto; margin-bottom: 25px; 
            font-size: 1rem; color: #ccc; z-index: 20; text-align: center; 
            font-family: var(--font-ui); line-height: 1.6;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .log-highlight { color: var(--accent-gold); font-weight: bold; }
        .log-dmg { color: var(--danger); font-weight: bold; }
        .log-evade { color: var(--accent-gold); font-weight: bold; }

        .btns { display: flex; gap: 15px; z-index: 20; flex-wrap: wrap; justify-content: center; }
        .btn { 
            padding: 12px 25px; border: 2px solid rgba(255,255,255,0.2); font-family: var(--font-combat);
            font-size: 1.1rem; cursor: pointer; color: #fff; transition: all 0.2s;
            text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-radius: 6px;
            position: relative; overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            min-width: 120px;
        }
        .btn::before { content:""; position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(rgba(255,255,255,0.2), transparent); }
        
        .btn-atk { background: linear-gradient(to bottom, #c62828, #8e0000); border-color: #ff5252; }
        .btn-atk:hover { background: linear-gradient(to bottom, #ef5350, #c62828); transform: translateY(-3px); box-shadow: 0 0 20px rgba(211, 47, 47, 0.6); }
        
        .btn-def { background: linear-gradient(to bottom, #1565c0, #0d47a1); border-color: #42a5f5; }
        .btn-def:hover { background: linear-gradient(to bottom, #42a5f5, #1565c0); transform: translateY(-3px); box-shadow: 0 0 20px rgba(33, 150, 243, 0.6); }

        .btn-skl { background: linear-gradient(to bottom, #00897b, #004d40); border-color: #26a69a; }
        .btn-skl:hover { background: linear-gradient(to bottom, #26a69a, #00897b); transform: translateY(-3px); box-shadow: 0 0 20px rgba(38, 166, 154, 0.6); }
        
        .btn-special { background: linear-gradient(to bottom, #7b1fa2, #4a148c); border-color: #ab47bc; }
        .btn-special:hover { background: linear-gradient(to bottom, #ab47bc, #7b1fa2); transform: translateY(-3px); box-shadow: 0 0 20px rgba(123, 31, 162, 0.6); }
        .btn-special:disabled { filter: grayscale(100%); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .btn-item { background: linear-gradient(to bottom, #2e7d32, #1b5e20); border-color: #66bb6a; }
        .btn-item:hover { background: linear-gradient(to bottom, #66bb6a, #2e7d32); transform: translateY(-3px); box-shadow: 0 0 20px rgba(46, 125, 50, 0.6); }

        .btn-run { background: linear-gradient(to bottom, #424242, #212121); border-color: #555; }
        .btn-run:hover { background: linear-gradient(to bottom, #757575, #424242); transform: translateY(-3px); color: #fff; }

        .btn-rage {
            background: linear-gradient(to bottom, #e65100, #bf360c); border-color: #ff9800;
            color: #fff; font-size: 1.5rem; padding: 15px 50px; display: none;
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            animation: ragePulse 1s infinite alternate; z-index: 30;
        }
        @keyframes ragePulse { from { box-shadow: 0 0 10px #ff9800; transform: translateX(-50%) scale(1); } to { box-shadow: 0 0 30px #ff9800; transform: translateX(-50%) scale(1.1); } }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }

        .modal-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 520px; 
            background: rgba(30, 30, 35, 0.98);
            border: 2px solid var(--accent-gold); display: none;
            flex-direction: column; align-items: center; padding: 40px; z-index: 1000; 
            box-shadow: 0 0 80px rgba(0,0,0,1); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 8px; 
        }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        .modal-title { 
            font-family: var(--font-combat); font-size: 3rem; color: var(--accent-gold); margin-bottom: 20px; 
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); letter-spacing: 2px; border-bottom: 3px solid var(--accent-red); padding-bottom: 5px; 
        }
        .result-content {
            width: 100%; text-align: center; margin-bottom: 25px; color: #eee; font-family: var(--font-ui);
            text-shadow: 1px 1px 2px #000;
        }
        .result-row { margin: 12px 0; font-size: 1.2rem; display: flex; justify-content: space-between; padding: 0 40px; }
        
        .result-item-box {
            margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); 
            border: 1px solid #555; border-radius: 8px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 80%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .result-item-img { width: 64px; height: 64px; border: 2px solid var(--accent-gold); border-radius: 6px; object-fit: cover; box-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .result-item-name { font-weight: bold; color: var(--accent-gold); font-family: var(--font-ui); font-size: 1.1rem; }
        
        .lv-grid { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .lv-stat { background: rgba(0,0,0,0.4); padding: 10px; border: 1px solid #333; text-align: center; border-radius: 4px; }
        .stat-name { font-size: 0.9rem; color: #888; margin-bottom: 5px; font-family: var(--font-eng); font-weight: bold; }
        .stat-change { font-size: 1.3rem; font-weight: bold; color: #fff; font-family: var(--font-combat); }
        .stat-up { color: #00e676; font-size: 0.9rem; margin-left: 5px; }
        
        .btn-confirm { 
            background: var(--accent-gold); color: #000; padding: 12px 50px; border: none; 
            cursor: pointer; font-size: 1.2rem; font-family: var(--font-combat); margin-top: 10px; 
            transition: 0.2s; border-radius: 4px; font-weight: bold;
        }
        .btn-confirm:hover { background: #ffea00; transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 234, 0, 0.5); }

        /* GameOver Modal */
        #gameover-modal { width: 560px; height: auto; z-index: 1000; border: 3px solid var(--danger); display: none; padding: 20px 30px; box-sizing: border-box; overflow: hidden; }
        .gameover-title { font-family: var(--font-combat); font-size: 2.4rem; color: var(--danger); text-align: center; margin-bottom: 15px; text-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .gameover-stats {
            background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; width: 100%; box-sizing: border-box;
            border-top: 2px solid rgba(255,255,255,0.1); border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .go-row { display: flex; justify-content: space-between; margin: 6px 0; font-size: 0.9rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 3px; }
        .go-row:last-child { border-bottom: none; }
        .go-label { display: flex; align-items: center; gap: 8px; }
        .go-val { color: var(--accent-gold); font-weight: bold; }
        .go-score { font-size: 1.8rem; color: #fff; text-align: center; margin-top: 5px; border-top: 2px solid #555; padding-top: 10px; font-family: var(--font-combat); letter-spacing: 2px; }

        /* Item Modal Styles */
        #item-modal {
            width: 400px;
            background: rgba(15, 15, 20, 0.98);
            border: 2px solid #4caf50;
        }
        .item-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .battle-item-row {
            display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.2s;
        }
        .battle-item-row:hover { background: rgba(255, 255, 255, 0.1); }
        .battle-item-icon { width: 32px; height: 32px; margin-right: 10px; border: 1px solid #444; }
        .battle-item-info { flex: 1; text-align: left; }
        .battle-item-name { font-weight: bold; color: #eee; font-size: 0.9rem; }
        .battle-item-desc { font-size: 0.7rem; color: #aaa; }
        .battle-item-count { font-weight: bold; color: var(--accent-gold); margin-left: 10px; }

        @keyframes shakeSmall { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-4px, 4px); } 50% { transform: translate(4px, -4px); } 75% { transform: translate(-4px, -4px); } }
        .hit-small { animation: shakeSmall 0.3s ease-out; }
        @keyframes shakeBig { 0% { transform: rotate(0deg); } 20% { transform: translate(-10px, 10px) rotate(-5deg); } 40% { transform: translate(10px, -10px) rotate(5deg); } 60% { transform: translate(-5px, 5px) rotate(-3deg); } 100% { transform: rotate(0deg); } }
        .hit-big { animation: shakeBig 0.4s ease-out; }
        @keyframes flashRed { 0% { filter: sepia(0) saturate(1); } 50% { filter: sepia(1) saturate(5) hue-rotate(-50deg); } 100% { filter: sepia(0) saturate(1); } }
        .player-hit-anim { animation: shakeBig 0.4s ease-out, flashRed 0.3s; border-color: var(--danger) !important; }
        
        @keyframes critShake {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            10% { transform: translate(-15px, -15px) rotate(-10deg) scale(1.2); }
            20% { transform: translate(15px, 15px) rotate(10deg) scale(1.3); }
            30% { transform: translate(-20px, 10px) rotate(-15deg) scale(1.4); }
            40% { transform: translate(20px, -10px) rotate(15deg) scale(1.3); }
            50% { transform: translate(0, 0) rotate(0deg) scale(1.2); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }
        .crit-action { animation: critShake 1.0s cubic-bezier(.36,.07,.19,.97) both; z-index: 50; }

        @keyframes evasionShake {
            0% { transform: translate(0, 0) scale(1); }
            20% { transform: translate(40px, -20px) rotate(15deg) scale(0.9); }
            40% { transform: translate(-10px, 10px) rotate(-5deg) scale(1.1); }
            100% { transform: translate(0, 0) scale(1); }
        }
        .evade-action { animation: evasionShake 1.0s ease-out; z-index: 50; }

        /* Screen Shake Effect */
        @keyframes screenShake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, -10px); }
            60% { transform: translate(10px, 10px); }
            70% { transform: translate(-10px, 10px); }
            80% { transform: translate(10px, -10px); }
            90% { transform: translate(-10px, -10px); }
            100% { transform: translate(0, 0); }
        }
        .screen-shake { animation: screenShake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes screenShakeStrong {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-15px, -15px); }
            20% { transform: translate(15px, 15px); }
            30% { transform: translate(-15px, -15px); }
            40% { transform: translate(15px, -15px); }
            50% { transform: translate(-15px, -15px); }
            60% { transform: translate(15px, 15px); }
            70% { transform: translate(-15px, -15px); }
            80% { transform: translate(15px, -15px); }
            90% { transform: translate(-15px, -15px); }
            100% { transform: translate(0, 0); }
        }
        .screen-shake-strong { animation: screenShakeStrong 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        .dmg-text {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            font-family: var(--font-combat); font-weight: bold; font-size: 3.5rem; color: #fff; 
            text-shadow: -2px -2px 0 #000, 2px 2px 0 #000, 0 0 10px rgba(0,0,0,0.5); 
            pointer-events: none; z-index: 200; animation: damagePop 1.5s forwards;
        }
        .crit-text { font-size: 5rem; color: #ff3333; text-shadow: 3px 3px 0 #000, 0 0 20px #ff3333; z-index: 201; }
        .player-dmg { color: #ff5252; font-size: 4rem; }
        .evade-text { color: #ffd700; font-size: 4rem; text-shadow: 0 0 15px #ffd700; }
        @keyframes damagePop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -100%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -180%); } }
        
        /* Legendary Warrior Damage */
        .dmg-legendary-warrior {
            color: #ffd700 !important;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8f00, 0 0 30px #ffd700 !important;
            font-size: 4.5rem !important;
            animation: damagePop 1.5s forwards, goldDust 1s infinite !important;
        }
        @keyframes goldDust {
            0% { text-shadow: 0 0 10px #ffd700; }
            50% { text-shadow: 0 0 20px #ffeb3b, 0 0 40px #ffd700; }
            100% { text-shadow: 0 0 10px #ffd700; }
        }

        /* Warrior Shockwave */
        .shockwave-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border: 5px solid #ffd700;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 250;
            animation: shockwavePop 0.5s ease-out;
            box-shadow: 0 0 20px #ffd700, inset 0 0 20px #b8860b;
        }
        @keyframes shockwavePop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; border-width: 10px; }
            100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; border-width: 0px; }
        }

        /* Legendary Rogue Animation */
        .rogue-legendary-action {
            animation: rogueLegendary 0.5s ease-out !important;
        }
        @keyframes rogueLegendary {
            0% { transform: scale(1); filter: none; }
            20% { transform: scale(1.1); filter: drop-shadow(-20px 0 0 rgba(147, 51, 234, 0.6)) drop-shadow(20px 0 0 rgba(147, 51, 234, 0.6)); opacity: 0.8; }
            40% { transform: translate(-30px, 0) scale(1); filter: drop-shadow(60px 0 0 rgba(147, 51, 234, 0.4)); opacity: 0.6; }
            60% { transform: translate(30px, 0) scale(1); filter: drop-shadow(-60px 0 0 rgba(147, 51, 234, 0.4)); opacity: 0.6; }
            80% { transform: scale(1.1); filter: drop-shadow(-20px 0 0 rgba(147, 51, 234, 0.6)) drop-shadow(20px 0 0 rgba(147, 51, 234, 0.6)); opacity: 0.8; }
            100% { transform: scale(1); filter: none; opacity: 1; }
        }

        /* Legendary Mage Holy Light */
        .holy-light-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            background: radial-gradient(circle, #fff 20%, #ffd700 50%, transparent 70%);
            z-index: 300; pointer-events: none;
            animation: holyLightPop 0.6s ease-out forwards;
            mix-blend-mode: screen;
            box-shadow: 0 0 60px 30px #ffd700;
            border-radius: 50%;
        }
        @keyframes holyLightPop {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .drop-item-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 160px; height: 160px; object-fit: contain; z-index: 300; pointer-events: none;
            animation: dropItemPop 2.5s ease-out forwards; filter: drop-shadow(0 0 25px var(--accent-gold));
            border-radius: 12px; box-sizing: border-box;
        }
        @keyframes dropItemPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); } 100% { opacity: 0; transform: translate(-50%, -120%) scale(0.8); } }

        .border-common { border: 3px solid #fff; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .border-rare { border: 3px solid #2196f3; box-shadow: 0 0 15px rgba(33, 150, 243, 0.6); }
        .border-epic { border: 3px solid #a335ee; box-shadow: 0 0 15px rgba(163, 53, 238, 0.6); }
        .border-legendary { border: 3px solid #ff8000; box-shadow: 0 0 20px rgba(255, 128, 0, 0.8); }

        /* Rage Kill Effect */
        .rage-kill-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            width: 500px; z-index: 500; pointer-events: none; display: none;
            filter: drop-shadow(0 0 30px #ff9800);
        }
        @keyframes rageKillPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        .rage-kill-anim { display: block; animation: rageKillPop 2s forwards; }

        /* Poison Aura Effect */
        .poison-aura {
            box-shadow: 0 0 30px 10px rgba(155, 38, 182, 0.7) !important;
            border-color: #9b26b6 !important;
            transition: box-shadow 0.5s ease-in-out;
        }
        .poison-dmg {
            color: #9b26b6 !important;
            text-shadow: 0 0 10px #9b26b6 !important;
        }

        /* Cure Effect */
        .cure-effect {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 230, 118, 0.3);
            z-index: 10;
            display: none;
            animation: cureFlash 1s forwards;
        }
        @keyframes cureFlash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Weather UI in Battle */
        #weather-info {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 5px 15px;
            border-radius: 20px; display: flex; align-items: center; gap: 8px;
            font-family: var(--font-ui); font-size: 0.8rem; color: #fff; z-index: 100;
        }

        /* Rage Mode Visuals */
        .rage-ready-overlay {
            box-shadow: inset 0 0 60px 30px rgba(255, 50, 0, 0.4);
            animation: rageScreenPulse 1s infinite alternate;
            border: 2px solid rgba(255, 50, 0, 0.6);
        }
        @keyframes rageScreenPulse {
            from { box-shadow: inset 0 0 60px 30px rgba(255, 50, 0, 0.3); }
            to { box-shadow: inset 0 0 100px 50px rgba(255, 50, 0, 0.6); }
        }

        .rage-active-aura {
            box-shadow: 0 0 40px 15px #ff3d00 !important;
            border-color: #ff3d00 !important;
            filter: sepia(1) saturate(5) hue-rotate(-50deg) !important;
            animation: rageShake 0.2s infinite;
            z-index: 50;
        }
        @keyframes rageShake {
            0% { transform: translate(0, 0) scale(1.1); }
            25% { transform: translate(-3px, 3px) scale(1.1); }
            50% { transform: translate(3px, -3px) scale(1.1); }
            75% { transform: translate(-3px, -3px) scale(1.1); }
            100% { transform: translate(0, 0) scale(1.1); }
        }

        /* Double Attack Effect */
        .double-attack-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.5);
            z-index: 60;
            animation: doubleFlash 0.2s ease-out;
            pointer-events: none;
        }
        @keyframes doubleFlash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .double-attack-text {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-combat); font-size: 4rem; color: #fff;
            text-shadow: 0 0 20px #00e676, 0 0 40px #00e676;
            z-index: 250; pointer-events: none;
            animation: doubleTextPop 1s ease-out forwards;
        }
        @keyframes doubleTextPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(1.5); }
        }

        /* --- [ì‹ ê·œ] ì§ì—…ë³„ ë°©ì–´ ì´í™íŠ¸ ìŠ¤íƒ€ì¼ --- */

        /* ê³µí†µ ê¸°ë°˜ ìŠ¤íƒ€ì¼ */
        .defense-aura {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 200px;
            pointer-events: none; z-index: 15; display: none;
            border-radius: 50%;
        }

        /* 1. ì „ì‚¬ ê³„ì—´: ì•„ì´ì–¸ ì‹¤ë“œ (ë‹¨ë‹¨í•œ ê¸ˆë¹›/ê°•ì²  ë°©íŒ¨ ëŠë‚Œ) */
        .def-warrior {
            background: radial-gradient(circle, transparent 40%, rgba(255, 215, 0, 0.1) 60%, rgba(255, 215, 0, 0.4) 100%);
            border: 4px solid #ffd700;
            box-shadow: 0 0 20px #ffd700, inset 0 0 20px #b8860b;
            animation: shieldPulse 1.5s infinite alternate;
        }
        @keyframes shieldPulse {
            0% { transform: translate(-50%, -50%) scale(0.95); box-shadow: 0 0 15px #ffd700; opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 0 30px #ffd700; opacity: 1; }
        }

        /* 2. ë„ì  ê³„ì—´: ì—°ë§‰/ê·¸ë¦¼ì (íšŒí”¼, ì€ì‹  ëŠë‚Œ) */
        .def-rogue {
            background: radial-gradient(circle, rgba(0,0,0,0.5) 0%, transparent 70%);
            box-shadow: 0 0 40px 20px rgba(0, 0, 0, 0.8);
            border: none;
            filter: blur(5px);
            animation: smokeMove 2s infinite linear;
        }
        @keyframes smokeMove {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(180deg); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 0.6; }
        }

        /* 3. ë§ˆë²•ì‚¬ ê³„ì—´: ë§ˆë‚˜ ë°°ë¦¬ì–´ (ì‹ ë¹„ë¡œìš´ ìœ¡ê°í˜•/ì›í˜• ê²°ê³„) */
        .def-mage {
            background: rgba(41, 121, 255, 0.1);
            border: 2px dashed #00e5ff;
            box-shadow: 0 0 20px #2979ff, inset 0 0 30px #2979ff;
            animation: barrierRotate 3s infinite linear;
        }
        @keyframes barrierRotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); border-color: #00e5ff; }
            50% { border-color: #2979ff; opacity: 0.8; }
            100% { transform: translate(-50%, -50%) rotate(360deg); border-color: #00e5ff; }
        }

        /* 4. ê¶ìˆ˜ ê³„ì—´: ë°”ëŒì˜ ì¥ë§‰/ì§‘ì¤‘ (ì´ˆë¡ë¹› ë°”ëŒ ëŠë‚Œ) */
        .def-archer {
            background: transparent;
            border-top: 4px solid #00e676;
            border-bottom: 4px solid #00e676;
            border-radius: 50%;
            box-shadow: 0 0 25px #00e676;
            animation: windSpin 1s infinite ease-in-out;
        }
        @keyframes windSpin {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(180deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 0.7; }
        }

        /* [ì‹ ê·œ] í¬ë¦¬í‹°ì»¬ íˆíŠ¸ ì´í™íŠ¸ ìŠ¤íƒ€ì¼ */
        .crit-effect-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            width: 180px;
            z-index: 500;
            pointer-events: none;
            animation: critPop 0.6s ease-out forwards;
        }

        @keyframes critPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.0); }
        }

        /* [ì‹ ê·œ] ìŠ¤ì½”ì–´ ê³„ì‚° ì¤‘ ì˜¤ë²„ë ˆì´ */
        #score-calculating-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .calc-text {
            font-family: var(--font-combat); font-size: 2.5rem; color: var(--accent-gold);
            margin-top: 20px; letter-spacing: 3px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="weather-info">
            <span id="weather-icon">â˜€ï¸</span>
            <span id="weather-text">ë§‘ìŒ</span>
        </div>

        <img id="drop-item-img" class="drop-item-effect" src="" style="display:none;">
        <img id="rage-kill-img" class="rage-kill-effect" src="image/damage_kill.jpg">

        <div id="loading-overlay"><div class="spinner"></div><h2 id="loading-text" style="color:var(--accent-red); font-family:var(--font-eng);">BATTLE START</h2></div>
        
        <!-- ìŠ¤ì½”ì–´ ê³„ì‚° ì¤‘ ì˜¤ë²„ë ˆì´ ì¶”ê°€ -->
        <div id="score-calculating-overlay">
            <div class="spinner"></div>
            <div class="calc-text">ìŠ¤ì½”ì–´ ê³„ì‚° ì¤‘...</div>
        </div>

        <div id="result-modal" class="modal-overlay">
            <div class="modal-title">ì „íˆ¬ ìŠ¹ë¦¬!</div>
            <div id="result-content" class="result-content"></div>
            <button class="btn-confirm" onclick="checkLevelUpOrFinish()">í™•ì¸</button>
        </div>

        <div id="levelup-modal" class="modal-overlay">
            <div class="modal-title" style="color:#00e676; border-color:#00e676;">ë ˆë²¨ ì—…!</div>
            <div class="lv-grid">
                <div class="lv-stat"><div class="stat-name">LEVEL</div><div class="stat-change"><span id="old-lv">1</span> â–· <span id="new-lv" style="color:var(--accent-gold)">2</span></div></div>
                <div class="lv-stat"><div class="stat-name">MAX HP</div><div class="stat-change" id="stat-hp"></div></div>
                <div class="lv-stat"><div class="stat-name">MAX MP</div><div class="stat-change" id="stat-mp"></div></div>
            </div>
            <button id="lv-confirm-btn" class="btn-confirm" onclick="finishBattleWithLevelUp()" style="background:#00e676;">íŠ¹ì„± ë¶„ë°°í•˜ëŸ¬ ê°€ê¸°</button>
        </div>

        <div id="item-modal" class="modal-overlay">
            <div class="modal-title" style="color:#4caf50; border-color:#4caf50; font-size: 2rem;">ì•„ì´í…œ ì„ íƒ</div>
            <div id="item-list" class="item-list"></div>
            <button class="btn-confirm" onclick="closeItemModal()" style="background:#555; margin-top:20px;">ë‹«ê¸°</button>
        </div>

        <div id="effect-modal" class="modal-overlay">
            <div class="modal-title" id="effect-title" style="font-size: 2rem;">íš¨ê³¼ ë°œë™</div>
            <img id="effect-img" src="" style="width:100px; height:100px; border-radius:10px; margin:20px 0; box-shadow:0 0 20px var(--accent-gold);">
            <div id="effect-desc" class="result-content" style="font-size:1.2rem; white-space: pre-line;"></div>
            <button class="btn-confirm" onclick="closeEffectModal()">í™•ì¸</button>
        </div>

        <div id="gameover-modal" class="modal-overlay">
            <div class="gameover-title">íŒ¨ë°°</div>
            <div id="go-stats-container" class="gameover-stats">
                <!-- ìƒì„¸ ì ìˆ˜ ë‚´ì—­ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            </div>
            <div class="go-score">ìµœì¢… ì ìˆ˜: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            <button class="btn-confirm" style="width:100%; margin-top: 20px;" onclick="location.href='index.html'">ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
        </div>

        <div class="battle-stage">
            <div class="unit-box">
                <div id="p-speech" class="speech"></div>
                <div id="player-frame" class="unit-frame" style="border-color:#2979ff;">
                    <div id="p-cure" class="cure-effect"></div>
                    <div id="p-defense-aura" class="defense-aura"></div>
                    <img id="p-img" class="unit-img">
                    <img id="atk-warrior" src="image/warrior_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-rogue" src="image/rogue_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-mage" src="image/mage_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-archer" src="image/archer_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-archer1" src="image/archer_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-warrior-double" src="image/warrior_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-rogue-double" src="image/rogue_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-mage-double" src="image/mage_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-archer-double" src="image/archer_attack2.jpg" class="unit-img" style="display:none;">
                    <img id="atk-ranger-double" src="image/ranger_attack.jpg" class="unit-img" style="display:none;">
                    <img id="hit-warrior" src="image/warrior_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-rogue" src="image/rogue_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-mage" src="image/mage_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-archer" src="image/archer_hit.jpg" class="unit-img" style="display:none;">
                    <img id="crit-warrior" src="image/critical_warrior.jpg" class="unit-img" style="display:none;">
                    <img id="crit-rogue" src="image/critical_rogue.jpg" class="unit-img" style="display:none;">
                    <img id="crit-mage" src="image/critical_mage.jpg" class="unit-img" style="display:none;">
                    <img id="crit-archer" src="image/archer_critical.jpg" class="unit-img" style="display:none;">
                    <img id="crit-archer-advanced" src="image/critical_archer.jpg" class="unit-img" style="display:none;">
                    <img id="crit-warrior1" src="image/warrior_critical.jpg" class="unit-img" style="display:none;">
                    <img id="crit-rogue1" src="image/rogue_critical.jpg" class="unit-img" style="display:none;">
                    <img id="crit-mage1" src="image/mage_critical.jpg" class="unit-img" style="display:none;">
                    <img id="eva-warrior" src="image/warrior_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-rogue" src="image/rogue_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-mage" src="image/mage_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="evasion-archer" src="image/archer_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-warrior1" src="image/warrior3.jpg" class="unit-img" style="display:none;">
                    <img id="eva-rogue1" src="image/rogue3.jpg" class="unit-img" style="display:none;">
                    <img id="eva-mage1" src="image/mage3.jpg" class="unit-img" style="display:none;">
                    <img id="eva-archer1" src="image/archer3.jpg" class="unit-img" style="display:none;">
                    <video id="v-warrior" src="image/warrior_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-rogue" src="image/rogue_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage" src="image/mage_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-archer" src="image/v-archer.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-warrior1" src="image/warrior_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage1" src="image/mage_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-rogue1" src="image/rogue_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-archer1" src="image/v-archer1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-archer2" src="image/v-archer2.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-archer3" src="image/v-archer3.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage2" src="image/mage_atk2.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-warrior2" src="image/warrior_atk2.mp4" class="unit-img" style="display:none;"></video>
                </div>
                <div class="unit-info">
                    <h3 id="p-name" class="unit-name">í”Œë ˆì´ì–´</h3>
                    <div id="p-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div id="p-hp-bar-wrap" class="bar-wrap"><div id="p-hp-bar" class="bar-fill hp-bar"></div><span id="p-hp-text" class="bar-text"></span></div>
                        <div id="p-mp-bar-wrap" class="bar-wrap"><div id="p-mp-bar" class="bar-fill mp-bar"></div><span id="p-mp-text" class="bar-text"></span></div>
                        <div id="p-rage-bar-wrap" class="bar-wrap"><div id="p-rage-bar" class="bar-fill rage-bar"></div><span id="p-rage-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="vs-text">VS</div>
            
            <div class="unit-box">
                <div id="e-speech" class="speech"></div>
                <div id="enemy-frame" class="unit-frame" style="border-color:var(--danger);">
                    <img id="e-img" class="unit-img">
                </div>
                <div class="unit-info">
                    <h3 id="e-name" class="unit-name">ì  ì´ë¦„</h3>
                    <div id="e-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div class="bar-wrap"><div id="e-hp-bar" class="bar-fill hp-bar"></div><span id="e-hp-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="log" class="log-panel">ì „íˆ¬ê°€ ê³§ ì‹œì‘ë©ë‹ˆë‹¤...</div>
        
        <div class="btns">
            <button class="btn btn-atk" onclick="atk()">âš”ï¸ ê³µê²©</button>
            <button class="btn btn-def" onclick="def()">ğŸ›¡ï¸ ë°©ì–´</button>
            <button class="btn btn-skl" onclick="skl()">âš¡ ìŠ¤í‚¬</button>
            <button id="btn-special" class="btn btn-special" onclick="specialAtk()">ğŸŒŸ íŠ¹ìˆ˜ê¸°</button>
            <button class="btn btn-item" onclick="openItemModal()">ğŸ’Š ì•„ì´í…œ</button>
            <button class="btn btn-run" onclick="run()">ğŸƒ ë„ë§</button>
        </div>

        <button id="btn-rage" class="btn btn-rage" onclick="rageAtk()">ğŸ”¥ ë¶„ë…¸ ê³µê²©</button>
    </div>

    <script>
        const DB_URL = "https://script.google.com/macros/s/AKfycbwvbEnc9OXDrh80QO_kVn9z3YtmXOLgtNcEd4jksEQ7CLtmgvpiXf0WbiSPwUHgkeIAWQ/exec";
        
        const attackSfx = new Audio('song/attack.mp3');
        const critSfx = new Audio('song/attack_1.mp3');
        const levelupSfx = new Audio('song/powerup.mp3');
        const itemSfx = new Audio('song/poka.mp3');
        const damageSfx = new Audio('song/damage1.mp3');
        const evadeSfx = new Audio('song/swish.mp3');
        const potionSfx = new Audio('song/potion-inght.wav');
        const goldSfx = new Audio('song/gold_drop-inght.wav');

        let bossBgm = null;

        const MAP_SETS = [
            { day: 'image/map.jpg', night: 'image/map1.jpg' },
            { day: 'image/map2.jpg', night: 'image/map3.jpg' },
            { day: 'image/map4.jpg', night: 'image/map5.jpg' },
            { day: 'image/map6.jpg', night: 'image/map7.jpg' }
        ];

        const DAY_ENEMY_POOL = [
            {f:'image/ka.jpg', n:'ë‚˜ë¬´ ëª¬ìŠ¤í„°', e:70, w:3, speech: ['ìš°ì›Œì–´!', 'ìì—°ì˜ í˜ì„ ë³´ì—¬ì£¼ë§ˆ!', 'ë‚´ ìì‚¬ê·€ëŠ” ë‚ ì¹´ë¡­ë‹¤!']},
            {f:'image/ka2.jpg', n:'ë¦¬ë˜', e:50, w:3, speech: ['í‚¤í‚¤í‚¥!', 'ë‚´ ë³´ë¬¼ ë‚´ë†”!', 'ë¹ ë¥´ì§€? ëª» ì¡ì„ê±¸!']},
            {f:'image/ka3.jpg', n:'í† ë¼ì‚¬ëƒ¥ê¾¼ ìš”ì¹˜', e:30, w:4, speech: ['ê¹¡ì´!', 'ë‹¹ê·¼ ë‚´ë†”!', 'ê·€ì—½ë‹¤ê³  ì–•ë³´ì§€ ë§ˆë¼!']},
            {f:'image/ka4.jpg', n:'ê³°ì „ì‚¬ ì¶”íŒŒ', e:120, w:2, type: 'bear_warrior', speech: ['í¬ì•„ì•™!', 'í˜ ëŒ€ê²°ì´ë‹¤!', 'ë‚´ ë°œí†±ì€ ê°•ì² ë³´ë‹¤ ë‹¨ë‹¨í•´!']},
            {f:'image/ke1.jpg', n:'ì—˜ë¦¬íŠ¸ ë‚˜ë¬´ ë³‘ì‚¬', e:100, w:1, mult: 1.2, speech: ['ìˆ²ì„ ì§€í‚¨ë‹¤!', 'ì¹¨ì…ì ë°œê²¬!', 'ë‹¨ë‹¨í•œ ê»ì§ˆì„ ëš«ì–´ë´ë¼!']}
        ];
        const NIGHT_ENEMY_POOL = [
            {f:'image/monster1.jpg', n:'ë¸”ë£¨ë¨¸ì‰¬ ê°€ë””ì–¸ (Bluemush Guardian)', e:150, w:3, poison: true, speech: ['í¬ìê°€ í¼ì§„ë‹¤...', 'ì–´ë‘  ì†ìœ¼ë¡œ...', 'ë…ì„ ë§›ë´ë¼!']},
            {f:'image/monster2.jpg', n:'ê·¸ë¡œìš¸ íŠ¸ë ŒíŠ¸ (Growl Trent)', e:180, w:3, speech: ['ê·¸ë¥´ë¥´...', 'ë°¤ì˜ ìˆ²ì€ ìœ„í—˜í•´...', 'ë¿Œë¦¬ë¡œ ë¬¶ì–´ì£¼ë§ˆ!']},
            {f:'image/monster3.jpg', n:'ìœ„ìŠ¤í”„ ëœí„´ (Wisp Lantern)', e:120, w:4, poison: true, speech: ['ë°˜ì§ë°˜ì§...', 'ê¸¸ì„ ìƒê²Œ í•´ì£¼ì§€...', 'ì˜í˜¼ì„ ë‚´ë†”!']},
            {f:'image/ke3.jpg', n:'ë§ˆë²•ì‚¬ í™€ë¦¬', e:200, w:2, type: 'mage_holly', speech: ['ë§ˆë²•ì˜ í˜ìœ¼ë¡œ!', 'ì‹ ì„±í•œ ë¹›ì„ ë°›ì•„ë¼!', 'ì–´ë‘ ì„ ì •í™”í•˜ë¦¬ë¼!']},
            {f:'image/ke2.jpg', n:'ì‹¬ì—°ì˜ ê°ì‹œì', e:250, w:1, mult: 1.3, speech: ['ì‹¬ì—°ì„ ë“¤ì—¬ë‹¤ë³´ì§€ ë§ˆë¼...', 'ì–´ë‘ ì´ ë„ˆë¥¼ ì‚¼í‚¬ ê²ƒì´ë‹¤...', 'ê³µí¬ë¥¼ ëŠê»´ë¼!']}
        ];
        
        const WEAPON_IMAGES = {
            'ì „ì‚¬': 'weapon_warrior.jpg', 'ë„ì ': 'weapon_rogue.jpg', 'ë§ˆë²•ì‚¬': 'weapon_mage.jpg', 'ì—˜í”„ ê¶ìˆ˜': 'weapon_archer.jpg',
            'ë²„ì„œì»¤': 'weapon_warrior.jpg', 'ê°€ë””ì–¸': 'weapon_warrior.jpg',
            'ì–´ìŒ”ì‹ ': 'weapon_rogue.jpg', 'ì„€ë„ìš°': 'weapon_rogue.jpg',
            'ì•„í¬ë©”ì´ì§€': 'weapon_mage.jpg', 'ì†Œì„œëŸ¬': 'weapon_mage.jpg',
            'ìŠ¤ë‚˜ì´í¼': 'weapon_archer.jpg', 'ë ˆì¸ì €': 'weapon_archer.jpg'
        };
        const ITEM_IMAGES = {
            'hp_potion': 'potion_hp.jpg', 'potion_hp': 'potion_hp.jpg',
            'mp_potion': 'potion_mp.jpg', 'potion_mp': 'potion_mp.jpg',
            'poison_potion': 'potion_poison.jpg', 'potion_poison': 'potion_poison.jpg',
            'exp_potion': 'potion_exp.jpg', 'potion_exp': 'potion_exp.jpg',
            'gold': 'coin_gold.jpg',
            'potion_atk': 'attack_10.jpg',
            'potion_def': 'Defense_10.jpg',
            'scroll_option': 'Scroll.jpg',
            'potion_skeleton': 'potion_skeleton.jpg',
            'potion_invis': 'potion_invis.jpg',
            'potion_gamble': 'potion_gamble.jpg',
            'potion_focus': 'potion_focus.jpg',
            'potion_holy': 'potion_holy.jpg',
            'potion_madness': 'potion_madness.jpg',
            'potion_full': 'potion_full.jpg'
        };
        
        const DROP_TABLE = {
            'ì „ì‚¬': ['ê¸°ì‚¬ì˜ ê²€', 'ëŒ€ê²€', 'ìš©ì‚¬ì˜ ê²€', 'ì‹¬íŒì˜ ë„ë¼'],
            'ë„ì ': ['ì•”ì‚´ìì˜ ë‹¨ë„', 'ìŒê²€', 'ê·¸ë¦¼ì ë¹„ìˆ˜'],
            'ë§ˆë²•ì‚¬': ['ë§ˆë²• ì§€íŒ¡ì´', 'ì˜¤ë¸Œ', 'í˜„ìì˜ ìŠ¤íƒœí”„'],
            'ì—˜í”„ ê¶ìˆ˜': ['ì—°ìŠµìš© ëª©ê¶', 'ì»´í¬ì§€íŠ¸ ë³´ìš°', 'ìœˆë“œëŸ°ë„ˆ'],
            'ë²„ì„œì»¤': ['ê´‘ì „ì‚¬ì˜ ë„ë¼', 'í”¼ì˜ ê²€'],
            'ê°€ë””ì–¸': ['ìˆ˜í˜¸ìì˜ ë°©íŒ¨ê²€', 'ì„±ê¸°ì‚¬ì˜ ë§ì¹˜'],
            'ì–´ìŒ”ì‹ ': ['ì£½ìŒì˜ ì¸ë„ì', 'ê·¸ë¦¼ì ì†¡ê³³ë‹ˆ'],
            'ì„€ë„ìš°': ['ê³µí¬ì˜ ë¹„ìˆ˜', 'ì‹¬ì—°ì˜ ì¹¼ë‚ '],
            'ì•„í¬ë©”ì´ì§€': ['ëŒ€ë§ˆë²•ì‚¬ì˜ ì§€íŒ¡ì´', 'ë³„ì˜ ì¡°ê°'],
            'ì†Œì„œëŸ¬': ['ì›ì†Œì˜ ê·¼ì›', 'ë§ˆë‚˜ì˜ ëˆˆ'],
            'ìŠ¤ë‚˜ì´í¼': ['ì €ê²©ìˆ˜ì˜ í™œ', 'ì •ë ¹ì˜ í™œ'],
            'ë ˆì¸ì €': ['í­í’ì˜ í™œ', 'ìì—°ì˜ í™œ']
        };

        const LEGENDARY_SPECIAL_OPTIONS = [
            { name: "í”¼ì˜ ê°ˆì¦", desc: "ê³µê²© ì‹œ 10% í™•ë¥ ë¡œ í”¼í•´ëŸ‰ì˜ 20% HP í¡ìˆ˜", key: "l_vamp", val: 20 },
            { name: "ë§ˆë‚˜ì˜ ìƒ˜", desc: "ê³µê²© ì‹œ 10% í™•ë¥ ë¡œ ìµœëŒ€ MPì˜ 10% íšŒë³µ", key: "l_mana", val: 10 },
            { name: "ê°€ë²¼ìš´ ë°œê±¸ìŒ", desc: "íšŒí”¼ìœ¨ +10%", key: "l_eva", val: 10 },
            { name: "ê°•ì²  í”¼ë¶€", desc: "ë°›ëŠ” í”¼í•´ëŸ‰ -10%", key: "l_def", val: 10 },
            { name: "ì•½ì  ê°„íŒŒ", desc: "ì¹˜ëª…íƒ€ í”¼í•´ëŸ‰ +25%", key: "l_crit_dmg", val: 25 },
            { name: "ê³¨ë“œ ëŸ¬ì‹œ", desc: "ê³¨ë“œ íšë“ëŸ‰ +30%", key: "l_gold", val: 30 },
            { name: "ì„±ì¥ì˜ ê°€ì†", desc: "ê²½í—˜ì¹˜ íšë“ëŸ‰ +20%", key: "l_exp", val: 20 },
            { name: "êµ³ê±´í•œ ì˜ì§€", desc: "ìƒíƒœì´ìƒ ì €í•­ +30%", key: "l_resist", val: 30 },
            { name: "ë¶„ë…¸ ì¡°ì ˆ", desc: "ë¶„ë…¸ íšë“ëŸ‰ +20%", key: "l_rage", val: 20 },
            { name: "ì¬ë¹ ë¥¸ ì†ë†€ë¦¼", desc: "ì•„ì´í…œ íšë“ ì‹œ 5% í™•ë¥ ë¡œ 2ë°° íšë“", key: "l_double_drop", val: 5 }
        ];

        const ENEMY_ATTACK_IMAGES = {
            'image/best_boss.jpg': 'image/best_boss_1.jpg',
            'image/ka.jpg': 'image/ka_1.jpg',
            'image/ka1.jpg': 'image/ka1_1.jpg',
            'image/ke2.jpg': 'image/ke2_1.jpg',
            'image/ke3.jpg': 'image/ke3_1.jpg',
            'image/monster_boss.jpg': 'image/monster_boss_1.jpg',
            'image/monster1.jpg': 'image/monster1_1.jpg',
            'image/monster2.jpg': 'image/monster2_1.jpg',
            'image/monster3.jpg': 'image/monster3_1.jpg',
            'image/ka4.jpg': 'image/ka4_1.jpg',
            'image/ke1.jpg': 'image/ke1_1.jpg',
            'image/ka2.jpg': 'image/ka2_1.jpg',
            'image/ka3.jpg': 'image/ka3_1.jpg'
        };

        let player, enemy, isActing = false;
        let isBossBattle = false;
        let isSuperBoss = false;
        let currentWeather = "sunny";
        let isLegendary = false;

        let pStatus = { poison: 0, stun: 0, defUp: 0, focus: 0, atkUp: 0, invincible: 0, nextSkillTriple: 0, zeroMana: 0, invis: 0, skillDmgUp: 0, critUp: 0, nextSkillZeroCost: 0, doubleAttackChance: 0, windAttribute: 0, atkUpRanger: 0, evasionUp: 0, counterReady: false, evasionBoost: 0, aiming: 0 };
        let eStatus = { poison: 0, stun: 0 };
        let rage = 0;
        const maxRage = 100;
        let mageAttackToggle = false;
        let specialCooldown = 0;
        const SPECIAL_COOLDOWN_MAX = 10;
        let doubleAttackCooldown = 0;

        window.onload = async () => {
            const name = localStorage.getItem('rpg_player_name');
            const temp = localStorage.getItem('rpg_temp_player');
            try {
                if (temp && temp !== "undefined") { player = JSON.parse(temp); if (!player || !player.job) throw new Error("Err"); init(); } 
                else if (name) {
                    const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                    player = await res.json(); if(player.error) throw new Error("Hero not found"); init();
                } else { throw new Error("No data"); }
            } catch (e) { alert("ë°ì´í„° ì˜¤ë¥˜. ë§µìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤."); localStorage.removeItem('rpg_temp_player'); location.href = 'map.html'; }
        };

        function init() {
            if(!player.inventory) player.inventory = [];
            if(!player.bonusAtk) player.bonusAtk = 0;
            if(!player.bonusDef) player.bonusDef = 0;
            if(player.gold === undefined) player.gold = 0;
            if(player.coinScore === undefined) player.coinScore = 0;
            if(player.rage === undefined) player.rage = 0;
            rage = player.rage;
            currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

            pStatus = { poison: 0, stun: 0, defUp: 0, focus: 0, atkUp: 0, invincible: 0, nextSkillTriple: 0, zeroMana: 0, invis: 0, skillDmgUp: 0, critUp: 0, nextSkillZeroCost: 0, doubleAttackChance: 0, windAttribute: 0, atkUpRanger: 0, evasionUp: 0, counterReady: false, evasionBoost: 0, aiming: 0 };
            doubleAttackCooldown = 0;

            if (player.specialCooldown > 0) {
                player.specialCooldown--;
            }
            specialCooldown = player.specialCooldown || 0;
            updateSpecialTooltip();
            updateSkillTooltip();
            updateDefenseTooltip();

            if (player.battleCurse) {
                pStatus.stun = 1;
                pStatus.poison = 1;
                addLog("<span style='color:#9b26b6; font-weight:bold;'>â˜ ï¸ í•´ê³¨ í¬ì…˜ì˜ ì €ì£¼ê°€ ë°œë™í–ˆìŠµë‹ˆë‹¤! (ê¸°ì ˆ/ì¤‘ë…)</span>");
                delete player.battleCurse;
            }

            if(!player.quests) player.quests = {
                killCount: 0,
                dayKillCount: 0,
                nightKillCount: 0,
                bossKillCount: 0,
                superBossKillCount: 0,
                enhanceCount: 0,
                claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
            };
            if (player.quests.superBossKillCount === undefined) player.quests.superBossKillCount = 0;

            const jM = {
                'ì „ì‚¬': 'warrior', 'ë„ì ': 'rogue', 'ë§ˆë²•ì‚¬': 'mage', 'ì—˜í”„ ê¶ìˆ˜': 'archer',
                'ë²„ì„œì»¤': 'warrior1', 'ê°€ë””ì–¸': 'warrior1',
                'ì–´ìŒ”ì‹ ': 'rogue1', 'ì„€ë„ìš°': 'rogue1',
                'ì•„í¬ë©”ì´ì§€': 'mage1', 'ì†Œì„œëŸ¬': 'mage1',
                'ìŠ¤ë‚˜ì´í¼': 'archer1', 'ë ˆì¸ì €': 'archer1'
            };

            let pImgSrc = `image/${jM[player.job] || 'warrior'}.jpg`;

            const weapon = player.inventory.find(i => i.type === 'weapon' && i.equipped);
            if (weapon && weapon.rarity === 'legendary') {
                isLegendary = true;
                const j = player.job;
                if (j === 'ì „ì‚¬' || j === 'ë²„ì„œì»¤' || j === 'ê°€ë””ì–¸') pImgSrc = 'image/warrior4.jpg';
                else if (j === 'ë„ì ' || j === 'ì–´ìŒ”ì‹ ' || j === 'ì„€ë„ìš°') pImgSrc = 'image/rogue4.jpg';
                else if (j === 'ë§ˆë²•ì‚¬' || j === 'ì•„í¬ë©”ì´ì§€' || j === 'ì†Œì„œëŸ¬') pImgSrc = 'image/mage4.jpg';
                else if (j === 'ì—˜í”„ ê¶ìˆ˜' || j === 'ìŠ¤ë‚˜ì´í¼' || j === 'ë ˆì¸ì €') pImgSrc = 'image/archer4.jpg';
            } else if (player.isAdvanced) {
                // ì „ì§ ìƒíƒœì´ì§€ë§Œ ë ˆì „ë“œ ë¬´ê¸°ê°€ ì—†ëŠ” ê²½ìš° ì „ì§ ì´ë¯¸ì§€ ì‚¬ìš©
                const j = player.job;
                if (j === 'ë²„ì„œì»¤' || j === 'ê°€ë””ì–¸') pImgSrc = 'image/warrior1.jpg';
                else if (j === 'ì–´ìŒ”ì‹ ' || j === 'ì„€ë„ìš°') pImgSrc = 'image/rogue1.jpg';
                else if (j === 'ì•„í¬ë©”ì´ì§€' || j === 'ì†Œì„œëŸ¬') pImgSrc = 'image/mage1.jpg';
                else if (j === 'ìŠ¤ë‚˜ì´í¼' || j === 'ë ˆì¸ì €') pImgSrc = 'image/archer1.jpg';
            }

            document.getElementById('p-img').src = pImgSrc;
            document.getElementById('p-name').innerText = player.name;
            
            const isBossFlag = localStorage.getItem('rpg_boss_encounter');
            const isSuperBossFlag = localStorage.getItem('rpg_is_super_boss');
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            // Background update based on map set and time
            const mapSetIndex = parseInt(localStorage.getItem('rpg_map_set_index') || 0);
            const currentSet = MAP_SETS[mapSetIndex];
            const bgImg = isNight ? currentSet.night : currentSet.day;
            document.getElementById('game-container').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('${bgImg}')`;

            if (isSuperBossFlag === 'true') {
                isBossBattle = true;
                isSuperBoss = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 1500);
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 1500);
                enemy = { name: 'ì´ˆê°•ë ¥ ë³´ìŠ¤ (Ancient Overlord)', hp: bossHp, maxHp: bossMaxHp, atk: 30 + (player.level * 3), exp: 10000, img: 'image/best_boss.jpg', speech: ['ê°íˆ ë‚´ê²Œ ë„ì „í•˜ë‹¤ë‹ˆ!', 'ì§„ì •í•œ í˜ì„ ë³´ì—¬ì£¼ë§ˆ!', 'ì ˆë§í•˜ë¼!'] };
                localStorage.removeItem('rpg_is_super_boss');
                playBossBgm('song/best_boss_bgm.mp3');
            } else if (isBossFlag === 'true') {
                isBossBattle = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 400 + (player.level * 30));
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 400 + (player.level * 30));
                let bossAtk = 15 + (player.level * 2);

                if (isNight) {
                    const nHp = Math.floor(bossHp * 1.5);
                    const nMaxHp = Math.floor(bossMaxHp * 1.5);
                    const nAtk = Math.floor(bossAtk * 1.2);
                    enemy = { name: 'ì‹¬ì—°ì˜ êµ°ì£¼', hp: nHp, maxHp: nMaxHp, atk: nAtk, exp: 5000, img: 'image/monster_boss.jpg', isNightBoss: true, speech: ['ì–´ë‘ ì´ ë„ˆë¥¼ ì‚¼í‚¬ ê²ƒì´ë‹¤!', 'ì‹¬ì—°ì˜ ê³µí¬ë¥¼ ëŠê»´ë¼!', 'ë¹›ì€ ì—†ë‹¤!'] };
                    playBossBgm('song/monster_boss_bgm1.mp3');
                } else {
                    enemy = { name: 'ê°•í™”ëœ ë³´ìŠ¤ ë‚˜ë¬´', hp: bossHp, maxHp: bossMaxHp, atk: bossAtk, exp: 2000, img: 'image/ka1.jpg', speech: ['ìˆ²ì˜ ë¶„ë…¸ë¥¼ ëŠê»´ë¼!', 'ë‚´ ë¿Œë¦¬ëŠ” ê¹Šë‹¤!', 'ìì—°ìœ¼ë¡œ ëŒì•„ê°€ë¼!'] };
                    playBossBgm('song/monster_boss_bgm.mp3');
                }
                localStorage.removeItem('rpg_boss_encounter'); 
            } else {
                isBossBattle = false;
                const pool = isNight ? NIGHT_ENEMY_POOL : DAY_ENEMY_POOL;
                let tW = pool.reduce((s, e) => s + e.w, 0);
                let r = Math.random() * tW; let sel = pool[0];
                for (let e of pool) { if (r < e.w) { sel = e; break; } r -= e.w; }

                const avg = (player.stats.str + player.stats.int) / 2 + (player.level * 3);
                const multiplier = sel.mult || 1.0;
                enemy = {
                    name: sel.n,
                    hp: Math.floor(avg * 2.8 * multiplier) + 15,
                    maxHp: Math.floor(avg * 2.8 * multiplier) + 15,
                    atk: Math.floor((avg/2.0) * multiplier) + 4,
                    exp: sel.e,
                    img: sel.f,
                    canPoison: sel.poison || false,
                    type: sel.type || 'normal',
                    speech: sel.speech || ['í¬ë¥´ë¥´...', 'ê³µê²©í•œë‹¤!', 'ë¨¹ì‡ê°ì´ë‹¤!']
                };
            }
            
            document.getElementById('e-img').src = enemy.img;
            document.getElementById('e-name').innerText = enemy.name;
            if(isBossBattle) {
                document.getElementById('e-name').style.color = "#ff1744";
                document.getElementById('e-name').innerText = "ğŸ’€ " + enemy.name;
            }
            
            updateWeatherUI();
            addLog(`<span class='log-highlight'>[${enemy.name}]</span>ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
            document.getElementById('loading-overlay').style.display = 'none';
            say('p', getStartSpeech(player.job));
            update(); // Call update here to display initial HP/MP/Rage
        }

        function getStartSpeech(job) {
            const speeches = {
                'ì „ì‚¬': ['ì „íˆ¬ ì¤€ë¹„ ì™„ë£Œ!', 'ë‚˜ì˜ ê²€ì„ ë°›ì•„ë¼!', 'ëª…ì˜ˆë¡œìš´ ì „íˆ¬ë¥¼!'],
                'ë„ì ': ['ì¡°ìš©íˆ ì²˜ë¦¬í•´ì£¼ì§€.', 'ë‚´ ì†ë„ë¥¼ ë”°ë¼ì˜¬ ìˆ˜ ìˆì„ê¹Œ?', 'ë¹ˆí‹ˆì´ ë³´ì´ëŠ”êµ°.'],
                'ë§ˆë²•ì‚¬': ['ë§ˆë²•ì˜ í˜ì„ ë³´ì—¬ì£¼ë§ˆ!', 'ì§€ì‹ì€ í˜ì´ë‹¤!', 'ì›ì†Œë“¤ì´ì—¬, ë‚˜ë¥¼ ë”°ë¥´ë¼!'],
                'ì—˜í”„ ê¶ìˆ˜': ['ì •ë ¹ì˜ í™œì‹œìœ„ë¥¼ ë‹¹ê²¨ë¼!', 'ë°”ëŒì´ ë‚´ í™”ì‚´ì„ ì¸ë„í•œë‹¤!', 'ìˆ¨í†µì„ ëŠì–´ì£¼ë§ˆ!'],
                'ë²„ì„œì»¤': ['í”¼ê°€ ë“ì–´ì˜¤ë¥¸ë‹¤!', 'ë‹¤ ë¶€ìˆ´ë²„ë¦¬ê² ì–´!', 'í¬ì•„ì•„ì•„!'],
                'ê°€ë””ì–¸': ['ë‚´ê°€ ëª¨ë‘ë¥¼ ì§€í‚¤ê² ë‹¤!', 'ë°©íŒ¨ëŠ” ëš«ë¦¬ì§€ ì•ŠëŠ”ë‹¤!', 'ì‹ ì„±í•œ í˜ìœ¼ë¡œ!'],
                'ì–´ìŒ”ì‹ ': ['ê·¸ë¦¼ì ì†ì— ìˆ¨ì–´...', 'ì£½ìŒì€ ì¡°ìš©íˆ ì°¾ì•„ì˜¤ì§€.', 'ì´ë¯¸ ë„Œ ì£½ì–´ìˆë‹¤.'],
                'ì„€ë„ìš°': ['ì–´ë‘ ì´ ë„ˆë¥¼ ë®ì¹  ê²ƒì´ë‹¤.', 'ë…ì´ í¼ì§€ëŠ”êµ°...', 'ê³µí¬ë¥¼ ëŠê»´ë´ë¼.'],
                'ì•„í¬ë©”ì´ì§€': ['ê¶ê·¹ì˜ ë§ˆë²•ì„ ë³´ì—¬ì£¼ì§€!', 'ë§ˆë‚˜ì˜ íë¦„ì´ ëŠê»´ì§„ë‹¤.', 'íŒŒë©¸ì˜ ì£¼ë¬¸ì„ ì™¸ìš°ë§ˆ!'],
                'ì†Œì„œëŸ¬': ['ì›ì†Œì˜ í­í’ì´ì—¬!', 'ë§ˆë²•ì€ ì˜ˆìˆ ì´ë‹¤!', 'ì¬ë¡œ ë§Œë“¤ì–´ì£¼ì§€.'],
                'ìŠ¤ë‚˜ì´í¼': ['ì‹¬ì¥ì„ ê¿°ëš«ì–´ì£¼ë§ˆ!', 'ë‹¨ í•œ ë°œë¡œ ëë‚¸ë‹¤!', 'ë‚´ ì‹œì•¼ì— ë“¤ì–´ì™”êµ°.'],
                'ë ˆì¸ì €': ['í­í’ì²˜ëŸ¼ ìŸì•„ì ¸ë¼!', 'í™”ì‚´ ë¹„ë¥¼ ë‚´ë ¤ì£¼ì§€!', 'ìì—°ì˜ ë¶„ë…¸ë¥¼ ëŠê»´ë¼!']
            };
            const list = speeches[job] || ['ì „íˆ¬ ì‹œì‘!'];
            return list[Math.floor(Math.random() * list.length)];
        }

        function getAttackSpeech(job) {
            const speeches = {
                'ì „ì‚¬': ['ë°›ì•„ë¼!', 'ê²€ì˜ ë§›ì„ ë´ë¼!', 'í•˜ì••!'],
                'ë„ì ': ['ì‰¿!', 'ë†“ì¹˜ì§€ ì•Šì•„!', 'ë¹ ë¥´ê²Œ!'],
                'ë§ˆë²•ì‚¬': ['ë¨¹ì–´ë¼!', 'ë§ˆë ¥íƒ„!', 'ê°€ë¼!'],
                'ì—˜í”„ ê¶ìˆ˜': ['ëª…ì¤‘!', 'ê¿°ëš«ì–´ë¼!', 'ìŠ‰!'],
                'ë²„ì„œì»¤': ['ìœ¼ë¼ì°¨ì°¨!', 'ë¶€ìˆ´ì ¸ë¼!', 'ì£½ì–´ë¼!'],
                'ê°€ë””ì–¸': ['ë¬¼ëŸ¬ì„œë¼!', 'ì‹¬íŒì´ë‹¤!', 'ê°•íƒ€!'],
                'ì–´ìŒ”ì‹ ': ['ì‚¬ë¼ì ¸ë¼.', 'ê¸‰ì†Œë‹¤.', 'ëì´ë‹¤.'],
                'ì„€ë„ìš°': ['ê³ í†µì„...', 'ë…ì´ì—¬...', 'ìŠ¤ë©°ë“ ë‹¤.'],
                'ì•„í¬ë©”ì´ì§€': ['íŒŒê´´í•˜ë¼!', 'ë§ˆë ¥ ë°©ì¶œ!', 'ì†Œë©¸í•´ë¼!'],
                'ì†Œì„œëŸ¬': ['íƒ€ì˜¬ë¼ë¼!', 'ì–¼ì–´ë¶™ì–´ë¼!', 'ì°¢ì–´ë°œê²¨ë¼!'],
                'ìŠ¤ë‚˜ì´í¼': ['ì‹¬ì¥ì„ ê¿°ëš«ì–´ì£¼ë§ˆ!'],
                'ë ˆì¸ì €': ['í­í’ì²˜ëŸ¼ ìŸì•„ì ¸ë¼!']
            };
            const list = speeches[job] || ['ê³µê²©!'];
            return Math.random() < 0.4 ? list[Math.floor(Math.random() * list.length)] : null;
        }

        function getSkillSpeech(job) {
             const speeches = {
                'ì „ì‚¬': ['ê°•ë ¥í•œ ì¼ê²©!', 'íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬!', 'ê²€ê¸° ë°œì‚°!'],
                'ë„ì ': ['ê¸‰ì†Œ ì°Œë¥´ê¸°!', 'ë°±ìŠ¤íƒ­!', 'ì¹˜ëª…íƒ€ë¥¼ ë…¸ë¦°ë‹¤!'],
                'ë§ˆë²•ì‚¬': ['íŒŒì´ì–´ë³¼!', 'ì•„ì´ìŠ¤ ìŠ¤í”¼ì–´!', 'ì¬ë” ë³¼íŠ¸!'],
                'ì—˜í”„ ê¶ìˆ˜': ['ë°”ëŒì˜ í™”ì‚´!', 'ë°”ëŒì´ì—¬, ì ì„ ë¬¶ì–´ë¼!', 'ì •ë ¹ì˜ ì†ì‚­ì„!'],
                'ë²„ì„œì»¤': ['ê´‘ë€ì˜ ì¼ê²©!', 'í”¼ì˜ ì¶•ì œë‹¤!', 'ëª¨ì¡°ë¦¬ ì”¹ì–´ë¨¹ì–´ì£¼ë§ˆ!'],
                'ê°€ë””ì–¸': ['ì‹¤ë“œ ë°°ì‰¬!', 'ì •ì˜ì˜ ì‹¬íŒ!', 'ë¹›ì˜ ê²€ì´ì—¬!'],
                'ì–´ìŒ”ì‹ ': ['ì•”ì‚´.', 'ëª©ì„ ë…¸ë¦°ë‹¤.', 'ê·¸ë¦¼ì ë² ê¸°.'],
                'ì„€ë„ìš°': ['ë² ë†ˆ ìŠ¤íŠ¸ë¼ì´í¬!', 'ë…ë¬´!', 'ì£½ìŒì˜ ìˆ¨ê²°.'],
                'ì•„í¬ë©”ì´ì§€': ['ë©”í…Œì˜¤!', 'ë¸”ë¦¬ìë“œ!', 'ì²´ì¸ ë¼ì´íŠ¸ë‹!'],
                'ì†Œì„œëŸ¬': ['ì—˜ë¦¬ë©˜íƒˆ ë²„ìŠ¤íŠ¸!', 'í˜¼ëˆì˜ ë§ˆë²•!', 'í­ì£¼í•˜ë¼!'],
                'ìŠ¤ë‚˜ì´í¼': ['í—¤ë“œìƒ·!', 'ì •ë°€ ì‚¬ê²©!', 'ê¿°ëš«ëŠ” í™”ì‚´!'],
                'ë ˆì¸ì €': ['í™”ì‚´ ë¹„!', 'ë‚œì‚¬!', 'í­ìš°ì²˜ëŸ¼ ìŸì•„ì ¸ë¼!']
            };
            const list = speeches[job] || ['ìŠ¤í‚¬ ë°œë™!'];
            return list[Math.floor(Math.random() * list.length)];
        }

        function playBossBgm(src) {
            if (bossBgm) {
                bossBgm.pause();
                bossBgm.currentTime = 0;
            }
            bossBgm = new Audio(src);
            bossBgm.loop = true;
            bossBgm.volume = 0.5;
            bossBgm.play().catch(e => console.log("BGM play failed:", e));
        }

        function stopBossBgm() {
            if (bossBgm) {
                bossBgm.pause();
                bossBgm.currentTime = 0;
                bossBgm = null;
            }
        }

        function updateSkillTooltip() {
            const btn = document.querySelector('.btn-skl');
            let desc = "";
            switch(player.job) {
                case 'ì „ì‚¬': desc = "[ê°•íƒ€] ì ì—ê²Œ ê°•ë ¥í•œ ë¬¼ë¦¬ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤."; break;
                case 'ë„ì ': desc = "[ê¸‰ì†Œ ê³µê²©] ë†’ì€ í™•ë¥ ë¡œ ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…íˆê³ , 50% í™•ë¥ ë¡œ ì ì„ ì¤‘ë…ì‹œí‚µë‹ˆë‹¤."; break;
                case 'ë§ˆë²•ì‚¬': desc = "[ë§ˆë ¥íƒ„] ì ì—ê²Œ ê°•ë ¥í•œ ë§ˆë²• í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤."; break;
                case 'ì—˜í”„ ê¶ìˆ˜': desc = "[ë°”ëŒì˜ í™”ì‚´] ì ì—ê²Œ ì•½ê°„ì˜ í”¼í•´ë¥¼ ì£¼ê³ , 3í„´ê°„ ìì‹ ì˜ ê³µê²©ì— ë°”ëŒ ì†ì„±ì„ ë¶€ì—¬í•©ë‹ˆë‹¤. ë°”ëŒ ì†ì„± ê³µê²©ì€ ì¶”ê°€ í”¼í•´ë¥¼ ì…íˆê³  25% í™•ë¥ ë¡œ ì ì„ ê¸°ì ˆì‹œí‚µë‹ˆë‹¤."; break;
                case 'ë²„ì„œì»¤': desc = "[ê´‘ë€] ì ì—ê²Œ ë§¤ìš° ê°•ë ¥í•œ ë¬¼ë¦¬ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤."; break;
                case 'ê°€ë””ì–¸': desc = "[ë°©íŒ¨ ê°•íƒ€] ì ì—ê²Œ ë¬¼ë¦¬ í”¼í•´ë¥¼ ì…íˆê³  30% í™•ë¥ ë¡œ ê¸°ì ˆì‹œí‚µë‹ˆë‹¤."; break;
                case 'ì–´ìŒ”ì‹ ': desc = "[ì•”ì‚´] ë§¤ìš° ë†’ì€ í™•ë¥ ë¡œ ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤."; break;
                case 'ì„€ë„ìš°': desc = "[ë§¹ë…] ë†’ì€ í™•ë¥ ë¡œ ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…íˆê³ , 100% í™•ë¥ ë¡œ ì ì„ ì¤‘ë…ì‹œí‚µë‹ˆë‹¤."; break;
                case 'ì•„í¬ë©”ì´ì§€': desc = "[ëŒ€ë§ˆë²•] ì ì—ê²Œ ë§¤ìš° ê°•ë ¥í•œ ë§ˆë²• í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤."; break;
                case 'ì†Œì„œëŸ¬': desc = "[ì›ì†Œ ë§ˆë²•] ì ì—ê²Œ ê°•ë ¥í•œ ë§ˆë²• í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤. (ë§ˆë‚˜ ì†Œëª¨ëŸ‰ ê°ì†Œ)"; break;
                case 'ìŠ¤ë‚˜ì´í¼': desc = "[í—¤ë“œìƒ·] ì ì˜ í˜„ì¬ ì²´ë ¥ì— ë¹„ë¡€í•œ ì¶”ê°€ í”¼í•´ë¥¼ ì…íˆëŠ” í™•ì • ì¹˜ëª…íƒ€ ê³µê²©ì…ë‹ˆë‹¤."; break;
                case 'ë ˆì¸ì €': desc = "[í™”ì‚´ë¹„] ì ì—ê²Œ ë¬¼ë¦¬ í”¼í•´ë¥¼ ì…íˆê³ , 3í„´ê°„ ì—°ì† ê³µê²© í™•ë¥ ì´ 3ë°° ì¦ê°€í•©ë‹ˆë‹¤. (MP ì†Œëª¨ëŸ‰ ëŒ€í­ ì¦ê°€)"; break;
                default: desc = "ì§ì—… ê³ ìœ ì˜ ê¸°ìˆ ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."; break;
            }
            btn.title = desc;
        }

        function updateSpecialTooltip() {
            const btn = document.getElementById('btn-special');
            let desc = "";
            switch(player.job) {
                case 'ì „ì‚¬': desc = "[ë°©íŒ¨ ë°©ì–´] 2í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ëŸ‰ 50% ê°ì†Œ"; break;
                case 'ë„ì ': desc = "[ì§‘ì¤‘ë ¥ ê°•í™”] ë‹¤ìŒ ê³µê²© ëª…ì¤‘ë¥ /ì¹˜ëª…íƒ€ ëŒ€í­ ìƒìŠ¹"; break;
                case 'ë§ˆë²•ì‚¬': desc = "[ë§ˆë‚˜ ìˆœí™˜] ìµœëŒ€ MPì˜ 30% ì¦‰ì‹œ íšŒë³µ"; break;
                case 'ì—˜í”„ ê¶ìˆ˜': desc = "[ì •ë ¹ì˜ ê°€í˜¸] 2í„´ ë™ì•ˆ íšŒí”¼ìœ¨ 2ë°° ì¦ê°€"; break;
                case 'ë²„ì„œì»¤': desc = "[í”¼ì˜ ê°ˆì¦] HP 20% ì†Œëª¨, 2í„´ê°„ ê³µê²©ë ¥ 2ë°°"; break;
                case 'ê°€ë””ì–¸': desc = "[ì™„ì „ ë°©ì–´] 2í„´ ë™ì•ˆ ë¬´ì  (ë°ë¯¸ì§€ ë¬´íš¨)"; break;
                case 'ì–´ìŒ”ì‹ ': desc = "[ê·¸ë¦¼ì ì¼ê²©] ë°©ì–´ ë¬´ì‹œ í¬ë¦¬í‹°ì»¬ ê³µê²©"; break;
                    case 'ì„€ë„ìš°': desc = "[ë… í™•ì‚°] ë… í”¼í•´ ì¦‰ì‹œ ì…íˆê³  ì¬ì¤‘ë…"; break;
                    case 'ì•„í¬ë©”ì´ì§€': desc = "[ë§ˆë ¥ í­ì£¼] ë‹¤ìŒ ìŠ¤í‚¬ ë°ë¯¸ì§€ 3ë°° (ì‚¬ìš© í›„ 1í„´ ê¸°ì ˆ)"; break;
                    case 'ì†Œì„œëŸ¬': desc = "[ì›ì†Œ ê³¼ë¶€í•˜] 2í„´ ë™ì•ˆ ìŠ¤í‚¬ ë§ˆë‚˜ ì†Œëª¨ 0"; break;
                    case 'ìŠ¤ë‚˜ì´í¼': desc = "[ì€ì‹ ] 2í„´ ë™ì•ˆ ì ì˜ ê³µê²©ì„ íšŒí”¼ (ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€)"; break;
                    case 'ë ˆì¸ì €': desc = "[ì•¼ìˆ˜ì˜ ëˆˆ] 3í„´ ë™ì•ˆ ê³µê²©ë ¥ 20% ì¦ê°€"; break;
                    default: desc = "íŠ¹ìˆ˜ ê¸°ìˆ "; break;
            }
            btn.title = desc;
        }

        function updateDefenseTooltip() {
            const btn = document.querySelector('.btn-def');
            let desc = "";
            const job = player.job;
            if (['ì „ì‚¬', 'ë²„ì„œì»¤', 'ê°€ë””ì–¸'].includes(job)) desc = "[ë°©ì–´] í”¼í•´ 60% ê°ì†Œ ë° í”¼ê²© ì‹œ ë°˜ê²© ë°œë™";
            else if (['ë„ì ', 'ì–´ìŒ”ì‹ ', 'ì„€ë„ìš°'].includes(job)) desc = "[ë°©ì–´] íšŒí”¼ìœ¨ +30% ì¦ê°€ ë° íšŒí”¼ ì‹œ ë¶„ë…¸ ì¶©ì „";
            else if (['ë§ˆë²•ì‚¬', 'ì•„í¬ë©”ì´ì§€', 'ì†Œì„œëŸ¬'].includes(job)) desc = "[ë°©ì–´] ë§ˆë‚˜(MP) 15% ì¦‰ì‹œ íšŒë³µ";
            else if (['ì—˜í”„ ê¶ìˆ˜', 'ìŠ¤ë‚˜ì´í¼', 'ë ˆì¸ì €'].includes(job)) desc = "[ë°©ì–´] ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€ í™•ë¥  +20% (ì¡°ìš°)";
            btn.title = desc;
        }

        function updateWeatherUI() {
            const icon = document.getElementById('weather-icon');
            const text = document.getElementById('weather-text');
            if (currentWeather === "sunny") { icon.innerText = "â˜€ï¸"; text.innerText = "ë§‘ìŒ"; }
            else if (currentWeather === "rain") { icon.innerText = "ğŸŒ§ï¸"; text.innerText = "ë¹„ (ë§ˆë²• ê°•í™”)"; }
            else if (currentWeather === "fog") {
                icon.innerText = "ğŸŒ«ï¸";
                if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                    text.innerText = "ì•ˆê°œ (ëª…ì¤‘ í˜ë„í‹° ì—†ìŒ)";
                } else {
                    text.innerText = "ì•ˆê°œ (ëª…ì¤‘ ì €í•˜)";
                }
            }
            else if (currentWeather === "thunder") { icon.innerText = "âš¡"; text.innerText = "ë‡Œìš°"; }
        }

        function say(target, txt) { const el = document.getElementById(target+'-speech'); el.innerText = txt; el.style.display = 'block'; setTimeout(()=>el.style.display='none', 1500); }
        
        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
        }

        function update() {
            document.getElementById('p-hp-bar').style.width = `${Math.max(0, Math.min(100, (player.hp/player.maxHp)*100))}%`;
            document.getElementById('p-mp-bar').style.width = `${Math.max(0, Math.min(100, (player.mp/player.maxMp)*100))}%`;
            document.getElementById('p-rage-bar').style.width = `${Math.min(100, (rage/maxRage)*100)}%`;
            document.getElementById('e-hp-bar').style.width = `${Math.max(0, Math.min(100, (enemy.hp/enemy.maxHp)*100))}%`;
            document.getElementById('p-hp-text').innerText = `${Math.max(0, Math.ceil(player.hp))}/${Math.round(player.maxHp)}`;
            document.getElementById('p-mp-text').innerText = `${Math.max(0, Math.ceil(player.mp))}/${Math.round(player.maxMp)}`;
            document.getElementById('p-rage-text').innerText = `RAGE ${rage}/${maxRage}`;
            document.getElementById('e-hp-text').innerText = `${Math.max(0, Math.ceil(enemy.hp))}/${Math.round(enemy.maxHp)}`;

            const btnSpecial = document.getElementById('btn-special');
            if (specialCooldown > 0) {
                btnSpecial.disabled = true;
                btnSpecial.innerText = `â³ ${specialCooldown}`;
            } else {
                btnSpecial.disabled = false;
                btnSpecial.innerText = "ğŸŒŸ íŠ¹ìˆ˜ê¸°";
            }

            const pStatusEl = document.getElementById('p-status');
            pStatusEl.innerHTML = '';
            if(pStatus.poison > 0) {
                pStatusEl.innerHTML += `<span class="status-icon status-poison">ë…(${pStatus.poison}í„´)</span>`;
                document.getElementById('player-frame').classList.add('poison-aura');
            } else {
                document.getElementById('player-frame').classList.remove('poison-aura');
            }
            if(pStatus.stun > 0) pStatusEl.innerHTML += `<span class="status-icon status-stun">ê¸°ì ˆ(${pStatus.stun}í„´)</span>`;

            // Buff Icons
            if(pStatus.defUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#795548;">ë°©ì–´(${pStatus.defUp}í„´)</span>`;
            if(pStatus.atkUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#d32f2f;">ê³µê²©(${pStatus.atkUp}í„´)</span>`;
            if(pStatus.invincible > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#ffd700; color:#000;">ë¬´ì (${pStatus.invincible}í„´)</span>`;
            if(pStatus.zeroMana > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#2979ff;">ë§ˆë‚˜0(${pStatus.zeroMana}í„´)</span>`;
            if(pStatus.skillDmgUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#2979ff;">ìŠ¤í‚¬ê°•í™”(${pStatus.skillDmgUp}í„´)</span>`;
            if(pStatus.critUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#ff1744;">ê´‘ê¸°(${pStatus.critUp}í„´)</span>`;
            if(pStatus.doubleAttackChance > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#00e676;">ì—°ì†ê³µê²©(${pStatus.doubleAttackChance}í„´)</span>`;
            if(pStatus.windAttribute > 0) pStatusEl.innerHTML += `<span class="status-icon status-wind">ë°”ëŒ(${pStatus.windAttribute}í„´)</span>`;
            if(pStatus.atkUpRanger > 0) pStatusEl.innerHTML += `<span class="status-icon status-atk-up-ranger">ê³µê²©ë ¥ì—…(${pStatus.atkUpRanger}í„´)</span>`;
            if(pStatus.invis > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#9c27b0;">ì€ì‹ (${pStatus.invis}í„´)</span>`;
            if(pStatus.evasionUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#81c784; color:#000;">ê°€í˜¸(${pStatus.evasionUp}í„´)</span>`;


            const eStatusEl = document.getElementById('e-status');
            eStatusEl.innerHTML = '';
            if(eStatus.poison > 0) eStatusEl.innerHTML += `<span class="status-icon status-poison">ë…(${eStatus.poison}í„´)</span>`;
            if(eStatus.stun > 0) eStatusEl.innerHTML += `<span class="status-icon status-stun">ê¸°ì ˆ(${eStatus.stun}í„´)</span>`;

            if (rage >= maxRage) {
                document.getElementById('btn-rage').style.display = 'block';
                document.getElementById('game-container').classList.add('rage-ready-overlay');
            } else {
                document.getElementById('btn-rage').style.display = 'none';
                document.getElementById('game-container').classList.remove('rage-ready-overlay');
            }
        }
        
        function showDamage(targetId, dmg, type) {
            const frame = document.getElementById(targetId); const el = document.createElement('div');
            let cssClass = 'dmg-text'; let content = dmg;
            if (type === 'crit') {
                cssClass += ' crit-text';
                content = '<div style="color: #ffeb3b; font-size: 2rem; margin-bottom: -10px;">CRITICAL!</div>' + dmg;
                triggerScreenShake();
            }
            else if (type === 'player_hit') { cssClass += ' player-dmg'; }
            else if (type === 'poison') { cssClass += ' poison-dmg'; content = 'POISON<br>' + dmg; }
            else if (type === 'evade') { cssClass += ' evade-text'; content = 'MISS'; }

            if (isLegendary && (player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸') && targetId === 'enemy-frame' && type !== 'evade') {
                cssClass += ' dmg-legendary-warrior';
            }

            el.className = cssClass; el.innerHTML = content;
            const randomX = Math.floor(Math.random()*40)-20; const randomY = Math.floor(Math.random()*20)-10;
            el.style.transform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px))`;
            frame.appendChild(el); setTimeout(() => el.remove(), 1500);
        }

        function triggerScreenShake(isStrong = false) {
            const container = document.getElementById('game-container');
            container.classList.remove('screen-shake', 'screen-shake-strong');
            void container.offsetWidth;
            if (isStrong) container.classList.add('screen-shake-strong');
            else container.classList.add('screen-shake');
            setTimeout(() => container.classList.remove('screen-shake', 'screen-shake-strong'), 500);
        }
        
        function triggerHitEffect(targetId, type) {
            const frame = document.getElementById(targetId);
            frame.classList.remove('hit-small', 'hit-big', 'hit-rogue', 'player-hit-anim', 'crit-action', 'evade-action'); void frame.offsetWidth;

            if (isLegendary && (player.job === 'ë§ˆë²•ì‚¬' || player.job === 'ì•„í¬ë©”ì´ì§€' || player.job === 'ì†Œì„œëŸ¬') && targetId === 'enemy-frame' && type !== 'evade') {
                 const light = document.createElement('div');
                 light.className = 'holy-light-effect';
                 frame.appendChild(light);
                 setTimeout(() => light.remove(), 800);
                 return;
            }

            if (isLegendary && (player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸') && targetId === 'enemy-frame' && type !== 'evade') {
                 const wave = document.createElement('div');
                 wave.className = 'shockwave-effect';
                 frame.appendChild(wave);
                 setTimeout(() => wave.remove(), 600);
            }

            if (type === 'normal') frame.classList.add('hit-small');
            else if (type === 'rogue') frame.classList.add('hit-rogue');
            else if (type === 'big') frame.classList.add('hit-big');
            else if (type === 'player_hit') frame.classList.add('player-hit-anim');
            else if (type === 'crit') frame.classList.add('crit-action');
            else if (type === 'evade') frame.classList.add('evade-action');
        }

        function showCritEffect(targetId) {
            const frame = document.getElementById(targetId);
            const img = document.createElement('img');
            img.src = 'image/criti_1.png';
            img.className = 'crit-effect-img';
            frame.appendChild(img);
            setTimeout(() => img.remove(), 1000);
        }
        
        function playMotion(imgId, targetFrameId, effectType) {
            const pImg = document.getElementById('p-img');
            const motionImg = document.getElementById(imgId);

            const jM = {
                'ë²„ì„œì»¤': 'warrior', 'ê°€ë””ì–¸': 'warrior',
                'ì–´ìŒ”ì‹ ': 'rogue', 'ì„€ë„ìš°': 'rogue',
                'ì•„í¬ë©”ì´ì§€': 'mage', 'ì†Œì„œëŸ¬': 'mage',
                'ìŠ¤ë‚˜ì´í¼': 'archer', 'ë ˆì¸ì €': 'archer'
            };

            let base = jM[player.job];
            if (base) {
                if (effectType === 'crit') {
                    const critMap = { 'warrior': 'crit-warrior1', 'rogue': 'crit-rogue1', 'mage': 'crit-mage1', 'archer': 'crit-archer-advanced' };
                    const cImg = document.getElementById(critMap[base]);
                    if (cImg) {
                        pImg.style.display = 'none'; cImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('crit-action');
                        setTimeout(() => {
                            cImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('crit-action');
                        }, 1000);
                        return; // ì „ì§ í¬ë¦¬í‹°ì»¬ì€ ì—¬ê¸°ì„œ ì¢…ë£Œ
                    }
                }

                if (effectType === 'evade') {
                    const evaMap = { 'warrior': 'eva-warrior1', 'rogue': 'eva-rogue1', 'mage': 'eva-mage1', 'archer': 'eva-archer1' };
                    const eImg = document.getElementById(evaMap[base]);
                    if (eImg) {
                        pImg.style.display = 'none'; eImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('evade-action');
                        setTimeout(() => {
                            eImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('evade-action');
                        }, 1000);
                        return;
                    }
                }

                if (imgId && imgId.includes('atk')) {
                    if (base === 'mage') {
                        pImg.src = mageAttackToggle ? 'image/mage3.jpg' : 'image/mage2.jpg';
                        mageAttackToggle = !mageAttackToggle;
                    } else if (base === 'archer') {
                        const atkImg = document.getElementById('atk-archer1');
                        pImg.style.display = 'none'; atkImg.style.display = 'block';
                        setTimeout(() => {
                            atkImg.style.display = 'none'; pImg.style.display = 'block';
                        }, 1000);
                    }
                    else {
                        pImg.src = `image/${base}2.jpg`;
                    }
                }
                triggerHitEffect(targetFrameId, effectType);
                setTimeout(() => {
                    if (isLegendary) {
                        if (base === 'warrior') pImg.src = 'image/warrior4.jpg';
                        else if (base === 'rogue') pImg.src = 'image/rogue4.jpg';
                        else if (base === 'mage') pImg.src = 'image/mage4.jpg';
                        else if (base === 'archer') pImg.src = 'image/archer4.jpg';
                        else pImg.src = `image/${base}1.jpg`;
                    } else {
                        pImg.src = `image/${base}1.jpg`;
                    }
                }, 1000);

            } else { // ì „ì§ ì•ˆí•œ ê²½ìš°
                if (effectType === 'crit') {
                    const critMap = { 'ì „ì‚¬': 'crit-warrior', 'ë„ì ': 'crit-rogue', 'ë§ˆë²•ì‚¬': 'crit-mage', 'ì—˜í”„ ê¶ìˆ˜': 'crit-archer' };
                    const cImg = document.getElementById(critMap[player.job || 'ì „ì‚¬']);
                    if (cImg) {
                        pImg.style.display = 'none'; cImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('crit-action');
                        setTimeout(() => {
                            cImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('crit-action');
                        }, 1000);
                    }
                } else if (effectType === 'evade') {
                    const evaMap = { 'ì „ì‚¬': 'eva-warrior', 'ë„ì ': 'eva-rogue', 'ë§ˆë²•ì‚¬': 'eva-mage', 'ì—˜í”„ ê¶ìˆ˜': 'evasion-archer' };
                    const eImg = document.getElementById(evaMap[player.job || 'ì „ì‚¬']);
                    if (eImg) {
                        pImg.style.display = 'none'; eImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('evade-action');
                        setTimeout(() => {
                            eImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('evade-action');
                        }, 1000);
                    }
                } else {
                    if(motionImg) { pImg.style.display = 'none'; motionImg.style.display = 'block'; setTimeout(() => { motionImg.style.display = 'none'; pImg.style.display = 'block'; }, 1000); }
                }
                triggerHitEffect(targetFrameId, effectType);
            }
        }

        function playEnemyAttackMotion() {
            const eImg = document.getElementById('e-img');
            const currentSrc = enemy.img;
            const attackImg = ENEMY_ATTACK_IMAGES[currentSrc];
            if (attackImg) {
                eImg.src = attackImg;
                setTimeout(() => {
                    eImg.src = currentSrc;
                }, 1000);
            }
        }

        function playAttackSfx() { attackSfx.currentTime = 0; attackSfx.play().catch(e => {}); }
        function playCritSfx() { critSfx.currentTime = 0; critSfx.play().catch(e => {}); }
        function playLevelupSfx() { levelupSfx.currentTime = 0; levelupSfx.play().catch(e => {}); }
        function playItemSfx() { itemSfx.currentTime = 0; itemSfx.play().catch(e => {}); }
        function playDamageSfx() { damageSfx.currentTime = 0; damageSfx.play().catch(e => {}); }
        function playEvadeSfx() { evadeSfx.currentTime = 0; evadeSfx.play().catch(e => {}); }
        function playPotionSfx() { potionSfx.currentTime = 0; potionSfx.play().catch(e => {}); }
        function playGoldSfx() { goldSfx.currentTime = 0; goldSfx.play().catch(e => {}); }

        function specialAtk() {
            if(isActing || specialCooldown > 0) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ íŠ¹ìˆ˜ê¸°ë¥¼ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; }

            isActing = true;
            specialCooldown = SPECIAL_COOLDOWN_MAX;

            let job = player.job;
            let logMsg = "";

            triggerScreenShake();
            playItemSfx();

            setTimeout(() => {
                switch(job) {
                    case 'ì „ì‚¬':
                        pStatus.defUp = 2;
                        logMsg = "ğŸ›¡ï¸ [ë°©íŒ¨ ë°©ì–´] íƒœì„¸ë¥¼ ì·¨í•©ë‹ˆë‹¤! (ë°›ëŠ” í”¼í•´ 50% ê°ì†Œ)";
                        say('p', 'ë°©ì–´ íƒœì„¸!');
                        break;
                    case 'ë„ì ':
                        pStatus.focus = 1;
                        logMsg = "ğŸ‘ï¸ [ì§‘ì¤‘ë ¥ ê°•í™”] ì ì˜ ì•½ì ì„ ë…¸ë¦½ë‹ˆë‹¤! (ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€)";
                        say('p', 'ì•½ì ì„ ê°„íŒŒí–ˆë‹¤!');
                        break;
                    case 'ë§ˆë²•ì‚¬':
                        let rec = Math.floor(player.maxMp * 0.3);
                        player.mp = Math.min(player.maxMp, player.mp + rec);
                        logMsg = `ğŸ’§ [ë§ˆë‚˜ ìˆœí™˜] ë§ˆë‚˜ë¥¼ ${rec} íšŒë³µí–ˆìŠµë‹ˆë‹¤!`;
                        say('p', 'ë§ˆë‚˜ì—¬, ì°¨ì˜¬ë¼ë¼!');
                        break;
                    case 'ì—˜í”„ ê¶ìˆ˜':
                        pStatus.evasionUp = 2; // 2í„´ê°„ íšŒí”¼ìœ¨ 2ë°° ì¦ê°€
                        logMsg = "ğŸƒ [ì •ë ¹ì˜ ê°€í˜¸] ì •ë ¹ì˜ ê°€í˜¸ë¡œ 2í„´ê°„ íšŒí”¼ìœ¨ì´ 2ë°° ì¦ê°€í•©ë‹ˆë‹¤!";
                        say('p', 'ì •ë ¹ì´ì—¬, ë‚˜ë¥¼ ë³´í˜¸í•˜ì†Œì„œ!');
                        break;
                    case 'ë²„ì„œì»¤':
                        let cost = Math.floor(player.hp * 0.2);
                        player.hp -= cost;
                        pStatus.atkUp = 2;
                        logMsg = `ğŸ©¸ [í”¼ì˜ ê°ˆì¦] ì²´ë ¥ ${cost}ì„ ì†Œëª¨í•˜ì—¬ ê³µê²©ë ¥ì„ 2ë°°ë¡œ ë†’ì…ë‹ˆë‹¤!`;
                        showDamage('player-frame', cost, 'player_hit');
                        say('p', 'í”¼ê°€ ë“ëŠ”ë‹¤!');
                        break;
                    case 'ê°€ë””ì–¸':
                        pStatus.invincible = 2;
                        logMsg = "ğŸ›¡ï¸ [ì™„ì „ ë°©ì–´] ì ˆëŒ€ ë°©ì–´ íƒœì„¸! (2í„´ê°„ ë¬´ì )";
                        say('p', 'ì ˆëŒ€ ëš«ë¦¬ì§€ ì•ŠëŠ”ë‹¤!');
                        break;
                    case 'ì–´ìŒ”ì‹ ':
                        let dmg = Math.floor((player.stats.dex * 2.5 + player.level * 5) * 1.5);
                        enemy.hp -= dmg;
                        showDamage('enemy-frame', dmg, 'crit');
                        showCritEffect('enemy-frame');
                        triggerHitEffect('enemy-frame', 'crit');
                        logMsg = `ğŸ—¡ï¸ [ê·¸ë¦¼ì ì¼ê²©] ì ì˜ ê¸‰ì†Œë¥¼ ì°”ëŸ¬ ${dmg}ì˜ ì¹˜ëª…ì ì¸ í”¼í•´!`;
                        say('p', 'ì£½ìŒì€ ì¡°ìš©íˆ...');
                        break;
                    case 'ì„€ë„ìš°':
                        if (eStatus.poison > 0) {
                            let pDmg = Math.floor(enemy.maxHp * 0.05) * eStatus.poison;
                            enemy.hp -= pDmg;
                            showDamage('enemy-frame', pDmg, 'poison');
                            logMsg = `â˜ ï¸ [ë… í™•ì‚°] ë…ì„ í­ë°œì‹œì¼œ ${pDmg} í”¼í•´ë¥¼ ì…íˆê³  ë‹¤ì‹œ ì¤‘ë…ì‹œí‚µë‹ˆë‹¤!`;
                        } else {
                            logMsg = "â˜ ï¸ [ë… í™•ì‚°] ì ì—ê²Œ ë§¹ë…ì„ ì£¼ì…í•©ë‹ˆë‹¤!";
                        }
                        eStatus.poison = 3;
                        say('p', 'ê³ í†µìŠ¤ëŸ¬ìš¸ ê²ƒì´ë‹¤...');
                        break;
                    case 'ì•„í¬ë©”ì´ì§€':
                        pStatus.nextSkillTriple = 1;
                        logMsg = "ğŸ”® [ë§ˆë ¥ í­ì£¼] ë§ˆë ¥ì„ í•œê³„ê¹Œì§€ ëŒì–´ì˜¬ë¦½ë‹ˆë‹¤! (ë‹¤ìŒ ìŠ¤í‚¬ 3ë°°)";
                        say('p', 'ê¶ê·¹ì˜ ë§ˆë²•ì„ ìœ„í•´!');
                        break;
                    case 'ì†Œì„œëŸ¬':
                        pStatus.zeroMana = 2;
                        logMsg = "ğŸŒ€ [ì›ì†Œ ê³¼ë¶€í•˜] ë§ˆë‚˜ì˜ íë¦„ì„ ì œì–´í•©ë‹ˆë‹¤! (ìŠ¤í‚¬ ì†Œëª¨ 0)";
                        say('p', 'ë¬´í•œí•œ ë§ˆë ¥ì„ ëŠê»´ë¼!');
                        break;
                    case 'ìŠ¤ë‚˜ì´í¼':
                        pStatus.invis = 2; // 2í„´ê°„ ì ì˜ ê³µê²© íšŒí”¼ (ë¬´ì ê³¼ ìœ ì‚¬)
                        pStatus.focus = 1; // ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€
                        logMsg = "ğŸ‘» [ì€ì‹ ] 2í„´ê°„ ì ì˜ ê³µê²©ì„ íšŒí”¼í•˜ê³  ë‹¤ìŒ ê³µê²©ì€ ì¹˜ëª…íƒ€ê°€ ë©ë‹ˆë‹¤!";
                        say('p', 'ì‚¬ë¼ì ¸ë¼!');
                        break;
                    case 'ë ˆì¸ì €':
                        pStatus.atkUpRanger = 3; // 3í„´ê°„ ê³µê²©ë ¥ 20% ì¦ê°€
                        logMsg = "ğŸº [ì•¼ìˆ˜ì˜ ëˆˆ] 3í„´ê°„ ê³µê²©ë ¥ì´ 20% ì¦ê°€í•©ë‹ˆë‹¤!";
                        say('p', 'ì‚¬ëƒ¥ì˜ ì‹œê°„ì´ë‹¤!');
                        break;
                    default:
                        logMsg = "íŠ¹ìˆ˜ ê¸°ìˆ  ë°œë™!";
                        break;
                }

                addLog(logMsg);
                update();
                check();
            }, 500);
        }

        function def() {
            if(isActing) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ë°©ì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            isActing = true;
            const job = player.job;
            pStatus.defUp = 1;

            let logMsg = "ğŸ›¡ï¸ ë°©ì–´ íƒœì„¸ë¥¼ ì·¨í•©ë‹ˆë‹¤!";

            // --- [ìˆ˜ì •ëœ ì´í™íŠ¸ ì ìš© ë¡œì§] ---
            const aura = document.getElementById('p-defense-aura');

            // ê¸°ì¡´ í´ë˜ìŠ¤ ì´ˆê¸°í™” (ê¸°ë³¸ í´ë˜ìŠ¤ë§Œ ë‚¨ê¹€)
            aura.className = 'defense-aura';

            // ì§ì—…ë³„ í´ë˜ìŠ¤ ì¶”ê°€
            if (['ì „ì‚¬', 'ë²„ì„œì»¤', 'ê°€ë””ì–¸'].includes(job)) {
                aura.classList.add('def-warrior');
                pStatus.counterReady = true;
                logMsg = "ğŸ›¡ï¸ [ì² ë²½ ë°©ì–´] ë°©íŒ¨ë¥¼ ë“¤ì–´ ì˜¬ë ¤ ë°˜ê²©ì„ ì¤€ë¹„í•©ë‹ˆë‹¤! (í”¼í•´ 60% ê°ì†Œ)";
            }
            else if (['ë„ì ', 'ì–´ìŒ”ì‹ ', 'ì„€ë„ìš°'].includes(job)) {
                aura.classList.add('def-rogue');
                pStatus.evasionBoost = 1;
                logMsg = "ğŸ’¨ [ì—°ë§‰ ì€ì‹ ] ê·¸ë¦¼ì ì†ìœ¼ë¡œ ëª¸ì„ ìˆ¨ê¹ë‹ˆë‹¤! (íšŒí”¼ìœ¨ +30%)";
            }
            else if (['ë§ˆë²•ì‚¬', 'ì•„í¬ë©”ì´ì§€', 'ì†Œì„œëŸ¬'].includes(job)) {
                aura.classList.add('def-mage');
                let rec = Math.floor(player.maxMp * 0.15);
                player.mp = Math.min(player.maxMp, player.mp + rec);
                logMsg = `ğŸ’§ [ë§ˆë‚˜ ì¥ë§‰] ë§ˆë ¥ì„ íšŒë³µí•˜ë©° ë³´í˜¸ë§‰ì„ í¼ì¹©ë‹ˆë‹¤! (MP +${rec})`;
            }
            else if (['ì—˜í”„ ê¶ìˆ˜', 'ìŠ¤ë‚˜ì´í¼', 'ë ˆì¸ì €'].includes(job)) {
                aura.classList.add('def-archer');
                pStatus.aiming = 1;
                logMsg = "ğŸ¯ [ë°”ëŒì˜ ì§‘ì¤‘] ì ì˜ ì›€ì§ì„ì„ ì½ê³  ì¡°ì¤€í•©ë‹ˆë‹¤! (ë‹¤ìŒ ì¹˜ëª…íƒ€ í™•ë¥  ì¦ê°€)";
            } else {
                aura.classList.add('def-warrior');
            }

            // ì´í™íŠ¸ í‘œì‹œ
            aura.style.display = 'block';

            // 2ì´ˆ ë’¤ ì‚¬ë¼ì§€ê²Œ ì„¤ì •
            setTimeout(() => { aura.style.display = 'none'; }, 2000);

            addLog(logMsg);
            say('p', 'ë°©ì–´!');
            playItemSfx();

            setTimeout(() => {
                update();
                eTurn();
            }, 800);
        }

        function atk() { 
            if(isActing) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ê³µê²©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            isActing = true;
            const jobKey = player.job || 'ì „ì‚¬'; 
            const imgMap = {
                'ì „ì‚¬':'atk-warrior', 'ë„ì ':'atk-rogue', 'ë§ˆë²•ì‚¬':'atk-mage', 'ì—˜í”„ ê¶ìˆ˜':'atk-archer',
                'ë²„ì„œì»¤':'atk-warrior', 'ê°€ë””ì–¸':'atk-warrior',
                'ì–´ìŒ”ì‹ ':'atk-rogue', 'ì„€ë„ìš°':'atk-rogue',
                'ì•„í¬ë©”ì´ì§€':'atk-mage', 'ì†Œì„œëŸ¬':'atk-mage',
                'ìŠ¤ë‚˜ì´í¼':'atk-archer1', 'ë ˆì¸ì €':'atk-archer1'
            };
            
            playAttackSfx();

            // Check Focus
            let isFocused = false;
            if (pStatus.focus > 0) {
                isFocused = true;
                pStatus.focus = 0;
            }

            // Check Berserk
            let isBerserk = (pStatus.atkUp > 0);

            // Double Attack Check
            let isDoubleAttack = false;
            const advancedJobs = ['ë²„ì„œì»¤', 'ê°€ë””ì–¸', 'ì–´ìŒ”ì‹ ', 'ì„€ë„ìš°', 'ì•„í¬ë©”ì´ì§€', 'ì†Œì„œëŸ¬', 'ìŠ¤ë‚˜ì´í¼', 'ë ˆì¸ì €'];
            let doubleAttackBaseChance = 0.08;
            if (player.job === 'ë ˆì¸ì €' && pStatus.doubleAttackChance > 0) { // ì—˜í”„ ë ˆì¸ì € í™”ì‚´ë¹„ ìŠ¤í‚¬ íš¨ê³¼
                doubleAttackBaseChance *= 3;
            } else if (pStatus.doubleAttackChance > 0) {
                doubleAttackBaseChance *= 2; // ê¸°ì¡´ ì—°ì† ê³µê²© í™•ë¥  2ë°° ì¦ê°€
            }

            if (advancedJobs.includes(player.job) && doubleAttackCooldown === 0 && Math.random() < doubleAttackBaseChance) {
                isDoubleAttack = true;
                doubleAttackCooldown = Math.floor(Math.random() * 2) + 2;
            }

            setTimeout(() => {
                let enemyEvadeChance = isBossBattle ? 0.1 : 0.05;
                // ì—˜í”„ ê¶ìˆ˜ ê³„ì—´ì€ ì•ˆê°œ ë‚ ì”¨ ëª…ì¤‘ë¥  í˜ë„í‹° ë¬´ì‹œ
                if (currentWeather === "fog" && !(player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €')) {
                    enemyEvadeChance += 0.15;
                }

                if (Math.random() < enemyEvadeChance && !isFocused) {
                    addLog("<span class='log-evade'>ì ì´ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!</span>");
                    playEvadeSfx();
                    showDamage('enemy-frame', 0, 'evade');
                    triggerHitEffect('enemy-frame', 'evade');
                    update(); check();
                    return;
                }

                const atkSpeech = getAttackSpeech(player.job);
                if(atkSpeech) say('p', atkSpeech);

                let critChance = 0.2;
                if (player.job === 'ì–´ìŒ”ì‹ ') critChance = 0.35;
                if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') critChance = 0.25; // ê¶ìˆ˜ ê¸°ë³¸ ì¹˜ëª…íƒ€ìœ¨
                if (isFocused) critChance = 1.0;
                if (pStatus.critUp > 0) critChance = 1.0;
                if (pStatus.aiming > 0) {
                    critChance += 0.2;
                    pStatus.aiming = 0;
                    addLog("ğŸ¯ ì¡°ì¤€ ì‚¬ê²©! ì¹˜ëª…íƒ€ í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤.");
                }

                let isCrit = Math.random() < critChance;
                let dmg = Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0);

                // ê¶ìˆ˜ ê³„ì—´ì€ ë¯¼ì²© ìŠ¤íƒ¯ ê¸°ë°˜ ê³µê²©ë ¥
                if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                    dmg = Math.floor(player.stats.dex/2.0) + (player.level*2) + 5 + (player.bonusAtk||0);
                }

                // ë°”ëŒì˜ í™”ì‚´ íš¨ê³¼ ì ìš©
                if (pStatus.windAttribute > 0) {
                    const windDmg = Math.floor(player.stats.int * 0.5);
                    dmg += windDmg;
                    addLog(`ë°”ëŒ ì†ì„± ì¶”ê°€ í”¼í•´ <span class='log-dmg'>${windDmg}</span>!`);
                    if (Math.random() < 0.25) { // 25% í™•ë¥ ë¡œ ê¸°ì ˆ
                        eStatus.stun = 1;
                        addLog("ë°”ëŒì˜ í˜ìœ¼ë¡œ ì ì´ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!");
                    }
                }

                // ë ˆì¸ì € ì•¼ìˆ˜ì˜ ëˆˆ íš¨ê³¼ ì ìš©
                if (pStatus.atkUpRanger > 0) {
                    dmg = Math.floor(dmg * 1.2); // 20% ê³µê²©ë ¥ ì¦ê°€
                }

                if (isBerserk) dmg *= 2;

                if(isCrit) {
                    dmg = Math.floor(dmg*2);
                    playCritSfx();
                }
                
                if (isLegendary) {
                    if (player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸') {
                        triggerScreenShake(true);
                    }
                }

                playMotion(imgMap[jobKey], 'enemy-frame', isCrit?'crit':'normal');
                enemy.hp -= dmg; 
                showDamage('enemy-frame', dmg, isCrit?'crit':'normal');
                if (isCrit) showCritEffect('enemy-frame');
                addLog(`ì ì—ê²Œ <span class='log-dmg'>${dmg}</span>ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);

                if (isDoubleAttack && enemy.hp > 0) {
                    setTimeout(() => {
                        performDoubleAttack();
                    }, 1500); // ë”œë ˆì´ ì¦ê°€
                } else {
                    update(); check();
                }
            }, 200);
        }

        function performDoubleAttack() {
            const job = player.job;
            let msg = "";
            let atkImg = "";
            let effectType = "normal";
            let dmgCorrection = 1.0;

            if (['ë²„ì„œì»¤', 'ê°€ë””ì–¸'].includes(job)) {
                msg = "í•œë²ˆ ë” ! ê°•ë ¥í•œ ì¼ê²©!";
                atkImg = "image/warrior_attack.jpg";
                effectType = "big";
            } else if (['ì–´ìŒ”ì‹ ', 'ì„€ë„ìš°'].includes(job)) {
                msg = "ë³´ì´ì§€ ì•ŠëŠ” ì†ë„ë¡œ!";
                atkImg = "image/rogue_attack.jpg";
                effectType = "rogue";
            } else if (['ì•„í¬ë©”ì´ì§€', 'ì†Œì„œëŸ¬'].includes(job)) {
                msg = "ë§ˆë ¥ì´ ë„˜ì³íë¥¸ë‹¤ !";
                atkImg = "image/mage_attack.jpg";
                effectType = "big";
            } else if (job === 'ìŠ¤ë‚˜ì´í¼') {
                msg = "ì‹¬ì¥ì„ ê¿°ëš«ì–´ì£¼ë§ˆ!";
                atkImg = "image/archer_attack2.jpg";
                effectType = "crit"; // ìŠ¤ë‚˜ì´í¼ëŠ” ë”ë¸” ì–´íƒë„ ì¹˜ëª…íƒ€ì²˜ëŸ¼ ì—°ì¶œ
                dmgCorrection = 0.8;
            } else if (job === 'ë ˆì¸ì €') {
                msg = "í­í’ì²˜ëŸ¼ ìŸì•„ì ¸ë¼!";
                atkImg = "image/ranger_attack.jpg";
                effectType = "normal";
                dmgCorrection = 0.4;
            }

            say('p', msg);

            setTimeout(() => {
                // ë”ë¸” ì–´íƒ ì‹œê° íš¨ê³¼ ì¶”ê°€
                const container = document.getElementById('game-container');
                const flash = document.createElement('div');
                flash.className = 'double-attack-flash';
                container.appendChild(flash);
                setTimeout(() => flash.remove(), 200);

                const textEffect = document.createElement('div');
                textEffect.className = 'double-attack-text';
                textEffect.innerText = "DOUBLE ATTACK!";
                container.appendChild(textEffect);
                setTimeout(() => textEffect.remove(), 1000);

                const pImg = document.getElementById('p-img');
                pImg.src = atkImg;

                playAttackSfx();

                setTimeout(() => {
                    let dmgRatio = (Math.random() * 0.4) + 0.3;
                    let baseDmg = Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0);

                    // ê¶ìˆ˜ ê³„ì—´ì€ ë¯¼ì²© ìŠ¤íƒ¯ ê¸°ë°˜ ê³µê²©ë ¥
                    if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                        baseDmg = Math.floor(player.stats.dex/2.0) + (player.level*2) + 5 + (player.bonusAtk||0);
                    }

                    // ë°”ëŒì˜ í™”ì‚´ íš¨ê³¼ ì ìš©
                    if (pStatus.windAttribute > 0) {
                        const windDmg = Math.floor(player.stats.int * 0.5);
                        baseDmg += windDmg;
                        addLog(`ë°”ëŒ ì†ì„± ì¶”ê°€ í”¼í•´ <span class='log-dmg'>${windDmg}</span>!`);
                        if (Math.random() < 0.25) { // 25% í™•ë¥ ë¡œ ê¸°ì ˆ
                            eStatus.stun = 1;
                            addLog("ë°”ëŒì˜ í˜ìœ¼ë¡œ ì ì´ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!");
                        }
                    }

                    // ë ˆì¸ì € ì•¼ìˆ˜ì˜ ëˆˆ íš¨ê³¼ ì ìš©
                    if (pStatus.atkUpRanger > 0) {
                        baseDmg = Math.floor(baseDmg * 1.2); // 20% ê³µê²©ë ¥ ì¦ê°€
                    }

                    if (pStatus.atkUp > 0) baseDmg *= 2;

                    let dmg = Math.floor(baseDmg * dmgRatio * dmgCorrection);

                    triggerHitEffect('enemy-frame', effectType);

                    enemy.hp -= dmg;
                    showDamage('enemy-frame', dmg, 'normal');
                    addLog(`ì—°ì† ê³µê²©! <span class='log-dmg'>${dmg}</span>ì˜ ì¶”ê°€ í”¼í•´!`);

                    setTimeout(() => {
                        if (isLegendary) {
                             const jM = {
                                'ì „ì‚¬': 'warrior', 'ë„ì ': 'rogue', 'ë§ˆë²•ì‚¬': 'mage', 'ì—˜í”„ ê¶ìˆ˜': 'archer',
                                'ë²„ì„œì»¤': 'warrior', 'ê°€ë””ì–¸': 'warrior',
                                'ì–´ìŒ”ì‹ ': 'rogue', 'ì„€ë„ìš°': 'rogue',
                                'ì•„í¬ë©”ì´ì§€': 'mage', 'ì†Œì„œëŸ¬': 'mage',
                                'ìŠ¤ë‚˜ì´í¼': 'archer', 'ë ˆì¸ì €': 'archer'
                            };
                            let base = jM[player.job];
                            if (base === 'warrior') pImg.src = 'image/warrior4.jpg';
                            else if (base === 'rogue') pImg.src = 'image/rogue4.jpg';
                            else if (base === 'mage') pImg.src = 'image/mage4.jpg';
                            else if (base === 'archer') pImg.src = 'image/archer4.jpg';
                            else pImg.src = `image/${base}1.jpg`;
                        } else {
                             const jM = {
                                'ì „ì‚¬': 'warrior', 'ë„ì ': 'rogue', 'ë§ˆë²•ì‚¬': 'mage', 'ì—˜í”„ ê¶ìˆ˜': 'archer',
                                'ë²„ì„œì»¤': 'warrior1', 'ê°€ë””ì–¸': 'warrior1',
                                'ì–´ìŒ”ì‹ ': 'rogue1', 'ì„€ë„ìš°': 'rogue1',
                                'ì•„í¬ë©”ì´ì§€': 'mage1', 'ì†Œì„œëŸ¬': 'mage1',
                                'ìŠ¤ë‚˜ì´í¼': 'archer1', 'ë ˆì¸ì €': 'archer1'
                            };
                            let base = jM[player.job] || 'warrior';
                            pImgSrc = `image/${base}.jpg`;
                        }
                    }, 800); // ëª¨ì…˜ ìœ ì§€ ì‹œê°„ ì¦ê°€

                    update();
                    check();
                }, 400); // íƒ€ê²© íƒ€ì´ë° ì¡°ì ˆ
            }, 800); // ë§í’ì„  ë”œë ˆì´
        }

        function skl() {
            if(isActing) return; 
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ìŠ¤í‚¬ì„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            let costRate = 0.6;
            if (player.job === 'ì†Œì„œëŸ¬') costRate = 0.3;
            if (player.job === 'ë„ì ' || player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') costRate = 0.4;
            if (player.job === 'ì—˜í”„ ê¶ìˆ˜') costRate = 0.3; // ê¶ìˆ˜ ìŠ¤í‚¬ ë§ˆë‚˜ ì†Œëª¨ìœ¨
            if (player.job === 'ë ˆì¸ì €') costRate = 0.8; // ì—˜í”„ ë ˆì¸ì € í™”ì‚´ë¹„ ìŠ¤í‚¬ ë§ˆë‚˜ ì†Œëª¨ìœ¨ ëŒ€í­ ì¦ê°€
            if (player.job === 'ìŠ¤ë‚˜ì´í¼') costRate = 0.7; // ìŠ¤ë‚˜ì´í¼ í—¤ë“œìƒ· ë§ˆë‚˜ ì†Œëª¨ìœ¨ ì¦ê°€

            if (pStatus.zeroMana > 0 || pStatus.nextSkillZeroCost > 0) costRate = 0;

            const cost = Math.floor(player.maxMp * costRate);
            if(player.mp < cost) { say('p', 'ë§ˆë‚˜ê°€ ë¶€ì¡±í•´!'); return; }

            isActing = true;
            player.mp -= cost;
            if (pStatus.nextSkillZeroCost > 0) pStatus.nextSkillZeroCost = 0;
            update();

            const jobKey = player.job || 'ì „ì‚¬';
            playAttackSfx();

            setTimeout(() => {
                let isCrit = false; let dmg = 0;
                
                const skillSpeech = getSkillSpeech(player.job);
                say('p', skillSpeech);

                if(player.job === 'ë„ì ' || player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') {
                    let baseDmg = Math.floor(player.stats.dex * 0.5) + (player.level * 2);
                    let critChance = (player.job === 'ì–´ìŒ”ì‹ ') ? 0.55 : 0.4;
                    if (pStatus.critUp > 0) critChance = 1.0;
                    if (pStatus.aiming > 0) {
                        critChance += 0.2;
                        pStatus.aiming = 0;
                        addLog("ğŸ¯ ì¡°ì¤€ ì‚¬ê²©! ì¹˜ëª…íƒ€ í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤.");
                    }
                    isCrit = Math.random() < critChance;
                    if (isCrit) {
                        dmg = (baseDmg * 4) + (player.bonusAtk||0);
                        playCritSfx();
                    }
                    else { dmg = baseDmg + (player.bonusAtk||0); }

                    let poisonChance = (player.job === 'ì„€ë„ìš°') ? 1.0 : 0.5;
                    if(Math.random() < poisonChance) { eStatus.poison = 3; addLog("ì ì—ê²Œ ë…ì„ ë¶€ì—¬í–ˆìŠµë‹ˆë‹¤!"); }

                    if (isLegendary) {
                        document.getElementById('player-frame').classList.add('rogue-legendary-action');
                        setTimeout(() => document.getElementById('player-frame').classList.remove('rogue-legendary-action'), 500);
                    }

                    const vMap = {
                        'ë„ì ':'v-rogue', 'ì–´ìŒ”ì‹ ':'v-rogue1', 'ì„€ë„ìš°':'v-rogue1'
                    };
                    const v = document.getElementById(vMap[jobKey] || 'v-rogue'); const pImg = document.getElementById('p-img');
                    if(v) {
                        v.pause();
                        v.currentTime = 0; // Reset video to start
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => { v.style.display='none'; pImg.style.display='block'; applySkillDmg(player.job, dmg, isCrit); }
                    } else {
                        playMotion('atk-rogue', 'enemy-frame', isCrit?'crit':'rogue');
                        applySkillDmg(player.job, dmg, isCrit);
                    }
                    return;
                } else if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                    let vId = 'v-archer';
                    if (player.job === 'ìŠ¤ë‚˜ì´í¼') vId = 'v-archer1';
                    else if (player.job === 'ë ˆì¸ì €') vId = 'v-archer2';

                    if (isLegendary) vId = 'v-archer3';

                    const v = document.getElementById(vId); const pImg = document.getElementById('p-img');
                    if(v) {
                        v.pause();
                        v.currentTime = 0;
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => {
                            v.style.display='none'; pImg.style.display='block';
                            applySkillDmg(player.job);
                        }
                    } else {
                        applySkillDmg(player.job);
                    }
                    return;
                } else {
                    let vMap = {
                        'ì „ì‚¬':'v-warrior', 'ë§ˆë²•ì‚¬':'v-mage',
                        'ë²„ì„œì»¤':'v-warrior1', 'ê°€ë””ì–¸':'v-warrior1',
                        'ì•„í¬ë©”ì´ì§€':'v-mage1', 'ì†Œì„œëŸ¬':'v-mage1'
                    };

                    if (isLegendary) {
                        if (player.job === 'ë§ˆë²•ì‚¬' || player.job === 'ì•„í¬ë©”ì´ì§€' || player.job === 'ì†Œì„œëŸ¬') {
                            vMap['ë§ˆë²•ì‚¬'] = 'v-mage2'; vMap['ì•„í¬ë©”ì´ì§€'] = 'v-mage2'; vMap['ì†Œì„œëŸ¬'] = 'v-mage2';
                        } else if (player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸') {
                            vMap['ì „ì‚¬'] = 'v-warrior2'; vMap['ë²„ì„œì»¤'] = 'v-warrior2'; vMap['ê°€ë””ì–¸'] = 'v-warrior2';
                        }
                    }

                    const v = document.getElementById(vMap[jobKey]); const pImg = document.getElementById('p-img');
                    if(v) {
                        v.pause();
                        v.currentTime = 0;
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => { v.style.display='none'; pImg.style.display='block'; applySkillDmg(player.job); }
                    } else applySkillDmg(player.job);
                    return;
                }
            }, 200);
        }

        function applySkillDmg(job, preCalcDmg = 0, preCalcCrit = false) {
            let isCrit = preCalcCrit;
            let dmg = preCalcDmg;

            if (dmg === 0) {
                isCrit = Math.random() < 0.2;
                if (pStatus.critUp > 0) isCrit = true;
                if (pStatus.aiming > 0) {
                    isCrit = true; // ê¶ìˆ˜ ì¡°ì¤€ ì‹œ ìŠ¤í‚¬ë„ í¬ë¦¬í‹°ì»¬ ë³´ì • (ê°„ì†Œí™”)
                    pStatus.aiming = 0;
                }
                let multiplier = 2.0;

                if (job === 'ë²„ì„œì»¤') multiplier = 4.0;
                else if (job === 'ì•„í¬ë©”ì´ì§€') multiplier = 4.5;
                else if (job === 'ì „ì‚¬' || job === 'ê°€ë””ì–¸') multiplier = 2.5;
                else if (job === 'ë§ˆë²•ì‚¬' || job === 'ì†Œì„œëŸ¬') multiplier = 2.2;
                else if (job === 'ì—˜í”„ ê¶ìˆ˜') {
                    multiplier = 0.5; // ì•½í•œ ë°ë¯¸ì§€
                    isCrit = false; // í¬ë¦¬í‹°ì»¬ ì—†ìŒ
                }
                else if (job === 'ìŠ¤ë‚˜ì´í¼') multiplier = 1.5; // ìŠ¤ë‚˜ì´í¼ í—¤ë“œìƒ· ë°ë¯¸ì§€ ê³„ìˆ˜ ê°ì†Œ
                else if (job === 'ë ˆì¸ì €') multiplier = 1.0;

                if (currentWeather === "rain" && (job === 'ë§ˆë²•ì‚¬' || job === 'ì•„í¬ë©”ì´ì§€' || job === 'ì†Œì„œëŸ¬')) {
                    multiplier *= 1.3;
                    addLog("<span style='color:#82b1ff'>ë¹„ì˜ ê¸°ìš´ìœ¼ë¡œ ë§ˆë²•ì´ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤!</span>");
                }

                if(job === 'ì „ì‚¬' || job === 'ë²„ì„œì»¤' || job === 'ê°€ë””ì–¸') {
                    dmg = (player.stats.str * multiplier) + (player.level * 4);
                    if (job === 'ê°€ë””ì–¸' && Math.random() < 0.3) { eStatus.stun = 1; addLog("ì ì„ ê¸°ì ˆì‹œì¼°ìŠµë‹ˆë‹¤!"); }
                } else if (job === 'ì—˜í”„ ê¶ìˆ˜') {
                    dmg = (player.stats.dex * multiplier) + (player.level * 1);
                    pStatus.windAttribute = 3;
                    addLog("ğŸƒ [ë°”ëŒì˜ í™”ì‚´] 3í„´ê°„ ê³µê²©ì— ë°”ëŒ ì†ì„±ì´ ë¶€ì—¬ë©ë‹ˆë‹¤!");
                } else if (job === 'ìŠ¤ë‚˜ì´í¼') {
                    dmg = (enemy.hp * 0.1) + (player.stats.dex * multiplier) + (player.level * 2); // ìŠ¤ë‚˜ì´í¼ í—¤ë“œìƒ· ë ˆë²¨ ê³„ìˆ˜ ê°ì†Œ
                    isCrit = true;
                } else if (job === 'ë ˆì¸ì €') {
                    dmg = (player.stats.dex * multiplier) + (player.level * 2);
                    pStatus.doubleAttackChance = 3;
                    addLog("ë ˆì¸ì €ì˜ [í™”ì‚´ ë¹„]! 3í„´ê°„ ì—°ì† ê³µê²© í™•ë¥ ì´ 3ë°° ì¦ê°€í•©ë‹ˆë‹¤!");
                } else {
                    dmg = (player.stats.int * multiplier) + (player.level * 5);
                }

                if (pStatus.atkUp > 0 && (job === 'ë²„ì„œì»¤' || job === 'ì „ì‚¬')) dmg *= 2;

                dmg += (player.bonusAtk||0);
                if(isCrit) { dmg = Math.floor(dmg*2); playCritSfx(); }
            }

            if (pStatus.skillDmgUp > 0) {
                dmg = Math.floor(dmg * 1.5);
            }

            if (pStatus.nextSkillTriple > 0) {
                dmg *= 3;
                pStatus.nextSkillTriple = 0;
                pStatus.stun = 1;
                addLog("ë§ˆë ¥ í­ì£¼ ë°˜ë™ìœ¼ë¡œ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!");
            }

            if (isLegendary && (job === 'ì „ì‚¬' || job === 'ë²„ì„œì»¤' || job === 'ê°€ë””ì–¸')) {
                triggerScreenShake(true);
            }

            if (dmg > 0) {
                triggerHitEffect('enemy-frame', isCrit?'crit':'big');
                enemy.hp -= dmg;
                showDamage('enemy-frame', dmg, isCrit?'crit':'normal');
                if (isCrit) showCritEffect('enemy-frame');
                addLog(`ìŠ¤í‚¬ ì ì¤‘! <span class='log-dmg'>${dmg}</span> í”¼í•´!`);
            }

            update(); check();
        }

        function rageAtk() {
            if(isActing || rage < maxRage) return;
            if(pStatus.stun > 0) { addLog("ê¸°ì ˆ ìƒíƒœë¼ ë¶„ë…¸ ê³µê²©ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; }

            isActing = true;
            rage = 0;
            player.rage = 0;
            update();

            const pFrame = document.getElementById('player-frame');
            pFrame.classList.add('rage-active-aura');

            say('p', 'ë¶„ë…¸ì˜ ì¼ê²©!!!');
            playCritSfx();

            const killImg = document.getElementById('rage-kill-img');

            const baseJobs = ['ì „ì‚¬', 'ë„ì ', 'ë§ˆë²•ì‚¬', 'ì—˜í”„ ê¶ìˆ˜'];
            if (!baseJobs.includes(player.job)) {
                killImg.src = 'image/damage_kill1.jpg';
            } else {
                killImg.src = 'image/damage_kill.jpg';
            }

            killImg.classList.add('rage-kill-anim');
            setTimeout(() => killImg.classList.remove('rage-kill-anim'), 2000);

            setTimeout(() => {
                let dmg = (Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0)) * 3;

                if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                    dmg = (Math.floor(player.stats.dex/2.0) + (player.level*2) + 5 + (player.bonusAtk||0)) * 3;
                }

                if (pStatus.windAttribute > 0) {
                    const windDmg = Math.floor(player.stats.int * 0.5);
                    dmg += windDmg;
                    addLog(`ë°”ëŒ ì†ì„± ì¶”ê°€ í”¼í•´ <span class='log-dmg'>${windDmg}</span>!`);
                    if (Math.random() < 0.25) {
                        eStatus.stun = 1;
                        addLog("ë°”ëŒì˜ í˜ìœ¼ë¡œ ì ì´ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!");
                    }
                }

                if (pStatus.atkUpRanger > 0) {
                    dmg = Math.floor(dmg * 1.2);
                }

                const jobKey = player.job || 'ì „ì‚¬';
                const imgMap = {
                    'ì „ì‚¬':'atk-warrior', 'ë„ì ':'atk-rogue', 'ë§ˆë²•ì‚¬':'atk-mage', 'ì—˜í”„ ê¶ìˆ˜':'atk-archer',
                    'ë²„ì„œì»¤':'atk-warrior', 'ê°€ë””ì–¸':'atk-warrior',
                    'ì–´ìŒ”ì‹ ':'atk-rogue', 'ì„€ë„ìš°':'atk-rogue',
                    'ì•„í¬ë©”ì´ì§€':'atk-mage', 'ì†Œì„œëŸ¬':'atk-mage',
                    'ìŠ¤ë‚˜ì´í¼':'atk-archer', 'ë ˆì¸ì €':'atk-archer'
                };

                if (isLegendary && (player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸')) {
                    triggerScreenShake(true);
                }

                playMotion(imgMap[jobKey], 'enemy-frame', 'crit');
                enemy.hp -= dmg;
                showDamage('enemy-frame', dmg, 'crit');
                showCritEffect('enemy-frame');
                addLog(`ë¶„ë…¸ ê³µê²©! ì ì—ê²Œ <span class='log-dmg'>${dmg}</span>ì˜ ì¹˜ëª…ì ì¸ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);

                setTimeout(() => {
                    pFrame.classList.remove('rage-active-aura');
                }, 1000);

                update(); check();
            }, 500);
        }

        function check() { 
            if(enemy.hp <= 0) { say('e', 'í¬ìœ½..!'); setTimeout(win, 1000); }
            else { setTimeout(eTurn, 1500); }
        }
        
        function tickPlayerBuffs() {
            if (specialCooldown > 0) specialCooldown--;
            if (doubleAttackCooldown > 0) doubleAttackCooldown--;
            if (pStatus.defUp > 0) pStatus.defUp--;
            if (pStatus.atkUp > 0) pStatus.atkUp--;
            if (pStatus.invincible > 0) pStatus.invincible--;
            if (pStatus.zeroMana > 0) pStatus.zeroMana--;
            if (pStatus.skillDmgUp > 0) pStatus.skillDmgUp--;
            if (pStatus.critUp > 0) pStatus.critUp--;
            if (pStatus.evasionUp > 0) pStatus.evasionUp--;
            if (pStatus.doubleAttackChance > 0) pStatus.doubleAttackChance--;
            if (pStatus.invis > 0) pStatus.invis--;
            if (pStatus.windAttribute > 0) pStatus.windAttribute--;
            if (pStatus.atkUpRanger > 0) pStatus.atkUpRanger--;
            if (pStatus.evasionBoost > 0) pStatus.evasionBoost--;
            pStatus.counterReady = false; // Reset counter each turn
        }

        function eTurn() {
            if(eStatus.stun > 0) {
                addLog("ì ì´ ê¸°ì ˆ ìƒíƒœë¼ í–‰ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                eStatus.stun--;
                tickPlayerBuffs();
                update(); isActing = false; return;
            }

            if(eStatus.poison > 0) {
                const pDmg = Math.floor(enemy.maxHp * 0.05);
                enemy.hp -= pDmg;
                showDamage('enemy-frame', pDmg, 'poison');
                addLog(`ì ì´ ë…ìœ¼ë¡œ ì¸í•´ <span style="color:#9b26b6">${pDmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
                eStatus.poison--;
                update();
                if(enemy.hp <= 0) { win(); return; }
            }

            if(pStatus.poison > 0) {
                const pDmg = Math.floor(player.maxHp * 0.12);
                player.hp -= pDmg;
                showDamage('player-frame', pDmg, 'poison');
                addLog(`ë…ìœ¼ë¡œ ì¸í•´ <span style="color:#9b26b6">${pDmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
                pStatus.poison--;
                update();
                if(player.hp <= 0) { showGameOver("ë…ì— ì˜í•´ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤..."); return; }
            }

            let evadeChance = (player.stats.dex / 100) + (player.level * 0.005);
            if (player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°') evadeChance += 0.1;
            if (player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') evadeChance += 0.05; // ê¶ìˆ˜ ê¸°ë³¸ íšŒí”¼ìœ¨ ë³´ë„ˆìŠ¤
            if (pStatus.evasionUp > 0) evadeChance *= 2; // ì—˜í”„ ê¶ìˆ˜ íŠ¹ìˆ˜ê¸° íš¨ê³¼
            if (pStatus.invis > 0) evadeChance = 1.0; // ìŠ¤ë‚˜ì´í¼ ì€ì‹ 
            if (pStatus.evasionBoost > 0) evadeChance += 0.3; // ë„ì  ë°©ì–´ ë³´ë„ˆìŠ¤

            if (currentWeather === "fog" && !(player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €')) {
                evadeChance += 0.1;
            }
            evadeChance = Math.min(0.7, evadeChance); // Max evade chance increased for defense boost

            if (Math.random() < evadeChance) {
                addLog("<span class='log-evade'>ì ì˜ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!</span>");
                playEvadeSfx();
                say('p', 'ëŠë ¤!');
                playMotion('', 'player-frame', 'evade');
                showDamage('player-frame', 0, 'evade');
                playEnemyAttackMotion();

                if (pStatus.evasionBoost > 0) {
                    rage = Math.min(maxRage, rage + 20);
                    addLog("íšŒí”¼ ì„±ê³µ! ë¶„ë…¸ê°€ <span style='color:orange'>20</span> ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }

                tickPlayerBuffs();
                update(); isActing = false;
                return;
            }

            playEnemyAttackMotion();

            let dmg = Math.max(1, enemy.atk - Math.floor(player.stats.dex/3) - (player.bonusDef || 0));
            if (player.job === 'ê°€ë””ì–¸') dmg = Math.floor(dmg * 0.8);

            let isCrit = false;
            const critChance = 0.08;
            if (Math.random() < critChance) {
                dmg = Math.floor(dmg * 1.5);
                isCrit = true;
            }

            if (enemy.type === 'bear_warrior') {
                if (player.job === 'ë§ˆë²•ì‚¬' || player.job === 'ì•„í¬ë©”ì´ì§€' || player.job === 'ì†Œì„œëŸ¬') {
                    dmg = Math.floor(dmg * 1.3);
                    addLog("<span style='color:orange'>ê³°ì „ì‚¬ ì¶”íŒŒê°€ ë§ˆë²•ì‚¬ì—ê²Œ ì¶”ê°€ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤!</span>");
                }
            } else if (enemy.type === 'mage_holly') {
                if (player.job === 'ë„ì ' || player.job === 'ì–´ìŒ”ì‹ ' || player.job === 'ì„€ë„ìš°' ||
                    player.job === 'ì „ì‚¬' || player.job === 'ë²„ì„œì»¤' || player.job === 'ê°€ë””ì–¸' ||
                    player.job === 'ì—˜í”„ ê¶ìˆ˜' || player.job === 'ìŠ¤ë‚˜ì´í¼' || player.job === 'ë ˆì¸ì €') {
                    dmg = Math.floor(dmg * 1.3);
                    addLog("<span style='color:purple'>ë§ˆë²•ì‚¬ í™€ë¦¬ê°€ ë¬¼ë¦¬ ì§ì—…ì—ê²Œ ì¶”ê°€ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤!</span>");
                }
            }

            if (pStatus.invincible > 0) {
                dmg = 0;
                addLog("ì™„ì „ ë°©ì–´ë¡œ ê³µê²©ì„ ë¬´íš¨í™”í–ˆìŠµë‹ˆë‹¤!");
            } else if (pStatus.defUp > 0) {
                let reduction = 0.5;
                if (['ì „ì‚¬', 'ë²„ì„œì»¤', 'ê°€ë””ì–¸'].includes(player.job)) reduction = 0.4; // ì „ì‚¬ ê³„ì—´ 60% ê°ì†Œ
                dmg = Math.floor(dmg * reduction);
                addLog("ë°©ì–´ë¡œ ì¸í•´ í”¼í•´ê°€ í¬ê²Œ ê°ì†Œí–ˆìŠµë‹ˆë‹¤.");

                // ì „ì‚¬ ë°˜ê²© ë¡œì§
                if (pStatus.counterReady && dmg > 0) {
                    setTimeout(() => {
                        let counterDmg = Math.floor((player.stats.str/2) + player.level);
                        enemy.hp -= counterDmg;
                        showDamage('enemy-frame', counterDmg, 'normal');
                        addLog(`âš”ï¸ ë°˜ê²©! ì ì—ê²Œ <span class='log-dmg'>${counterDmg}</span>ì˜ í”¼í•´ë¥¼ ëŒë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤!`);
                        update();
                    }, 500);
                }
            }

            if (dmg > 0) {
                player.hp -= dmg;

                const cha = player.stats.cha || 10;
                const chaRageBonus = (cha - 10) * 0.005;
                rage = Math.min(maxRage, rage + Math.floor(dmg * 1.5 + chaRageBonus));
                player.rage = rage;

                playDamageSfx();
                const jobKey = player.job || 'ì „ì‚¬';
                const hitMap = {
                    'ì „ì‚¬':'hit-warrior', 'ë„ì ':'hit-rogue', 'ë§ˆë²•ì‚¬':'hit-mage', 'ì—˜í”„ ê¶ìˆ˜':'hit-archer',
                    'ë²„ì„œì»¤':'hit-warrior', 'ê°€ë””ì–¸':'hit-warrior',
                    'ì–´ìŒ”ì‹ ':'hit-rogue', 'ì„€ë„ìš°':'hit-rogue',
                    'ì•„í¬ë©”ì´ì§€':'hit-mage', 'ì†Œì„œëŸ¬':'hit-mage',
                    'ìŠ¤ë‚˜ì´í¼':'hit-archer', 'ë ˆì¸ì €':'hit-archer'
                };

                if (isCrit) {
                    triggerScreenShake(true);
                    playMotion(hitMap[jobKey], 'player-frame', 'big');
                    showDamage('player-frame', dmg, 'player_hit');
                    showCritEffect('player-frame');
                    say('e', 'í¬í•˜í•˜í•˜!');
                    addLog(`<span style='color:red; font-weight:bold; font-size:1.2rem;'>ì¹˜ëª…ìƒ! ${dmg} í”¼í•´!</span>`);
                } else {
                    playMotion(hitMap[jobKey], 'player-frame', 'player_hit');
                    showDamage('player-frame', dmg, 'player_hit');

                    if (enemy.speech && enemy.speech.length > 0) {
                        const randSpeech = enemy.speech[Math.floor(Math.random() * enemy.speech.length)];
                        say('e', randSpeech);
                    } else {
                        say('e', 'ë°›ì•„ë¼!');
                    }

                    addLog(`ì ì´ ê³µê²©í•©ë‹ˆë‹¤! <span style='color:red'>${dmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
                }

                let poisonChance = enemy.canPoison ? 0.3 : 0;
                if(Math.random() < poisonChance) { pStatus.poison = 3; addLog("<span style='color:#9b26b6'>ì ì˜ ê³µê²©ì— ì¤‘ë…ë˜ì—ˆìŠµë‹ˆë‹¤!</span>"); }
                if(Math.random() < 0.1) { pStatus.stun = 1; addLog("ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!"); }
            }

            tickPlayerBuffs();
            update(); isActing = false;
            if(player.hp <= 0) { showGameOver("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤..."); }
        }

        function sendRankingData(score, survivalTime) {
            const bossKills = player.quests.bossKillCount || 0;
            fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    type: 'ranking',
                    name: player.name,
                    score: score,
                    job: player.job,
                    level: player.level,
                    bossKills: bossKills
                })
            });
        }

        function showGameOver(msg) {
            isActing = true;
            document.querySelectorAll('.btns .btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            const rageBtn = document.getElementById('btn-rage');
            if(rageBtn) rageBtn.style.display = 'none';

            stopBossBgm();

            // ìŠ¤ì½”ì–´ ê³„ì‚° ì¤‘ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const calcOverlay = document.getElementById('score-calculating-overlay');
            calcOverlay.style.display = 'flex';

            setTimeout(() => {
                const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
                const survivalTime = Math.floor((Date.now() - startTime) / 1000);
                const min = Math.floor(survivalTime / 60);
                const sec = survivalTime % 60;

                const kills = player.quests.killCount || 0;
                const midBossKills = player.quests.bossKillCount || 0;
                const superBossKills = player.quests.superBossKillCount || 0;
                const normalKills = Math.max(0, kills - midBossKills - superBossKills);

                let itemValue = 0;
                player.inventory.forEach(item => {
                    if (item.type === 'weapon') {
                        if (item.rarity === 'legendary') itemValue += 5000;
                        else if (item.rarity === 'epic') itemValue += 2000;
                    } else if (item.type.includes('potion') || item.type.includes('scroll')) {
                        const rareItems = ['potion_full', 'potion_focus', 'potion_madness', 'potion_skeleton', 'potion_holy', 'potion_gamble', 'scroll_option'];
                        if (rareItems.includes(item.type)) itemValue += 500;
                    }
                });

                const lvScore = player.level * 1000;
                const midBossScore = midBossKills * 2000;
                const superBossScore = superBossKills * 10000;
                const normalScore = normalKills * 10;
                const goldScore = Math.floor(player.gold * 0.1);
                const survivalScore = survivalTime;
                const coinScore = player.coinScore || 0;
                const merchantScore = player.merchantUsed ? 1000 : 0;

                const totalScore = lvScore + midBossScore + superBossScore + normalScore + goldScore + itemValue + survivalScore + coinScore + merchantScore;

                const statsContainer = document.getElementById('go-stats-container');
                statsContainer.innerHTML = `
                    <div class="go-row"><div class="go-label">ğŸ”¹ ìºë¦­í„° ë ˆë²¨</div><div class="go-val">${player.level} (LV) <span style="color:#888; font-size:0.8rem;">+${lvScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸ’€ ìµœì¢… ë³´ìŠ¤ ì²˜ì¹˜</div><div class="go-val">${superBossKills} (ë§ˆë¦¬) <span style="color:#888; font-size:0.8rem;">+${superBossScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸ’€ ì¤‘ê°„ ë³´ìŠ¤ ì²˜ì¹˜</div><div class="go-val">${midBossKills} (ë§ˆë¦¬) <span style="color:#888; font-size:0.8rem;">+${midBossScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">âš”ï¸ ëª¬ìŠ¤í„° ì‚¬ëƒ¥</div><div class="go-val">${normalKills} (ë§ˆë¦¬) <span style="color:#888; font-size:0.8rem;">+${normalScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸ’° ë³´ìœ  ìì‚°</div><div class="go-val">${player.gold.toLocaleString()} (G) <span style="color:#888; font-size:0.8rem;">+${goldScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸ’ ì•„ì´í…œ ê°€ì¹˜</div><div class="go-val"><span style="color:#888; font-size:0.8rem;">+${itemValue.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸª™ ì½”ì¸ ì ìˆ˜</div><div class="go-val">${coinScore.toLocaleString()} <span style="color:#888; font-size:0.8rem;">+${coinScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">ğŸ° ê³ ë¸”ë¦° ìƒì¸ ì¡°ìš°</div><div class="go-val">${player.merchantUsed ? 'ì™„ë£Œ' : 'ë¯¸ë°œê²¬'} <span style="color:#888; font-size:0.8rem;">+${merchantScore.toLocaleString()}</span></div></div>
                    <div class="go-row"><div class="go-label">â³ ìƒì¡´ ë³´ë„ˆìŠ¤</div><div class="go-val">${min}ë¶„ ${sec}ì´ˆ <span style="color:#888; font-size:0.8rem;">+${survivalScore.toLocaleString()}</span></div></div>
                `;

                document.querySelector('.gameover-title').innerText = msg;
                document.getElementById('go-score-val').innerText = totalScore.toLocaleString();

                sendRankingData(totalScore, survivalTime);

                localStorage.removeItem('rpg_temp_player');
                localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
                localStorage.removeItem('rpg_boss_death_time');

                calcOverlay.style.display = 'none';
                document.getElementById('gameover-modal').style.display = 'flex';
            }, 2000); // 2ì´ˆê°„ ê³„ì‚° ì¤‘ ë©”ì‹œì§€ í‘œì‹œ
        }

        function getWeaponImage(job, rarity) {
            let baseJob = 'ì „ì‚¬';
            if (['ë„ì ', 'ì–´ìŒ”ì‹ ', 'ì„€ë„ìš°'].includes(job)) baseJob = 'ë„ì ';
            if (['ë§ˆë²•ì‚¬', 'ì•„í¬ë©”ì´ì§€', 'ì†Œì„œëŸ¬'].includes(job)) baseJob = 'ë§ˆë²•ì‚¬';
            if (['ì—˜í”„ ê¶ìˆ˜', 'ìŠ¤ë‚˜ì´í¼', 'ë ˆì¸ì €'].includes(job)) baseJob = 'ì—˜í”„ ê¶ìˆ˜';

            if (baseJob === 'ì „ì‚¬') {
                if (rarity === 'legendary') return 'legend_warrior.jpg';
                if (rarity === 'epic') return 'epic_warrior.jpg';
                return 'weapon_warrior.jpg';
            } else if (baseJob === 'ë„ì ') {
                if (rarity === 'legendary') return 'legend_rogue.jpg';
                if (rarity === 'epic') return 'epic_rogue.jpg';
                return 'weapon_rogue.jpg';
            } else if (baseJob === 'ë§ˆë²•ì‚¬') {
                if (rarity === 'legendary') return 'legend_mage.jpg';
                if (rarity === 'epic') return 'epic_mage.jpg';
                return 'weapon_mage.jpg';
            } else if (baseJob === 'ì—˜í”„ ê¶ìˆ˜') {
                if (rarity === 'legendary') return 'legend_archer.jpg';
                if (rarity === 'epic') return 'epic_archer.jpg';
                if (rarity === 'rare') return 'rare_archer.jpg';
                return 'weapon_archer.jpg';
            }
            return 'weapon_warrior.jpg';
        }

        function win() {
            stopBossBgm();
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            if (isBossBattle) {
                if (isSuperBoss) {
                    localStorage.setItem('rpg_super_boss_killed', 'true');
                    player.quests.superBossKillCount = (player.quests.superBossKillCount || 0) + 1;
                } else {
                    localStorage.setItem('rpg_boss_death_time', Date.now());
                    player.quests.bossKillCount = (player.quests.bossKillCount || 0) + 1;
                }
                localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
            } else {
                if (isNight) player.quests.nightKillCount = (player.quests.nightKillCount || 0) + 1;
                else player.quests.dayKillCount = (player.quests.dayKillCount || 0) + 1;
            }

            player.exp += enemy.exp;
            player.quests.killCount++;

            let resultHTML = `<div class="result-row">íšë“ ê²½í—˜ì¹˜ <span style="color:violet">+${enemy.exp} EXP</span></div>`;

            const gold = Math.floor(Math.random()*50)+10 + (isBossBattle ? 500 : 0);
            player.gold = (player.gold||0) + gold;
            resultHTML += `<div class="result-row">íšë“ ê³¨ë“œ <span style="color:gold">+${gold} G</span></div>`;
            playGoldSfx();

            const drops = [];
            const cha = player.stats.cha || 10;
            const chaDropBonus = (cha - 10) * 0.005;

            const generateConsumable = () => {
                const r = Math.random();
                const ns = isNight ? "_night" : "";
                const holyNs = isNight ? "_night" : "";
                let item = null;
                let rarity = 'common';

                if (r < 0.008 + chaDropBonus) {
                    const img = "potion_full" + ns + ".jpg";
                    item = {name:'í’€ íšŒë³µ í¬ì…˜', type:'potion_full', desc:'HPì™€ MPë¥¼ ëª¨ë‘ íšŒë³µí•©ë‹ˆë‹¤.', val:200, img: img};
                    rarity = 'epic';
                } else if (r < 0.018 + chaDropBonus) {
                     const img = "potion_focus" + ns + ".jpg";
                     item = {name:'ì •ì‹  ì§‘ì¤‘ í¬ì…˜', type:'potion_focus', desc:'ë‹¤ìŒ ìŠ¤í‚¬ ë§ˆë‚˜ 0 & 3í„´ê°„ ìŠ¤í‚¬ ë°ë¯¸ì§€ 50% ì¦ê°€', val:0, img: img};
                     rarity = 'rare';
                } else if (r < 0.03 + chaDropBonus) {
                     const img = "potion_madness" + ns + ".jpg";
                     item = {name:'ê´‘ê¸°ì˜ ë¬¼ì•½', type:'potion_madness', desc:'HP 30% ê°ì†Œ, 3í„´ê°„ 100% í¬ë¦¬í‹°ì»¬', val:0, img: img};
                     rarity = 'rare';
                } else if (r < 0.05 + chaDropBonus) {
                    const img = "potion_skeleton" + ns + ".jpg";
                    item = {name:'í•´ê³¨ í¬ì…˜', type:'potion_skeleton', desc:'HP/MP ì™„ì „ íšŒë³µ (ë‹¤ìŒ ì „íˆ¬ ì €ì£¼)', val:0, img: img};
                    rarity = 'rare';
                } else if (r < 0.08 + chaDropBonus) {
                     const img = "potion_holy" + holyNs + ".jpg";
                     item = {name:'ì •í™”ì˜ ì„±ìˆ˜', type:'potion_holy', desc:'ëª¨ë“  ìƒíƒœ ì´ìƒ í•´ì œ', val:0, img: img};
                     rarity = 'rare';
                } else if (r < 0.12 + chaDropBonus) {
                    const img = "potion_gamble" + ns + ".jpg";
                    item = {name:'ë„ë°•ì‚¬ì˜ ì‹œì•½', type:'potion_gamble', desc:'8ê°€ì§€ íš¨ê³¼ ì¤‘ í•˜ë‚˜ê°€ ë¬´ì‘ìœ„ë¡œ ë°œë™í•©ë‹ˆë‹¤.', val:0, img: img};
                    rarity = 'rare';
                } else if (r < 0.25 + chaDropBonus) {
                    const img = "Scroll" + ns + ".jpg";
                    item = {name:'ì˜µì…˜ ë¶€ì—¬ ìŠ¤í¬ë¡¤', type:'scroll_option', desc:'ì¥ë¹„ ì˜µì…˜ ì¬ì„¤ì • (1~3ê°œ)', val:0, img: img};
                    rarity = 'epic';
                } else {
                    const subR = Math.random();
                    if(subR < 0.3) { const img = "potion_hp" + ns + ".jpg"; item = {name:'ì²´ë ¥ ë¬¼ì•½', type:'potion_hp', desc:'HP +50 íšŒë³µ', val:50, img: img}; }
                    else if(subR < 0.6) { const img = "potion_mp" + ns + ".jpg"; item = {name:'ë§ˆë‚˜ ë¬¼ì•½', type:'potion_mp', desc:'MP +30 íšŒë³µ', val:30, img: img}; }
                    else if(subR < 0.8) { const img = "potion_exp" + ns + ".jpg"; item = {name:'ê²½í—˜ì¹˜ ë¬¼ì•½', type:'potion_exp', desc:'EXP +100 íšë“', val:100, img: img}; }
                    else { const img = "potion_poison" + ns + ".jpg"; item = {name:'í•´ë… ë¬¼ì•½', type:'potion_poison', desc:'ë… ìƒíƒœ í•´ì œ', val:0, img: img}; }
                }
                return { item, rarity };
            };

            const rand = Math.random();
            if (isBossBattle && rand < 0.5 + chaDropBonus) {
                const jobList = DROP_TABLE[player.job] || DROP_TABLE['ì „ì‚¬'];
                const baseName = jobList[Math.floor(Math.random() * jobList.length)];
                let isLegendary = isSuperBoss || Math.random() < 0.3 + chaDropBonus;
                if (!player.isAdvanced) isLegendary = false;
                let grade = isLegendary ? Math.floor(Math.random() * 6) + 10 : Math.floor(Math.random() * 5) + 8;
                let colorCode = isLegendary ? "#ff8000" : "#a335ee";
                let rarityName = isLegendary ? "ì „ì„¤ì˜" : "ì—í”½";
                const newItem = { name: `${rarityName} ${baseName} (+${grade})`, type: 'weapon', desc: `ê³µê²©ë ¥ +${grade} (${player.job} ì „ìš©)`, val: grade, reqJob: player.job, equipped: false, rarity: isLegendary ? "legendary" : "epic", rarityColor: colorCode, enhanceCount: grade, options: [] };
                const optCount = isLegendary ? 3 : 1;
                const possibleOpts = [{name:"í˜",key:"str",val:Math.floor(Math.random()*5)+2}, {name:"ë¯¼ì²©",key:"dex",val:Math.floor(Math.random()*5)+2}, {name:"ì²´ë ¥",key:"con",val:Math.floor(Math.random()*5)+2}, {name:"ì§€ëŠ¥",key:"int",val:Math.floor(Math.random()*5)+2}];
                for(let i=0; i<optCount; i++) { const opt = possibleOpts[Math.floor(Math.random()*possibleOpts.length)]; newItem.options.push(opt); newItem.desc += `\n[ì˜µì…˜] ${opt.name} +${opt.val}`; }

                if (newItem.rarity === "legendary") {
                     const specialOpt = LEGENDARY_SPECIAL_OPTIONS[Math.floor(Math.random() * LEGENDARY_SPECIAL_OPTIONS.length)];
                     newItem.specialOption = specialOpt;
                     newItem.desc += `\n<span style='color:#b2ff59; font-weight:bold;'>[íŠ¹ìˆ˜] ${specialOpt.name}</span>\n<span style='color:#aaa; font-size:0.7rem;'>${specialOpt.desc}</span>`;
                }

                drops.push({ item: newItem, rarity: newItem.rarity });
            } 
            else if (!isBossBattle && rand < 0.05 + chaDropBonus) {
                const nameList = DROP_TABLE[player.job] || DROP_TABLE['ì „ì‚¬'];
                const baseName = nameList[Math.floor(Math.random() * nameList.length)];
                let isLegendary = false;
                if (player.isAdvanced && Math.random() < 0.01 + chaDropBonus) isLegendary = true;
                let grade = isLegendary ? Math.floor(Math.random() * 6) + 10 : Math.floor(Math.random() * 5) + 8;
                let colorCode = isLegendary ? "#ff8000" : "#a335ee";
                let rarityName = isLegendary ? "ì „ì„¤ì˜" : "ì—í”½";
                let rarity = isLegendary ? "legendary" : "epic";
                const newItem = { name: `${rarityName} ${baseName} (+${grade})`, type: 'weapon', desc: `ê³µê²©ë ¥ +${grade} (${player.job} ì „ìš©)`, val: grade, reqJob: player.job, equipped: false, rarity: rarity, rarityColor: colorCode, enhanceCount: grade, options: [] };
                const optCount = isLegendary ? 3 : 1;
                const possibleOpts = [{name:"í˜",key:"str",val:Math.floor(Math.random()*5)+1}, {name:"ë¯¼ì²©",key:"dex",val:Math.floor(Math.random()*5)+1}, {name:"ì²´ë ¥",key:"con",val:Math.floor(Math.random()*5)+1}, {name:"ì§€ëŠ¥",key:"int",val:Math.floor(Math.random()*5)+1}];
                for(let i=0; i<optCount; i++) { const opt = possibleOpts[Math.floor(Math.random()*possibleOpts.length)]; newItem.options.push(opt); newItem.desc += `\n[ì˜µì…˜] ${opt.name} +${opt.val}`; }

                if (newItem.rarity === "legendary") {
                     const specialOpt = LEGENDARY_SPECIAL_OPTIONS[Math.floor(Math.random() * LEGENDARY_SPECIAL_OPTIONS.length)];
                     newItem.specialOption = specialOpt;
                     newItem.desc += `\n<span style='color:#b2ff59; font-weight:bold;'>[íŠ¹ìˆ˜] ${specialOpt.name}</span>\n<span style='color:#aaa; font-size:0.7rem;'>${specialOpt.desc}</span>`;
                }

                drops.push({ item: newItem, rarity: newItem.rarity });
            }
            else if (Math.random() < 0.6 + chaDropBonus) {
                drops.push(generateConsumable());
            }
            else if (Math.random() < 0.2 + chaDropBonus) {
                const rand = Math.random();
                const ns = isNight ? "_night" : "";
                let item = null;
                if(rand < 0.5) {
                    const val = Math.floor(Math.random() * 5) + 1;
                    const img = "attack_10" + ns + ".jpg";
                    item = {name:'ê³µê²©ë ¥ ê°•í™” ë¬¼ì•½', type:'potion_atk', desc:`ê³µê²©ë ¥ +${val} ì˜êµ¬ ì¦ê°€`, val:val, img: img};
                } else {
                    const val = Math.random() < 0.5 ? 1 : 5;
                    const img = "Defense_10" + ns + ".jpg";
                    item = {name:'ë°©ì–´ë ¥ ê°•í™” ë¬¼ì•½', type:'potion_def', desc:`ë°©ì–´ë ¥ +${val} ì˜êµ¬ ì¦ê°€`, val:val, img: img};
                }
                drops.push({ item: item, rarity: 'rare' });
            }

            if (drops.length > 0 && Math.random() < 0.05 + (chaDropBonus/2)) {
                drops.push(generateConsumable());
                addLog("<span style='color:#ffd700; font-weight:bold;'>ğŸ€ í–‰ìš´! ì•„ì´í…œì„ í•˜ë‚˜ ë” ë°œê²¬í–ˆìŠµë‹ˆë‹¤!</span>");
            }

            let bestDrop = null;
            const rarityWeight = { 'legendary': 4, 'epic': 3, 'rare': 2, 'common': 1 };

            drops.forEach(d => {
                player.inventory.push(d.item);

                let dropColor = "#fff";
                if (d.rarity === 'legendary') dropColor = "#ff8000";
                else if (d.rarity === 'epic') dropColor = "#a335ee";
                else if (d.rarity === 'rare') dropColor = "#2196f3";

                let dropImg = d.item.img;
                if (d.item.type === 'weapon') dropImg = getWeaponImage(player.job, d.item.rarity);

                resultHTML += `<div class="result-item-box"><img src="image/${dropImg}" class="result-item-img"><div class="result-item-name" style="color:${dropColor}">${d.item.name}</div><div style="font-size:0.8rem; color:#aaa;">ì•„ì´í…œì„ íšë“í–ˆìŠµë‹ˆë‹¤!</div></div>`;

                if (!bestDrop || rarityWeight[d.rarity] > rarityWeight[bestDrop.rarity]) {
                    bestDrop = d;
                    bestDrop.displayImg = dropImg;
                }
            });

            if (drops.length > 0) {
                playItemSfx();
                const imgEl = document.getElementById('drop-item-img');
                imgEl.src = `image/${bestDrop.displayImg}`;

                imgEl.className = 'drop-item-effect';
                if (bestDrop.rarity === 'legendary') imgEl.classList.add('border-legendary');
                else if (bestDrop.rarity === 'epic') imgEl.classList.add('border-epic');
                else if (bestDrop.rarity === 'rare') imgEl.classList.add('border-rare');
                else imgEl.classList.add('border-common');

                imgEl.style.display = 'block';
                setTimeout(() => { imgEl.style.display = 'none'; showResultModal(resultHTML); }, 2000);
            } else {
                showResultModal(resultHTML);
            }
        }

        function showResultModal(html) { document.getElementById('result-content').innerHTML = html; document.getElementById('result-modal').style.display = 'flex'; }
        
        function checkLevelUpOrFinish() { 
            document.getElementById('result-modal').style.display = 'none'; 
            if(player.exp >= player.maxExp) { showLevelUpModal(); } 
            else { finishBattle(); } 
        }
        
        function showLevelUpModal() {
            playLevelupSfx();
            const modal = document.getElementById('levelup-modal');
            const oldLv = player.level;
            const oldHp = player.maxHp;
            const oldMp = player.maxMp;
            player.level++;
            player.exp -= player.maxExp;
            player.maxExp = Math.floor(player.maxExp * 1.5);
            player.maxHp += 10;
            player.maxMp += 5;
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            player.traitPoints = (player.traitPoints || 0) + 2;
            document.getElementById('old-lv').innerText = oldLv;
            document.getElementById('new-lv').innerText = player.level;
            document.getElementById('stat-hp').innerHTML = `${Math.round(oldHp)} <span class='stat-up'>â–· ${Math.round(player.maxHp)} (+10)</span>`;
            document.getElementById('stat-mp').innerHTML = `${Math.round(oldMp)} <span class='stat-up'>â–· ${Math.round(player.maxMp)} (+5)</span>`;

            const btn = document.getElementById('lv-confirm-btn');
            if (player.level >= 5 && !player.isAdvanced) {
                btn.innerText = "ì „ì§í•˜ëŸ¬ ê°€ê¸°";
            } else {
                btn.innerText = "íŠ¹ì„± ë¶„ë°°í•˜ëŸ¬ ê°€ê¸°";
            }

            modal.style.display = 'flex';
        }
        
        function finishBattle() {
            player.rage = rage;
            player.specialCooldown = specialCooldown;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            location.href = 'map.html';
        }

        function finishBattleWithLevelUp() {
            player.rage = rage;
            player.specialCooldown = specialCooldown;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            if (!(player.level >= 5 && !player.isAdvanced)) {
                localStorage.setItem('rpg_open_traits', 'true');
            }
            location.href = 'map.html';
        }
        
        function run() { 
            if(isActing) return; isActing = true; 

            const cha = player.stats.cha || 10;
            const chaRunBonus = (cha - 10) * 0.01; // 1% per CHA point above 10

            let runChance = isBossBattle ? 0.3 : 0.4;
            runChance += chaRunBonus;

            if(Math.random() < runChance) {
                say('p', "íŠ€ì–´!");
                addLog("ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤!");
                stopBossBgm();

                if (isBossBattle && !isSuperBoss) {
                    localStorage.setItem('rpg_boss_ran_away', 'true');
                }

                setTimeout(finishBattle, 1200);
            }
            else {
                say('p', "ì‹¤íŒ¨..!");
                addLog("ë„ë§ì¹˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!");
                setTimeout(eTurn, 1500);
            }
        }

        function openItemModal() {
            if(isActing) return;
            const modal = document.getElementById('item-modal');
            const list = document.getElementById('item-list');
            list.innerHTML = '';
            const potions = player.inventory.filter(i => i.type.includes('potion'));
            const potionGroups = {};
            potions.forEach((p, idx) => {
                const originalIdx = player.inventory.indexOf(p);
                if (!potionGroups[p.name]) potionGroups[p.name] = { item: p, count: 0, indices: [] };
                potionGroups[p.name].count++;
                potionGroups[p.name].indices.push(originalIdx);
            });

            if (Object.keys(potionGroups).length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                for (const key in potionGroups) {
                    const group = potionGroups[key];
                    const item = group.item;
                    const div = document.createElement('div');
                    div.className = 'battle-item-row';
                    let iconSrc = item.img || ITEM_IMAGES[item.type] || 'potion_hp.jpg';

                    div.innerHTML = `<img src="image/${iconSrc}" class="battle-item-icon"><div class="battle-item-info"><div class="battle-item-name">${item.name}<span class="battle-item-count">x${group.count}</span></div><div class="battle-item-desc">${item.desc}</div></div>`;
                    div.onclick = () => useBattleItem(group.indices[0]);
                    list.appendChild(div);
                }
            }
            modal.style.display = 'flex';
        }

        function closeItemModal() { document.getElementById('item-modal').style.display = 'none'; }

        function useBattleItem(index) {
            closeItemModal();
            if(isActing) return;
            const item = player.inventory[index];
            if (!item) return;

            let handledByPopup = false;

            if (item.type === 'potion_full') {
                isActing = true;
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                addLog(`<span style="color:#00e676">í’€ íšŒë³µ í¬ì…˜</span>ì„ ì‚¬ìš©í•˜ì—¬ HPì™€ MPë¥¼ ëª¨ë‘ íšŒë³µí–ˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
            } else if (item.name.includes('ì²´ë ¥')) {
                if (player.hp >= player.maxHp) { addLog("ì²´ë ¥ì´ ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); return; }
                isActing = true;
                const heal = item.val;
                player.hp = Math.min(player.hp + heal, player.maxHp);
                addLog(`<span style="color:#ff5252">ì²´ë ¥ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ HPë¥¼ <span style="color:#00e676">${heal}</span> íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
                playPotionSfx();
            } else if (item.name.includes('ë§ˆë‚˜')) {
                if (player.mp >= player.maxMp) { addLog("ë§ˆë‚˜ê°€ ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); return; }
                isActing = true;
                const heal = item.val;
                player.mp = Math.min(player.mp + heal, player.maxMp);
                addLog(`<span style="color:#2979ff">ë§ˆë‚˜ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ MPë¥¼ <span style="color:#2979ff">${heal}</span> íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
                playPotionSfx();
            } else if (item.name.includes('ê²½í—˜ì¹˜')) {
                isActing = true;
                player.exp += item.val;
                addLog(`<span style="color:#e040fb">ê²½í—˜ì¹˜ ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ ê²½í—˜ì¹˜ë¥¼ <span style="color:#e040fb">${item.val}</span> íšë“í–ˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
            } else if (item.type === 'potion_poison') {
                if (pStatus.poison <= 0) { addLog("ë… ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."); return; }
                isActing = true;
                pStatus.poison = 0;
                addLog(`<span style="color:#00e676">í•´ë… ë¬¼ì•½</span>ì„ ì‚¬ìš©í•˜ì—¬ ë…ì„ ì¹˜ë£Œí–ˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
                const cureEl = document.getElementById('p-cure');
                cureEl.style.display = 'block';
                setTimeout(() => { cureEl.style.display = 'none'; }, 1000);
            } else if (item.type === 'potion_skeleton') {
                isActing = true;
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                player.battleCurse = true;
                addLog(`<span style="color:#757575">í•´ê³¨ í¬ì…˜</span>ì„ ì‚¬ìš©í•˜ì—¬ ì²´ë ¥ê³¼ ë§ˆë‚˜ë¥¼ ëª¨ë‘ íšŒë³µí–ˆìŠµë‹ˆë‹¤...`);
                playPotionSfx();
            } else if (item.type === 'potion_focus') {
                isActing = true;
                pStatus.nextSkillZeroCost = 1;
                pStatus.skillDmgUp = 3;
                showEffectPopup("ì •ì‹  ì§‘ì¤‘", "ë‹¤ìŒ ìŠ¤í‚¬ ë§ˆë‚˜ ì†Œëª¨ 0\n3í„´ê°„ ìŠ¤í‚¬ ë°ë¯¸ì§€ 50% ì¦ê°€", item.img || "potion_focus.jpg");
                playPotionSfx();
                handledByPopup = true;
            } else if (item.type === 'potion_holy') {
                isActing = true;
                pStatus.poison = 0;
                pStatus.stun = 0;
                addLog(`<span style="color:#00e676">ì •í™”ì˜ ì„±ìˆ˜</span>ê°€ ëª¨ë“  ìƒíƒœ ì´ìƒì„ ì”»ì–´ëƒˆìŠµë‹ˆë‹¤!`);
                playPotionSfx();
                const cureEl = document.getElementById('p-cure');
                cureEl.style.display = 'block';
                setTimeout(() => { cureEl.style.display = 'none'; }, 1000);
            } else if (item.type === 'potion_madness') {
                isActing = true;
                const dmg = Math.floor(player.hp * 0.3);
                player.hp = Math.max(1, player.hp - dmg);
                pStatus.critUp = 3;
                showDamage('player-frame', dmg, 'player_hit');
                showEffectPopup("ê´‘ê¸°ì˜ í˜", `HP ${dmg} ê°ì†Œ\n3í„´ê°„ í¬ë¦¬í‹°ì»¬ 100%`, item.img || "potion_madness.jpg");
                playPotionSfx();
                handledByPopup = true;
            } else if (item.type === 'potion_gamble') {
                isActing = true;
                player.inventory.splice(index, 1);
                const rand = Math.random() * 100;
                playItemSfx();

                if (rand < 5) { // 1. í™©ê¸ˆì˜ ì†
                    const stolenGold = (player.level * 150) + 300;
                    player.gold += stolenGold;
                    addLog(`<span style='color:gold; font-weight:bold;'>ğŸ’° í™©ê¸ˆì˜ ì†! ì ì„ í„¸ì–´ ${stolenGold}Gë¥¼ ì–»ê³  ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!</span>`);
                    setTimeout(win, 1000);
                    return;
                }
                else if (rand < 15) { // 2. ì‹œê³µê°„ì˜ ë’¤í‹€ë¦¼
                    const pHpP = player.hp / player.maxHp;
                    const eHpP = enemy.hp / enemy.maxHp;
                    player.hp = player.maxHp * eHpP;
                    enemy.hp = enemy.maxHp * pHpP;
                    addLog("<span style='color:#9c27b0;'>ğŸŒ€ ì‹œê³µê°„ì˜ ë’¤í‹€ë¦¼! ì ê³¼ ë‚˜ì˜ ì²´ë ¥ ë¹„ìœ¨ì´ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤!</span>");
                }
                else if (rand < 30) { // 3. ë…ì´ ë“  ì„±ë°°
                    eStatus.poison = 5; pStatus.poison = 3;
                    addLog("<span style='color:#4caf50;'>ğŸ§ª ë…ì´ ë“  ì„±ë°°! ì„œë¡œì—ê²Œ ì¹˜ëª…ì ì¸ ë…ì„ ì£¼ì…í•©ë‹ˆë‹¤.</span>");
                }
                else if (rand < 55) { // 4. ë¯¸ì™„ì„±ëœ í­ë°œ
                    const pDmg = Math.floor(player.hp * 0.3);
                    const eDmg = Math.floor(enemy.hp * 0.3);
                    player.hp -= pDmg; enemy.hp -= eDmg;
                    showDamage('player-frame', pDmg, 'player_hit');
                    showDamage('enemy-frame', eDmg, 'normal');
                    triggerScreenShake(true);
                    addLog("<span style='color:#ff5722;'>ğŸ’¥ ë¯¸ì™„ì„±ëœ í­ë°œ! ëª¨ë‘ì—ê²Œ í˜„ì¬ ì²´ë ¥ì˜ 30% í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤!</span>");
                }
                else if (rand < 65) { // 5. ê°€ë°©ì˜ ê¸°ì 
                    const potions = player.inventory.filter(i => i.type.includes('potion') && i.type !== 'potion_gamble');
                    if (potions.length > 0) {
                        const randomPotion = potions[Math.floor(Math.random() * potions.length)];
                        if (player.inventory.length < 24) {
                            player.inventory.push({...randomPotion});
                            addLog(`<span style='color:#e040fb;'>ğŸ’ ê°€ë°©ì˜ ê¸°ì ! [${randomPotion.name}]ì„(ë¥¼) ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!</span>`);
                        } else {
                            addLog(`<span style='color:#e040fb;'>ğŸ’ ê°€ë°©ì´ ê°€ë“ ì°¨ [${randomPotion.name}]ì˜ íš¨ê³¼ë¥¼ ì¦‰ì‹œ ë°œë™í•©ë‹ˆë‹¤!</span>`);
                            player.hp = Math.min(player.maxHp, player.hp + 50);
                        }
                    } else { addLog("ë³µì‚¬í•  ë¬¼ì•½ì´ ì—†ì–´ íš¨ê³¼ê°€ ì†Œë©¸í–ˆìŠµë‹ˆë‹¤."); }
                }
                else if (rand < 75) { // 6. ë¶„ë…¸ì˜ í™”ì‹ 
                    rage = 100; player.rage = 100;
                    addLog("<span style='color:#ff9800; font-weight:bold;'>ğŸ”¥ ë¶„ë…¸ì˜ í™”ì‹ ! ë¶„ë…¸ ê²Œì´ì§€ê°€ ì¦‰ì‹œ ì¶©ì „ë©ë‹ˆë‹¤!</span>");
                }
                else if (rand < 95) { // 7. ê°•ì œ ì°¨ì› ì´ë™
                    addLog("<span style='color:#607d8b;'>ğŸŒ«ï¸ ê°•ì œ ì°¨ì› ì´ë™! ì „íˆ¬ì—ì„œ ê°•ì œë¡œ ì´íƒˆí•©ë‹ˆë‹¤.</span>");
                    setTimeout(finishBattle, 1200);
                    return;
                }
                else { // 8. ì‹ ì˜ ê°€í˜¸
                    pStatus.invincible = 3;
                    player.hp = Math.min(player.maxHp, player.hp + (player.maxHp * 0.5));
                    player.mp = Math.min(player.maxMp, player.mp + (player.maxMp * 0.5));
                    addLog("<span style='color:#ffd700; font-weight:bold;'>âœ¨ ì‹ ì˜ ê°€í˜¸! 3í„´ ë¬´ì  ë° ì²´ë ¥/ë§ˆë‚˜ê°€ íšŒë³µë©ë‹ˆë‹¤!</span>");
                }

                update();
                if (enemy.hp <= 0) setTimeout(win, 1000);
                else if (player.hp <= 0) showGameOver("ë„ë°•ì˜ ëŒ€ê°€ëŠ” ì£½ìŒì´ì—ˆìŠµë‹ˆë‹¤.");
                else setTimeout(eTurn, 1500);
                return;
            }

            player.inventory.splice(index, 1);

            if (!handledByPopup) {
                update();
                setTimeout(eTurn, 1500);
            }
        }

        function showEffectPopup(title, desc, img) {
            document.getElementById('effect-title').innerText = title;
            document.getElementById('effect-desc').innerText = desc;
            document.getElementById('effect-img').src = 'image/' + img;
            document.getElementById('effect-modal').style.display = 'flex';
        }

        function closeEffectModal() {
            document.getElementById('effect-modal').style.display = 'none';
            update();
            setTimeout(eTurn, 1500);
        }
    </script>
</body>
</html>
