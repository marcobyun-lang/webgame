<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DUNGEON RPG - Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Cinzel:wght@700&family=Noto+Serif+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #050505; 
            --panel-bg: rgba(20, 20, 25, 0.95); 
            --border-color: #5c4d3c; 
            --accent-gold: #ffd700; 
            --accent-red: #ff3333; 
            --danger: #ff1744; 
            --mp-color: #2979ff; 
            --rage-color: #ff9800;
            --text-main: #e0e0e0;
            --font-combat: 'Black Han Sans', sans-serif;
            --font-ui: 'Noto Serif KR', serif;
            --font-eng: 'Cinzel', serif;
        }

        body { 
            background-color: var(--bg-color); 
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), repeating-linear-gradient(45deg, #121212 0, #121212 10px, #0a0a0a 10px, #0a0a0a 20px); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; user-select: none;
        }

        #game-container { 
            width: 960px; height: 720px; 
            background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('image/map.jpg') center/cover;
            border: 2px solid #333; 
            box-shadow: 0 0 80px rgba(0,0,0,0.9), inset 0 0 100px rgba(0,0,0,0.8); 
            border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }

        #game-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 60%, black 100%); pointer-events: none; z-index: 5; }
        
        .battle-stage { display: flex; justify-content: space-around; align-items: center; width: 90%; margin-bottom: 20px; z-index: 20; position: relative; }
        .unit-box { text-align: center; width: 260px; position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .unit-frame {
            width: 180px; height: 180px; 
            border: 4px solid #444; border-radius: 8px; 
            overflow: hidden; position: relative; background: #111;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 1; 
            transition: transform 0.1s;
        }
        .unit-img, video { width: 100% !important; height: 100% !important; object-fit: cover !important; background-color: #000; }
        
        .unit-info { margin-top: 15px; width: 100%; text-shadow: 2px 2px 4px #000; }
        .unit-name { font-family: var(--font-combat); font-size: 1.5rem; color: #fff; margin: 0; letter-spacing: 1px; }
        .unit-job { font-family: var(--font-eng); font-size: 0.8rem; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        
        .bar-container { width: 100%; display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
        .bar-wrap { 
            background: #111; height: 16px; border: 1px solid #333; 
            border-radius: 3px; overflow: hidden; position: relative; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
        }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; position: relative; }
        .bar-fill::after { content:""; position:absolute; top:0; left:0; width:100%; height:50%; background:rgba(255,255,255,0.2); }
        .hp-bar { background: linear-gradient(90deg, #b71c1c, #ff5252); }
        .mp-bar { background: linear-gradient(90deg, #0d47a1, #448aff); }
        .rage-bar { background: linear-gradient(90deg, #e65100, #ff9800); }

        .bar-text { 
            position: absolute; width: 100%; top: 0; left: 0; line-height: 16px; 
            font-size: 10px; font-family: var(--font-eng); font-weight: bold; text-align: center; 
            text-shadow: 1px 1px 2px #000; z-index: 5; color: #fff; letter-spacing: 1px;
        }

        .status-effects { display: flex; gap: 5px; margin-top: 5px; justify-content: center; min-height: 20px; }
        .status-icon { padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: #fff; }
        .status-poison { background: #4caf50; }
        .status-stun { background: #ffeb3b; color: #000; }

        .speech {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.95); color: #000; padding: 8px 16px; border: 2px solid #000; 
            border-radius: 8px; font-family: var(--font-ui); font-weight: bold; font-size: 0.95rem; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; z-index: 100; white-space: nowrap; 
            animation: float 2s infinite ease-in-out;
        }
        .speech::after { content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); border-width:8px 8px 0; border-style:solid; border-color:rgba(255,255,255,0.95) transparent transparent transparent; }
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }
        
        .vs-text { font-family: var(--font-eng); font-size: 4rem; color: rgba(255,255,255,0.1); font-style: italic; font-weight: bold; }

        .log-panel {
            width: 700px; height: 100px; 
            background: rgba(0,0,0,0.7); border: 1px solid #444; border-radius: 4px;
            padding: 15px; overflow-y: auto; margin-bottom: 25px; 
            font-size: 1rem; color: #ccc; z-index: 20; text-align: center; 
            font-family: var(--font-ui); line-height: 1.6;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .log-highlight { color: var(--accent-gold); font-weight: bold; }
        .log-dmg { color: var(--danger); font-weight: bold; }
        .log-evade { color: var(--accent-gold); font-weight: bold; }

        .btns { display: flex; gap: 20px; z-index: 20; }
        .btn { 
            padding: 12px 35px; border: 2px solid #333; font-family: var(--font-combat); 
            font-size: 1.3rem; cursor: pointer; color: #ccc; transition: all 0.2s; 
            text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-radius: 6px;
            position: relative; overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .btn::before { content:""; position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(rgba(255,255,255,0.1), transparent); }
        
        .btn-atk { background: linear-gradient(to bottom, #8b0000, #520000); border-color: #b71c1c; }
        .btn-atk:hover { background: linear-gradient(to bottom, #d32f2f, #8b0000); transform: translateY(-3px); color: #fff; box-shadow: 0 0 20px rgba(211, 47, 47, 0.6); }
        
        .btn-skl { background: linear-gradient(to bottom, #1a237e, #000051); border-color: #304ffe; }
        .btn-skl:hover { background: linear-gradient(to bottom, #304ffe, #1a237e); transform: translateY(-3px); color: #fff; box-shadow: 0 0 20px rgba(48, 79, 254, 0.6); }
        
        .btn-item { background: linear-gradient(to bottom, #1b5e20, #003300); border-color: #2e7d32; }
        .btn-item:hover { background: linear-gradient(to bottom, #2e7d32, #1b5e20); transform: translateY(-3px); color: #fff; box-shadow: 0 0 20px rgba(46, 125, 50, 0.6); }

        .btn-run { background: linear-gradient(to bottom, #333, #111); border-color: #555; }
        .btn-run:hover { background: linear-gradient(to bottom, #555, #333); transform: translateY(-3px); color: #fff; }

        /* Special Button Style */
        .btn-special { background: linear-gradient(to bottom, #6a1b9a, #4a148c); border-color: #7b1fa2; }
        .btn-special:hover { background: linear-gradient(to bottom, #8e24aa, #6a1b9a); transform: translateY(-3px); color: #fff; box-shadow: 0 0 20px rgba(123, 31, 162, 0.6); }
        .btn-special:disabled { filter: grayscale(100%); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .btn-rage {
            background: linear-gradient(to bottom, #e65100, #bf360c); border-color: #ff9800;
            color: #fff; font-size: 1.5rem; padding: 15px 50px; display: none;
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            animation: ragePulse 1s infinite alternate; z-index: 30;
        }
        @keyframes ragePulse { from { box-shadow: 0 0 10px #ff9800; transform: translateX(-50%) scale(1); } to { box-shadow: 0 0 30px #ff9800; transform: translateX(-50%) scale(1.1); } }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }

        .modal-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 520px; 
            background: rgba(15, 15, 20, 0.98); border: 2px solid var(--accent-gold); display: none; 
            flex-direction: column; align-items: center; padding: 40px; z-index: 1000; 
            box-shadow: 0 0 80px rgba(0,0,0,1); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 8px; 
        }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        .modal-title { 
            font-family: var(--font-combat); font-size: 3rem; color: var(--accent-gold); margin-bottom: 20px; 
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); letter-spacing: 2px; border-bottom: 3px solid var(--accent-red); padding-bottom: 5px; 
        }
        .result-content { width: 100%; text-align: center; margin-bottom: 25px; color: #eee; font-family: var(--font-ui); }
        .result-row { margin: 12px 0; font-size: 1.2rem; display: flex; justify-content: space-between; padding: 0 40px; }
        
        .result-item-box {
            margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); 
            border: 1px solid #555; border-radius: 8px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 80%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .result-item-img { width: 64px; height: 64px; border: 2px solid var(--accent-gold); border-radius: 6px; object-fit: cover; box-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .result-item-name { font-weight: bold; color: var(--accent-gold); font-family: var(--font-ui); font-size: 1.1rem; }
        
        .lv-grid { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .lv-stat { background: rgba(0,0,0,0.4); padding: 10px; border: 1px solid #333; text-align: center; border-radius: 4px; }
        .stat-name { font-size: 0.9rem; color: #888; margin-bottom: 5px; font-family: var(--font-eng); font-weight: bold; }
        .stat-change { font-size: 1.3rem; font-weight: bold; color: #fff; font-family: var(--font-combat); }
        .stat-up { color: #00e676; font-size: 0.9rem; margin-left: 5px; }
        
        .btn-confirm { 
            background: var(--accent-gold); color: #000; padding: 12px 50px; border: none; 
            cursor: pointer; font-size: 1.2rem; font-family: var(--font-combat); margin-top: 10px; 
            transition: 0.2s; border-radius: 4px; font-weight: bold;
        }
        .btn-confirm:hover { background: #ffea00; transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 234, 0, 0.5); }

        /* GameOver Modal */
        #gameover-modal { width: 520px; height: auto; z-index: 1000; border: 2px solid var(--danger); display: none; }
        .gameover-title { font-family: var(--font-combat); font-size: 2.5rem; color: var(--danger); text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .gameover-stats { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .go-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.1rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .go-label { display: flex; align-items: center; gap: 8px; }
        .go-val { color: var(--accent-gold); font-weight: bold; }
        .go-score { font-size: 2rem; color: #fff; text-align: center; margin-top: 15px; border-top: 2px solid #444; padding-top: 15px; font-family: var(--font-combat); letter-spacing: 2px; }

        /* Item Modal Styles */
        #item-modal {
            width: 400px;
            background: rgba(15, 15, 20, 0.98);
            border: 2px solid #4caf50;
        }
        .item-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .battle-item-row {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .battle-item-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .battle-item-icon {
            width: 32px; height: 32px; margin-right: 10px; border: 1px solid #444;
        }
        .battle-item-info {
            flex: 1; text-align: left;
        }
        .battle-item-name {
            font-weight: bold; color: #eee; font-size: 0.9rem;
        }
        .battle-item-desc {
            font-size: 0.7rem; color: #aaa;
        }
        .battle-item-count {
            font-weight: bold; color: var(--accent-gold); margin-left: 10px;
        }

        @keyframes shakeSmall { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-4px, 4px); } 50% { transform: translate(4px, -4px); } 75% { transform: translate(-4px, -4px); } }
        .hit-small { animation: shakeSmall 0.3s ease-out; }
        @keyframes shakeBig { 0% { transform: rotate(0deg); } 20% { transform: translate(-10px, 10px) rotate(-5deg); } 40% { transform: translate(10px, -10px) rotate(5deg); } 60% { transform: translate(-5px, 5px) rotate(-3deg); } 100% { transform: rotate(0deg); } }
        .hit-big { animation: shakeBig 0.4s ease-out; }
        @keyframes flashRed { 0% { filter: sepia(0) saturate(1); } 50% { filter: sepia(1) saturate(5) hue-rotate(-50deg); } 100% { filter: sepia(0) saturate(1); } }
        .player-hit-anim { animation: shakeBig 0.4s ease-out, flashRed 0.3s; border-color: var(--danger) !important; }
        
        @keyframes critShake {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            10% { transform: translate(-15px, -15px) rotate(-10deg) scale(1.2); }
            20% { transform: translate(15px, 15px) rotate(10deg) scale(1.3); }
            30% { transform: translate(-20px, 10px) rotate(-15deg) scale(1.4); }
            40% { transform: translate(20px, -10px) rotate(15deg) scale(1.3); }
            50% { transform: translate(0, 0) rotate(0deg) scale(1.2); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }
        .crit-action { animation: critShake 1.0s cubic-bezier(.36,.07,.19,.97) both; z-index: 50; }

        @keyframes evasionShake {
            0% { transform: translate(0, 0) scale(1); }
            20% { transform: translate(40px, -20px) rotate(15deg) scale(0.9); }
            40% { transform: translate(-10px, 10px) rotate(-5deg) scale(1.1); }
            100% { transform: translate(0, 0) scale(1); }
        }
        .evasion-action { animation: evasionShake 1.0s ease-out; z-index: 50; }

        /* Screen Shake Effect */
        @keyframes screenShake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, -10px); }
            60% { transform: translate(10px, 10px); }
            70% { transform: translate(-10px, 10px); }
            80% { transform: translate(10px, -10px); }
            90% { transform: translate(-10px, -10px); }
            100% { transform: translate(0, 0); }
        }
        .screen-shake { animation: screenShake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes screenShakeStrong {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-15px, -15px); }
            20% { transform: translate(15px, 15px); }
            30% { transform: translate(-15px, 15px); }
            40% { transform: translate(15px, -15px); }
            50% { transform: translate(-15px, -15px); }
            60% { transform: translate(15px, 15px); }
            70% { transform: translate(-15px, 15px); }
            80% { transform: translate(15px, -15px); }
            90% { transform: translate(-15px, -15px); }
            100% { transform: translate(0, 0); }
        }
        .screen-shake-strong { animation: screenShakeStrong 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        .dmg-text {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            font-family: var(--font-combat); font-weight: bold; font-size: 3.5rem; color: #fff; 
            text-shadow: -2px -2px 0 #000, 2px 2px 0 #000, 0 0 10px rgba(0,0,0,0.5); 
            pointer-events: none; z-index: 200; animation: damagePop 1.5s forwards;
        }
        .crit-text { font-size: 5rem; color: #ff3333; text-shadow: 3px 3px 0 #000, 0 0 20px #ff3333; z-index: 201; }
        .player-dmg { color: #ff5252; font-size: 4rem; }
        .evade-text { color: #ffd700; font-size: 4rem; text-shadow: 0 0 15px #ffd700; }
        @keyframes damagePop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -100%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -180%); } }
        
        /* Legendary Warrior Damage */
        .dmg-legendary-warrior {
            color: #ffd700 !important;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8f00, 0 0 30px #ffd700 !important;
            font-size: 4.5rem !important;
            animation: damagePop 1.5s forwards, goldDust 1s infinite !important;
        }
        @keyframes goldDust {
            0% { text-shadow: 0 0 10px #ffd700; }
            50% { text-shadow: 0 0 20px #ffeb3b, 0 0 40px #ffd700; }
            100% { text-shadow: 0 0 10px #ffd700; }
        }

        /* Warrior Shockwave */
        .shockwave-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border: 5px solid #ffd700;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 250;
            animation: shockwavePop 0.5s ease-out;
            box-shadow: 0 0 20px #ffd700, inset 0 0 20px #ffd700;
        }
        @keyframes shockwavePop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; border-width: 10px; }
            100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; border-width: 0px; }
        }

        /* Legendary Rogue Animation */
        .rogue-legendary-action {
            animation: rogueLegendary 0.5s ease-out !important;
        }
        @keyframes rogueLegendary {
            0% { transform: scale(1); filter: none; }
            20% { transform: scale(1.1); filter: drop-shadow(-20px 0 0 rgba(147, 51, 234, 0.6)) drop-shadow(20px 0 0 rgba(147, 51, 234, 0.6)); opacity: 0.8; }
            40% { transform: translate(-30px, 0) scale(1); filter: drop-shadow(60px 0 0 rgba(147, 51, 234, 0.4)); opacity: 0.6; }
            60% { transform: translate(30px, 0) scale(1); filter: drop-shadow(-60px 0 0 rgba(147, 51, 234, 0.4)); opacity: 0.6; }
            80% { transform: scale(1.1); filter: drop-shadow(-20px 0 0 rgba(147, 51, 234, 0.6)) drop-shadow(20px 0 0 rgba(147, 51, 234, 0.6)); opacity: 0.8; }
            100% { transform: scale(1); filter: none; opacity: 1; }
        }

        /* Legendary Mage Holy Light */
        .holy-light-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            background: radial-gradient(circle, #fff 20%, #ffd700 50%, transparent 70%);
            z-index: 300; pointer-events: none;
            animation: holyLightPop 0.6s ease-out forwards;
            mix-blend-mode: screen;
            box-shadow: 0 0 60px 30px #ffd700;
            border-radius: 50%;
        }
        @keyframes holyLightPop {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .drop-item-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; object-fit: contain; z-index: 300; pointer-events: none; animation: dropItemPop 2.5s ease-out forwards; filter: drop-shadow(0 0 25px var(--accent-gold)); }
        @keyframes dropItemPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); } 100% { opacity: 0; transform: translate(-50%, -120%) scale(0.8); } }

        /* Rage Kill Effect */
        .rage-kill-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            width: 500px; z-index: 500; pointer-events: none; display: none;
            filter: drop-shadow(0 0 30px #ff9800);
        }
        @keyframes rageKillPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        .rage-kill-anim { display: block; animation: rageKillPop 2s forwards; }

        /* Poison Aura Effect */
        .poison-aura {
            box-shadow: 0 0 30px 10px rgba(155, 38, 182, 0.7) !important;
            border-color: #9b26b6 !important;
            transition: box-shadow 0.5s ease-in-out;
        }
        .poison-dmg {
            color: #9b26b6 !important;
            text-shadow: 0 0 10px #9b26b6 !important;
        }

        /* Cure Effect */
        .cure-effect {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 230, 118, 0.3);
            z-index: 10;
            display: none;
            animation: cureFlash 1s forwards;
        }
        @keyframes cureFlash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Weather UI in Battle */
        #weather-info {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 5px 15px;
            border-radius: 20px; display: flex; align-items: center; gap: 8px;
            font-family: var(--font-ui); font-size: 0.8rem; color: #fff; z-index: 100;
        }

        /* Rage Mode Visuals */
        .rage-ready-overlay {
            box-shadow: inset 0 0 60px 30px rgba(255, 50, 0, 0.4);
            animation: rageScreenPulse 1s infinite alternate;
            border: 2px solid rgba(255, 50, 0, 0.6);
        }
        @keyframes rageScreenPulse {
            from { box-shadow: inset 0 0 60px 30px rgba(255, 50, 0, 0.3); }
            to { box-shadow: inset 0 0 100px 50px rgba(255, 50, 0, 0.6); }
        }

        .rage-active-aura {
            box-shadow: 0 0 40px 15px #ff3d00 !important;
            border-color: #ff3d00 !important;
            filter: sepia(1) saturate(5) hue-rotate(-50deg) !important;
            animation: rageShake 0.2s infinite;
            z-index: 50;
        }
        @keyframes rageShake {
            0% { transform: translate(0, 0) scale(1.1); }
            25% { transform: translate(-3px, 3px) scale(1.1); }
            50% { transform: translate(3px, -3px) scale(1.1); }
            75% { transform: translate(-3px, -3px) scale(1.1); }
            100% { transform: translate(0, 0) scale(1.1); }
        }

        /* Double Attack Effect */
        .double-attack-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.5);
            z-index: 60;
            animation: doubleFlash 0.2s ease-out;
            pointer-events: none;
        }
        @keyframes doubleFlash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .double-attack-text {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-combat); font-size: 4rem; color: #fff;
            text-shadow: 0 0 20px #00e676, 0 0 40px #00e676;
            z-index: 250; pointer-events: none;
            animation: doubleTextPop 1s ease-out forwards;
        }
        @keyframes doubleTextPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100%) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="weather-info">
            <span id="weather-icon">‚òÄÔ∏è</span>
            <span id="weather-text">ÎßëÏùå</span>
        </div>

        <img id="drop-item-img" class="drop-item-effect" src="" style="display:none;">
        <img id="rage-kill-img" class="rage-kill-effect" src="image/damage_kill.jpg">

        <div id="loading-overlay"><div class="spinner"></div><h2 id="loading-text" style="color:var(--accent-red); font-family:var(--font-eng);">BATTLE START</h2></div>
        
        <div id="result-modal" class="modal-overlay">
            <div class="modal-title">Ï†ÑÌà¨ ÏäπÎ¶¨!</div>
            <div id="result-content" class="result-content"></div>
            <button class="btn-confirm" onclick="checkLevelUpOrFinish()">ÌôïÏù∏</button>
        </div>

        <div id="levelup-modal" class="modal-overlay">
            <div class="modal-title" style="color:#00e676; border-color:#00e676;">Î†àÎ≤® ÏóÖ!</div>
            <div class="lv-grid">
                <div class="lv-stat"><div class="stat-name">LEVEL</div><div class="stat-change"><span id="old-lv">1</span> ‚ñ∑ <span id="new-lv" style="color:var(--accent-gold)">2</span></div></div>
                <div class="lv-stat"><div class="stat-name">MAX HP</div><div class="stat-change" id="stat-hp"></div></div>
                <div class="lv-stat"><div class="stat-name">MAX MP</div><div class="stat-change" id="stat-mp"></div></div>
            </div>
            <button id="lv-confirm-btn" class="btn-confirm" onclick="finishBattleWithLevelUp()" style="background:#00e676;">ÌäπÏÑ± Î∂ÑÎ∞∞ÌïòÎü¨ Í∞ÄÍ∏∞</button>
        </div>

        <div id="item-modal" class="modal-overlay">
            <div class="modal-title" style="color:#4caf50; border-color:#4caf50; font-size: 2rem;">ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù</div>
            <div id="item-list" class="item-list"></div>
            <button class="btn-confirm" onclick="closeItemModal()" style="background:#555; margin-top:20px;">Îã´Í∏∞</button>
        </div>

        <div id="effect-modal" class="modal-overlay">
            <div class="modal-title" id="effect-title" style="font-size: 2rem;">Ìö®Í≥º Î∞úÎèô</div>
            <img id="effect-img" src="" style="width:100px; height:100px; border-radius:10px; margin:20px 0; box-shadow:0 0 20px var(--accent-gold);">
            <div id="effect-desc" class="result-content" style="font-size:1.2rem; white-space: pre-line;"></div>
            <button class="btn-confirm" onclick="closeEffectModal()">ÌôïÏù∏</button>
        </div>

        <div id="gameover-modal" class="modal-overlay">
            <div class="gameover-title">Ìå®Î∞∞</div>
            <div id="go-stats-container" class="gameover-stats">
                <!-- ÏÉÅÏÑ∏ Ï†êÏàò ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê Îì§Ïñ¥Í∞ëÎãàÎã§ -->
            </div>
            <div class="go-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="go-score-val" style="color:var(--accent-gold)">0</span></div>
            <button class="btn-confirm" style="width:100%; margin-top: 20px;" onclick="location.href='index.html'">Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú</button>
        </div>

        <div class="battle-stage">
            <div class="unit-box">
                <div id="p-speech" class="speech"></div>
                <div id="player-frame" class="unit-frame" style="border-color:#2979ff;">
                    <div id="p-cure" class="cure-effect"></div>
                    <img id="p-img" class="unit-img">
                    <img id="atk-warrior" src="image/warrior_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-rogue" src="image/rogue_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-mage" src="image/mage_atk_img.jpg" class="unit-img" style="display:none;">
                    <img id="atk-warrior-double" src="image/warrior_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-rogue-double" src="image/rogue_attack.jpg" class="unit-img" style="display:none;">
                    <img id="atk-mage-double" src="image/mage_attack.jpg" class="unit-img" style="display:none;">
                    <img id="hit-warrior" src="image/warrior_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-rogue" src="image/rogue_hit.jpg" class="unit-img" style="display:none;">
                    <img id="hit-mage" src="image/mage_hit.jpg" class="unit-img" style="display:none;">
                    <img id="crit-warrior" src="image/critical_warrior.jpg" class="unit-img" style="display:none;">
                    <img id="crit-rogue" src="image/critical_rogue.jpg" class="unit-img" style="display:none;">
                    <img id="crit-mage" src="image/critical_mage.jpg" class="unit-img" style="display:none;">
                    <img id="crit-warrior1" src="image/warrior_critical.jpg" class="unit-img" style="display:none;">
                    <img id="crit-rogue1" src="image/rogue_critical.jpg" class="unit-img" style="display:none;">
                    <img id="crit-mage1" src="image/mage_critical.jpg" class="unit-img" style="display:none;">
                    <img id="eva-warrior" src="image/warrior_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-rogue" src="image/rogue_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-mage" src="image/mage_evasion.jpg" class="unit-img" style="display:none;">
                    <img id="eva-warrior1" src="image/warrior3.jpg" class="unit-img" style="display:none;">
                    <img id="eva-rogue1" src="image/rogue3.jpg" class="unit-img" style="display:none;">
                    <img id="eva-mage1" src="image/mage3.jpg" class="unit-img" style="display:none;">
                    <video id="v-warrior" src="image/warrior_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-rogue" src="image/rogue_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage" src="image/mage_atk.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-warrior1" src="image/warrior_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage1" src="image/mage_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-rogue1" src="image/rogue_atk1.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-mage2" src="image/mage_atk2.mp4" class="unit-img" style="display:none;"></video>
                    <video id="v-warrior2" src="image/warrior_atk2.mp4" class="unit-img" style="display:none;"></video>
                </div>
                <div class="unit-info">
                    <h3 id="p-name" class="unit-name">ÌîåÎ†àÏù¥Ïñ¥</h3>
                    <div id="p-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div class="bar-wrap"><div id="p-hp-bar" class="bar-fill hp-bar"></div><span id="p-hp-text" class="bar-text"></span></div>
                        <div class="bar-wrap"><div id="p-mp-bar" class="bar-fill mp-bar"></div><span id="p-mp-text" class="bar-text"></span></div>
                        <div class="bar-wrap"><div id="p-rage-bar" class="bar-fill rage-bar"></div><span id="p-rage-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="vs-text">VS</div>
            
            <div class="unit-box">
                <div id="e-speech" class="speech"></div>
                <div id="enemy-frame" class="unit-frame" style="border-color:var(--danger);">
                    <img id="e-img" class="unit-img">
                </div>
                <div class="unit-info">
                    <h3 id="e-name" class="unit-name">Ï†Å Ïù¥Î¶Ñ</h3>
                    <div id="e-status" class="status-effects"></div>
                    <div class="bar-container">
                        <div class="bar-wrap"><div id="e-hp-bar" class="bar-fill hp-bar"></div><span id="e-hp-text" class="bar-text"></span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="log" class="log-panel">Ï†ÑÌà¨Í∞Ä Í≥ß ÏãúÏûëÎê©ÎãàÎã§...</div>
        
        <div class="btns">
            <button class="btn btn-atk" onclick="atk()">‚öîÔ∏è Í≥µÍ≤©</button>
            <button class="btn btn-skl" onclick="skl()">‚ö° Ïä§ÌÇ¨</button>
            <button id="btn-special" class="btn btn-special" onclick="specialAtk()">üåü ÌäπÏàòÍ∏∞</button>
            <button class="btn btn-item" onclick="openItemModal()">üíä ÏïÑÏù¥ÌÖú</button>
            <button class="btn btn-run" onclick="run()">üèÉ ÎèÑÎßù</button>
        </div>

        <button id="btn-rage" class="btn btn-rage" onclick="rageAtk()">üî• Î∂ÑÎÖ∏ Í≥µÍ≤©</button>
    </div>

    <script>
        const DB_URL = "https://script.google.com/macros/s/AKfycbwFtbKreW0iJpUXrUs3haBJqiMREL2EQ8XhpomKe7mR6l1Q0NDjoXpe31XY6k6VPe48Iw/exec";
        
        const attackSfx = new Audio('song/attack.mp3');
        const critSfx = new Audio('song/attack_1.mp3');
        const levelupSfx = new Audio('song/powerup.mp3');
        const itemSfx = new Audio('song/poka.mp3');
        const damageSfx = new Audio('song/damage1.mp3');
        const evadeSfx = new Audio('song/swish.mp3');
        const potionSfx = new Audio('song/potion-inght.wav');
        const goldSfx = new Audio('song/gold_drop-inght.wav');

        let bossBgm = null;

        const MAP_SETS = [
            { day: 'image/map.jpg', night: 'image/map1.jpg' },
            { day: 'image/map2.jpg', night: 'image/map3.jpg' },
            { day: 'image/map4.jpg', night: 'image/map5.jpg' },
            { day: 'image/map6.jpg', night: 'image/map7.jpg' }
        ];

        const DAY_ENEMY_POOL = [
            {f:'image/ka.jpg', n:'ÎÇòÎ¨¥ Î™¨Ïä§ÌÑ∞', e:70, w:3},  
            {f:'image/ka2.jpg', n:'Î¶¨Îçò', e:50, w:3},
            {f:'image/ka3.jpg', n:'ÌÜ†ÎÅºÏÇ¨ÎÉ•Íæº ÏöîÏπò', e:30, w:4},
            {f:'image/ka4.jpg', n:'Í≥∞Ï†ÑÏÇ¨ Ï∂îÌåå', e:120, w:2, type: 'bear_warrior'},
            {f:'image/ke1.jpg', n:'ÏóòÎ¶¨Ìä∏ ÎÇòÎ¨¥ Î≥ëÏÇ¨', e:100, w:1, mult: 1.2}
        ];
        const NIGHT_ENEMY_POOL = [
            {f:'image/monster1.jpg', n:'Î∏îÎ£®Î®∏Ïâ¨ Í∞ÄÎîîÏñ∏ (Bluemush Guardian)', e:150, w:3, poison: true},
            {f:'image/monster2.jpg', n:'Í∑∏Î°úÏö∏ Ìä∏Î†åÌä∏ (Growl Trent)', e:180, w:3},
            {f:'image/monster3.jpg', n:'ÏúÑÏä§ÌîÑ ÎûúÌÑ¥ (Wisp Lantern)', e:120, w:4, poison: true},
            {f:'image/ke3.jpg', n:'ÎßàÎ≤ïÏÇ¨ ÌôÄÎ¶¨', e:200, w:2, type: 'mage_holly'},
            {f:'image/ke2.jpg', n:'Ïã¨Ïó∞Ïùò Í∞êÏãúÏûê', e:250, w:1, mult: 1.3}
        ];
        
        const WEAPON_IMAGES = {
            'Ï†ÑÏÇ¨': 'weapon_warrior.jpg', 'ÎèÑÏ†Å': 'weapon_rogue.jpg', 'ÎßàÎ≤ïÏÇ¨': 'weapon_mage.jpg',
            'Î≤ÑÏÑúÏª§': 'weapon_warrior.jpg', 'Í∞ÄÎîîÏñ∏': 'weapon_warrior.jpg',
            'Ïñ¥ÏåîÏã†': 'weapon_rogue.jpg', 'ÏÑÄÎèÑÏö∞': 'weapon_rogue.jpg',
            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'weapon_mage.jpg', 'ÏÜåÏÑúÎü¨': 'weapon_mage.jpg'
        };
        const ITEM_IMAGES = {
            'hp_potion': 'potion_hp.jpg', 'potion_hp': 'potion_hp.jpg',
            'mp_potion': 'potion_mp.jpg', 'potion_mp': 'potion_mp.jpg',
            'poison_potion': 'potion_poison.jpg', 'potion_poison': 'potion_poison.jpg',
            'exp_potion': 'potion_exp.jpg', 'potion_exp': 'potion_exp.jpg',
            'gold': 'coin_gold.jpg',
            'potion_atk': 'attack_10.jpg',
            'potion_def': 'Defense_10.jpg',
            'scroll_option': 'Scroll.jpg',
            'potion_skeleton': 'potion_skeleton.jpg',
            'potion_invis': 'potion_invis.jpg',
            'potion_gamble': 'potion_gamble.jpg',
            'potion_focus': 'potion_focus.jpg',
            'potion_holy': 'potion_holy.jpg',
            'potion_madness': 'potion_madness.jpg',
            'potion_full': 'potion_full.jpg'
        };
        
        const DROP_TABLE = {
            'Ï†ÑÏÇ¨': ['Í∏∞ÏÇ¨Ïùò Í≤Ä', 'ÎåÄÍ≤Ä', 'Ïö©ÏÇ¨Ïùò Í≤Ä', 'Ïã¨ÌåêÏùò ÎèÑÎÅº'],
            'ÎèÑÏ†Å': ['ÏïîÏÇ¥ÏûêÏùò Îã®ÎèÑ', 'ÏåçÍ≤Ä', 'Í∑∏Î¶ºÏûê ÎπÑÏàò'],
            'ÎßàÎ≤ïÏÇ¨': ['ÎßàÎ≤ï ÏßÄÌå°Ïù¥', 'Ïò§Î∏å', 'ÌòÑÏûêÏùò Ïä§ÌÉúÌîÑ'],
            'Î≤ÑÏÑúÏª§': ['Í¥ëÏ†ÑÏÇ¨Ïùò ÎèÑÎÅº', 'ÌîºÏùò Í≤Ä'],
            'Í∞ÄÎîîÏñ∏': ['ÏàòÌò∏ÏûêÏùò Î∞©Ìå®Í≤Ä', 'ÏÑ±Í∏∞ÏÇ¨Ïùò ÎßùÏπò'],
            'Ïñ¥ÏåîÏã†': ['Ï£ΩÏùåÏùò Ïù∏ÎèÑÏûê', 'Í∑∏Î¶ºÏûê ÏÜ°Í≥≥Îãà'],
            'ÏÑÄÎèÑÏö∞': ['Í≥µÌè¨Ïùò ÎπÑÏàò', 'Ïã¨Ïó∞Ïùò ÏπºÎÇ†'],
            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': ['ÎåÄÎßàÎ≤ïÏÇ¨Ïùò ÏßÄÌå°Ïù¥', 'Î≥ÑÏùò Ï°∞Í∞Å'],
            'ÏÜåÏÑúÎü¨': ['ÏõêÏÜåÏùò Í∑ºÏõê', 'ÎßàÎÇòÏùò Îàà']
        };

        const ENEMY_ATTACK_IMAGES = {
            'image/best_boss.jpg': 'image/best_boss_1.jpg',
            'image/ka.jpg': 'image/ka_1.jpg',
            'image/ka1.jpg': 'image/ka1_1.jpg',
            'image/ke2.jpg': 'image/ke2_1.jpg',
            'image/ke3.jpg': 'image/ke3_1.jpg',
            'image/monster_boss.jpg': 'image/monster_boss_1.jpg',
            'image/monster1.jpg': 'image/monster1_1.jpg',
            'image/monster2.jpg': 'image/monster2_1.jpg',
            'image/monster3.jpg': 'image/monster3_1.jpg',
            'image/ka4.jpg': 'image/ka4_1.jpg',
            'image/ke1.jpg': 'image/ke1_1.jpg',
            'image/ka2.jpg': 'image/ka2_1.jpg',
            'image/ka3.jpg': 'image/ka3_1.jpg'
        };

        let player, enemy, isActing = false;
        let isBossBattle = false;
        let isSuperBoss = false;
        let currentWeather = "sunny";
        let isLegendary = false;

        let pStatus = { poison: 0, stun: 0, defUp: 0, focus: 0, atkUp: 0, invincible: 0, nextSkillTriple: 0, zeroMana: 0, invis: 0, skillDmgUp: 0, critUp: 0, nextSkillZeroCost: 0 };
        let eStatus = { poison: 0, stun: 0 };
        let rage = 0;
        const maxRage = 100;
        let mageAttackToggle = false;
        let specialCooldown = 0;
        const SPECIAL_COOLDOWN_MAX = 10;
        let doubleAttackCooldown = 0;

        window.onload = async () => {
            const name = localStorage.getItem('rpg_player_name');
            const temp = localStorage.getItem('rpg_temp_player');
            try {
                if (temp && temp !== "undefined") { player = JSON.parse(temp); if (!player || !player.job) throw new Error("Err"); init(); } 
                else if (name) {
                    const res = await fetch(`${DB_URL}?name=${encodeURIComponent(name)}`);
                    player = await res.json(); if(player.error) throw new Error("Hero not found"); init();
                } else { throw new Error("No data"); }
            } catch (e) { alert("Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò. ÎßµÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§."); localStorage.removeItem('rpg_temp_player'); location.href = 'map.html'; }
        };

        function init() {
            if(!player.inventory) player.inventory = [];
            if(!player.bonusAtk) player.bonusAtk = 0;
            if(!player.bonusDef) player.bonusDef = 0;
            if(player.gold === undefined) player.gold = 0;
            if(player.coinScore === undefined) player.coinScore = 0;
            if(player.rage === undefined) player.rage = 0;
            rage = player.rage;
            currentWeather = localStorage.getItem('rpg_current_weather') || "sunny";

            pStatus = { poison: 0, stun: 0, defUp: 0, focus: 0, atkUp: 0, invincible: 0, nextSkillTriple: 0, zeroMana: 0, invis: 0, skillDmgUp: 0, critUp: 0, nextSkillZeroCost: 0 };
            doubleAttackCooldown = 0;

            if (player.specialCooldown > 0) {
                player.specialCooldown--;
            }
            specialCooldown = player.specialCooldown || 0;
            updateSpecialTooltip();

            if (player.battleCurse) {
                pStatus.stun = 1;
                pStatus.poison = 1;
                addLog("<span style='color:#9b26b6; font-weight:bold;'>‚ò†Ô∏è Ìï¥Í≥® Ìè¨ÏÖòÏùò Ï†ÄÏ£ºÍ∞Ä Î∞úÎèôÌñàÏäµÎãàÎã§! (Í∏∞Ï†à/Ï§ëÎèÖ)</span>");
                delete player.battleCurse;
            }

            if(!player.quests) player.quests = {
                killCount: 0,
                dayKillCount: 0,
                nightKillCount: 0,
                bossKillCount: 0,
                enhanceCount: 0,
                claimed: { kill: false, dayKill: false, nightKill: false, bossKill: false, enhance: false }
            };

            const jM = {
                'Ï†ÑÏÇ¨': 'warrior', 'ÎèÑÏ†Å': 'rogue', 'ÎßàÎ≤ïÏÇ¨': 'mage',
                'Î≤ÑÏÑúÏª§': 'warrior1', 'Í∞ÄÎîîÏñ∏': 'warrior1',
                'Ïñ¥ÏåîÏã†': 'rogue1', 'ÏÑÄÎèÑÏö∞': 'rogue1',
                'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'mage1', 'ÏÜåÏÑúÎü¨': 'mage1'
            };

            let pImgSrc = `image/${jM[player.job] || 'warrior'}.jpg`;

            const weapon = player.inventory.find(i => i.type === 'weapon' && i.equipped);
            if (weapon && weapon.rarity === 'legendary') {
                isLegendary = true;
                const j = player.job;
                if (j === 'Ï†ÑÏÇ¨' || j === 'Î≤ÑÏÑúÏª§' || j === 'Í∞ÄÎîîÏñ∏') pImgSrc = 'image/warrior4.jpg';
                else if (j === 'ÎèÑÏ†Å' || j === 'Ïñ¥ÏåîÏã†' || j === 'ÏÑÄÎèÑÏö∞') pImgSrc = 'image/rogue4.jpg';
                else if (j === 'ÎßàÎ≤ïÏÇ¨' || j === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || j === 'ÏÜåÏÑúÎü¨') pImgSrc = 'image/mage4.jpg';
            } else if (player.isAdvanced) {
                // Ï†ÑÏßÅ ÏÉÅÌÉúÏù¥ÏßÄÎßå Î†àÏ†ÑÎìú Î¨¥Í∏∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ï†ÑÏßÅ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
                const j = player.job;
                if (j === 'Î≤ÑÏÑúÏª§' || j === 'Í∞ÄÎîîÏñ∏') pImgSrc = 'image/warrior1.jpg';
                else if (j === 'Ïñ¥ÏåîÏã†' || j === 'ÏÑÄÎèÑÏö∞') pImgSrc = 'image/rogue1.jpg';
                else if (j === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || j === 'ÏÜåÏÑúÎü¨') pImgSrc = 'image/mage1.jpg';
            }

            document.getElementById('p-img').src = pImgSrc;
            document.getElementById('p-name').innerText = player.name;
            
            const isBossFlag = localStorage.getItem('rpg_boss_encounter');
            const isSuperBossFlag = localStorage.getItem('rpg_is_super_boss');
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            // Background update based on map set and time
            const mapSetIndex = parseInt(localStorage.getItem('rpg_map_set_index') || 0);
            const currentSet = MAP_SETS[mapSetIndex];
            const bgImg = isNight ? currentSet.night : currentSet.day;
            document.getElementById('game-container').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('${bgImg}')`;

            if (isSuperBossFlag === 'true') {
                isBossBattle = true;
                isSuperBoss = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 1500);
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 1500);
                enemy = { name: 'Ï¥àÍ∞ïÎ†• Î≥¥Ïä§ (Ancient Overlord)', hp: bossHp, maxHp: bossMaxHp, atk: 30 + (player.level * 3), exp: 10000, img: 'image/best_boss.jpg' };
                localStorage.removeItem('rpg_is_super_boss');
                playBossBgm('song/best_boss_bgm.mp3');
            } else if (isBossFlag === 'true') {
                isBossBattle = true;
                const bossHp = parseFloat(localStorage.getItem('rpg_boss_hp') || 400 + (player.level * 30));
                const bossMaxHp = parseFloat(localStorage.getItem('rpg_boss_max_hp') || 400 + (player.level * 30));
                let bossAtk = 15 + (player.level * 2);

                if (isNight) {
                    const nHp = Math.floor(bossHp * 1.5);
                    const nMaxHp = Math.floor(bossMaxHp * 1.5);
                    const nAtk = Math.floor(bossAtk * 1.2);
                    enemy = { name: 'Ïã¨Ïó∞Ïùò Íµ∞Ï£º', hp: nHp, maxHp: nMaxHp, atk: nAtk, exp: 5000, img: 'image/monster_boss.jpg', isNightBoss: true };
                    playBossBgm('song/monster_boss_bgm1.mp3');
                } else {
                    enemy = { name: 'Í∞ïÌôîÎêú Î≥¥Ïä§ ÎÇòÎ¨¥', hp: bossHp, maxHp: bossMaxHp, atk: bossAtk, exp: 2000, img: 'image/ka1.jpg' };
                    playBossBgm('song/monster_boss_bgm.mp3');
                }
                localStorage.removeItem('rpg_boss_encounter'); 
            } else {
                isBossBattle = false;
                const pool = isNight ? NIGHT_ENEMY_POOL : DAY_ENEMY_POOL;
                let tW = pool.reduce((s, e) => s + e.w, 0);
                let r = Math.random() * tW; let sel = pool[0];
                for (let e of pool) { if (r < e.w) { sel = e; break; } r -= e.w; }

                const avg = (player.stats.str + player.stats.int) / 2 + (player.level * 3);
                const multiplier = sel.mult || 1.0;
                enemy = {
                    name: sel.n,
                    hp: Math.floor(avg * 2.8 * multiplier) + 15,
                    maxHp: Math.floor(avg * 2.8 * multiplier) + 15,
                    atk: Math.floor((avg/2.0) * multiplier) + 4,
                    exp: sel.e,
                    img: sel.f,
                    canPoison: sel.poison || false,
                    type: sel.type || 'normal'
                };
            }
            
            document.getElementById('e-img').src = enemy.img;
            document.getElementById('e-name').innerText = enemy.name;
            if(isBossBattle) {
                document.getElementById('e-name').style.color = "#ff1744";
                document.getElementById('e-name').innerText = "üíÄ " + enemy.name;
            }
            
            updateWeatherUI();
            addLog(`<span class='log-highlight'>[${enemy.name}]</span>Ïù¥(Í∞Ä) ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!`);
            document.getElementById('loading-overlay').style.display = 'none';
            update(); say('p', 'Ï†ÑÌà¨ ÏãúÏûë!');
        }

        function playBossBgm(src) {
            if (bossBgm) {
                bossBgm.pause();
                bossBgm.currentTime = 0;
            }
            bossBgm = new Audio(src);
            bossBgm.loop = true;
            bossBgm.volume = 0.5;
            bossBgm.play().catch(e => console.log("BGM play failed:", e));
        }

        function stopBossBgm() {
            if (bossBgm) {
                bossBgm.pause();
                bossBgm.currentTime = 0;
                bossBgm = null;
            }
        }

        function updateSpecialTooltip() {
            const btn = document.getElementById('btn-special');
            let desc = "";
            switch(player.job) {
                case 'Ï†ÑÏÇ¨': desc = "[Î∞©Ìå® Î∞©Ïñ¥] 2ÌÑ¥ ÎèôÏïà Î∞õÎäî ÌîºÌï¥Îüâ 50% Í∞êÏÜå"; break;
                case 'ÎèÑÏ†Å': desc = "[ÏßëÏ§ëÎ†• Í∞ïÌôî] Îã§Ïùå Í≥µÍ≤© Î™ÖÏ§ëÎ•†/ÏπòÎ™ÖÌÉÄ ÎåÄÌè≠ ÏÉÅÏäπ"; break;
                case 'ÎßàÎ≤ïÏÇ¨': desc = "[ÎßàÎÇò ÏàúÌôò] ÏµúÎåÄ MPÏùò 30% Ï¶âÏãú ÌöåÎ≥µ"; break;
                case 'Î≤ÑÏÑúÏª§': desc = "[ÌîºÏùò Í∞àÏ¶ù] HP 20% ÏÜåÎ™®, 2ÌÑ¥Í∞Ñ Í≥µÍ≤©Î†• 2Î∞∞"; break;
                case 'Í∞ÄÎîîÏñ∏': desc = "[ÏôÑÏ†Ñ Î∞©Ïñ¥] 2ÌÑ¥ ÎèôÏïà Î¨¥Ï†Å (Îç∞ÎØ∏ÏßÄ Î¨¥Ìö®)"; break;
                case 'Ïñ¥ÏåîÏã†': desc = "[Í∑∏Î¶ºÏûê ÏùºÍ≤©] Î∞©Ïñ¥ Î¨¥Ïãú ÌÅ¨Î¶¨Ìã∞Ïª¨ Í≥µÍ≤©"; break;
                case 'ÏÑÄÎèÑÏö∞': desc = "[ÎèÖ ÌôïÏÇ∞] ÎèÖ ÌîºÌï¥ Ï¶âÏãú ÏûÖÌûàÍ≥† Ïû¨Ï§ëÎèÖ"; break;
                case 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': desc = "[ÎßàÎ†• Ìè≠Ï£º] Îã§Ïùå Ïä§ÌÇ¨ Îç∞ÎØ∏ÏßÄ 3Î∞∞ (ÏÇ¨Ïö© ÌõÑ 1ÌÑ¥ Í∏∞Ï†à)"; break;
                case 'ÏÜåÏÑúÎü¨': desc = "[ÏõêÏÜå Í≥ºÎ∂ÄÌïò] 2ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨ ÎßàÎÇò ÏÜåÎ™® 0"; break;
                default: desc = "ÌäπÏàò Í∏∞Ïà†"; break;
            }
            btn.title = desc;
        }

        function updateWeatherUI() {
            const icon = document.getElementById('weather-icon');
            const text = document.getElementById('weather-text');
            if (currentWeather === "sunny") { icon.innerText = "‚òÄÔ∏è"; text.innerText = "ÎßëÏùå"; }
            else if (currentWeather === "rain") { icon.innerText = "üåßÔ∏è"; text.innerText = "ÎπÑ (ÎßàÎ≤ï Í∞ïÌôî)"; }
            else if (currentWeather === "fog") { icon.innerText = "üå´Ô∏è"; text.innerText = "ÏïàÍ∞ú (Î™ÖÏ§ë Ï†ÄÌïò)"; }
            else if (currentWeather === "thunder") { icon.innerText = "‚ö°"; text.innerText = "ÎáåÏö∞"; }
        }

        function say(target, txt) { const el = document.getElementById(target+'-speech'); el.innerText = txt; el.style.display = 'block'; setTimeout(()=>el.style.display='none', 1500); }
        
        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
        }

        function update() {
            document.getElementById('p-hp-bar').style.width = `${Math.max(0, Math.min(100, (player.hp/player.maxHp)*100))}%`;
            document.getElementById('p-mp-bar').style.width = `${Math.max(0, Math.min(100, (player.mp/player.maxMp)*100))}%`;
            document.getElementById('p-rage-bar').style.width = `${Math.min(100, (rage/maxRage)*100)}%`;
            document.getElementById('e-hp-bar').style.width = `${Math.max(0, Math.min(100, (enemy.hp/enemy.maxHp)*100))}%`;
            document.getElementById('p-hp-text').innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
            document.getElementById('p-mp-text').innerText = `${Math.ceil(player.mp)}/${player.maxMp}`;
            document.getElementById('p-rage-text').innerText = `RAGE ${rage}/${maxRage}`;
            document.getElementById('e-hp-text').innerText = `${Math.ceil(enemy.hp)}/${enemy.maxHp}`;

            const btnSpecial = document.getElementById('btn-special');
            if (specialCooldown > 0) {
                btnSpecial.disabled = true;
                btnSpecial.innerText = `‚è≥ ${specialCooldown}`;
            } else {
                btnSpecial.disabled = false;
                btnSpecial.innerText = "üåü ÌäπÏàòÍ∏∞";
            }

            const pStatusEl = document.getElementById('p-status');
            pStatusEl.innerHTML = '';
            if(pStatus.poison > 0) {
                pStatusEl.innerHTML += `<span class="status-icon status-poison">ÎèÖ(${pStatus.poison})</span>`;
                document.getElementById('player-frame').classList.add('poison-aura');
            } else {
                document.getElementById('player-frame').classList.remove('poison-aura');
            }
            if(pStatus.stun > 0) pStatusEl.innerHTML += `<span class="status-icon status-stun">Í∏∞Ï†à(${pStatus.stun})</span>`;

            // Buff Icons
            if(pStatus.defUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#795548;">Î∞©Ïñ¥(${pStatus.defUp})</span>`;
            if(pStatus.atkUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#d32f2f;">Í≥µÍ≤©(${pStatus.atkUp})</span>`;
            if(pStatus.invincible > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#ffd700; color:#000;">Î¨¥Ï†Å(${pStatus.invincible})</span>`;
            if(pStatus.zeroMana > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#2979ff;">ÎßàÎÇò0(${pStatus.zeroMana})</span>`;
            if(pStatus.skillDmgUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#2979ff;">Ïä§ÌÇ¨Í∞ïÌôî(${pStatus.skillDmgUp})</span>`;
            if(pStatus.critUp > 0) pStatusEl.innerHTML += `<span class="status-icon" style="background:#ff1744;">Í¥ëÍ∏∞(${pStatus.critUp})</span>`;

            const eStatusEl = document.getElementById('e-status');
            eStatusEl.innerHTML = '';
            if(eStatus.poison > 0) eStatusEl.innerHTML += `<span class="status-icon status-poison">ÎèÖ(${eStatus.poison})</span>`;
            if(eStatus.stun > 0) eStatusEl.innerHTML += `<span class="status-icon status-stun">Í∏∞Ï†à(${eStatus.stun})</span>`;

            if (rage >= maxRage) {
                document.getElementById('btn-rage').style.display = 'block';
                document.getElementById('game-container').classList.add('rage-ready-overlay');
            } else {
                document.getElementById('btn-rage').style.display = 'none';
                document.getElementById('game-container').classList.remove('rage-ready-overlay');
            }
        }
        
        function showDamage(targetId, dmg, type) {
            const frame = document.getElementById(targetId); const el = document.createElement('div');
            let cssClass = 'dmg-text'; let content = dmg;
            if (type === 'crit') {
                cssClass += ' crit-text';
                content = '<div style="color: #ffeb3b; font-size: 2rem; margin-bottom: -10px;">CRITICAL!</div>' + dmg;
                triggerScreenShake();
            }
            else if (type === 'player_hit') { cssClass += ' player-dmg'; }
            else if (type === 'poison') { cssClass += ' poison-dmg'; content = 'POISON<br>' + dmg; }
            else if (type === 'evade') { cssClass += ' evade-text'; content = 'MISS'; }

            if (isLegendary && (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏') && targetId === 'enemy-frame' && type !== 'evade') {
                cssClass += ' dmg-legendary-warrior';
            }

            el.className = cssClass; el.innerHTML = content;
            const randomX = Math.floor(Math.random()*40)-20; const randomY = Math.floor(Math.random()*20)-10;
            el.style.transform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px))`;
            frame.appendChild(el); setTimeout(() => el.remove(), 1500);
        }

        function triggerScreenShake(isStrong = false) {
            const container = document.getElementById('game-container');
            container.classList.remove('screen-shake', 'screen-shake-strong');
            void container.offsetWidth;
            if (isStrong) container.classList.add('screen-shake-strong');
            else container.classList.add('screen-shake');
            setTimeout(() => container.classList.remove('screen-shake', 'screen-shake-strong'), 500);
        }
        
        function triggerHitEffect(targetId, type) {
            const frame = document.getElementById(targetId);
            frame.classList.remove('hit-small', 'hit-big', 'hit-rogue', 'player-hit-anim', 'crit-action', 'evasion-action'); void frame.offsetWidth;

            if (isLegendary && (player.job === 'ÎßàÎ≤ïÏÇ¨' || player.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || player.job === 'ÏÜåÏÑúÎü¨') && targetId === 'enemy-frame' && type !== 'evade') {
                 const light = document.createElement('div');
                 light.className = 'holy-light-effect';
                 frame.appendChild(light);
                 setTimeout(() => light.remove(), 800);
                 return;
            }

            if (isLegendary && (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏') && targetId === 'enemy-frame' && type !== 'evade') {
                 const wave = document.createElement('div');
                 wave.className = 'shockwave-effect';
                 frame.appendChild(wave);
                 setTimeout(() => wave.remove(), 600);
            }

            if (type === 'normal') frame.classList.add('hit-small');
            else if (type === 'rogue') frame.classList.add('hit-rogue');
            else if (type === 'big') frame.classList.add('hit-big');
            else if (type === 'player_hit') frame.classList.add('player-hit-anim');
            else if (type === 'crit') frame.classList.add('crit-action');
            else if (type === 'evade') frame.classList.add('evasion-action');
        }
        
        function playMotion(imgId, targetFrameId, effectType) {
            const pImg = document.getElementById('p-img');
            const motionImg = document.getElementById(imgId);

            const jM = {
                'Î≤ÑÏÑúÏª§': 'warrior', 'Í∞ÄÎîîÏñ∏': 'warrior',
                'Ïñ¥ÏåîÏã†': 'rogue', 'ÏÑÄÎèÑÏö∞': 'rogue',
                'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'mage', 'ÏÜåÏÑúÎü¨': 'mage'
            };

            let base = jM[player.job];
            if (base) {
                if (effectType === 'crit') {
                    const critMap = { 'warrior': 'crit-warrior1', 'rogue': 'crit-rogue1', 'mage': 'crit-mage1' };
                    const cImg = document.getElementById(critMap[base]);
                    if (cImg) {
                        pImg.style.display = 'none'; cImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('crit-action');
                        setTimeout(() => {
                            cImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('crit-action');
                        }, 1000);
                        return; // Ï†ÑÏßÅ ÌÅ¨Î¶¨Ìã∞Ïª¨ÏùÄ Ïó¨Í∏∞ÏÑú Ï¢ÖÎ£å
                    }
                }

                if (effectType === 'evade') {
                    const evaMap = { 'warrior': 'eva-warrior1', 'rogue': 'eva-rogue1', 'mage': 'eva-mage1' };
                    const eImg = document.getElementById(evaMap[base]);
                    if (eImg) {
                        pImg.style.display = 'none'; eImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('evasion-action');
                        setTimeout(() => {
                            eImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('evasion-action');
                        }, 1000);
                        return;
                    }
                }

                if (imgId && imgId.includes('atk')) {
                    if (base === 'mage') {
                        pImg.src = mageAttackToggle ? 'image/mage3.jpg' : 'image/mage2.jpg';
                        mageAttackToggle = !mageAttackToggle;
                    } else {
                        pImg.src = `image/${base}2.jpg`;
                    }
                }
                triggerHitEffect(targetFrameId, effectType);
                setTimeout(() => {
                    if (isLegendary) {
                        if (base === 'warrior') pImg.src = 'image/warrior4.jpg';
                        else if (base === 'rogue') pImg.src = 'image/rogue4.jpg';
                        else if (base === 'mage') pImg.src = 'image/mage4.jpg';
                        else pImg.src = `image/${base}1.jpg`;
                    } else {
                        pImg.src = `image/${base}1.jpg`;
                    }
                }, 1000);

            } else { // Ï†ÑÏßÅ ÏïàÌïú Í≤ΩÏö∞
                if (effectType === 'crit') {
                    const critMap = { 'Ï†ÑÏÇ¨': 'crit-warrior', 'ÎèÑÏ†Å': 'crit-rogue', 'ÎßàÎ≤ïÏÇ¨': 'crit-mage' };
                    const cImg = document.getElementById(critMap[player.job || 'Ï†ÑÏÇ¨']);
                    if (cImg) {
                        pImg.style.display = 'none'; cImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('crit-action');
                        setTimeout(() => {
                            cImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('crit-action');
                        }, 1000);
                    }
                } else if (effectType === 'evade') {
                    const evaMap = { 'Ï†ÑÏÇ¨': 'eva-warrior', 'ÎèÑÏ†Å': 'eva-rogue', 'ÎßàÎ≤ïÏÇ¨': 'eva-mage' };
                    const eImg = document.getElementById(evaMap[player.job || 'Ï†ÑÏÇ¨']);
                    if (eImg) {
                        pImg.style.display = 'none'; eImg.style.display = 'block';
                        document.getElementById('player-frame').classList.add('evasion-action');
                        setTimeout(() => {
                            eImg.style.display = 'none'; pImg.style.display = 'block';
                            document.getElementById('player-frame').classList.remove('evasion-action');
                        }, 1000);
                    }
                } else {
                    if(motionImg) { pImg.style.display = 'none'; motionImg.style.display = 'block'; setTimeout(() => { motionImg.style.display = 'none'; pImg.style.display = 'block'; }, 1000); }
                }
                triggerHitEffect(targetFrameId, effectType);
            }
        }

        function playEnemyAttackMotion() {
            const eImg = document.getElementById('e-img');
            const currentSrc = enemy.img;
            const attackImg = ENEMY_ATTACK_IMAGES[currentSrc];
            if (attackImg) {
                eImg.src = attackImg;
                setTimeout(() => {
                    eImg.src = currentSrc;
                }, 1000);
            }
        }

        function playAttackSfx() { attackSfx.currentTime = 0; attackSfx.play().catch(e => {}); }
        function playCritSfx() { critSfx.currentTime = 0; critSfx.play().catch(e => {}); }
        function playLevelupSfx() { levelupSfx.currentTime = 0; levelupSfx.play().catch(e => {}); }
        function playItemSfx() { itemSfx.currentTime = 0; itemSfx.play().catch(e => {}); }
        function playDamageSfx() { damageSfx.currentTime = 0; damageSfx.play().catch(e => {}); }
        function playEvadeSfx() { evadeSfx.currentTime = 0; evadeSfx.play().catch(e => {}); }
        function playPotionSfx() { potionSfx.currentTime = 0; potionSfx.play().catch(e => {}); }
        function playGoldSfx() { goldSfx.currentTime = 0; goldSfx.play().catch(e => {}); }

        function specialAtk() {
            if(isActing || specialCooldown > 0) return;
            if(pStatus.stun > 0) { addLog("Í∏∞Ï†à ÏÉÅÌÉúÎùº ÌäπÏàòÍ∏∞Î•º Ïì∏ Ïàò ÏóÜÏäµÎãàÎã§!"); return; }

            isActing = true;
            specialCooldown = SPECIAL_COOLDOWN_MAX;

            let job = player.job;
            let logMsg = "";

            triggerScreenShake();
            playItemSfx();

            setTimeout(() => {
                switch(job) {
                    case 'Ï†ÑÏÇ¨':
                        pStatus.defUp = 2;
                        logMsg = "üõ°Ô∏è [Î∞©Ìå® Î∞©Ïñ¥] ÌÉúÏÑ∏Î•º Ï∑®Ìï©ÎãàÎã§! (Î∞õÎäî ÌîºÌï¥ 50% Í∞êÏÜå)";
                        break;
                    case 'ÎèÑÏ†Å':
                        pStatus.focus = 1;
                        logMsg = "üëÅÔ∏è [ÏßëÏ§ëÎ†• Í∞ïÌôî] Ï†ÅÏùò ÏïΩÏ†êÏùÑ ÎÖ∏Î¶ΩÎãàÎã§! (Îã§Ïùå Í≥µÍ≤© ÏπòÎ™ÖÌÉÄ)";
                        break;
                    case 'ÎßàÎ≤ïÏÇ¨':
                        let rec = Math.floor(player.maxMp * 0.3);
                        player.mp = Math.min(player.maxMp, player.mp + rec);
                        logMsg = `üíß [ÎßàÎÇò ÏàúÌôò] ÎßàÎÇòÎ•º ${rec} ÌöåÎ≥µÌñàÏäµÎãàÎã§!`;
                        break;
                    case 'Î≤ÑÏÑúÏª§':
                        let cost = Math.floor(player.hp * 0.2);
                        player.hp -= cost;
                        pStatus.atkUp = 2;
                        logMsg = `ü©∏ [ÌîºÏùò Í∞àÏ¶ù] Ï≤¥Î†• ${cost}ÏùÑ ÏÜåÎ™®ÌïòÏó¨ Í≥µÍ≤©Î†•ÏùÑ 2Î∞∞Î°ú ÎÜíÏûÖÎãàÎã§!`;
                        showDamage('player-frame', cost, 'player_hit');
                        break;
                    case 'Í∞ÄÎîîÏñ∏':
                        pStatus.invincible = 2;
                        logMsg = "üõ°Ô∏è [ÏôÑÏ†Ñ Î∞©Ïñ¥] Ï†àÎåÄ Î∞©Ïñ¥ ÌÉúÏÑ∏! (2ÌÑ¥Í∞Ñ Î¨¥Ï†Å)";
                        break;
                    case 'Ïñ¥ÏåîÏã†':
                        let dmg = Math.floor((player.stats.dex * 2.5 + player.level * 5) * 1.5);
                        enemy.hp -= dmg;
                        showDamage('enemy-frame', dmg, 'crit');
                        triggerHitEffect('enemy-frame', 'crit');
                        logMsg = `üó°Ô∏è [Í∑∏Î¶ºÏûê ÏùºÍ≤©] Ï†ÅÏùò Í∏âÏÜåÎ•º Ï∞îÎü¨ ${dmg}Ïùò ÏπòÎ™ÖÏ†ÅÏù∏ ÌîºÌï¥!`;
                        break;
                    case 'ÏÑÄÎèÑÏö∞':
                        if (eStatus.poison > 0) {
                            let pDmg = Math.floor(enemy.maxHp * 0.05) * eStatus.poison;
                            enemy.hp -= pDmg;
                            showDamage('enemy-frame', pDmg, 'poison');
                            logMsg = `‚ò†Ô∏è [ÎèÖ ÌôïÏÇ∞] ÎèÖÏùÑ Ìè≠Î∞úÏãúÏºú ${pDmg} ÌîºÌï¥Î•º ÏûÖÌûàÍ≥† Îã§Ïãú Ï§ëÎèÖÏãúÌÇµÎãàÎã§!`;
                        } else {
                            logMsg = "‚ò†Ô∏è [ÎèÖ ÌôïÏÇ∞] Ï†ÅÏóêÍ≤å ÎßπÎèÖÏùÑ Ï£ºÏûÖÌï©ÎãàÎã§!";
                        }
                        eStatus.poison = 3;
                        break;
                    case 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ':
                        pStatus.nextSkillTriple = 1;
                        logMsg = "üîÆ [ÎßàÎ†• Ìè≠Ï£º] ÎßàÎ†•ÏùÑ ÌïúÍ≥ÑÍπåÏßÄ ÎÅåÏñ¥Ïò¨Î¶ΩÎãàÎã§! (Îã§Ïùå Ïä§ÌÇ¨ 3Î∞∞)";
                        break;
                    case 'ÏÜåÏÑúÎü¨':
                        pStatus.zeroMana = 2;
                        logMsg = "üåÄ [ÏõêÏÜå Í≥ºÎ∂ÄÌïò] ÎßàÎÇòÏùò ÌùêÎ¶ÑÏùÑ Ï†úÏñ¥Ìï©ÎãàÎã§! (Ïä§ÌÇ¨ ÏÜåÎ™® 0)";
                        break;
                    default:
                        logMsg = "ÌäπÏàò Í∏∞Ïà† Î∞úÎèô!";
                        break;
                }

                addLog(logMsg);
                update();
                check();
            }, 500);
        }

        function atk() { 
            if(isActing) return;
            if(pStatus.stun > 0) { addLog("Í∏∞Ï†à ÏÉÅÌÉúÎùº Í≥µÍ≤©Ìï† Ïàò ÏóÜÏäµÎãàÎã§!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            isActing = true;
            const jobKey = player.job || 'Ï†ÑÏÇ¨'; 
            const imgMap = {
                'Ï†ÑÏÇ¨':'atk-warrior', 'ÎèÑÏ†Å':'atk-rogue', 'ÎßàÎ≤ïÏÇ¨':'atk-mage',
                'Î≤ÑÏÑúÏª§':'atk-warrior', 'Í∞ÄÎîîÏñ∏':'atk-warrior',
                'Ïñ¥ÏåîÏã†':'atk-rogue', 'ÏÑÄÎèÑÏö∞':'atk-rogue',
                'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ':'atk-mage', 'ÏÜåÏÑúÎü¨':'atk-mage'
            };
            
            playAttackSfx();

            // Check Focus
            let isFocused = false;
            if (pStatus.focus > 0) {
                isFocused = true;
                pStatus.focus = 0;
            }

            // Check Berserk
            let isBerserk = (pStatus.atkUp > 0);

            // Double Attack Check
            let isDoubleAttack = false;
            const advancedJobs = ['Î≤ÑÏÑúÏª§', 'Í∞ÄÎîîÏñ∏', 'Ïñ¥ÏåîÏã†', 'ÏÑÄÎèÑÏö∞', 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', 'ÏÜåÏÑúÎü¨'];
            if (advancedJobs.includes(player.job) && doubleAttackCooldown === 0 && Math.random() < 0.08) {
                isDoubleAttack = true;
                doubleAttackCooldown = Math.floor(Math.random() * 2) + 2;
            }

            setTimeout(() => {
                let enemyEvadeChance = isBossBattle ? 0.1 : 0.05;
                if (currentWeather === "fog") enemyEvadeChance += 0.15;

                if (Math.random() < enemyEvadeChance && !isFocused) {
                    addLog("<span class='log-evade'>Ï†ÅÏù¥ Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§!</span>");
                    playEvadeSfx();
                    showDamage('enemy-frame', 0, 'evade');
                    triggerHitEffect('enemy-frame', 'evade');
                    update(); check();
                    return;
                }

                let critChance = 0.2;
                if (player.job === 'Ïñ¥ÏåîÏã†') critChance = 0.35;
                if (isFocused) critChance = 1.0;
                if (pStatus.critUp > 0) critChance = 1.0;

                let isCrit = Math.random() < critChance;
                let dmg = Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0);

                if (isBerserk) dmg *= 2;

                if(isCrit) {
                    dmg = Math.floor(dmg*2);
                    playCritSfx();
                }
                
                if (isLegendary) {
                    if (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏') {
                        triggerScreenShake(true);
                    }
                }

                playMotion(imgMap[jobKey], 'enemy-frame', isCrit?'crit':'normal');
                enemy.hp -= dmg; 
                showDamage('enemy-frame', dmg, isCrit?'crit':'normal');
                addLog(`Ï†ÅÏóêÍ≤å <span class='log-dmg'>${dmg}</span>Ïùò ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§!`);

                if (isDoubleAttack && enemy.hp > 0) {
                    setTimeout(() => {
                        performDoubleAttack();
                    }, 1500); // ÎîúÎ†àÏù¥ Ï¶ùÍ∞Ä
                } else {
                    update(); check();
                }
            }, 200);
        }

        function performDoubleAttack() {
            const job = player.job;
            let msg = "";
            let atkImg = "";
            let effectType = "normal";

            if (['Î≤ÑÏÑúÏª§', 'Í∞ÄÎîîÏñ∏'].includes(job)) {
                msg = "ÌïúÎ≤à Îçî ! Í∞ïÎ†•Ìïú ÏùºÍ≤©!";
                atkImg = "image/warrior_attack.jpg";
                effectType = "big";
            } else if (['Ïñ¥ÏåîÏã†', 'ÏÑÄÎèÑÏö∞'].includes(job)) {
                msg = "Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÏÜçÎèÑÎ°ú!";
                atkImg = "image/rogue_attack.jpg";
                effectType = "rogue";
            } else if (['ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', 'ÏÜåÏÑúÎü¨'].includes(job)) {
                msg = "ÎßàÎ†•Ïù¥ ÎÑòÏ≥êÌùêÎ•∏Îã§ !";
                atkImg = "image/mage_attack.jpg";
                effectType = "big";
            }

            say('p', msg);

            // ÎçîÎ∏î Ïñ¥ÌÉù ÏãúÍ∞Å Ìö®Í≥º Ï∂îÍ∞Ä
            const container = document.getElementById('game-container');
            const flash = document.createElement('div');
            flash.className = 'double-attack-flash';
            container.appendChild(flash);
            setTimeout(() => flash.remove(), 200);

            const textEffect = document.createElement('div');
            textEffect.className = 'double-attack-text';
            textEffect.innerText = "DOUBLE ATTACK!";
            container.appendChild(textEffect);
            setTimeout(() => textEffect.remove(), 1000);

            const pImg = document.getElementById('p-img');
            pImg.src = atkImg;

            playAttackSfx();

            setTimeout(() => {
                let dmgRatio = (Math.random() * 0.4) + 0.3;
                let baseDmg = Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0);

                if (pStatus.atkUp > 0) baseDmg *= 2;

                let dmg = Math.floor(baseDmg * dmgRatio);

                triggerHitEffect('enemy-frame', effectType);

                enemy.hp -= dmg;
                showDamage('enemy-frame', dmg, 'normal');
                addLog(`Ïó∞ÏÜç Í≥µÍ≤©! <span class='log-dmg'>${dmg}</span>Ïùò Ï∂îÍ∞Ä ÌîºÌï¥!`);

                setTimeout(() => {
                    if (isLegendary) {
                         const jM = {
                            'Ï†ÑÏÇ¨': 'warrior', 'ÎèÑÏ†Å': 'rogue', 'ÎßàÎ≤ïÏÇ¨': 'mage',
                            'Î≤ÑÏÑúÏª§': 'warrior', 'Í∞ÄÎîîÏñ∏': 'warrior',
                            'Ïñ¥ÏåîÏã†': 'rogue', 'ÏÑÄÎèÑÏö∞': 'rogue',
                            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'mage', 'ÏÜåÏÑúÎü¨': 'mage'
                        };
                        let base = jM[player.job];
                        if (base === 'warrior') pImg.src = 'image/warrior4.jpg';
                        else if (base === 'rogue') pImg.src = 'image/rogue4.jpg';
                        else if (base === 'mage') pImg.src = 'image/mage4.jpg';
                        else pImg.src = `image/${base}1.jpg`;
                    } else {
                         const jM = {
                            'Ï†ÑÏÇ¨': 'warrior', 'ÎèÑÏ†Å': 'rogue', 'ÎßàÎ≤ïÏÇ¨': 'mage',
                            'Î≤ÑÏÑúÏª§': 'warrior1', 'Í∞ÄÎîîÏñ∏': 'warrior1',
                            'Ïñ¥ÏåîÏã†': 'rogue1', 'ÏÑÄÎèÑÏö∞': 'rogue1',
                            'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ': 'mage1', 'ÏÜåÏÑúÎü¨': 'mage1'
                        };
                        let base = jM[player.job] || 'warrior';
                        pImg.src = `image/${base}.jpg`;
                    }
                }, 800); // Î™®ÏÖò Ïú†ÏßÄ ÏãúÍ∞Ñ Ï¶ùÍ∞Ä

                update();
                check();
            }, 400); // ÌÉÄÍ≤© ÌÉÄÏù¥Î∞ç Ï°∞Ï†à
        }

        function skl() {
            if(isActing) return; 
            if(pStatus.stun > 0) { addLog("Í∏∞Ï†à ÏÉÅÌÉúÎùº Ïä§ÌÇ¨ÏùÑ Ïì∏ Ïàò ÏóÜÏäµÎãàÎã§!"); pStatus.stun--; update(); setTimeout(eTurn, 1500); return; }

            let costRate = 0.6;
            if (player.job === 'ÏÜåÏÑúÎü¨') costRate = 0.3;
            if (player.job === 'ÎèÑÏ†Å' || player.job === 'Ïñ¥ÏåîÏã†' || player.job === 'ÏÑÄÎèÑÏö∞') costRate = 0.4;

            if (pStatus.zeroMana > 0 || pStatus.nextSkillZeroCost > 0) costRate = 0;

            const cost = Math.floor(player.maxMp * costRate);
            if(player.mp < cost) { say('p', 'ÎßàÎÇòÍ∞Ä Î∂ÄÏ°±Ìï¥!'); return; }

            isActing = true;
            player.mp -= cost;
            if (pStatus.nextSkillZeroCost > 0) pStatus.nextSkillZeroCost = 0;
            update();

            const jobKey = player.job || 'Ï†ÑÏÇ¨';
            playAttackSfx();

            setTimeout(() => {
                let isCrit = false; let dmg = 0;
                
                if(player.job === 'ÎèÑÏ†Å' || player.job === 'Ïñ¥ÏåîÏã†' || player.job === 'ÏÑÄÎèÑÏö∞') {
                    say('p', `Í∏âÏÜå Ï∞åÎ•¥Í∏∞!`);
                    let baseDmg = Math.floor(player.stats.dex * 0.5) + (player.level * 2);
                    let critChance = (player.job === 'Ïñ¥ÏåîÏã†') ? 0.55 : 0.4;
                    if (pStatus.critUp > 0) critChance = 1.0;
                    isCrit = Math.random() < critChance;
                    if (isCrit) {
                        dmg = (baseDmg * 4) + (player.bonusAtk||0);
                        playCritSfx();
                    }
                    else { dmg = baseDmg + (player.bonusAtk||0); }

                    let poisonChance = (player.job === 'ÏÑÄÎèÑÏö∞') ? 1.0 : 0.5;
                    if(Math.random() < poisonChance) { eStatus.poison = 3; addLog("Ï†ÅÏóêÍ≤å ÎèÖÏùÑ Î∂ÄÏó¨ÌñàÏäµÎãàÎã§!"); }

                    if (isLegendary) {
                        document.getElementById('player-frame').classList.add('rogue-legendary-action');
                        setTimeout(() => document.getElementById('player-frame').classList.remove('rogue-legendary-action'), 500);
                    }

                    const vMap = {
                        'ÎèÑÏ†Å':'v-rogue', 'Ïñ¥ÏåîÏã†':'v-rogue1', 'ÏÑÄÎèÑÏö∞':'v-rogue1'
                    };
                    const v = document.getElementById(vMap[jobKey] || 'v-rogue'); const pImg = document.getElementById('p-img');
                    if(v) {
                        v.pause();
                        v.currentTime = 0; // Reset video to start
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => { v.style.display='none'; pImg.style.display='block'; applySkillDmg(player.job, dmg, isCrit); }
                    } else {
                        playMotion('atk-rogue', 'enemy-frame', isCrit?'crit':'rogue');
                        applySkillDmg(player.job, dmg, isCrit);
                    }
                    return;
                } else {
                    say('p', 'Í∞ïÎ†•Ìïú Ïä§ÌÇ¨ Î∞úÎèô!');
                    let vMap = {
                        'Ï†ÑÏÇ¨':'v-warrior', 'ÎßàÎ≤ïÏÇ¨':'v-mage',
                        'Î≤ÑÏÑúÏª§':'v-warrior1', 'Í∞ÄÎîîÏñ∏':'v-warrior1',
                        'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ':'v-mage1', 'ÏÜåÏÑúÎü¨':'v-mage1'
                    };

                    if (isLegendary) {
                        if (player.job === 'ÎßàÎ≤ïÏÇ¨' || player.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || player.job === 'ÏÜåÏÑúÎü¨') {
                            vMap['ÎßàÎ≤ïÏÇ¨'] = 'v-mage2'; vMap['ÏïÑÌÅ¨Î©îÏù¥ÏßÄ'] = 'v-mage2'; vMap['ÏÜåÏÑúÎü¨'] = 'v-mage2';
                        } else if (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏') {
                            vMap['Ï†ÑÏÇ¨'] = 'v-warrior2'; vMap['Î≤ÑÏÑúÏª§'] = 'v-warrior2'; vMap['Í∞ÄÎîîÏñ∏'] = 'v-warrior2';
                        }
                    }

                    const v = document.getElementById(vMap[jobKey]); const pImg = document.getElementById('p-img');
                    if(v) {
                        v.pause();
                        v.currentTime = 0; // Reset video to start
                        pImg.style.display='none'; v.style.display='block'; v.play();
                        v.onended = () => { v.style.display='none'; pImg.style.display='block'; applySkillDmg(player.job); }
                    } else applySkillDmg(player.job);
                    return;
                }
            }, 200);
        }

        function applySkillDmg(job, preCalcDmg = 0, preCalcCrit = false) {
            let isCrit = preCalcCrit;
            let dmg = preCalcDmg;

            if (dmg === 0) { // If not pre-calculated (for non-rogue classes)
                isCrit = Math.random() < 0.2;
                if (pStatus.critUp > 0) isCrit = true;
                let multiplier = 2.0;

                if (job === 'Î≤ÑÏÑúÏª§') multiplier = 4.0;
                else if (job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ') multiplier = 4.5;
                else if (job === 'Ï†ÑÏÇ¨' || job === 'Í∞ÄÎîîÏñ∏') multiplier = 2.5;
                else if (job === 'ÎßàÎ≤ïÏÇ¨' || job === 'ÏÜåÏÑúÎü¨') multiplier = 2.2;

                if (currentWeather === "rain" && (job === 'ÎßàÎ≤ïÏÇ¨' || job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || job === 'ÏÜåÏÑúÎü¨')) {
                    multiplier *= 1.3;
                    addLog("<span style='color:#82b1ff'>ÎπÑÏùò Í∏∞Ïö¥ÏúºÎ°ú ÎßàÎ≤ïÏù¥ Í∞ïÌôîÎêòÏóàÏäµÎãàÎã§!</span>");
                }

                if(job === 'Ï†ÑÏÇ¨' || job === 'Î≤ÑÏÑúÏª§' || job === 'Í∞ÄÎîîÏñ∏') {
                    dmg = (player.stats.str * multiplier) + (player.level * 4);
                    if (job === 'Í∞ÄÎîîÏñ∏' && Math.random() < 0.3) { eStatus.stun = 1; addLog("Ï†ÅÏùÑ Í∏∞Ï†àÏãúÏº∞ÏäµÎãàÎã§!"); }
                } else {
                    dmg = (player.stats.int * multiplier) + (player.level * 5);
                }

                // Berserk check
                if (pStatus.atkUp > 0 && (job === 'Î≤ÑÏÑúÏª§' || job === 'Ï†ÑÏÇ¨')) dmg *= 2;

                dmg += (player.bonusAtk||0);
                if(isCrit) { dmg = Math.floor(dmg*2); playCritSfx(); }
            }

            // Skill Dmg Up (Focus Potion)
            if (pStatus.skillDmgUp > 0) {
                dmg = Math.floor(dmg * 1.5);
            }

            // Archmage Triple
            if (pStatus.nextSkillTriple > 0) {
                dmg *= 3;
                pStatus.nextSkillTriple = 0;
                pStatus.stun = 1;
                addLog("ÎßàÎ†• Ìè≠Ï£º Î∞òÎèôÏúºÎ°ú Í∏∞Ï†àÌñàÏäµÎãàÎã§!");
            }

            if (isLegendary && (job === 'Ï†ÑÏÇ¨' || job === 'Î≤ÑÏÑúÏª§' || job === 'Í∞ÄÎîîÏñ∏')) {
                triggerScreenShake(true);
            }

            triggerHitEffect('enemy-frame', isCrit?'crit':'big');
            enemy.hp -= dmg; 
            showDamage('enemy-frame', dmg, isCrit?'crit':'normal'); 
            addLog(`Ïä§ÌÇ¨ Ï†ÅÏ§ë! <span class='log-dmg'>${dmg}</span> ÌîºÌï¥!`);
            update(); check();
        }

        function rageAtk() {
            if(isActing || rage < maxRage) return;
            if(pStatus.stun > 0) { addLog("Í∏∞Ï†à ÏÉÅÌÉúÎùº Î∂ÑÎÖ∏ Í≥µÍ≤©ÏùÑ Ìï† Ïàò ÏóÜÏäµÎãàÎã§!"); return; }

            isActing = true;
            rage = 0;
            player.rage = 0;
            update();

            // Î∂ÑÎÖ∏ Î∞úÎèô Ïù¥ÌéôÌä∏
            const pFrame = document.getElementById('player-frame');
            pFrame.classList.add('rage-active-aura');

            say('p', 'Î∂ÑÎÖ∏Ïùò ÏùºÍ≤©!!!');
            playCritSfx();

            // Show Rage Kill Effect
            const killImg = document.getElementById('rage-kill-img');

            const baseJobs = ['Ï†ÑÏÇ¨', 'ÎèÑÏ†Å', 'ÎßàÎ≤ïÏÇ¨'];
            if (!baseJobs.includes(player.job)) {
                killImg.src = 'image/damage_kill1.jpg';
            } else {
                killImg.src = 'image/damage_kill.jpg';
            }

            killImg.classList.add('rage-kill-anim');
            setTimeout(() => killImg.classList.remove('rage-kill-anim'), 2000);

            setTimeout(() => {
                let dmg = (Math.floor(player.stats.str/1.8) + (player.level*2) + 5 + (player.bonusAtk||0)) * 3;

                const jobKey = player.job || 'Ï†ÑÏÇ¨';
                const imgMap = {
                    'Ï†ÑÏÇ¨':'atk-warrior', 'ÎèÑÏ†Å':'atk-rogue', 'ÎßàÎ≤ïÏÇ¨':'atk-mage',
                    'Î≤ÑÏÑúÏª§':'atk-warrior', 'Í∞ÄÎîîÏñ∏':'atk-warrior',
                    'Ïñ¥ÏåîÏã†':'atk-rogue', 'ÏÑÄÎèÑÏö∞':'atk-rogue',
                    'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ':'atk-mage', 'ÏÜåÏÑúÎü¨':'atk-mage'
                };

                if (isLegendary && (player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏')) {
                    triggerScreenShake(true);
                }

                playMotion(imgMap[jobKey], 'enemy-frame', 'crit');
                enemy.hp -= dmg;
                showDamage('enemy-frame', dmg, 'crit');
                addLog(`Î∂ÑÎÖ∏ Í≥µÍ≤©! Ï†ÅÏóêÍ≤å <span class='log-dmg'>${dmg}</span>Ïùò ÏπòÎ™ÖÏ†ÅÏù∏ ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§!`);

                // Ïù¥ÌéôÌä∏ Ï†úÍ±∞
                setTimeout(() => {
                    pFrame.classList.remove('rage-active-aura');
                }, 1000);

                update(); check();
            }, 500);
        }

        function check() { 
            if(enemy.hp <= 0) { say('e', 'ÌÅ¨ÏúΩ..!'); setTimeout(win, 1000); }
            else { setTimeout(eTurn, 1500); }
        }
        
        function tickPlayerBuffs() {
            if (specialCooldown > 0) specialCooldown--;
            if (doubleAttackCooldown > 0) doubleAttackCooldown--;
            if (pStatus.defUp > 0) pStatus.defUp--;
            if (pStatus.atkUp > 0) pStatus.atkUp--;
            if (pStatus.invincible > 0) pStatus.invincible--;
            if (pStatus.zeroMana > 0) pStatus.zeroMana--;
            if (pStatus.skillDmgUp > 0) pStatus.skillDmgUp--;
            if (pStatus.critUp > 0) pStatus.critUp--;
        }

        function eTurn() {
            if(eStatus.stun > 0) {
                addLog("Ï†ÅÏù¥ Í∏∞Ï†à ÏÉÅÌÉúÎùº ÌñâÎèôÌï† Ïàò ÏóÜÏäµÎãàÎã§!");
                eStatus.stun--;
                tickPlayerBuffs();
                update(); isActing = false; return;
            }

            if(eStatus.poison > 0) {
                const pDmg = Math.floor(enemy.maxHp * 0.05);
                enemy.hp -= pDmg;
                showDamage('enemy-frame', pDmg, 'poison');
                addLog(`Ï†ÅÏù¥ ÎèÖÏúºÎ°ú Ïù∏Ìï¥ <span style="color:#9b26b6">${pDmg}</span> ÌîºÌï¥Î•º ÏûÖÏóàÏäµÎãàÎã§.`);
                eStatus.poison--;
                update();
                if(enemy.hp <= 0) { win(); return; }
            }

            if(pStatus.poison > 0) {
                const pDmg = Math.floor(player.maxHp * 0.12);
                player.hp -= pDmg;
                showDamage('player-frame', pDmg, 'poison');
                addLog(`ÎèÖÏúºÎ°ú Ïù∏Ìï¥ <span style="color:#9b26b6">${pDmg}</span> ÌîºÌï¥Î•º ÏûÖÏóàÏäµÎãàÎã§.`);
                pStatus.poison--;
                update();
                if(player.hp <= 0) { showGameOver("ÎèÖÏóê ÏùòÌï¥ Ïì∞Îü¨Ï°åÏäµÎãàÎã§..."); return; }
            }

            let evadeChance = (player.stats.dex / 100) + (player.level * 0.005);
            if (player.job === 'Ïñ¥ÏåîÏã†' || player.job === 'ÏÑÄÎèÑÏö∞') evadeChance += 0.1;
            if (currentWeather === "fog") evadeChance += 0.1;
            evadeChance = Math.min(0.4, evadeChance);

            if (Math.random() < evadeChance) {
                addLog("<span class='log-evade'>Ï†ÅÏùò Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§!</span>");
                playEvadeSfx();
                say('p', 'ÎäêÎ†§!');
                playMotion('', 'player-frame', 'evade');
                showDamage('player-frame', 0, 'evade');
                playEnemyAttackMotion();
                tickPlayerBuffs();
                update(); isActing = false;
                return;
            }

            playEnemyAttackMotion();

            let dmg = Math.max(1, enemy.atk - Math.floor(player.stats.dex/3) - (player.bonusDef || 0));
            if (player.job === 'Í∞ÄÎîîÏñ∏') dmg = Math.floor(dmg * 0.8);

            let isCrit = false;
            const critChance = 0.08;
            if (Math.random() < critChance) {
                dmg = Math.floor(dmg * 1.5);
                isCrit = true;
            }

            // Special damage logic for new monsters
            if (enemy.type === 'bear_warrior') {
                if (player.job === 'ÎßàÎ≤ïÏÇ¨' || player.job === 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ' || player.job === 'ÏÜåÏÑúÎü¨') {
                    dmg = Math.floor(dmg * 1.3);
                    addLog("<span style='color:orange'>Í≥∞Ï†ÑÏÇ¨ Ï∂îÌååÍ∞Ä ÎßàÎ≤ïÏÇ¨ÏóêÍ≤å Ï∂îÍ∞Ä ÌîºÌï¥Î•º ÏûÖÌûôÎãàÎã§!</span>");
                }
            } else if (enemy.type === 'mage_holly') {
                if (player.job === 'ÎèÑÏ†Å' || player.job === 'Ïñ¥ÏåîÏã†' || player.job === 'ÏÑÄÎèÑÏö∞' ||
                    player.job === 'Ï†ÑÏÇ¨' || player.job === 'Î≤ÑÏÑúÏª§' || player.job === 'Í∞ÄÎîîÏñ∏') {
                    dmg = Math.floor(dmg * 1.3);
                    addLog("<span style='color:purple'>ÎßàÎ≤ïÏÇ¨ ÌôÄÎ¶¨Í∞Ä Í∑ºÏ†ë ÏßÅÏóÖÏóêÍ≤å Ï∂îÍ∞Ä ÌîºÌï¥Î•º ÏûÖÌûôÎãàÎã§!</span>");
                }
            }

            // Apply Defense Buffs
            if (pStatus.invincible > 0) {
                dmg = 0;
                addLog("ÏôÑÏ†Ñ Î∞©Ïñ¥Î°ú Í≥µÍ≤©ÏùÑ Î¨¥Ìö®ÌôîÌñàÏäµÎãàÎã§!");
            } else if (pStatus.defUp > 0) {
                dmg = Math.floor(dmg * 0.5);
                addLog("Î∞©Ìå® Î∞©Ïñ¥Î°ú ÌîºÌï¥Í∞Ä Î∞òÍ∞êÎêòÏóàÏäµÎãàÎã§.");
            }

            if (dmg > 0) {
                player.hp -= dmg;

                const cha = player.stats.cha || 10;
                const chaRageBonus = (cha - 10) * 0.5; // 0.5 extra rage per CHA point above 10
                rage = Math.min(maxRage, rage + Math.floor(dmg * 1.5 + chaRageBonus));
                player.rage = rage;

                playDamageSfx();
                const jobKey = player.job || 'Ï†ÑÏÇ¨';
                const hitMap = {
                    'Ï†ÑÏÇ¨':'hit-warrior', 'ÎèÑÏ†Å':'hit-rogue', 'ÎßàÎ≤ïÏÇ¨':'hit-mage',
                    'Î≤ÑÏÑúÏª§':'hit-warrior', 'Í∞ÄÎîîÏñ∏':'hit-warrior',
                    'Ïñ¥ÏåîÏã†':'hit-rogue', 'ÏÑÄÎèÑÏö∞':'hit-rogue',
                    'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ':'hit-mage', 'ÏÜåÏÑúÎü¨':'hit-mage'
                };

                if (isCrit) {
                    triggerScreenShake(true);
                    playMotion(hitMap[jobKey], 'player-frame', 'big');
                    showDamage('player-frame', dmg, 'player_hit');
                    say('e', 'ÌÅ¨ÌïòÌïòÌïò!');
                    addLog(`<span style='color:red; font-weight:bold; font-size:1.2rem;'>ÏπòÎ™ÖÏÉÅ! ${dmg} ÌîºÌï¥!</span>`);
                } else {
                    playMotion(hitMap[jobKey], 'player-frame', 'player_hit');
                    showDamage('player-frame', dmg, 'player_hit');
                    say('e', 'Î∞õÏïÑÎùº!');
                    addLog(`Ï†ÅÏù¥ Í≥µÍ≤©Ìï©ÎãàÎã§! <span style='color:red'>${dmg}</span> ÌîºÌï¥Î•º ÏûÖÏóàÏäµÎãàÎã§.`);
                }

                let poisonChance = enemy.canPoison ? 0.3 : 0;
                if(Math.random() < poisonChance) { pStatus.poison = 3; addLog("<span style='color:#9b26b6'>Ï†ÅÏùò Í≥µÍ≤©Ïóê Ï§ëÎèÖÎêòÏóàÏäµÎãàÎã§!</span>"); }
                if(Math.random() < 0.1) { pStatus.stun = 1; addLog("Í∏∞Ï†àÌñàÏäµÎãàÎã§!"); }
            }

            tickPlayerBuffs();
            update(); isActing = false;
            if(player.hp <= 0) { showGameOver("Ìå®Î∞∞ÌñàÏäµÎãàÎã§..."); }
        }

        function sendRankingData(score, survivalTime) {
            const bossKills = player.quests.bossKillCount || 0;
            fetch(DB_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    type: 'ranking',
                    name: player.name,
                    score: score,
                    job: player.job,
                    level: player.level,
                    bossKills: bossKills
                })
            });
        }

        function showGameOver(msg) {
            isActing = true; // Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            // Î∞∞Í≤Ω Î≤ÑÌäºÎì§ Î™ÖÏãúÏ†Å ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.btns .btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            const rageBtn = document.getElementById('btn-rage');
            if(rageBtn) rageBtn.style.display = 'none';

            stopBossBgm();
            const startTime = parseInt(localStorage.getItem('rpg_start_time') || Date.now());
            const survivalTime = Math.floor((Date.now() - startTime) / 1000);
            const min = Math.floor(survivalTime / 60);
            const sec = survivalTime % 60;

            const kills = player.quests.killCount || 0;
            const bossKills = player.quests.bossKillCount || 0;
            const normalKills = Math.max(0, kills - bossKills);

            let itemValue = 0;
            player.inventory.forEach(item => {
                if (item.type === 'weapon') {
                    if (item.rarity === 'legendary') itemValue += 5000;
                    else if (item.rarity === 'epic') itemValue += 2000;
                } else if (item.type.includes('potion') || item.type.includes('scroll')) {
                    const rareItems = ['potion_full', 'potion_focus', 'potion_madness', 'potion_skeleton', 'potion_holy', 'potion_gamble', 'scroll_option'];
                    if (rareItems.includes(item.type)) itemValue += 500;
                }
            });

            const lvScore = player.level * 1000;
            const bossScore = bossKills * 2000;
            const normalScore = normalKills * 10;
            const goldScore = Math.floor(player.gold * 0.1);
            const survivalScore = survivalTime;
            const coinScore = player.coinScore || 0;

            const totalScore = lvScore + bossScore + normalScore + goldScore + itemValue + survivalScore + coinScore;

            const statsContainer = document.getElementById('go-stats-container');
            statsContainer.innerHTML = `
                <div class="go-row"><div class="go-label">üîπ Ï∫êÎ¶≠ÌÑ∞ Î†àÎ≤®</div><div class="go-val">${player.level} (LV) <span style="color:#888; font-size:0.8rem;">+${lvScore.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">üíÄ Î≥¥Ïä§ Ï≤òÏπò</div><div class="go-val">${bossKills} (ÎßàÎ¶¨) <span style="color:#888; font-size:0.8rem;">+${bossScore.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">‚öîÔ∏è Î™¨Ïä§ÌÑ∞ ÏÇ¨ÎÉ•</div><div class="go-val">${normalKills} (ÎßàÎ¶¨) <span style="color:#888; font-size:0.8rem;">+${normalScore.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">üí∞ Î≥¥Ïú† ÏûêÏÇ∞</div><div class="go-val">${player.gold.toLocaleString()} (G) <span style="color:#888; font-size:0.8rem;">+${goldScore.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">üíé ÏïÑÏù¥ÌÖú Í∞ÄÏπò</div><div class="go-val"><span style="color:#888; font-size:0.8rem;">+${itemValue.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">ü™ô ÏΩîÏù∏ Ï†êÏàò</div><div class="go-val">${coinScore.toLocaleString()} <span style="color:#888; font-size:0.8rem;">+${coinScore.toLocaleString()}</span></div></div>
                <div class="go-row"><div class="go-label">‚è≥ ÏÉùÏ°¥ Î≥¥ÎÑàÏä§</div><div class="go-val">${min}Î∂Ñ ${sec}Ï¥à <span style="color:#888; font-size:0.8rem;">+${survivalScore.toLocaleString()}</span></div></div>
            `;

            document.querySelector('.gameover-title').innerText = msg;
            document.getElementById('go-score-val').innerText = totalScore.toLocaleString();

            // Send Ranking Data
            sendRankingData(totalScore, survivalTime);

            localStorage.removeItem('rpg_temp_player');
            localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
            localStorage.removeItem('rpg_boss_death_time');

            document.getElementById('gameover-modal').style.display = 'flex';
        }

        function getWeaponImage(job, rarity) {
            let baseJob = 'Ï†ÑÏÇ¨';
            if (['ÎèÑÏ†Å', 'Ïñ¥ÏåîÏã†', 'ÏÑÄÎèÑÏö∞'].includes(job)) baseJob = 'ÎèÑÏ†Å';
            if (['ÎßàÎ≤ïÏÇ¨', 'ÏïÑÌÅ¨Î©îÏù¥ÏßÄ', 'ÏÜåÏÑúÎü¨'].includes(job)) baseJob = 'ÎßàÎ≤ïÏÇ¨';

            if (baseJob === 'Ï†ÑÏÇ¨') {
                if (rarity === 'legendary') return 'legend_warrior.jpg';
                if (rarity === 'epic') return 'epic_warrior.jpg';
                return 'weapon_warrior.jpg';
            } else if (baseJob === 'ÎèÑÏ†Å') {
                if (rarity === 'legendary') return 'legend_rogue.jpg';
                if (rarity === 'epic') return 'epic_rogue.jpg';
                return 'weapon_rogue.jpg';
            } else if (baseJob === 'ÎßàÎ≤ïÏÇ¨') {
                if (rarity === 'legendary') return 'legend_mage.jpg';
                if (rarity === 'epic') return 'epic_mage.jpg';
                return 'weapon_mage.jpg';
            }
            return 'weapon_warrior.jpg';
        }

        function win() {
            stopBossBgm();
            const isNight = localStorage.getItem('rpg_is_night') === 'true';

            if (isBossBattle) {
                if (isSuperBoss) {
                    localStorage.setItem('rpg_super_boss_killed', 'true');
                } else {
                    localStorage.setItem('rpg_boss_death_time', Date.now());
                }
                localStorage.removeItem('rpg_boss_x'); localStorage.removeItem('rpg_boss_y');
                player.quests.bossKillCount = (player.quests.bossKillCount || 0) + 1;
            } else {
                if (isNight) player.quests.nightKillCount = (player.quests.nightKillCount || 0) + 1;
                else player.quests.dayKillCount = (player.quests.dayKillCount || 0) + 1;
            }

            player.exp += enemy.exp;
            player.quests.killCount++;

            let resultHTML = `<div class="result-row">ÌöçÎìù Í≤ΩÌóòÏπò <span style="color:violet">+${enemy.exp} EXP</span></div>`;
            let dropImg = null; let dropName = ""; let dropColor = "#fff";

            const gold = Math.floor(Math.random()*50)+10 + (isBossBattle ? 500 : 0);
            player.gold = (player.gold||0) + gold;
            resultHTML += `<div class="result-row">ÌöçÎìù Í≥®Îìú <span style="color:gold">+${gold} G</span></div>`;
            if(!dropImg) dropImg = ITEM_IMAGES['gold'];
            playGoldSfx();

            const cha = player.stats.cha || 10;
            const chaDropBonus = (cha - 10) * 0.005; // 0.5% per CHA point above 10

            const rand = Math.random();

            if (isBossBattle && rand < 0.5 + chaDropBonus) {
                const jobList = DROP_TABLE[player.job] || DROP_TABLE['Ï†ÑÏÇ¨'];
                const baseName = jobList[Math.floor(Math.random() * jobList.length)];

                let isLegendary = isSuperBoss || Math.random() < 0.3 + chaDropBonus;
                if (!player.isAdvanced) isLegendary = false;

                let grade = isLegendary ? Math.floor(Math.random() * 6) + 10 : Math.floor(Math.random() * 5) + 8;
                let colorCode = isLegendary ? "#ff8000" : "#a335ee";
                let rarityName = isLegendary ? "Ï†ÑÏÑ§Ïùò" : "ÏóêÌîΩ";
                const newItem = { name: `${rarityName} ${baseName} (+${grade})`, type: 'weapon', desc: `Í≥µÍ≤©Î†• +${grade} (${player.job} Ï†ÑÏö©)`, val: grade, reqJob: player.job, equipped: false, rarity: isLegendary ? "legendary" : "epic", rarityColor: colorCode, enhanceCount: grade, options: [] };

                const optCount = isLegendary ? 3 : 1;
                const possibleOpts = [{name:"Ìûò",key:"str",val:Math.floor(Math.random()*5)+2}, {name:"ÎØºÏ≤©",key:"dex",val:Math.floor(Math.random()*5)+2}, {name:"Ï≤¥Î†•",key:"con",val:Math.floor(Math.random()*5)+2}, {name:"ÏßÄÎä•",key:"int",val:Math.floor(Math.random()*5)+2}];
                for(let i=0; i<optCount; i++) { const opt = possibleOpts[Math.floor(Math.random()*possibleOpts.length)]; newItem.options.push(opt); newItem.desc += `\n[ÏòµÏÖò] ${opt.name} +${opt.val}`; }

                player.inventory.push(newItem);
                dropName = newItem.name; dropColor = colorCode; dropImg = getWeaponImage(player.job, newItem.rarity);
            } 
            else if (!isBossBattle && rand < 0.05 + chaDropBonus) {
                const nameList = DROP_TABLE[player.job] || DROP_TABLE['Ï†ÑÏÇ¨'];
                const baseName = nameList[Math.floor(Math.random() * nameList.length)];

                let isLegendary = false;
                if (player.isAdvanced && Math.random() < 0.01 + chaDropBonus) isLegendary = true;

                let grade = isLegendary ? Math.floor(Math.random() * 6) + 10 : Math.floor(Math.random() * 5) + 8;
                let colorCode = isLegendary ? "#ff8000" : "#a335ee";
                let rarityName = isLegendary ? "Ï†ÑÏÑ§Ïùò" : "ÏóêÌîΩ";
                let rarity = isLegendary ? "legendary" : "epic";

                const newItem = { name: `${rarityName} ${baseName} (+${grade})`, type: 'weapon', desc: `Í≥µÍ≤©Î†• +${grade} (${player.job} Ï†ÑÏö©)`, val: grade, reqJob: player.job, equipped: false, rarity: rarity, rarityColor: colorCode, enhanceCount: grade, options: [] };

                const optCount = isLegendary ? 3 : 1;
                const possibleOpts = [{name:"Ìûò",key:"str",val:Math.floor(Math.random()*5)+1}, {name:"ÎØºÏ≤©",key:"dex",val:Math.floor(Math.random()*5)+1}, {name:"Ï≤¥Î†•",key:"con",val:Math.floor(Math.random()*5)+1}, {name:"ÏßÄÎä•",key:"int",val:Math.floor(Math.random()*5)+1}];
                for(let i=0; i<optCount; i++) { const opt = possibleOpts[Math.floor(Math.random()*possibleOpts.length)]; newItem.options.push(opt); newItem.desc += `\n[ÏòµÏÖò] ${opt.name} +${opt.val}`; }

                player.inventory.push(newItem);
                dropName = newItem.name; dropColor = colorCode; dropImg = getWeaponImage(player.job, newItem.rarity);
            }
            else if (Math.random() < 0.6 + chaDropBonus) {
                const r = Math.random();
                const ns = isNight ? "_night" : "";
                const holyNs = isNight ? "_night" : "";
                if (r < 0.008 + chaDropBonus) {
                    const img = "potion_full" + ns + ".jpg";
                    player.inventory.push({name:'ÌíÄ ÌöåÎ≥µ Ìè¨ÏÖò', type:'potion_full', desc:'HPÏôÄ MPÎ•º Î™®Îëê ÌöåÎ≥µÌï©ÎãàÎã§.', val:9999, img: img});
                    dropName = "ÌíÄ ÌöåÎ≥µ Ìè¨ÏÖò"; dropColor="#00e676"; dropImg=img;
                } else if (r < 0.018 + chaDropBonus) {
                     const img = "potion_focus" + ns + ".jpg";
                     player.inventory.push({name:'Ï†ïÏã† ÏßëÏ§ë Ìè¨ÏÖò', type:'potion_focus', desc:'Îã§Ïùå Ïä§ÌÇ¨ ÎßàÎÇò 0 & 3ÌÑ¥Í∞Ñ Ïä§ÌÇ¨ Îç∞ÎØ∏ÏßÄ 50% Ï¶ùÍ∞Ä', val:0, img: img});
                     dropName = "Ï†ïÏã† ÏßëÏ§ë Ìè¨ÏÖò"; dropColor="#2979ff"; dropImg=img;
                } else if (r < 0.03 + chaDropBonus) {
                     const img = "potion_madness" + ns + ".jpg";
                     player.inventory.push({name:'Í¥ëÍ∏∞Ïùò Î¨ºÏïΩ', type:'potion_madness', desc:'HP 30% Í∞êÏÜå, 3ÌÑ¥Í∞Ñ 100% ÌÅ¨Î¶¨Ìã∞Ïª¨', val:0, img: img});
                     dropName = "Í¥ëÍ∏∞Ïùò Î¨ºÏïΩ"; dropColor="#ff1744"; dropImg=img;
                } else if (r < 0.05 + chaDropBonus) {
                    const img = "potion_skeleton" + ns + ".jpg";
                    player.inventory.push({name:'Ìï¥Í≥® Ìè¨ÏÖò', type:'potion_skeleton', desc:'HP/MP ÏôÑÏ†Ñ ÌöåÎ≥µ (Îã§Ïùå Ï†ÑÌà¨ Ï†ÄÏ£º)', val:0, img: img});
                    dropName = "Ìï¥Í≥® Ìè¨ÏÖò"; dropColor="#757575"; dropImg=img;
                } else if (r < 0.08 + chaDropBonus) {
                     const img = "potion_holy" + holyNs + ".jpg";
                     player.inventory.push({name:'Ï†ïÌôîÏùò ÏÑ±Ïàò', type:'potion_holy', desc:'Î™®Îì† ÏÉÅÌÉú Ïù¥ÏÉÅ Ìï¥Ï†ú', val:0, img: img});
                     dropName = "Ï†ïÌôîÏùò ÏÑ±Ïàò"; dropColor="#00e676"; dropImg=img;
                } else if (r < 0.12 + chaDropBonus) {
                    const img = "potion_gamble" + ns + ".jpg";
                    player.inventory.push({name:'ÎèÑÎ∞ïÏÇ¨Ïùò ÏãúÏïΩ', type:'potion_gamble', desc:'8Í∞ÄÏßÄ Ìö®Í≥º Ï§ë ÌïòÎÇòÍ∞Ä Î¨¥ÏûëÏúÑÎ°ú Î∞úÎèôÌï©ÎãàÎã§.', val:0, img: img});
                    dropName = "ÎèÑÎ∞ïÏÇ¨Ïùò ÏãúÏïΩ"; dropColor="#ffd700"; dropImg=img;
                } else if (r < 0.25 + chaDropBonus) {
                    const img = "Scroll" + ns + ".jpg";
                    player.inventory.push({name:'ÏòµÏÖò Î∂ÄÏó¨ Ïä§ÌÅ¨Î°§', type:'scroll_option', desc:'Ïû•ÎπÑ ÏòµÏÖò Ïû¨ÏÑ§Ï†ï (1~3Í∞ú)', val:0, img: img});
                    dropName = "ÏòµÏÖò Î∂ÄÏó¨ Ïä§ÌÅ¨Î°§"; dropColor="#ffb74d"; dropImg=img;
                } else {
                    const subR = Math.random();
                    if(subR < 0.3) { const img = "potion_hp" + ns + ".jpg"; player.inventory.push({name:'Ï≤¥Î†• Î¨ºÏïΩ', type:'potion_hp', desc:'HP +50 ÌöåÎ≥µ', val:50, img: img}); dropName = "Ï≤¥Î†• Î¨ºÏïΩ"; dropColor="#ff8a80"; dropImg=img; }
                    else if(subR < 0.6) { const img = "potion_mp" + ns + ".jpg"; player.inventory.push({name:'ÎßàÎÇò Î¨ºÏïΩ', type:'potion_mp', desc:'MP +30 ÌöåÎ≥µ', val:30, img: img}); dropName = "ÎßàÎÇò Î¨ºÏïΩ"; dropColor="#82b1ff"; dropImg=img; }
                    else if(subR < 0.8) { const img = "potion_exp" + ns + ".jpg"; player.inventory.push({name:'Í≤ΩÌóòÏπò Î¨ºÏïΩ', type:'potion_exp', desc:'EXP +100 ÌöçÎìù', val:100, img: img}); dropName = "Í≤ΩÌóòÏπò Î¨ºÏïΩ"; dropColor="#e040fb"; dropImg=img; }
                    else { const img = "potion_poison" + ns + ".jpg"; player.inventory.push({name:'Ìï¥ÎèÖ Î¨ºÏïΩ', type:'potion_poison', desc:'ÎèÖ ÏÉÅÌÉú Ìï¥Ï†ú', val:0, img: img}); dropName = "Ìï¥ÎèÖ Î¨ºÏïΩ"; dropColor="#00e676"; dropImg=img; }
                }
            }
            else if (Math.random() < 0.2 + chaDropBonus) {
                const rand = Math.random();
                const ns = isNight ? "_night" : "";
                if(rand < 0.5) {
                    const val = Math.floor(Math.random() * 5) + 1;
                    const img = "attack_10" + ns + ".jpg";
                    player.inventory.push({name:'Í≥µÍ≤©Î†• Í∞ïÌôî Î¨ºÏïΩ', type:'potion_atk', desc:`Í≥µÍ≤©Î†• +${val} ÏòÅÍµ¨ Ï¶ùÍ∞Ä`, val:val, img: img});
                    dropName = "Í≥µÍ≤©Î†• Í∞ïÌôî Î¨ºÏïΩ";
                    dropColor="#ff8a80";
                    dropImg=img;
                } else {
                    const val = Math.random() < 0.5 ? 1 : 5;
                    const img = "Defense_10" + ns + ".jpg";
                    player.inventory.push({name:'Î∞©Ïñ¥Î†• Í∞ïÌôî Î¨ºÏïΩ', type:'potion_def', desc:`Î∞©Ïñ¥Î†• +${val} ÏòÅÍµ¨ Ï¶ùÍ∞Ä`, val:val, img: img});
                    dropName = "Î∞©Ïñ¥Î†• Í∞ïÌôî Î¨ºÏïΩ";
                    dropColor="#82b1ff";
                    dropImg=img;
                }
            }

            if(dropName) {
                playItemSfx();
                resultHTML += `<div class="result-item-box"><img src="image/${dropImg}" class="result-item-img"><div class="result-item-name" style="color:${dropColor}">${dropName}</div><div style="font-size:0.8rem; color:#aaa;">ÏïÑÏù¥ÌÖúÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!</div></div>`;
            }
            
            if(dropName && dropImg) { 
                const imgEl = document.getElementById('drop-item-img'); 
                imgEl.src = `image/${dropImg}`; 
                imgEl.style.display = 'block'; 
                setTimeout(() => { imgEl.style.display = 'none'; showResultModal(resultHTML); }, 2000); 
            } else { 
                showResultModal(resultHTML); 
            }
        }

        function showResultModal(html) { document.getElementById('result-content').innerHTML = html; document.getElementById('result-modal').style.display = 'flex'; }
        
        function checkLevelUpOrFinish() { 
            document.getElementById('result-modal').style.display = 'none'; 
            if(player.exp >= player.maxExp) { showLevelUpModal(); } 
            else { finishBattle(); } 
        }
        
        function showLevelUpModal() {
            playLevelupSfx();
            const modal = document.getElementById('levelup-modal'); const oldLv = player.level; const oldHp = player.maxHp; const oldMp = player.maxMp;
            player.level++; player.exp -= player.maxExp; player.maxExp = Math.floor(player.maxExp*1.5); player.maxHp+=10; player.maxMp+=5; player.hp=player.maxHp; player.mp=player.maxMp;
            player.traitPoints = (player.traitPoints || 0) + 2;
            document.getElementById('old-lv').innerText = oldLv; document.getElementById('new-lv').innerText = player.level;
            document.getElementById('stat-hp').innerHTML = `${oldHp} <span class='stat-up'>‚ñ∑ ${player.maxHp} (+10)</span>`;
            document.getElementById('stat-mp').innerHTML = `${oldMp} <span class='stat-up'>‚ñ∑ ${player.maxMp} (+5)</span>`;

            const btn = document.getElementById('lv-confirm-btn');
            if (player.level >= 5 && !player.isAdvanced) {
                btn.innerText = "Ï†ÑÏßÅÌïòÎü¨ Í∞ÄÍ∏∞";
            } else {
                btn.innerText = "ÌäπÏÑ± Î∂ÑÎ∞∞ÌïòÎü¨ Í∞ÄÍ∏∞";
            }

            modal.style.display = 'flex';
        }
        
        function finishBattle() {
            player.rage = rage;
            player.specialCooldown = specialCooldown;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            location.href = 'map.html';
        }

        function finishBattleWithLevelUp() {
            player.rage = rage;
            player.specialCooldown = specialCooldown;
            localStorage.setItem('rpg_temp_player', JSON.stringify(player));
            if (!(player.level >= 5 && !player.isAdvanced)) {
                localStorage.setItem('rpg_open_traits', 'true');
            }
            location.href = 'map.html';
        }
        
        function run() { 
            if(isActing) return; isActing = true; 

            const cha = player.stats.cha || 10;
            const chaRunBonus = (cha - 10) * 0.01; // 1% per CHA point above 10

            let runChance = isBossBattle ? 0.3 : 0.4;
            runChance += chaRunBonus;

            if(Math.random() < runChance) {
                say('p', "ÌäÄÏñ¥!");
                addLog("Î¨¥ÏÇ¨Ìûà ÎèÑÎßùÏ≥§ÏäµÎãàÎã§!");
                stopBossBgm();

                if (isBossBattle && !isSuperBoss) {
                    localStorage.setItem('rpg_boss_ran_away', 'true');
                }

                setTimeout(finishBattle, 1200);
            }
            else {
                say('p', "Ïã§Ìå®..!");
                addLog("ÎèÑÎßùÏπòÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§!");
                setTimeout(eTurn, 1500);
            }
        }

        function openItemModal() {
            if(isActing) return;
            const modal = document.getElementById('item-modal');
            const list = document.getElementById('item-list');
            list.innerHTML = '';
            const potions = player.inventory.filter(i => i.type.includes('potion'));
            const potionGroups = {};
            potions.forEach((p, idx) => {
                const originalIdx = player.inventory.indexOf(p);
                if (!potionGroups[p.name]) potionGroups[p.name] = { item: p, count: 0, indices: [] };
                potionGroups[p.name].count++;
                potionGroups[p.name].indices.push(originalIdx);
            });

            if (Object.keys(potionGroups).length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            } else {
                for (const key in potionGroups) {
                    const group = potionGroups[key];
                    const item = group.item;
                    const div = document.createElement('div');
                    div.className = 'battle-item-row';
                    let iconSrc = item.img || ITEM_IMAGES[item.type] || 'potion_hp.jpg';

                    div.innerHTML = `<img src="image/${iconSrc}" class="battle-item-icon"><div class="battle-item-info"><div class="battle-item-name">${item.name}<span class="battle-item-count">x${group.count}</span></div><div class="battle-item-desc">${item.desc}</div></div>`;
                    div.onclick = () => useBattleItem(group.indices[0]);
                    list.appendChild(div);
                }
            }
            modal.style.display = 'flex';
        }

        function closeItemModal() { document.getElementById('item-modal').style.display = 'none'; }

        function useBattleItem(index) {
            closeItemModal();
            if(isActing) return;
            const item = player.inventory[index];
            if (!item) return;

            let handledByPopup = false;

            if (item.type === 'potion_full') {
                isActing = true;
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                addLog(`<span style="color:#00e676">ÌíÄ ÌöåÎ≥µ Ìè¨ÏÖò</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ HPÏôÄ MPÎ•º Î™®Îëê ÌöåÎ≥µÌñàÏäµÎãàÎã§!`);
                playPotionSfx();
            } else if (item.name.includes('Ï≤¥Î†•')) {
                if (player.hp >= player.maxHp) { addLog("Ï≤¥Î†•Ïù¥ Ïù¥ÎØ∏ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§."); return; }
                isActing = true;
                const heal = item.val;
                player.hp = Math.min(player.hp + heal, player.maxHp);
                addLog(`<span style="color:#ff5252">Ï≤¥Î†• Î¨ºÏïΩ</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ HPÎ•º <span style="color:#00e676">${heal}</span> ÌöåÎ≥µÌñàÏäµÎãàÎã§.`);
                playPotionSfx();
            } else if (item.name.includes('ÎßàÎÇò')) {
                if (player.mp >= player.maxMp) { addLog("ÎßàÎÇòÍ∞Ä Ïù¥ÎØ∏ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§."); return; }
                isActing = true;
                const heal = item.val;
                player.mp = Math.min(player.mp + heal, player.maxMp);
                addLog(`<span style="color:#2979ff">ÎßàÎÇò Î¨ºÏïΩ</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ MPÎ•º <span style="color:#2979ff">${heal}</span> ÌöåÎ≥µÌñàÏäµÎãàÎã§.`);
                playPotionSfx();
            } else if (item.name.includes('Í≤ΩÌóòÏπò')) {
                isActing = true;
                player.exp += item.val;
                addLog(`<span style="color:#e040fb">Í≤ΩÌóòÏπò Î¨ºÏïΩ</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í≤ΩÌóòÏπòÎ•º <span style="color:#e040fb">${item.val}</span> ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                playPotionSfx();
            } else if (item.type === 'potion_poison') {
                if (pStatus.poison <= 0) { addLog("ÎèÖ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãôÎãàÎã§."); return; }
                isActing = true;
                pStatus.poison = 0;
                addLog(`<span style="color:#00e676">Ìï¥ÎèÖ Î¨ºÏïΩ</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÎèÖÏùÑ ÏπòÎ£åÌñàÏäµÎãàÎã§!`);
                playPotionSfx();
                const cureEl = document.getElementById('p-cure');
                cureEl.style.display = 'block';
                setTimeout(() => { cureEl.style.display = 'none'; }, 1000);
            } else if (item.type === 'potion_skeleton') {
                isActing = true;
                player.hp = player.maxHp;
                player.mp = player.maxMp;
                player.battleCurse = true;
                addLog(`<span style="color:#757575">Ìï¥Í≥® Ìè¨ÏÖò</span>ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ï≤¥Î†•Í≥º ÎßàÎÇòÎ•º Î™®Îëê ÌöåÎ≥µÌñàÏäµÎãàÎã§...`);
                playPotionSfx();
            } else if (item.type === 'potion_focus') {
                isActing = true;
                pStatus.nextSkillZeroCost = 1;
                pStatus.skillDmgUp = 3;
                showEffectPopup("Ï†ïÏã† ÏßëÏ§ë", "Îã§Ïùå Ïä§ÌÇ¨ ÎßàÎÇò ÏÜåÎ™® 0\n3ÌÑ¥Í∞Ñ Ïä§ÌÇ¨ Îç∞ÎØ∏ÏßÄ 50% Ï¶ùÍ∞Ä", item.img || "potion_focus.jpg");
                playPotionSfx();
                handledByPopup = true;
            } else if (item.type === 'potion_holy') {
                isActing = true;
                pStatus.poison = 0;
                pStatus.stun = 0;
                addLog(`<span style="color:#00e676">Ï†ïÌôîÏùò ÏÑ±Ïàò</span>Í∞Ä Î™®Îì† ÏÉÅÌÉú Ïù¥ÏÉÅÏùÑ ÏîªÏñ¥ÎÉàÏäµÎãàÎã§!`);
                playPotionSfx();
                const cureEl = document.getElementById('p-cure');
                cureEl.style.display = 'block';
                setTimeout(() => { cureEl.style.display = 'none'; }, 1000);
            } else if (item.type === 'potion_madness') {
                isActing = true;
                const dmg = Math.floor(player.hp * 0.3);
                player.hp = Math.max(1, player.hp - dmg);
                pStatus.critUp = 3;
                showDamage('player-frame', dmg, 'player_hit');
                showEffectPopup("Í¥ëÍ∏∞Ïùò Ìûò", `HP ${dmg} Í∞êÏÜå\n3ÌÑ¥Í∞Ñ ÌÅ¨Î¶¨Ìã∞Ïª¨ 100%`, item.img || "potion_madness.jpg");
                playPotionSfx();
                handledByPopup = true;
            } else if (item.type === 'potion_gamble') {
                isActing = true;
                player.inventory.splice(index, 1);
                const rand = Math.random() * 100;
                playItemSfx();

                if (rand < 5) { // 1. Ìô©Í∏àÏùò ÏÜê
                    const stolenGold = (player.level * 150) + 300;
                    player.gold += stolenGold;
                    addLog(`<span style='color:gold; font-weight:bold;'>üí∞ Ìô©Í∏àÏùò ÏÜê! Ï†ÅÏùÑ ÌÑ∏Ïñ¥ ${stolenGold}GÎ•º ÏñªÍ≥† ÏäπÎ¶¨ÌñàÏäµÎãàÎã§!</span>`);
                    setTimeout(win, 1000);
                    return;
                }
                else if (rand < 15) { // 2. ÏãúÍ≥µÍ∞ÑÏùò Îí§ÌãÄÎ¶º
                    const pHpP = player.hp / player.maxHp;
                    const eHpP = enemy.hp / enemy.maxHp;
                    player.hp = player.maxHp * eHpP;
                    enemy.hp = enemy.maxHp * pHpP;
                    addLog("<span style='color:#9c27b0;'>üåÄ ÏãúÍ≥µÍ∞ÑÏùò Îí§ÌãÄÎ¶º! Ï†ÅÍ≥º ÎÇòÏùò Ï≤¥Î†• ÎπÑÏú®Ïù¥ Î∞îÎÄåÏóàÏäµÎãàÎã§!</span>");
                }
                else if (rand < 30) { // 3. ÎèÖÏù¥ Îì† ÏÑ±Î∞∞
                    eStatus.poison = 5; pStatus.poison = 3;
                    addLog("<span style='color:#4caf50;'>üß™ ÎèÖÏù¥ Îì† ÏÑ±Î∞∞! ÏÑúÎ°úÏóêÍ≤å ÏπòÎ™ÖÏ†ÅÏù∏ ÎèÖÏùÑ Ï£ºÏûÖÌï©ÎãàÎã§.</span>");
                }
                else if (rand < 55) { // 4. ÎØ∏ÏôÑÏÑ±Îêú Ìè≠Î∞ú
                    const pDmg = Math.floor(player.hp * 0.3);
                    const eDmg = Math.floor(enemy.hp * 0.3);
                    player.hp -= pDmg; enemy.hp -= eDmg;
                    showDamage('player-frame', pDmg, 'player_hit');
                    showDamage('enemy-frame', eDmg, 'normal');
                    triggerScreenShake(true);
                    addLog("<span style='color:#ff5722;'>üí• ÎØ∏ÏôÑÏÑ±Îêú Ìè≠Î∞ú! Î™®ÎëêÏóêÍ≤å ÌòÑÏû¨ Ï≤¥Î†•Ïùò 30% ÌîºÌï¥Î•º ÏûÖÌûôÎãàÎã§!</span>");
                }
                else if (rand < 65) { // 5. Í∞ÄÎ∞©Ïùò Í∏∞Ï†Å
                    const potions = player.inventory.filter(i => i.type.includes('potion') && i.type !== 'potion_gamble');
                    if (potions.length > 0) {
                        const randomPotion = potions[Math.floor(Math.random() * potions.length)];
                        if (player.inventory.length < 24) {
                            player.inventory.push({...randomPotion});
                            addLog(`<span style='color:#e040fb;'>üéí Í∞ÄÎ∞©Ïùò Í∏∞Ï†Å! [${randomPotion.name}]ÏùÑ(Î•º) Î≥µÏÇ¨ÌñàÏäµÎãàÎã§!</span>`);
                        } else {
                            addLog(`<span style='color:#e040fb;'>üéí Í∞ÄÎ∞©Ïù¥ Í∞ÄÎìù Ï∞® [${randomPotion.name}]Ïùò Ìö®Í≥ºÎ•º Ï¶âÏãú Î∞úÎèôÌï©ÎãàÎã§!</span>`);
                            player.hp = Math.min(player.maxHp, player.hp + 50);
                        }
                    } else { addLog("Î≥µÏÇ¨Ìï† Î¨ºÏïΩÏù¥ ÏóÜÏñ¥ Ìö®Í≥ºÍ∞Ä ÏÜåÎ©∏ÌñàÏäµÎãàÎã§."); }
                }
                else if (rand < 75) { // 6. Î∂ÑÎÖ∏Ïùò ÌôîÏã†
                    rage = 100; player.rage = 100;
                    addLog("<span style='color:#ff9800; font-weight:bold;'>üî• Î∂ÑÎÖ∏Ïùò ÌôîÏã†! Î∂ÑÎÖ∏ Í≤åÏù¥ÏßÄÍ∞Ä Ï¶âÏãú Ï∂©Ï†ÑÎê©ÎãàÎã§!</span>");
                }
                else if (rand < 95) { // 7. Í∞ïÏ†ú Ï∞®Ïõê Ïù¥Îèô
                    addLog("<span style='color:#607d8b;'>üå´Ô∏è Í∞ïÏ†ú Ï∞®Ïõê Ïù¥Îèô! Ï†ÑÌà¨ÏóêÏÑú Í∞ïÏ†úÎ°ú Ïù¥ÌÉàÌï©ÎãàÎã§.</span>");
                    setTimeout(finishBattle, 1200);
                    return;
                }
                else { // 8. Ïã†Ïùò Í∞ÄÌò∏
                    pStatus.invincible = 3;
                    player.hp = Math.min(player.maxHp, player.hp + (player.maxHp * 0.5));
                    player.mp = Math.min(player.maxMp, player.mp + (player.maxMp * 0.5));
                    addLog("<span style='color:#ffd700; font-weight:bold;'>‚ú® Ïã†Ïùò Í∞ÄÌò∏! 3ÌÑ¥ Î¨¥Ï†Å Î∞è Ï≤¥Î†•/ÎßàÎÇòÍ∞Ä ÌöåÎ≥µÎê©ÎãàÎã§!</span>");
                }

                update();
                if (enemy.hp <= 0) setTimeout(win, 1000);
                else if (player.hp <= 0) showGameOver("ÎèÑÎ∞ïÏùò ÎåÄÍ∞ÄÎäî Ï£ΩÏùåÏù¥ÏóàÏäµÎãàÎã§.");
                else setTimeout(eTurn, 1500);
                return;
            }

            player.inventory.splice(index, 1);

            if (!handledByPopup) {
                update();
                setTimeout(eTurn, 1500);
            }
        }

        function showEffectPopup(title, desc, img) {
            document.getElementById('effect-title').innerText = title;
            document.getElementById('effect-desc').innerText = desc;
            document.getElementById('effect-img').src = 'image/' + img;
            document.getElementById('effect-modal').style.display = 'flex';
        }

        function closeEffectModal() {
            document.getElementById('effect-modal').style.display = 'none';
            update();
            setTimeout(eTurn, 1500);
        }
    </script>
</body>
</html>