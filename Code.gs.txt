// Code.gs

// 1. 데이터 저장 (POST 요청)
function doPost(e) {
  const lock = LockService.getScriptLock();
  // 30초 락 시도 (동시성 제어) - 실패 시 에러 반환
  if (!lock.tryLock(30000)) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", error: "Server Busy"})).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const contents = e.postData.contents;

    if (!contents) {
      return ContentService.createTextOutput(JSON.stringify({result: "error", error: "No content"})).setMimeType(ContentService.MimeType.JSON);
    }

    const params = JSON.parse(contents);

    // 랭킹 저장 요청인지 확인
    if (params.type === 'ranking') {
      return saveRanking(ss, params);
    }

    // 일반 캐릭터 데이터 저장
    let sheet = ss.getSheetByName('시트1') || ss.getSheets()[0];
    const name = params.name;
    const jsonData = JSON.stringify(params);

    const data = sheet.getDataRange().getValues();
    let rowIndex = -1;

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == name) {
        rowIndex = i + 1;
        break;
      }
    }

    if (rowIndex > 0) {
      sheet.getRange(rowIndex, 2).setValue(jsonData);
      sheet.getRange(rowIndex, 3).setValue(new Date());
    } else {
      sheet.appendRow([name, jsonData, new Date()]);
    }

    return ContentService.createTextOutput(JSON.stringify({result: "success"})).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", error: err.toString()})).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// 랭킹 저장 함수
function saveRanking(ss, params) {
  try {
    let rankSheet = ss.getSheetByName('Ranking');
    if (!rankSheet) {
      rankSheet = ss.insertSheet('Ranking');
      rankSheet.appendRow(['Name', 'Score', 'Job', 'Level', 'UpdatedAt', 'BossKills']);
    }

    if (rankSheet.getLastRow() === 0) {
      rankSheet.appendRow(['Name', 'Score', 'Job', 'Level', 'UpdatedAt', 'BossKills']);
    }

    const data = rankSheet.getDataRange().getValues();
    let rowIndex = -1;
    const playerName = params.name || "Unknown";

    // Find existing player
    for (let i = 1; i < data.length; i++) { // Start from 1 to skip header
      if (data[i][0] == playerName) {
        rowIndex = i + 1;
        break;
      }
    }

    const newScore = Number(params.score || 0);

    if (rowIndex > 0) { // Player exists
      const oldScore = Number(data[rowIndex - 1][1] || 0);
      if (newScore > oldScore) {
        // Update row
        rankSheet.getRange(rowIndex, 1, 1, 6).setValues([[
          playerName,
          newScore,
          params.job || "Novice",
          Number(params.level || 1),
          new Date(),
          Number(params.bossKills || 0)
        ]]);
      }
    } else { // New player
      // Append new row
      rankSheet.appendRow([
        playerName,
        newScore,
        params.job || "Novice",
        Number(params.level || 1),
        new Date(),
        Number(params.bossKills || 0)
      ]);
    }

    // 정렬 및 상위 10개 유지
    const lastRow = rankSheet.getLastRow();
    if (lastRow > 1) {
      const lastCol = rankSheet.getLastColumn();
      const range = rankSheet.getRange(2, 1, lastRow - 1, lastCol);
      range.sort({column: 2, ascending: false}); // Score(2열) 기준 내림차순
    }

    // 10위 밖 데이터 삭제 (헤더 1줄 + 데이터 10줄 = 11줄 유지)
    if (rankSheet.getLastRow() > 11) {
      rankSheet.deleteRows(12, rankSheet.getLastRow() - 11);
    }

    return ContentService.createTextOutput(JSON.stringify({result: "success", message: "Ranking Updated"})).setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", error: e.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}


// 2. 데이터 불러오기 (GET 요청)
function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // 랭킹 데이터 요청
    if (e.parameter.type === 'ranking') {
      let rankSheet = ss.getSheetByName('Ranking');
      // 시트가 없거나 데이터가 없으면 빈 배열 반환
      if (!rankSheet || rankSheet.getLastRow() <= 1) {
        return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
      }

      const data = rankSheet.getDataRange().getValues();
      let rankings = [];

      // 상위 10개 데이터 가져오기 (헤더 제외)
      const numRows = Math.min(data.length, 11);
      for (let i = 1; i < numRows; i++) {
        // 이름이 있는 경우만 추가
        if (data[i][0]) {
          rankings.push({
            name: data[i][0],
            score: Number(data[i][1] || 0), // 숫자로 변환하여 전송
            job: data[i][2],
            level: Number(data[i][3] || 1),
            bossKills: Number(data[i][5] || 0)
          });
        }
      }
      return ContentService.createTextOutput(JSON.stringify(rankings)).setMimeType(ContentService.MimeType.JSON);
    }

    // 일반 캐릭터 데이터 불러오기
    let sheet = ss.getSheetByName('시트1') || ss.getSheets()[0];
    const name = e.parameter.name;
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == name) {
        return ContentService.createTextOutput(data[i][1]).setMimeType(ContentService.MimeType.JSON);
      }
    }

    return ContentService.createTextOutput(JSON.stringify({ error: "Not Found" })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ error: err.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}
